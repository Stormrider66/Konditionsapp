// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
}

enum TestType {
  RUNNING
  CYCLING
  SKIING
}

enum TestStatus {
  DRAFT
  COMPLETED
  ARCHIVED
}

enum InclineUnit {
  PERCENT
  DEGREES
}

enum UserRole {
  ADMIN
  COACH
  ATHLETE
}

enum WorkoutType {
  RUNNING
  STRENGTH
  PLYOMETRIC
  CORE
  RECOVERY
  CYCLING
  SKIING
  OTHER
}

enum WorkoutIntensity {
  RECOVERY      // Very easy
  EASY          // Zone 1-2
  MODERATE      // Zone 3
  THRESHOLD     // Zone 4
  INTERVAL      // Zone 5
  MAX           // All-out
}

enum PeriodPhase {
  BASE          // Building aerobic base
  BUILD         // Increasing intensity
  PEAK          // Race-specific training
  TAPER         // Pre-race recovery
  RECOVERY      // Post-race recovery
  TRANSITION    // Off-season
}

enum SubscriptionTier {
  FREE          // Basic features
  BASIC         // Up to 5 athletes
  PRO           // Up to 50 athletes
  ENTERPRISE    // Unlimited athletes
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      UserRole @default(COACH)
  language  String   @default("sv") // "sv" or "en"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Existing relations
  tests    Test[]
  clients  Client[]
  teams    Team[]

  // New relations for training programs
  coachPrograms     TrainingProgram[] @relation("CoachPrograms")
  exercises         Exercise[]
  workoutLogs       WorkoutLog[]
  sentMessages      Message[]         @relation("SentMessages")
  receivedMessages  Message[]         @relation("ReceivedMessages")
  athleteAccount    AthleteAccount?
  subscription      Subscription?

  @@index([email])
  @@index([role])
}

model Team {
  id        String   @id @default(uuid())
  userId    String
  name      String
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  members   Client[]

  @@index([userId])
  @@index([name])
}

model Client {
  id        String   @id @default(uuid())
  userId    String
  teamId    String?
  name      String
  email     String?
  phone     String?
  gender    Gender
  birthDate DateTime
  height    Float    // cm
  weight    Float    // kg
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user             User              @relation(fields: [userId], references: [id])
  team             Team?             @relation(fields: [teamId], references: [id], onDelete: SetNull)
  tests            Test[]
  trainingPrograms TrainingProgram[]
  athleteAccount   AthleteAccount?

  // Training Engine relationships
  athleteProfile       AthleteProfile?
  dailyMetrics         DailyMetrics[]
  trainingLoads        TrainingLoad[]
  programsEngine       TrainingProgramEngine[]
  fieldTests           FieldTest[]
  selfReportedLactates SelfReportedLactate[]
  raceCalendars        RaceCalendar[]
  races                Race[]
  injuryAssessments    InjuryAssessment[]
  crossTrainingSessions CrossTrainingSession[]
  strengthSessions     StrengthTrainingSession[]

  @@index([userId])
  @@index([teamId])
  @@index([name])
  @@index([email])
}

model Test {
  id         String     @id @default(uuid())
  clientId   String
  userId     String
  testDate   DateTime
  testType   TestType
  status     TestStatus @default(DRAFT)

  // Test metadata
  location    String?     // Piteå, Skellefteå, etc.
  testLeader  String?     // Name of test leader
  inclineUnit InclineUnit @default(PERCENT) // For running tests: % or degrees

  // Beräknade värden
  maxHR      Int?
  maxLactate Float?
  vo2max     Float?

  // Tröskelvärden
  aerobicThreshold    Json?  // {hr: number, value: number, unit: string}
  anaerobicThreshold  Json?  // {hr: number, value: number, unit: string}

  // Träningszoner
  trainingZones Json?  // Array av zoner

  // Anteckningar
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client           Client            @relation(fields: [clientId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  testStages       TestStage[]
  report           Report?
  trainingPrograms TrainingProgram[]

  // Training Engine relationships
  thresholdCalculation ThresholdCalculation?

  @@index([clientId])
  @@index([userId])
  @@index([testDate])
  @@index([location])
}

model TestStage {
  id       String @id @default(uuid())
  testId   String
  sequence Int    // Ordning i testet

  // Gemensamma fält
  duration    Float  // minuter
  heartRate   Int    // slag/min
  lactate     Float  // mmol/L
  vo2         Float? // ml/kg/min

  // Löpspecifika
  speed       Float? // km/h
  incline     Float? // procent

  // Cykelspecifika
  power       Float? // watt
  cadence     Int?   // rpm

  // Skidåkning (Cross-country skiing)
  pace        Float? // min/km

  // Beräknade värden
  economy     Float? // ml/kg/km för löpning
  wattsPerKg  Float? // watt/kg för cykling

  createdAt DateTime @default(now())

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@index([sequence])
}

model Report {
  id        String   @id @default(uuid())
  testId    String   @unique

  // Rapportdata
  htmlContent String  @db.Text
  pdfUrl      String?

  // Metadata
  generatedAt DateTime @default(now())
  generatedBy String

  // Anpassningar
  customNotes     String?
  recommendations String?

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)
}

model TestTemplate {
  id          String   @id @default(uuid())
  userId      String
  name        String
  testType    TestType
  description String?
  stages      Json     // Array of stage configurations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([testType])
  @@index([name])
}

// ==================== SUBSCRIPTION & BILLING ====================

model Subscription {
  id     String             @id @default(uuid())
  userId String             @unique
  tier   SubscriptionTier   @default(FREE)
  status SubscriptionStatus @default(TRIAL)

  // Limits based on tier
  maxAthletes      Int      @default(0) // 0=FREE, 5=BASIC, 50=PRO, -1=ENTERPRISE (unlimited)
  currentAthletes  Int      @default(0)

  // Billing
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  trialEndsAt DateTime?
  cancelAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([tier])
}

// ==================== ATHLETE ACCOUNTS ====================

// Links a Client to an Athlete User account (1-to-1)
model AthleteAccount {
  id        String   @id @default(uuid())
  clientId  String   @unique
  userId    String   @unique

  // Athlete preferences
  notificationPrefs Json? // { email: boolean, push: boolean, workoutReminders: boolean }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([userId])
}

// ==================== TRAINING PROGRAMS ====================

model TrainingProgram {
  id          String   @id @default(uuid())
  clientId    String
  coachId     String   // User who created it
  testId      String?  // Optional: linked to specific test results

  name        String   // "Marathon Training - Spring 2025"
  description String?  @db.Text
  goalRace    String?  // "Stockholm Marathon", "Get in shape", "5K PR"
  goalDate    DateTime?
  goalType    String?  // "marathon", "half-marathon", "10k", "5k", "fitness", "cycling", "skiing"

  startDate DateTime
  endDate   DateTime

  // Metadata
  isActive   Boolean @default(true)
  isTemplate Boolean @default(false) // Can be reused as template

  // Generated from which test?
  generatedFromTest Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  coach  User   @relation("CoachPrograms", fields: [coachId], references: [id])
  test   Test?  @relation(fields: [testId], references: [id], onDelete: SetNull)

  weeks TrainingWeek[]

  @@index([clientId])
  @@index([coachId])
  @@index([testId])
  @@index([startDate, endDate])
  @@index([isActive])
}

model TrainingWeek {
  id        String @id @default(uuid())
  programId String

  weekNumber   Int    // 1, 2, 3...
  startDate    DateTime
  endDate      DateTime

  phase        PeriodPhase
  focus        String? // "Build endurance", "Taper week", "Recovery"
  weeklyVolume Float?  // Planned total hours or km

  notes String? @db.Text

  program TrainingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  days    TrainingDay[]

  @@unique([programId, weekNumber])
  @@index([programId])
  @@index([startDate, endDate])
}

model TrainingDay {
  id     String @id @default(uuid())
  weekId String

  dayNumber Int      // 1=Monday, 2=Tuesday, etc.
  date      DateTime

  notes String? @db.Text

  week     TrainingWeek @relation(fields: [weekId], references: [id], onDelete: Cascade)
  workouts Workout[]

  @@unique([weekId, dayNumber])
  @@index([weekId])
  @@index([date])
}

model Workout {
  id    String @id @default(uuid())
  dayId String

  type        WorkoutType
  name        String   // "Long Run", "Tempo Run", "Upper Body Strength"
  description String?  @db.Text
  status      String   @default("PLANNED") // "PLANNED", "MODIFIED", "CANCELLED", "COMPLETED"

  intensity WorkoutIntensity
  duration  Int?   // Planned minutes
  distance  Float? // Planned km (for running)

  // Coach instructions
  instructions String? @db.Text
  coachNotes   String? @db.Text

  // Ordering (if multiple workouts in one day)
  order Int @default(1)

  // Is this a custom workout added by athlete?
  isCustom Boolean @default(false)

  day      TrainingDay      @relation(fields: [dayId], references: [id], onDelete: Cascade)
  segments WorkoutSegment[]
  logs     WorkoutLog[]
  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dayId, order])
  @@index([type])
  @@index([isCustom])
  @@index([status]) // Filter by workout status
}

model WorkoutSegment {
  id        String @id @default(uuid())
  workoutId String

  order Int    // 1, 2, 3...
  type  String // "warmup", "interval", "cooldown", "exercise", "rest", "work"

  // Running/Cycling specific
  duration  Int?    // minutes
  distance  Float?  // km
  pace      String? // "5:00/km" or calculated from zone
  zone      Int?    // Training zone 1-5
  heartRate String? // "140-150 bpm" or zone-based
  power     Int?    // watts (cycling)

  // Interval-specific
  reps Int? // Number of repetitions (for intervals)

  // Strength/Plyo/Core specific
  exerciseId String? // FK to Exercise library
  sets       Int?
  repsCount  String? // "10" or "10-12" or "AMRAP" or "30 seconds"
  weight     String? // "80kg" or "BW" or "50% 1RM"
  tempo      String? // "3-1-1" (eccentric-pause-concentric)
  rest       Int?    // seconds between sets

  // General
  description String? @db.Text
  notes       String? @db.Text

  workout  Workout   @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exercise Exercise? @relation(fields: [exerciseId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([workoutId, order])
  @@index([exerciseId])
}

// ==================== EXERCISE LIBRARY ====================

model Exercise {
  id          String       @id @default(uuid())
  coachId     String?      // NULL = system exercise, else custom
  name        String       // "Back Squat", "Box Jump", "Plank"
  category    WorkoutType  // STRENGTH, PLYOMETRIC, CORE
  muscleGroup String?      // "Legs", "Core", "Upper Body"

  description  String? @db.Text
  instructions String? @db.Text
  videoUrl     String? // YouTube/Vimeo link
  equipment    String? // "Barbell, Rack", "Box", "None"

  difficulty String? // "Beginner", "Intermediate", "Advanced"

  isPublic Boolean @default(true) // System exercises vs coach-specific

  // Swedish/English names
  nameSv String?
  nameEn String?

  coach    User?            @relation(fields: [coachId], references: [id], onDelete: SetNull)
  segments WorkoutSegment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([category])
  @@index([name])
  @@index([isPublic])
}

// ==================== WORKOUT LOGGING ====================

model WorkoutLog {
  id         String  @id @default(uuid())
  workoutId  String
  athleteId  String  // User with ATHLETE role
  completed  Boolean @default(false)

  completedAt DateTime?

  // Actual values
  duration Int?   // actual minutes
  distance Float? // actual km
  avgPace  String? // "5:15/km"
  avgHR    Int?   // bpm
  maxHR    Int?   // bpm

  // Subjective feedback
  perceivedEffort Int?    // 1-10 RPE scale
  difficulty      Int?    // 1-5 stars
  feeling         String? // "Great", "Good", "Okay", "Tired", "Struggled"
  notes           String? @db.Text

  // File uploads (Garmin .fit, Strava link, etc.)
  dataFileUrl String?
  stravaUrl   String?

  // Coach feedback
  coachFeedback  String? @db.Text
  coachViewedAt  DateTime?

  workout Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  athlete User    @relation(fields: [athleteId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workoutId])
  @@index([athleteId])
  @@index([completedAt])
  @@index([completed])
}

// ==================== MESSAGING ====================

model Message {
  id         String  @id @default(uuid())
  senderId   String
  receiverId String

  subject String?
  content String  @db.Text

  // Optional: link to specific workout
  workoutId String?

  isRead Boolean   @default(false)
  readAt DateTime?

  sender   User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  workout  Workout? @relation(fields: [workoutId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@index([workoutId])
  @@index([createdAt])
  @@index([isRead])
}

// ============================================
// TRAINING ENGINE MODELS
// Added: 2025-11-14
// Purpose: Elite training program generation with monitoring and adaptation
// ============================================

// ============================================
// ENHANCED THRESHOLD CALCULATIONS
// ============================================

/// Stores results from D-max, Mod-Dmax, and field test threshold calculations
model ThresholdCalculation {
  id               String   @id @default(uuid())
  testId           String   @unique
  method           String   // "D-MAX", "MOD-DMAX", "OBLA", "FIELD_TEST", "SELF_REPORTED"
  confidence       String   // "VERY_HIGH", "HIGH", "MEDIUM", "LOW"

  // D-max specific data
  polynomialCoeffs Json?    // {a: number, b: number, c: number, d: number}
  r2               Float?   // Goodness of fit (require ≥0.90 for high confidence)
  dmaxIntensity    Float?   // Intensity at D-max point
  dmaxLactate      Float?   // Lactate at D-max point
  dmaxHr           Float?   // Heart rate at D-max point

  // LT1 (Aerobic Threshold) data
  lt1Intensity     Float    // km/h, watts, or m/s
  lt1Lactate       Float    // mmol/L
  lt1Hr            Float    // bpm
  lt1Method        String   // "BASELINE_PLUS_0.5", "HR_DRIFT", "TALK_TEST"

  // LT2 (Anaerobic Threshold) data
  lt2Intensity     Float
  lt2Lactate       Float
  lt2Hr            Float
  lt2PercentVO2max Float?   // LT2 as % of VO2max (for categorization)

  // Metadata
  testDate         DateTime
  notes            String?
  warnings         Json?    // Array of validation warnings

  test             Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([testId])
  @@index([method, confidence]) // Filter by calculation method and confidence level
  @@index([testDate]) // Sort by test date for temporal queries
}

// ============================================
// ATHLETE PROFILING & CATEGORIZATION
// ============================================

/// Central profile for each athlete with categorization and baselines
model AthleteProfile {
  id                  String    @id @default(uuid())
  clientId            String    @unique

  // Categorization (affects methodology selection)
  category            String    // "BEGINNER", "RECREATIONAL", "ADVANCED", "ELITE"
  vo2maxPercentile    Float?    // Percentile for age/gender
  lt2AsPercentVO2max  Float?    // Key categorization metric

  // Monitoring baselines (established over 14-21 days)
  hrvBaseline         Float?    // RMSSD in ms
  hrvStdDev           Float?    // Standard deviation for thresholds
  hrvLastUpdated      DateTime?
  rhrBaseline         Float?    // bpm
  rhrLastUpdated      DateTime?

  // Current training zones (JSON for flexibility)
  trainingZones       Json?
  zonesLastUpdated    DateTime?

  // Equipment & capabilities
  hasLactateMeter     Boolean   @default(false)
  hasHRVMonitor       Boolean   @default(false)
  hasPowerMeter       Boolean   @default(false)

  // Training history context
  yearsRunning        Int?
  typicalWeeklyKm     Float?
  longestLongRun      Float?

  // Norwegian Method tracking
  norwegianPhase      Int?      // Current phase (1-4) in Norwegian transition

  client              Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([clientId])
  @@index([category])
  @@index([hasLactateMeter, hasHRVMonitor]) // Filter athletes by monitoring capabilities
  @@index([vo2maxPercentile]) // Rank athletes by VO2max
  @@index([norwegianPhase]) // Track Norwegian Method progression
}

// ============================================
// DAILY MONITORING SYSTEM
// ============================================

/// Quick daily check-in for athletes (<2 minutes)
model DailyCheckIn {
  id                  String    @id @default(uuid())
  clientId            String
  date                DateTime  @db.Date

  // Optional HRV/RHR (if athlete has monitors)
  hrv                 Float?    // RMSSD in ms
  restingHR           Float?    // bpm

  // Wellness questionnaire (1-10 scale, 7 questions)
  sleepQuality        Int       // 1=terrible, 10=perfect
  sleepHours          Float?    // Actual hours slept
  soreness            Int       // 1=none, 10=severe
  fatigue             Int       // 1=none, 10=extreme
  stress              Int       // 1=none, 10=extreme
  mood                Int       // 1=terrible, 10=excellent
  motivation          Int       // 1=none, 10=extremely motivated

  // Derived readiness score (0-100)
  readinessScore      Int?
  readinessDecision   String?   // "PROCEED", "REDUCE", "EASY", "REST"

  // Notes
  notes               String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([clientId, date])
  @@index([clientId, date])
  @@index([readinessScore])
  @@index([readinessDecision])
}

/// Field test schedule and reminders
model FieldTestSchedule {
  id              String    @id @default(uuid())
  clientId        String
  testType        String    // "30MIN_TT", "HR_DRIFT", "CRITICAL_VELOCITY"
  scheduledDate   DateTime
  required        Boolean   @default(false) // Critical tests must be completed

  completed       Boolean   @default(false)
  completedDate   DateTime?
  fieldTestId     String?   // Link to completed FieldTest

  // Reminders
  reminderSent    Boolean   @default(false)
  reminderDate    DateTime?

  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([clientId, scheduledDate])
  @@index([completed, scheduledDate])
  @@index([clientId, completed])
}

/// Daily metrics for athlete monitoring and readiness assessment
model DailyMetrics {
  id                  String    @id @default(uuid())
  clientId            String
  date                DateTime  @db.Date

  // HRV data
  hrvRMSSD            Float?    // Primary HRV metric (ms)
  hrvQuality          String?   // "GOOD", "FAIR", "POOR"
  hrvArtifactPercent  Float?    // % of recording with artifacts
  hrvDuration         Float?    // Duration of measurement in seconds
  hrvPosition         String?   // "SUPINE", "SEATED"
  hrvStatus           String?   // "EXCELLENT", "GOOD", "MODERATE", "FAIR", "POOR", "VERY_POOR"
  hrvPercent          Float?    // % of baseline
  hrvTrend            String?   // "IMPROVING", "STABLE", "DECLINING"

  // Resting Heart Rate
  restingHR           Float?    // bpm
  restingHRDev        Float?    // Deviation from baseline (bpm)
  restingHRStatus     String?   // Status based on deviation

  // Wellness questionnaire (1-10 scale)
  sleepQuality        Int?      // 1=terrible, 10=perfect
  sleepHours          Float?    // Actual hours slept
  muscleSoreness      Int?      // 1=none, 10=severe
  energyLevel         Int?      // 1=exhausted, 10=energized
  mood                Int?      // 1=terrible, 10=excellent
  stress              Int?      // 1=none, 10=extreme
  injuryPain          Int?      // 1=none, 10=severe

  // Derived scores
  wellnessScore       Float?    // Weighted composite (0-10)
  wellnessStatus      String?   // "EXCELLENT" to "VERY_POOR"

  // Composite readiness
  readinessScore      Float?    // 0-10 weighted composite
  readinessLevel      String?   // "EXCELLENT", "GOOD", "MODERATE", "FAIR", "POOR", "VERY_POOR"
  recommendedAction   String?   // "PROCEED", "MODIFY_LIGHT", "MODIFY_MODERATE", "MODIFY_SIGNIFICANT", "REST_REQUIRED"

  // Detailed breakdown
  factorScores        Json?     // Factor contributions
  redFlags            Json?     // Critical issues
  yellowFlags         Json?     // Warnings

  // Notes
  athleteNotes        String?
  coachNotes          String?

  client              Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([clientId, date])
  @@index([clientId, date])
  @@index([clientId, readinessScore]) // Filter athletes by readiness score
  @@index([clientId, readinessLevel]) // Filter by readiness level categories
  @@index([date, readinessLevel]) // Daily readiness overview across all athletes
}

// ============================================
// TRAINING LOAD & ACWR TRACKING
// ============================================

/// Daily training load with ACWR calculation using EWMA method
model TrainingLoad {
  id              String    @id @default(uuid())
  clientId        String
  date            DateTime  @db.Date

  // Daily training load
  dailyLoad       Float     // TSS or TRIMP value
  loadType        String    // "TSS", "TRIMP_EDWARDS", "TRIMP_BANISTER", "TRIMP_LUCIA"

  // ACWR calculations
  acuteLoad       Float?    // 7-day EWMA
  chronicLoad     Float?    // 28-day EWMA
  acwr            Float?    // Acute:Chronic ratio
  acwrZone        String?   // "DETRAINING", "OPTIMAL", "CAUTION", "DANGER", "CRITICAL"
  injuryRisk      String?   // "LOW", "MODERATE", "HIGH", "VERY_HIGH"

  // Session details
  duration        Float     // minutes
  distance        Float?    // km
  avgHR           Float?    // bpm
  maxHR           Float?    // bpm
  avgPace         Float?    // sec/km
  intensity       String    // "RECOVERY", "EASY", "MODERATE", "HARD", "VERY_HARD"

  // Session type
  workoutType     String?   // "EASY", "LONG", "THRESHOLD", "INTERVALS", "TEMPO", "RECOVERY", "RACE"
  workoutId       String?   // Link to planned workout

  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())

  @@index([clientId, date])
  @@index([clientId, acwrZone]) // Filter by ACWR risk zone
  @@index([clientId, injuryRisk]) // Filter by injury risk level
}

// ============================================
// ENHANCED TRAINING PROGRAMS
// ============================================

/// Complete training program with periodization and methodology
model TrainingProgramEngine {
  id              String   @id @default(uuid())
  clientId        String

  // Core settings
  name            String
  methodology     String   // "POLARIZED", "NORWEGIAN", "CANOVA", "PYRAMIDAL", "LYDIARD"
  status          String   @default("DRAFT") // "DRAFT", "ACTIVE", "COMPLETED", "PAUSED", "ARCHIVED"

  // Timeline
  startDate       DateTime
  endDate         DateTime
  totalWeeks      Int
  currentWeek     Int      @default(1)
  currentPhase    String?  // "BASE", "BUILD", "PEAK", "TAPER", "RECOVERY"

  // Goals
  targetRaceDate  DateTime?
  targetDistance  String?  // "5K", "10K", "HALF", "MARATHON", "ULTRA"
  targetTime      String?  // HH:MM:SS

  // Program structure (JSON for flexibility)
  periodization   Json
  weeklyPlans     Json

  // Methodology-specific settings
  methodologyConfig Json?

  // Generation metadata
  generatedBy     String   // "COACH" or "AUTO"
  generatedFrom   Json?    // {testId, fieldTestId, thresholdData}

  // Tracking
  completedWeeks  Int      @default(0)
  missedWorkouts  Int      @default(0)
  modifiedWorkouts Int     @default(0)

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId, status])
  @@index([clientId, startDate, endDate])
  @@index([methodology, status]) // Filter programs by training methodology
  @@index([currentPhase]) // Track athletes in specific training phases
}

// ============================================
// WORKOUT MODIFICATIONS
// ============================================

/// Tracks automatic and manual workout modifications
model WorkoutModification {
  id              String   @id @default(uuid())
  workoutId       String
  date            DateTime @default(now())

  // Decision
  decision        String   // "PROCEED", "MINOR_MODIFICATION", "MODERATE_MODIFICATION", "MAJOR_MODIFICATION", "CANCEL"
  autoGenerated   Boolean  @default(true)

  // Original plan
  plannedType     String
  plannedDuration Float    // minutes
  plannedDistance Float?   // km
  plannedIntensity String
  plannedDetails  Json?

  // Modified plan
  modifiedType    String?
  modifiedDuration Float?
  modifiedDistance Float?
  modifiedIntensity String?
  modifiedDetails Json?

  // Reasoning
  readinessScore  Float?
  factors         Json     // Array of {factor, weight, contribution, status}
  reasoning       String   // Human-readable explanation
  methodology     String?  // Methodology-specific guidance

  // References
  dailyMetricsId  String?
  acwr            Float?

  createdAt       DateTime @default(now())

  @@index([workoutId])
  @@index([date])
  @@index([decision])
  @@index([workoutId, date]) // Temporal workout modification history
  @@index([autoGenerated, decision]) // Filter manual vs automatic modifications
}

// ============================================
// FIELD TESTS
// ============================================

/// Results from field tests (alternative to lab testing)
model FieldTest {
  id              String   @id @default(uuid())
  clientId        String
  testType        String   // "30MIN_TT", "20MIN_TT", "HR_DRIFT", "CRITICAL_VELOCITY", "TALK_TEST", "RACE_BASED"
  date            DateTime

  // Test conditions
  conditions      Json?    // {temperature, humidity, wind, terrain}

  // Raw results (JSON for flexibility across test types)
  results         Json

  // Derived thresholds
  lt1Pace         Float?   // sec/km
  lt1HR           Float?   // bpm
  lt2Pace         Float?   // sec/km
  lt2HR           Float?   // bpm
  confidence      String?  // "VERY_HIGH", "HIGH", "MEDIUM", "LOW"

  // Validation
  valid           Boolean  @default(true)
  warnings        Json?
  errors          Json?

  notes           String?

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())

  @@index([clientId, date])
  @@index([testType, date])
  @@index([clientId, testType, date]) // Composite index for test type filtering
  @@index([confidence, valid]) // Filter high-confidence valid tests
}

// ============================================
// SELF-REPORTED LACTATE MEASUREMENTS
// ============================================

/// Athletes can track their own lactate measurements between lab tests
model SelfReportedLactate {
  id              String   @id @default(uuid())
  clientId        String
  date            DateTime

  // Measurement context
  measurementType String   // "WORKOUT", "RACE", "STANDALONE_TEST"
  workoutType     String?  // "EASY", "TEMPO", "THRESHOLD", "INTERVALS", "LONG"

  // Single measurement data
  intensity       Float?   // km/h, watts, or pace
  lactate         Float?   // mmol/L
  heartRate       Float?   // bpm
  rpe             Int?     // 1-10 scale

  // Multi-stage test data
  measurements    Json?    // [{stage, intensity, lactate, heartRate, rpe}]

  // Equipment & quality
  meterBrand      String?  // "Lactate Plus", "Lactate Scout", etc.
  calibrated      Boolean  @default(false)
  qualityRating   String?  // "GOOD", "FAIR", "POOR"

  // Derived insights
  estimatedLT1    Float?
  estimatedLT2    Float?
  confidence      String?  // "LOW", "MEDIUM", "HIGH"

  // Context
  workoutId       String?
  notes           String?
  photos          Json?    // Array of photo URLs

  // Validation status
  validated       Boolean  @default(false)
  validatedBy     String?  // Coach userId
  validatedAt     DateTime?
  validationNotes String?

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId, date])
  @@index([clientId, measurementType])
  @@index([validated])
  @@index([validated, clientId]) // Coach validation workflow - pending validations
  @@index([validatedBy, validatedAt]) // Track coach validation activity
}

// ============================================
// RACE CALENDAR & MULTI-RACE PLANNING
// ============================================

/// Season-level race planning with A/B/C classification
model RaceCalendar {
  id              String   @id @default(uuid())
  clientId        String
  seasonName      String   // "Spring 2025", "Fall Marathon Build"
  startDate       DateTime
  endDate         DateTime

  races           Race[]

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
}

/// Individual race with classification, goals, and results
model Race {
  id              String   @id @default(uuid())
  calendarId      String
  clientId        String

  // Race details
  name            String
  date            DateTime
  distance        String   // "5K", "10K", "HALF", "MARATHON"
  classification  String   // "A", "B", "C"
  priority        Int      @default(1)

  // Goals
  targetTime      String?  // HH:MM:SS
  targetPace      Float?   // sec/km

  // Preparation
  taperWeeks      Int?
  lastQualityDate DateTime?

  // Results
  actualTime      String?
  actualPace      Float?
  place           Int?
  avgHR           Float?
  maxHR           Float?
  splits          Json?
  conditions      Json?

  // Analysis
  vdot            Float?
  equivalents     Json?
  assessment      String?  // "EXCEEDED", "MET", "CLOSE", "MISSED"

  notes           String?
  photos          Json?

  calendar        RaceCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  client          Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([clientId, date])
  @@index([classification, date])
}

// ============================================
// INJURY MANAGEMENT SYSTEM
// ============================================

/// Injury assessment and pain tracking (University of Delaware Soreness Rules)
model InjuryAssessment {
  id              String   @id @default(uuid())
  clientId        String
  date            DateTime @default(now())
  detectedAt      DateTime @default(now()) // Timestamp of injury detection

  // Pain assessment (0-10 scale)
  painLevel       Int      // 0=none, 10=severe
  painLocation    String?  // "PLANTAR_FASCIA", "ACHILLES", "IT_BAND", etc.
  painTiming      String?  // "DURING_WARMUP", "DURING_WORKOUT", etc.
  gaitAffected    Boolean  @default(false) // RED FLAG if true

  // Soreness rules assessment
  painDuringWarmup Boolean @default(false)
  painContinuesThroughout Boolean @default(false)
  painDisappearsAfterWarmup Boolean @default(false)
  painRedevelopsLater Boolean @default(false)
  painPersists1HourPost Boolean @default(false)

  // Functional assessment
  rangeOfMotion   String?  // "NORMAL", "SLIGHTLY_LIMITED", etc.
  swelling        Boolean  @default(false)
  discoloration   Boolean  @default(false)
  weightBearing   String?  // "NORMAL", "SLIGHTLY_AFFECTED", "LIMPING", "UNABLE"

  // Assessment result
  assessment      String   // "CONTINUE", "MODIFY", "REST_1_DAY", etc.
  status          String   @default("ACTIVE") // "ACTIVE", "MONITORING", "RESOLVED"
  injuryType      String?
  phase           String?  // "ACUTE", "SUBACUTE", "CHRONIC", "RECOVERY"

  // Protocol recommendations
  recommendedProtocol Json?
  estimatedTimeOff String?

  // Follow-up
  resolved        Boolean  @default(false)
  resolvedDate    DateTime?
  notes           String?

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId, date])
  @@index([painLevel, gaitAffected])
  @@index([clientId, resolved]) // Track active vs resolved injuries
  @@index([injuryType, phase]) // Track injury types and phases across athletes
  @@index([clientId, injuryType, resolved]) // Track specific injury resolution
}

// ============================================
// CROSS-TRAINING SYSTEM
// ============================================

/// Cross-training sessions with running equivalencies
model CrossTrainingSession {
  id              String   @id @default(uuid())
  clientId        String
  date            DateTime
  workoutId       String?  // Link to replaced running workout

  // Session details
  modality        String   // "DEEP_WATER_RUNNING", "CYCLING", "ELLIPTICAL", etc.
  duration        Float    // minutes
  distance        Float?   // km (if applicable)
  avgHR           Float?   // bpm
  maxHR           Float?   // bpm
  avgPower        Float?   // watts (cycling)
  rpe             Int?     // 1-10 scale

  // Intensity structure
  intensity       String   // "EASY", "MODERATE", "HARD"
  structure       Json?    // Intervals, rest periods

  // Equipment specific
  bodyWeightSupport Float? // % for AlterG
  resistance      String?
  strokeRate      Float?   // Swimming

  // Conversion calculations
  runningEquivalent Json   // {estimatedTSS, runningDistance, runningDuration, fitnessRetention}
  tssEquivalent   Float?

  // Context
  reason          String?  // "INJURY", "VARIETY", "WEATHER", "PREFERENCE"
  injuryType      String?
  effectiveness   String?  // "EXCELLENT", "GOOD", "MODERATE", "POOR"

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId, date])
  @@index([modality, date])
  @@index([clientId, modality]) // Track preferred/used modalities per athlete
  @@index([reason, injuryType]) // Analyze cross-training usage patterns
}

// ============================================
// STRENGTH TRAINING & PLYOMETRICS
// ============================================

/// Periodized strength training sessions integrated with running
model StrengthTrainingSession {
  id              String   @id @default(uuid())
  clientId        String
  date            DateTime

  // Session type
  phase           String   // "ANATOMICAL_ADAPTATION", "MAXIMUM_STRENGTH", "POWER", "MAINTENANCE"
  sessionType     String   // "STRENGTH_A", "STRENGTH_B", "PLYOMETRICS", "COMBINED"

  // Timing relative to running
  timingRelativeToRun String? // "BEFORE_RUN", "AFTER_RUN_6H", "SEPARATE_DAY"
  runningWorkoutId String?

  // Exercises (JSON arrays)
  strengthExercises Json?   // [{exercise, sets, reps, load, rpe, rest}]
  plyometricExercises Json? // [{exercise, sets, reps, height, contacts, rest}]
  runningDrills   Json?     // [{drill, sets, distance, focus}]

  // Volume tracking
  totalSets       Int?
  totalContacts   Int?      // Plyometric contacts
  duration        Float     // minutes
  rpe             Int?      // Overall session RPE

  // Load progression
  strengthLoad    Float?    // Volume load (sets × reps × weight)
  plyometricLoad  Float?

  // Integration with running
  runningPhase    String?   // "BASE", "BUILD", "PEAK", "COMPETITION", "RECOVERY"
  priorityLevel   String    // "PRIMARY", "SECONDARY", "MAINTENANCE"

  // Effectiveness
  completionRate  Float?    // % of planned exercises completed
  qualityRating   String?   // "EXCELLENT", "GOOD", "MODERATE", "POOR"

  notes           String?

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId, date])
  @@index([phase, date])
  @@index([clientId, phase]) // Track strength phase progression per athlete
  @@index([runningPhase, priorityLevel]) // Analyze strength integration with running
}

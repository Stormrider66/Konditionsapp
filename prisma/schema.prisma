// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "../docs/database/erd.svg"
  theme    = "forest"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
}

enum TestType {
  RUNNING
  CYCLING
  SKIING
}

// ==================== MULTI-SPORT SYSTEM ====================

enum SportType {
  RUNNING // Road, trail, track running
  CYCLING // Road, indoor, MTB cycling
  SKIING // Cross-country skiing (classic, skate)
  SWIMMING // Pool/open water swimming
  TRIATHLON // Swim/Bike/Run combined
  HYROX // Functional fitness racing
  GENERAL_FITNESS // CrossFit-style, general PT programs
  FUNCTIONAL_FITNESS // CrossFit-style functional training (benchmarks, gymnastics, olympic lifting)
  STRENGTH // Standalone strength training programs
  // Team Sports
  TEAM_FOOTBALL // Soccer/Football
  TEAM_ICE_HOCKEY // Ice hockey
  TEAM_HANDBALL // Handball
  TEAM_FLOORBALL // Floorball (innebandy)
  TEAM_BASKETBALL // Basketball
  TEAM_VOLLEYBALL // Volleyball
  // Racket Sports
  TENNIS // Tennis
  PADEL // Padel
}

enum TestStatus {
  DRAFT
  COMPLETED
  ARCHIVED
}

enum InclineUnit {
  PERCENT
  DEGREES
}

enum UserRole {
  ADMIN
  COACH
  ATHLETE
  PHYSIO
}

enum WorkoutType {
  RUNNING
  STRENGTH
  PLYOMETRIC
  CORE
  RECOVERY
  CYCLING
  SKIING
  SWIMMING
  TRIATHLON
  HYROX
  ALTERNATIVE
  OTHER
}

enum WorkoutIntensity {
  RECOVERY // Very easy
  EASY // Zone 1-2
  MODERATE // Zone 3
  THRESHOLD // Zone 4
  INTERVAL // Zone 5
  MAX // All-out
}

enum PeriodPhase {
  BASE // Building aerobic base
  BUILD // Increasing intensity
  PEAK // Race-specific training
  TAPER // Pre-race recovery
  RECOVERY // Post-race recovery
  TRANSITION // Off-season
}

enum WorkoutSectionType {
  WARMUP // Warm-up exercises, dynamic stretches, activation
  MAIN // Primary strength exercises
  CORE // Core-specific exercises
  COOLDOWN // Cooldown, stretching, mobility
}

enum SubscriptionTier {
  FREE // Basic features
  BASIC // Up to 5 athletes
  PRO // Up to 50 athletes
  ENTERPRISE // Unlimited athletes
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

// ==================== ATHLETE SUBSCRIPTION TIERS ====================

enum AthleteSubscriptionTier {
  FREE // View reports only - no AI access
  STANDARD // Basic AI chat (50 msg/month), workout logging, daily check-in
  PRO // Full AI agent, unlimited AI, video analysis, Strava/Garmin sync
}

enum PaymentSource {
  DIRECT // Athlete pays directly - 100% to platform
  BUSINESS // Athlete onboarded via business - revenue shared
}

enum IntegrationType {
  STRAVA // Strava OAuth integration
  GARMIN // Garmin Health API integration
  CONCEPT2 // Concept2 Logbook integration
}

enum InvitationType {
  ATHLETE_SIGNUP // Invite athlete to create account
  REPORT_VIEW // Public report link
  REFERRAL // Referral bonus link
}

// ==================== REFERRAL SYSTEM ====================

enum ReferralStatus {
  PENDING // User signed up but hasn't completed onboarding/subscription
  COMPLETED // User completed signup and referral is valid
  EXPIRED // Referral expired (e.g., user never completed signup)
  REVOKED // Referral was revoked (e.g., refund, fraud)
}

enum ReferralRewardType {
  FREE_MONTH // One month free subscription
  DISCOUNT_PERCENT // Percentage discount on next billing
  EXTENDED_TRIAL // Extended trial period
  ATHLETE_SLOTS // Additional athlete slots
}

// ==================== ADMIN SYSTEM ====================

enum AdminRole {
  SUPER_ADMIN // Full system access, can delete contracts
  ADMIN // System administration
  SUPPORT // Customer support access
}

enum EnterpriseContractStatus {
  DRAFT // Contract being prepared
  PENDING_APPROVAL // Awaiting approval
  ACTIVE // Active contract
  SUSPENDED // Temporarily suspended
  CANCELLED // Cancelled contract
  EXPIRED // Contract period ended
}

// ==================== CALENDAR SYSTEM ====================

enum CalendarEventType {
  ALTITUDE_CAMP // Multi-day training camp at altitude
  TRAINING_CAMP // Multi-day training camp (non-altitude)
  TRAVEL // Travel days with reduced/no training
  ILLNESS // Illness tracking with return-to-training protocol
  VACATION // Personal time off
  WORK_BLOCKER // Work commitments blocking training
  PERSONAL_BLOCKER // Personal events (weddings, family, etc.)
  EXTERNAL_EVENT // Imported from external calendar
}

enum CalendarEventStatus {
  SCHEDULED // Future event
  ACTIVE // Currently ongoing
  COMPLETED // Past event
  CANCELLED // Cancelled but kept for history
}

enum EventImpact {
  NO_TRAINING // No training possible
  REDUCED // Reduced training (50% or less)
  MODIFIED // Training with modifications
  NORMAL // Normal training continues
}

enum AltitudeAdaptationPhase {
  ACUTE // First 3-5 days (reduced intensity)
  ADAPTATION // Days 6-14 (gradual increase)
  OPTIMAL // Day 15+ (full adaptation)
  POST_CAMP // Return to sea level (monitor for 14 days)
}

enum BiomechanicalPillar {
  POSTERIOR_CHAIN // Hip dominance - glutes, hamstrings
  KNEE_DOMINANCE // Quad strength & stiffness
  UNILATERAL // Single-leg exercises
  FOOT_ANKLE // Calf, ankle, foot strength
  ANTI_ROTATION_CORE // Core stability & anti-rotation
  UPPER_BODY // Upper body strength (optional for runners)
}

enum ProgressionLevel {
  LEVEL_1 // Static/Stability - beginners
  LEVEL_2 // Strength/Loading - intermediate
  LEVEL_3 // Dynamic/Ballistic - advanced
}

enum PlyometricIntensity {
  LOW // >250ms ground contact (pogo, squat jumps)
  MODERATE // 150-250ms (countermovement, bounds)
  HIGH // <150ms (depth jumps, max 27 contacts)
}

enum ProgressionStatus {
  ON_TRACK // Progressing as expected
  PLATEAU // No progress for 3+ weeks
  REGRESSING // Performance declining
  DELOAD_NEEDED // Volume/intensity too high
}

enum StrengthPhase {
  ANATOMICAL_ADAPTATION // 4-6 weeks, 2-3Ã—12-20 @ 40-60%
  MAXIMUM_STRENGTH // 6-8 weeks, 3-5Ã—3-6 @ 80-95%
  POWER // 3-4 weeks, 3-5Ã—4-6 @ 30-60% max velocity
  MAINTENANCE // Variable, 2Ã—3-5 @ 80-85%
  TAPER // 1-2 weeks, 41-60% volume reduction
}

// ==================== HABIT TRACKING ====================

enum HabitCategory {
  NUTRITION // Drink water, eat protein
  SLEEP // Bedtime routine, wake time
  MOVEMENT // Daily walks, stretching
  MINDFULNESS // Meditation, journaling
  TRAINING // Gym attendance
  RECOVERY // Foam rolling, ice bath
}

enum HabitFrequency {
  DAILY
  WEEKDAYS
  SPECIFIC_DAYS
  X_TIMES_WEEK
}

// ==================== ERGOMETER FIELD TESTING ====================

enum ErgometerType {
  WATTBIKE // Wattbike indoor cycling ergometer
  CONCEPT2_ROW // Concept2 RowErg (rowing machine)
  CONCEPT2_SKIERG // Concept2 SkiErg (skiing machine)
  CONCEPT2_BIKEERG // Concept2 BikeErg (cycling machine)
  ASSAULT_BIKE // Air bike / fan bike (Assault, Echo, Schwinn, etc.)
}

enum ErgometerTestProtocol {
  // Peak Power Tests (Anaerobic Capacity)
  PEAK_POWER_6S // 6-second max power - Wattbike neuromuscular test
  PEAK_POWER_7_STROKE // 7-stroke max power - Concept2 machines
  PEAK_POWER_30S // 30-second Wingate-style sprint

  // Threshold / Time Trial Tests
  TT_1K // 1000m time trial - SkiErg standard
  TT_2K // 2000m time trial - Row/Ski/BikeErg standard
  TT_10MIN // 10-minute max calories - Air Bike threshold
  TT_20MIN // 20-minute FTP test - Wattbike/Cycling

  // MAP Tests (Maximal Aerobic Power)
  MAP_RAMP // Incremental ramp test to exhaustion

  // Critical Power Tests
  CP_3MIN_ALL_OUT // 3-minute all-out test (CP + W' calculation)
  CP_MULTI_TRIAL // Multiple trials (3-min + 12-min) for CP model

  // Interval Tests
  INTERVAL_4X4 // 4Ã—4min with 3min rest - custom threshold test
}

// ==================== SPORT-SPECIFIC TESTING SYSTEM ====================

enum SportTestCategory {
  POWER           // Jump tests, peak power, force plate tests
  SPEED           // Sprint tests (5m, 10m, 20m, 40m)
  AGILITY         // Change of direction tests (T-test, 5-10-5, Illinois)
  STRENGTH        // 1RM tests, isometric tests
  ENDURANCE_FIELD // Yo-Yo IR, Beep test, Cooper test, CSS
  SPORT_SPECIFIC  // Sport-specific tests (serve speed, spike jump, etc.)
}

enum SportTestProtocol {
  // Power Tests
  VERTICAL_JUMP_CMJ       // Counter-movement jump
  VERTICAL_JUMP_SJ        // Squat jump (no arm swing)
  VERTICAL_JUMP_DJ        // Drop jump (reactive strength)
  STANDING_LONG_JUMP      // Broad jump / horizontal power
  SPIKE_JUMP              // Volleyball spike approach jump
  BLOCK_JUMP              // Volleyball block jump
  MEDICINE_BALL_THROW     // Rotational/overhead power (handball)

  // Speed Tests
  SPRINT_5M               // 5m acceleration
  SPRINT_10M              // 10m sprint
  SPRINT_20M              // 20m sprint
  SPRINT_30M              // 30m sprint
  SPRINT_40M              // 40m maximal speed
  FLYING_10M              // Flying 10m (max velocity)
  RSA_6X30M               // Repeated Sprint Ability (6x30m)

  // Agility Tests
  T_TEST                  // T-test agility
  ILLINOIS_AGILITY        // Illinois agility run
  PRO_AGILITY_5_10_5      // 5-10-5 pro agility shuttle
  LANE_AGILITY            // Basketball lane agility
  ARROWHEAD_AGILITY       // Multi-directional agility

  // Endurance Field Tests
  YOYO_IR1                // Yo-Yo Intermittent Recovery Level 1
  YOYO_IR2                // Yo-Yo Intermittent Recovery Level 2
  BEEP_TEST               // Multi-stage fitness test (Beep/Bleep)
  COOPER_TEST             // 12-minute run test
  TIME_TRIAL_5K           // 5K running time trial
  TIME_TRIAL_10K          // 10K running time trial

  // Strength Tests
  BENCH_PRESS_1RM         // Bench press max
  SQUAT_1RM               // Back squat max
  DEADLIFT_1RM            // Deadlift max
  LEG_PRESS_1RM           // Leg press max
  OVERHEAD_PRESS_1RM      // Overhead press max

  // Swimming Tests
  CSS_TEST                // Critical Swim Speed (400m + 200m)
  SWOLF_TEST              // Stroke efficiency (strokes + time)
  SWIM_TIME_TRIAL_100M    // 100m swim time trial
  SWIM_TIME_TRIAL_400M    // 400m swim time trial

  // HYROX Station Tests
  HYROX_SKIERG_1K         // SkiErg 1km
  HYROX_ROW_1K            // Rowing 1km
  HYROX_SLED_PUSH         // Sled push 50m
  HYROX_SLED_PULL         // Sled pull 50m
  HYROX_BURPEE_BROAD_JUMP // 80m burpee broad jumps
  HYROX_FARMERS_CARRY     // 200m farmers carry
  HYROX_SANDBAG_LUNGE     // 100m sandbag lunges
  HYROX_WALL_BALLS        // 75-100 wall balls

  // Sport-Specific Tests
  SERVE_SPEED             // Tennis/Padel serve speed (km/h)
  SHOT_SPEED              // Hockey shot speed
}

// ==================== EQUIPMENT & LOCATION SERVICES ====================

enum EquipmentCategory {
  CARDIO_MACHINE    // RowErg, SkiErg, BikeErg, Wattbike, Treadmill
  STRENGTH_MACHINE  // Cable machine, Leg press
  FREE_WEIGHTS      // Barbells, Dumbbells, Kettlebells
  RACKS             // Squat rack, Power cage
  TESTING           // Lactate analyzer, VO2max system, Force plates
  ACCESSORIES       // Bands, Boxes, Balls
  RECOVERY          // Massage gun, Foam roller, Sauna
  AGILITY           // Cones, Ladders, Hurdles, Poles, Reaction equipment
  TIMING_SYSTEMS    // Timing gates, Reaction lights, Laser systems
}

// ==================== AGILITY STUDIO SYSTEM ====================

enum AgilityDrillCategory {
  COD               // Change of Direction drills
  REACTIVE_AGILITY  // Reactive agility with decision making
  SPEED_ACCELERATION // Sprint and acceleration work
  PLYOMETRICS       // Jump and bound training
  FOOTWORK          // Ladder and cone footwork patterns
  BALANCE           // Balance and stability drills
}

enum AgilityWorkoutFormat {
  CIRCUIT           // Multiple drills in sequence
  STATION_ROTATION  // Teams rotate through stations
  INTERVAL          // Work/rest intervals
  PROGRESSIVE       // Progressive difficulty increase
  REACTIVE          // Reactive/random order drills
  TESTING           // Standardized testing session
}

/// Long-Term Athlete Development stages
enum DevelopmentStage {
  FUNDAMENTALS        // Ages 6-9: FUNdamentals, basic movement skills
  LEARNING_TO_TRAIN   // Ages 9-12: Learning to train, skill development
  TRAINING_TO_TRAIN   // Ages 12-16: Training to train, aerobic base
  TRAINING_TO_COMPETE // Ages 16-18+: Training to compete, specialization
  TRAINING_TO_WIN     // Ages 18+: Training to win, peak performance
  ELITE               // Professional/elite level athletes
}

enum TimingGateSource {
  CSV_IMPORT  // Generic CSV file import
  VALD_API    // VALD Performance API
  BROWER      // Brower timing systems
  FREELAP     // Freelap timing system
  WITTY       // Witty timing system
  MANUAL      // Manual entry
}

enum ServiceType {
  LACTATE_TESTING
  VO2MAX_TESTING
  BODY_COMPOSITION
  STRENGTH_TRAINING
  CARDIO_TRAINING
  GROUP_CLASSES
  PERSONAL_TRAINING
  REHABILITATION
  NUTRITION_COACHING
  VIDEO_ANALYSIS
  REMOTE_COACHING
}

enum FeatureFlag {
  // Core modules
  LACTATE_TESTING
  ERGOMETER_TESTING
  TRAINING_PROGRAMS
  AI_STUDIO
  VIDEO_ANALYSIS

  // Advanced
  HYBRID_WORKOUTS
  VBT_TRACKING
  NUTRITION_TRACKING
  MENSTRUAL_TRACKING

  // Integrations
  STRAVA_SYNC
  GARMIN_SYNC
  CONCEPT2_SYNC

  // Enterprise
  MULTI_LOCATION
  API_ACCESS
  WHITE_LABEL
  CUSTOM_BRANDING
  SSO_LOGIN

  // Limits
  UNLIMITED_ATHLETES
  UNLIMITED_COACHES
}

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  name      String
  role      UserRole   @default(COACH)
  adminRole AdminRole? // Admin-specific role for admin panel access
  language  String     @default("sv") // "sv" or "en"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Existing relations
  tests   Test[]
  clients Client[]
  teams   Team[]

  // New relations for training programs
  coachPrograms    TrainingProgram[] @relation("CoachPrograms")
  exercises        Exercise[]
  workoutLogs      WorkoutLog[]
  sentMessages     Message[]         @relation("SentMessages")
  receivedMessages Message[]         @relation("ReceivedMessages")
  athleteAccount   AthleteAccount?
  subscription     Subscription?
  // AI Studio relations
  coachDocuments   CoachDocument[]   @relation("CoachDocuments")
  aiConversations  AIConversation[]  @relation("CoachConversations")
  videoAnalyses    VideoAnalysis[]   @relation("CoachVideoAnalyses")
  apiKeys          UserApiKey?       @relation("UserApiKeys")

  // Hybrid Studio relations
  hybridWorkouts HybridWorkout[] @relation("CoachHybridWorkouts")

  // Strength & Cardio Studio relations
  strengthSessions  StrengthSession[]  @relation("CoachStrengthSessions")
  cardioSessions    CardioSession[]    @relation("CoachCardioSessions")
  strengthTemplates StrengthTemplate[] @relation("StrengthTemplateOwner")

  // Agility Studio relations
  agilityDrills         AgilityDrill[]         @relation("CoachAgilityDrills")
  agilityWorkouts       AgilityWorkout[]       @relation("CoachAgilityWorkouts")
  timingGateSessions    TimingGateSession[]    @relation("CoachTimingGateSessions")

  // Business & Organization relations
  businessMemberships BusinessMember[]
  tester              Tester?

  // Team Sports System relations
  organizations         Organization[]
  teamWorkoutBroadcasts TeamWorkoutBroadcast[] @relation("CoachBroadcasts")

  // Calendar System relations
  createdCalendarEvents  CalendarEvent[]       @relation("CreatedCalendarEvents")
  modifiedCalendarEvents CalendarEvent[]       @relation("ModifiedCalendarEvents")
  calendarChanges        CalendarEventChange[] @relation("CalendarChanges")

  // Referral System relations
  referralCode    ReferralCode? // Coach's unique referral code
  referralsMade   Referral[]       @relation("ReferrerUser") // Referrals this user made
  referredBy      Referral[]       @relation("ReferredUser") // How this user was referred
  referralRewards ReferralReward[] // Rewards received

  // Deep Research System relations
  deepResearchSessions DeepResearchSession[] @relation("CoachResearchSessions")
  aiUsageBudget        AIUsageBudget?        @relation("UserAIBudget")
  aiUsageLogs          AIUsageLog[]          @relation("UserAIUsageLogs")

  // Multi-part program generation sessions
  programGenerationSessions ProgramGenerationSession[] @relation("CoachProgramGenSessions")

  // Live HR Streaming System relations
  liveHRSessions LiveHRSession[] @relation("CoachLiveHRSessions")

  // Sport-Specific Testing System relations
  sportTests SportTest[] @relation("UserSportTests")

  // Admin System relations
  contractChanges EnterpriseContractChange[] @relation("ContractChanges")
  resolvedErrors  SystemError[]              @relation("ResolvedErrors")

  // Partner Referral System
  referredByBusinessId String?
  referredByBusiness   Business? @relation("PartnerReferredUsers", fields: [referredByBusinessId], references: [id], onDelete: SetNull)
  partnerReferral      PartnerReferral? @relation("ReferredUserPartner")

  // Location Staff assignments
  locationStaff LocationStaff[]

  // Self-coaching: link to coach's own athlete profile
  selfAthleteClientId String? @unique
  selfAthleteClient   Client? @relation("SelfAthleteClient", fields: [selfAthleteClientId], references: [id], onDelete: SetNull)

  // Data Moat System relations
  coachDecisions     CoachDecision[]  @relation("CoachDecisions")
  coachPredictions   AIPrediction[]   @relation("CoachPredictions")

  // Data Moat Phase 2: Training-Performance Correlation
  coachTrainingOutcomes TrainingPeriodOutcome[] @relation("CoachTrainingOutcomes")

  // Physiotherapist System relations
  physioAssignments      PhysioAssignment[]      @relation("PhysioAssignments")
  treatmentSessions      TreatmentSession[]      @relation("PhysioTreatmentSessions")
  rehabPrograms          RehabProgram[]          @relation("PhysioRehabPrograms")
  movementScreens        MovementScreen[]        @relation("PhysioMovementScreens")
  createdRestrictions    TrainingRestriction[]   @relation("UserCreatedRestrictions")
  acuteInjuryReports     AcuteInjuryReport[]     @relation("UserAcuteInjuryReports")
  createdCareTeamThreads CareTeamThread[]        @relation("UserCreatedCareTeamThreads")
  careTeamMessages       CareTeamMessage[]       @relation("UserCareTeamMessages")
  careTeamParticipations CareTeamParticipant[]   @relation("UserCareTeamParticipations")
  assessedInjuries       InjuryAssessment[]      @relation("AssessedInjuries")

  // Voice Workout Creation
  voiceWorkoutSessions VoiceWorkoutSession[] @relation("CoachVoiceWorkouts")

  @@index([email])
  @@index([role])
  @@index([referredByBusinessId])
}

// ==================== TEAM SPORTS SYSTEM ====================

/// Organization groups multiple teams (e.g., "IFK GÃ¶teborg" with U19, U21, Senior)
model Organization {
  id          String     @id @default(uuid())
  userId      String // Coach who owns the organization
  name        String // e.g., "IFK GÃ¶teborg"
  description String?
  sportType   SportType? // Primary sport for this organization

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id])
  teams Team[] // Teams belonging to this organization

  // Physiotherapist System relations
  physioAssignments PhysioAssignment[] @relation("OrgPhysioAssignments")

  @@index([userId])
  @@index([name])
}

model Team {
  id          String  @id @default(uuid())
  userId      String
  name        String
  description String?

  // Organization grouping (optional)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Team sport configuration
  sportType SportType?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id])
  members Client[]

  // Team workout broadcasts
  workoutBroadcasts TeamWorkoutBroadcast[]

  // Live HR Streaming System
  liveHRSessions LiveHRSession[]

  // Physiotherapist System relations
  physioAssignments PhysioAssignment[] @relation("TeamPhysioAssignments")

  @@index([userId])
  @@index([name])
  @@index([organizationId])
}

/// Tracks when a workout was assigned to an entire team
/// Links individual assignments for aggregation/reporting
model TeamWorkoutBroadcast {
  id      String @id @default(uuid())
  teamId  String
  coachId String

  // What was assigned (polymorphic - one will be set)
  strengthSessionId String?
  cardioSessionId   String?
  hybridWorkoutId   String?
  agilityWorkoutId  String?

  // Assignment metadata
  assignedDate DateTime @db.Date
  notes        String?  @db.Text

  // Cached stats for dashboard
  totalAssigned  Int @default(0)
  totalCompleted Int @default(0)

  createdAt DateTime @default(now())

  team  Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  coach User @relation("CoachBroadcasts", fields: [coachId], references: [id])

  strengthSession StrengthSession? @relation(fields: [strengthSessionId], references: [id])
  cardioSession   CardioSession?   @relation(fields: [cardioSessionId], references: [id])
  hybridWorkout   HybridWorkout?   @relation(fields: [hybridWorkoutId], references: [id])
  agilityWorkout  AgilityWorkout?  @relation("AgilityWorkoutBroadcasts", fields: [agilityWorkoutId], references: [id])

  // Individual assignments from this broadcast
  strengthAssignments StrengthSessionAssignment[]
  cardioAssignments   CardioSessionAssignment[]
  hybridAssignments   HybridWorkoutAssignment[]
  agilityAssignments  AgilityWorkoutAssignment[]

  @@index([teamId])
  @@index([coachId])
  @@index([assignedDate])
}

model Client {
  id        String   @id @default(uuid())
  userId    String
  teamId    String?
  name      String
  email     String?
  phone     String?
  gender    Gender
  birthDate DateTime
  height    Float // cm
  weight    Float // kg
  notes     String?

  // Direct athlete flag (not onboarded via coach)
  isDirect Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user             User              @relation(fields: [userId], references: [id])
  team             Team?             @relation(fields: [teamId], references: [id], onDelete: SetNull)
  tests            Test[]
  trainingPrograms TrainingProgram[]
  athleteAccount   AthleteAccount?

  // Training Engine relationships
  athleteProfile        AthleteProfile?
  dailyMetrics          DailyMetrics[]
  trainingLoads         TrainingLoad[]
  programsEngine        TrainingProgramEngine[]
  fieldTests            FieldTest[]
  selfReportedLactates  SelfReportedLactate[]
  raceCalendars         RaceCalendar[]
  races                 Race[]
  injuryAssessments     InjuryAssessment[]
  crossTrainingSessions CrossTrainingSession[]
  strengthSessions      StrengthTrainingSession[]
  progressionTracking   ProgressionTracking[]
  oneRepMaxHistory      OneRepMaxHistory[]
  raceResults           RaceResult[]
  dailyCheckIns         DailyCheckIn[]
  sportProfile          SportProfile?
  sportPerformances     SportPerformance[]

  // AI Studio relations
  aiConversations  AIConversation[]  @relation("AthleteConversations")
  videoAnalyses    VideoAnalysis[]   @relation("AthleteVideoAnalyses")
  bodyCompositions BodyComposition[] @relation("ClientBodyComposition")
  aiGeneratedWODs  AIGeneratedWOD[]  @relation("ClientWODs")

  // Gemini 3 Pro features
  audioJournals      AudioJournal[]
  menstrualCycles    MenstrualCycle[]
  menstrualDailyLogs MenstrualDailyLog[]

  // Hybrid Studio relations
  hybridWorkoutResults     HybridWorkoutResult[]
  hybridWorkoutAssignments HybridWorkoutAssignment[]
  hybridWorkoutLogs        HybridWorkoutLog[]        @relation("AthleteHybridLogs")

  // Strength & Cardio Studio relations
  strengthSessionAssignments StrengthSessionAssignment[]
  cardioSessionAssignments   CardioSessionAssignment[]
  cardioSessionLogs          CardioSessionLog[]          @relation("AthleteCardioLogs")

  // Agility Studio relations
  agilityWorkoutAssignments AgilityWorkoutAssignment[]
  agilityWorkoutResults     AgilityWorkoutResult[]
  timingGateResults         TimingGateResult[]

  // Nutrition Timing System relations
  dietaryPreferences DietaryPreferences?
  nutritionGoal      NutritionGoal?

  // Athlete Subscription & Integrations
  athleteSubscription AthleteSubscription?
  integrationTokens   IntegrationToken[]
  stravaActivities    StravaActivity[]
  garminActivities    GarminActivity[]
  concept2Results     Concept2Result[]

  // VBT (Velocity-Based Training) relations
  vbtSessions          VBTSession[]
  loadVelocityProfiles LoadVelocityProfile[]

  // Calendar System relations
  calendarEvents       CalendarEvent[]
  calendarEventChanges CalendarEventChange[]

  // Ergometer Field Testing System relations
  ergometerFieldTests         ErgometerFieldTest[]         @relation("ClientErgometerTests")
  ergometerThresholds         ErgometerThreshold[]         @relation("ClientErgometerThresholds")
  ergometerZones              ErgometerZone[]              @relation("ClientErgometerZones")
  externalCalendarConnections ExternalCalendarConnection[]

  // Deep Research System relations
  deepResearchSessions DeepResearchSession[]  @relation("AthleteResearchSessions")
  sharedResearchAccess SharedResearchAccess[] @relation("SharedResearchAccess")

  // Conversational Memory System relations
  conversationMemories  ConversationMemory[]  @relation("ClientMemories")
  conversationSummaries ConversationSummary[] @relation("ClientConversationSummaries")

  // Proactive AI System relations
  aiBriefings         AIBriefing[]               @relation("ClientBriefings")
  aiNotifications     AINotification[]           @relation("ClientAINotifications")

  // Ad-hoc Workout Logging relations
  adHocWorkouts       AdHocWorkout[]             @relation("ClientAdHocWorkouts")
  aiNotificationPrefs AINotificationPreferences? @relation("ClientAINotificationPrefs")

  // Coach-AI Collaboration relations
  coachAlerts CoachAlert[] @relation("ClientCoachAlerts")

  // Accountability tracking
  bestCheckInStreak    Int?      @default(0)
  bestStreakAchievedAt DateTime?

  // Training Summary System relations
  weeklyTrainingSummaries  WeeklyTrainingSummary[]  @relation("ClientWeeklySummaries")
  monthlyTrainingSummaries MonthlyTrainingSummary[] @relation("ClientMonthlySummaries")
  yearlySummaries          YearlySummary[]          @relation("ClientYearlySummaries")

  // Live HR Streaming System relations
  liveHRParticipations LiveHRParticipant[]

  // Habit Formation System relations
  habits Habit[]

  // Meal Logging System relations
  mealLogs MealLog[]

  // Team Sports Match Schedule relations
  matchSchedule ExternalMatchSchedule[]

  // Sport-Specific Testing System relations
  sportTests SportTest[] @relation("ClientSportTests")

  // Self-coaching: coach who owns this as their personal athlete profile
  selfCoachUser User? @relation("SelfAthleteClient")

  // Data Moat System relations
  athleteDecisions      CoachDecision[]      @relation("AthleteDecisions")
  athletePredictions    AIPrediction[]       @relation("AthletePredictions")
  dataMoatConsent       DataMoatConsent?     @relation("AthleteDataMoatConsent")

  // Data Moat Phase 2: Training-Performance Correlation
  trainingOutcomes        TrainingPeriodOutcome[] @relation("AthleteTrainingOutcomes")
  exerciseEffectiveness   ExerciseEffectiveness[] @relation("AthleteExerciseEffectiveness")
  testPredictiveValidations TestPredictiveValidation[] @relation("AthleteTestValidations")

  // Data Moat Phase 3: Cross-Athlete Intelligence
  benchmarkComparisons    BenchmarkComparison[]   @relation("AthleteBenchmarks")
  patternMatches          AthletePatternMatch[]   @relation("AthletePatternMatches")

  // Physiotherapist System relations
  physioAssignments     PhysioAssignment[]     @relation("ClientPhysioAssignments")
  treatmentSessions     TreatmentSession[]     @relation("ClientTreatmentSessions")
  rehabPrograms         RehabProgram[]         @relation("ClientRehabPrograms")
  rehabProgressLogs     RehabProgressLog[]     @relation("ClientRehabProgressLogs")
  trainingRestrictions  TrainingRestriction[]  @relation("ClientTrainingRestrictions")
  movementScreens       MovementScreen[]       @relation("ClientMovementScreens")
  acuteInjuryReports    AcuteInjuryReport[]    @relation("ClientAcuteInjuryReports")
  careTeamThreads       CareTeamThread[]       @relation("ClientCareTeamThreads")

  @@index([userId])
  @@index([teamId])
  @@index([name])
  @@index([email])
  @@index([isDirect])
}

model Test {
  id       String     @id @default(uuid())
  clientId String
  userId   String
  testDate DateTime
  testType TestType
  status   TestStatus @default(DRAFT)

  // Test metadata (legacy string fields - prefer relations below)
  location    String? // PiteÃ¥, SkellefteÃ¥, etc. (LEGACY - use locationId)
  testLeader  String? // Name of test leader (LEGACY - use testerId)
  inclineUnit InclineUnit @default(PERCENT) // For running tests: % or degrees

  // Structured references (preferred over string fields)
  testerId   String? // FK to Tester
  locationId String? // FK to Location

  // Public report sharing
  publicToken     String?   @unique // Random token for public access
  publicExpiresAt DateTime? // When public link expires

  // Pre-test baseline measurements
  restingLactate   Float? // Resting lactate before test (mmol/L)
  restingHeartRate Int? // Resting heart rate before test (bpm)

  // Post-test measurements (to capture peak lactate, 1-5 min after test)
  postTestMeasurements Json? // Array of {timeMin: number, lactate: number, heartRate?: number}

  // BerÃ¤knade vÃ¤rden
  maxHR      Int?
  maxLactate Float?
  vo2max     Float?

  // TrÃ¶skelvÃ¤rden
  aerobicThreshold   Json? // {hr: number, value: number, unit: string}
  anaerobicThreshold Json? // {hr: number, value: number, unit: string}

  // Manual threshold overrides (set by test leader when algorithm fails)
  manualLT1Lactate   Float? // Manual LT1 lactate value (mmol/L)
  manualLT1Intensity Float? // Manual LT1 intensity (speed/power/pace)
  manualLT2Lactate   Float? // Manual LT2 lactate value (mmol/L)
  manualLT2Intensity Float? // Manual LT2 intensity (speed/power/pace)

  // TrÃ¤ningszoner
  trainingZones Json? // Array av zoner

  // Anteckningar
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client           Client            @relation(fields: [clientId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  testStages       TestStage[]
  report           Report?
  trainingPrograms TrainingProgram[]

  // Training Engine relationships
  thresholdCalculation ThresholdCalculation?

  // Tester & Location relations
  tester       Tester?   @relation(fields: [testerId], references: [id], onDelete: SetNull)
  testLocation Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([userId])
  @@index([testDate])
  @@index([location])
  @@index([testerId])
  @@index([locationId])
  @@index([publicToken])
}

model TestStage {
  id       String @id @default(uuid())
  testId   String
  sequence Int // Ordning i testet

  // Gemensamma fÃ¤lt
  duration  Float // minuter
  heartRate Int // slag/min
  lactate   Float // mmol/L
  vo2       Float? // ml/kg/min

  // LÃ¶pspecifika
  speed   Float? // km/h
  incline Float? // procent

  // Cykelspecifika
  power   Float? // watt
  cadence Int? // rpm

  // SkidÃ¥kning (Cross-country skiing)
  pace Float? // min/km

  // BerÃ¤knade vÃ¤rden
  economy    Float? // ml/kg/km fÃ¶r lÃ¶pning
  wattsPerKg Float? // watt/kg fÃ¶r cykling

  createdAt DateTime @default(now())

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@index([sequence])
}

model Report {
  id     String @id @default(uuid())
  testId String @unique

  // Rapportdata
  htmlContent String  @db.Text
  pdfUrl      String?

  // Metadata
  generatedAt DateTime @default(now())
  generatedBy String

  // Anpassningar
  customNotes     String?
  recommendations String?

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)
}

model TestTemplate {
  id          String   @id @default(uuid())
  userId      String
  name        String
  testType    TestType
  description String?
  stages      Json // Array of stage configurations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([testType])
  @@index([name])
}

// ==================== SUBSCRIPTION & BILLING ====================

model Subscription {
  id     String             @id @default(uuid())
  userId String             @unique
  tier   SubscriptionTier   @default(FREE)
  status SubscriptionStatus @default(TRIAL)

  // Limits based on tier
  maxAthletes     Int @default(0) // 0=FREE, 5=BASIC, 50=PRO, -1=ENTERPRISE (unlimited)
  currentAthletes Int @default(0)

  // Billing
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  trialEndsAt DateTime?
  cancelAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([tier])
}

// ==================== REFERRAL SYSTEM ====================

/// Unique referral code for each coach
model ReferralCode {
  id       String  @id @default(uuid())
  userId   String  @unique // One code per coach
  code     String  @unique // e.g., "JOHN2024", "STAR-ABC123"
  isActive Boolean @default(true)

  // Usage tracking
  totalUses           Int @default(0) // Total times code was used
  successfulReferrals Int @default(0) // Completed referrals

  // Optional limits
  maxUses   Int? // null = unlimited
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  referrals Referral[]

  @@index([code])
  @@index([userId])
  @@index([isActive])
}

/// Tracks individual referrals (when someone signs up using a referral code)
model Referral {
  id             String  @id @default(uuid())
  referralCodeId String
  referrerUserId String // Coach who made the referral
  referredUserId String? // User who signed up (null until they complete signup)
  referredEmail  String // Email used during signup (for tracking before account created)

  status ReferralStatus @default(PENDING)

  // Reward tracking
  referrerRewardGranted Boolean @default(false)
  referredRewardGranted Boolean @default(false)

  // Timestamps
  signupAt    DateTime? // When referred user signed up
  completedAt DateTime? // When referral was marked complete
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  referralCode ReferralCode     @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)
  referrerUser User             @relation("ReferrerUser", fields: [referrerUserId], references: [id], onDelete: Cascade)
  referredUser User?            @relation("ReferredUser", fields: [referredUserId], references: [id], onDelete: SetNull)
  rewards      ReferralReward[]

  @@unique([referralCodeId, referredEmail]) // Prevent duplicate referrals for same email
  @@index([referrerUserId])
  @@index([referredUserId])
  @@index([referredEmail])
  @@index([status])
}

/// Rewards granted for successful referrals
model ReferralReward {
  id         String @id @default(uuid())
  referralId String
  userId     String // User who received the reward

  rewardType ReferralRewardType
  value      Float // e.g., 1 for 1 month, 20 for 20% discount, 5 for 5 athlete slots

  // Status
  applied   Boolean   @default(false)
  appliedAt DateTime?
  expiresAt DateTime?

  // For subscription-related rewards
  stripeDiscountId String? // If using Stripe coupon

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  referral Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([referralId])
  @@index([userId])
  @@index([applied])
}

// ==================== ATHLETE SUBSCRIPTION (Direct Athletes) ====================

/// Subscription for individual athletes (separate from coach Subscription)
model AthleteSubscription {
  id            String                  @id @default(uuid())
  clientId      String                  @unique
  tier          AthleteSubscriptionTier @default(FREE)
  status        SubscriptionStatus      @default(TRIAL)
  paymentSource PaymentSource           @default(DIRECT)

  // Stripe integration
  stripeCustomerId     String?
  stripeSubscriptionId String?
  billingCycle         String? // "MONTHLY" | "YEARLY"

  // Revenue sharing (if paymentSource = BUSINESS)
  businessId          String?
  revenueSharePercent Float? // Platform's share (e.g., 20 = 20%)

  // Feature flags (cached for performance)
  aiChatEnabled         Boolean @default(false)
  aiChatMessagesUsed    Int     @default(0)
  aiChatMessagesLimit   Int     @default(0) // 0 = disabled, -1 = unlimited
  videoAnalysisEnabled  Boolean @default(false)
  garminEnabled         Boolean @default(false)
  stravaEnabled         Boolean @default(false)
  workoutLoggingEnabled Boolean @default(false)
  dailyCheckInEnabled   Boolean @default(false)

  // Trial
  trialEndsAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client   Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  business Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([tier])
  @@index([status])
  @@index([businessId])
  @@index([paymentSource])
}

// ==================== BUSINESS & ORGANIZATION ====================

/// Business entity (gym, testing center, coaching company)
model Business {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique // URL-friendly identifier
  description String? @db.Text

  // Contact info
  email   String?
  phone   String?
  website String?

  // Address
  address    String?
  city       String?
  postalCode String?
  country    String? @default("SE")

  // Stripe Connect for revenue sharing
  stripeConnectAccountId String?
  stripeConnectStatus    String? // "PENDING", "ACTIVE", "RESTRICTED"
  defaultRevenueShare    Float   @default(20) // Default platform share %

  // Branding
  logoUrl      String?
  primaryColor String? @default("#3b82f6")

  // Settings
  isActive Boolean @default(true)
  settings Json? // Business-specific settings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members              BusinessMember[]
  testers              Tester[]
  locations            Location[]
  athleteSubscriptions AthleteSubscription[]
  invitations          Invitation[]

  // Admin System relations
  enterpriseContract EnterpriseContract?
  pricingOverrides   PricingOverride[]
  apiKeys            BusinessApiKey[]

  // Partner Referral System
  partnerReferrals   PartnerReferral[]
  referredUsers      User[] @relation("PartnerReferredUsers")

  // Enterprise Features
  features BusinessFeature[]

  // Physiotherapist System relations
  physioAssignments PhysioAssignment[] @relation("BusinessPhysioAssignments")

  @@index([slug])
  @@index([isActive])
}

/// Links users to businesses with roles
model BusinessMember {
  id         String @id @default(uuid())
  businessId String
  userId     String

  // Role within business
  role String @default("MEMBER") // "OWNER", "ADMIN", "MEMBER", "COACH"

  // Permissions (JSON for flexibility)
  permissions Json? // { canManageTesters, canViewAllTests, canManageClients, etc. }

  // Status
  isActive   Boolean   @default(true)
  invitedAt  DateTime  @default(now())
  acceptedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([businessId, userId])
  @@index([businessId])
  @@index([userId])
  @@index([role])
}

/// API keys for business external integrations
model BusinessApiKey {
  id         String  @id @default(uuid())
  businessId String
  name       String  // "Production API Key", "Development Key"
  keyHash    String  @unique // SHA-256 hash of the actual key
  keyPrefix  String  // First 8 chars for display: "bak_xxxx..."

  // Rate limiting
  requestsPerMinute Int @default(60)
  requestsPerDay    Int @default(10000)

  // Scopes/permissions
  scopes String[] @default([]) // ["read:athletes", "write:workouts", etc.]

  // Status
  isActive   Boolean   @default(true)
  lastUsedAt DateTime?
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([keyHash])
}

// ==================== PARTNER REFERRAL SYSTEM ====================

enum PartnerReferralStatus {
  PENDING     // User signed up but hasn't subscribed yet
  ACTIVE      // User has active subscription, revenue being shared
  CHURNED     // User cancelled subscription
  EXPIRED     // Referral expired (no subscription within window)
}

/// Tracks partner/business referrals and ongoing revenue sharing
model PartnerReferral {
  id         String  @id @default(uuid())
  businessId String
  userId     String  @unique // The user who was referred

  // Referral tracking
  referralCode    String? // Optional code used (e.g., "STAR2024")
  referralSource  String? // "link", "code", "api", "manual"
  landingPage     String? // URL they landed on

  status PartnerReferralStatus @default(PENDING)

  // Revenue sharing terms (copied from contract at time of referral)
  revenueSharePercent Float @default(70) // Business gets this % (e.g., 70 = 70%)
  platformSharePercent Float @default(30) // Platform gets this % (e.g., 30 = 30%)

  // Subscription tracking
  subscriptionTier     String? // "FREE", "STANDARD", "PRO"
  monthlyAmount        Int?    // Amount in smallest currency unit (öre)
  currency             String  @default("SEK")
  firstSubscriptionAt  DateTime?
  lastPaymentAt        DateTime?

  // Revenue totals (updated on each payment)
  totalRevenue         Int @default(0) // Total revenue generated (öre)
  totalBusinessShare   Int @default(0) // Total paid to business (öre)
  totalPlatformShare   Int @default(0) // Total kept by platform (öre)
  paymentCount         Int @default(0) // Number of payments processed

  // Payout tracking
  pendingPayout        Int @default(0) // Amount pending payout to business (öre)
  lastPayoutAt         DateTime?
  lastPayoutAmount     Int?

  // Timestamps
  signedUpAt  DateTime @default(now())
  activatedAt DateTime? // When subscription started
  churnedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user     User     @relation("ReferredUserPartner", fields: [userId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([status])
  @@index([signedUpAt])
  @@index([activatedAt])
}

// ==================== TESTERS & LOCATIONS ====================

/// Personnel who conduct tests (can have privacy restrictions)
model Tester {
  id         String  @id @default(uuid())
  businessId String? // Optional - can be independent
  userId     String? @unique // Link to User if they have account
  name       String
  email      String?

  // Privacy settings
  isPrivate Boolean @default(false) // Only sees own tests

  // Stats (cached for performance)
  totalTests Int       @default(0)
  lastTestAt DateTime?

  // Contact info
  phone String?
  title String? // "Fysiolog", "Coach", etc.

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)
  user     User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  tests    Test[]

  @@index([businessId])
  @@index([userId])
  @@index([isActive])
}

/// Physical location where tests are conducted
model Location {
  id         String  @id @default(uuid())
  businessId String
  name       String
  slug       String? // For URL: /star-by-thomson/locations/nordstan
  city       String?

  // Contact
  address    String?
  postalCode String?
  phone      String?
  email      String?

  // Coordinates (for map display)
  latitude  Float?
  longitude Float?

  // Operating hours
  openingHours Json? // { "monday": "06:00-22:00", ... }

  // Capabilities (computed from equipment/services)
  capabilities String[] // ["lactate_testing", "strength_training"]

  // Stats (cached for performance)
  totalTests Int       @default(0)
  lastTestAt DateTime?

  // Settings
  isActive  Boolean @default(true)
  isPrimary Boolean @default(false) // HQ/main location
  settings  Json? // Location-specific settings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business         Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)
  tests            Test[]
  equipment        LocationEquipment[]
  services         LocationService[]
  staff            LocationStaff[]
  athletePreferred AthleteAccount[]    @relation("AthletePreferredLocation")

  // Physiotherapist System relations
  physioAssignments PhysioAssignment[] @relation("LocationPhysioAssignments")

  // Agility Studio relations
  timingGateSessions TimingGateSession[] @relation("TimingGateSessionLocation")

  @@unique([businessId, slug])
  @@index([businessId])
  @@index([city])
  @@index([isActive])
}

/// Master catalog of all possible equipment
model Equipment {
  id          String            @id @default(uuid())
  name        String // "Concept2 RowErg"
  nameSv      String? // "Concept2 Roddmaskin"
  category    EquipmentCategory
  brand       String? // "Concept2", "Technogym"
  description String?
  imageUrl    String?

  // What this equipment enables
  enablesTests     String[] // ["rowing_2k", "rowing_cp"]
  enablesExercises String[] // Exercise IDs or categories

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  locations LocationEquipment[]

  @@index([category])
  @@index([isActive])
}

/// What equipment each location has
model LocationEquipment {
  id          String @id @default(uuid())
  locationId  String
  equipmentId String

  quantity  Int     @default(1)
  condition String? // "Good", "Needs maintenance"
  notes     String?

  // Availability
  isAvailable   Boolean   @default(true)
  availableFrom DateTime?
  availableTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  location  Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([locationId, equipmentId])
  @@index([locationId])
  @@index([equipmentId])
}

/// Services offered at each location
model LocationService {
  id          String @id @default(uuid())
  locationId  String

  serviceType ServiceType
  name        String // Custom name override
  description String?

  // Requirements
  requiredEquipment String[] // Equipment IDs needed
  requiredStaff     String[] // Certifications needed

  // Pricing (optional)
  price        Float?
  currency     String  @default("SEK")
  pricingModel String? // "per_session", "monthly", "included"

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([locationId])
  @@index([serviceType])
}

/// Staff assigned to locations
model LocationStaff {
  id         String @id @default(uuid())
  locationId String
  userId     String

  role      String  // "Manager", "Coach", "Tester"
  isPrimary Boolean @default(false) // Their main location

  // Availability
  schedule Json? // Weekly schedule

  createdAt DateTime @default(now())

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([locationId, userId])
  @@index([locationId])
  @@index([userId])
}

/// Business feature flags - what modules are enabled
model BusinessFeature {
  id         String @id @default(uuid())
  businessId String

  feature   FeatureFlag
  isEnabled Boolean     @default(false)

  // Optional config
  config Json?

  // Limits
  usageLimit Int @default(-1) // -1 = unlimited
  usageCount Int @default(0)

  enabledAt DateTime?
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, feature])
  @@index([businessId])
}

// ==================== INTEGRATIONS (Strava, Garmin) ====================

/// OAuth tokens for external integrations
model IntegrationToken {
  id       String          @id @default(uuid())
  clientId String
  type     IntegrationType

  // OAuth tokens (encrypted at application level)
  accessToken  String    @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?

  // Integration-specific data
  externalUserId String? // Strava athlete ID, Garmin user ID
  scope          String? // OAuth scopes granted

  // Sync status
  lastSyncAt    DateTime?
  lastSyncError String?
  syncEnabled   Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, type])
  @@index([clientId])
  @@index([type])
  @@index([lastSyncAt])
}

/// Temporary OAuth 1.0a request tokens (for Garmin OAuth flow)
/// These are short-lived and cleaned up after use or expiration
model OAuthRequestToken {
  id           String   @id @default(uuid())
  clientId     String // Client initiating the OAuth flow
  provider     String // e.g., "GARMIN"
  requestToken String // OAuth 1.0a request token
  tokenSecret  String // OAuth 1.0a token secret
  createdAt    DateTime @default(now())
  expiresAt    DateTime // Auto-expire after 10 minutes

  @@unique([clientId, provider])
  @@index([expiresAt])
}

/// Synced Strava activities for training load analysis
model StravaActivity {
  id       String @id @default(uuid())
  clientId String
  stravaId String @unique // Strava activity ID

  // Basic activity info
  name        String
  type        String // Strava activity type (Run, Ride, etc.)
  sportType   String? // Strava sport_type
  startDate   DateTime
  description String?  @db.Text

  // Metrics
  distance      Float? // meters
  movingTime    Int? // seconds
  elapsedTime   Int? // seconds
  elevationGain Float? // meters
  averageSpeed  Float? // m/s
  maxSpeed      Float? // m/s

  // Heart rate
  averageHeartrate Float?
  maxHeartrate     Float?

  // Cadence
  averageCadence Float?

  // Power (cycling)
  averageWatts         Float?
  weightedAverageWatts Float?
  kilojoules           Float?

  // Strava scores
  sufferScore Int?
  calories    Float?

  // Activity flags
  trainer Boolean @default(false)
  manual  Boolean @default(false)

  // Map data
  mapPolyline String? @db.Text

  // Calculated metrics
  tss   Float? // Training Stress Score
  trimp Float? // Training Impulse

  // Mapped to our internal types
  mappedType      String? // RUNNING, CYCLING, etc.
  mappedIntensity String? // EASY, MODERATE, HARD

  // Detailed data (JSON)
  splitsMetric Json? // Kilometer splits
  laps         Json? // Lap data

  // HR Stream data for zone tracking
  hrStream        Json? // Second-by-second HR data: number[]
  hrStreamFetched Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client           Client                      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  zoneDistribution ActivityHRZoneDistribution?

  @@index([clientId])
  @@index([startDate])
  @@index([type])
  @@index([mappedType])
}

/// Garmin Connect synced activities (Gap 5 fix - normalizes Garmin data like Strava)
model GarminActivity {
  id               String @id @default(uuid())
  clientId         String
  garminActivityId BigInt @unique // Garmin activity ID (can be large)

  // Basic activity info
  name        String?
  type        String // Garmin activity type (RUNNING, CYCLING, etc.)
  startDate   DateTime
  description String?  @db.Text

  // Metrics
  distance      Float? // meters
  duration      Int? // seconds (movingTime equivalent)
  elapsedTime   Int? // seconds (total elapsed time)
  elevationGain Float? // meters
  averageSpeed  Float? // m/s
  maxSpeed      Float? // m/s

  // Heart rate
  averageHeartrate Float?
  maxHeartrate     Float?

  // Cadence
  averageCadence Float?

  // Power (cycling)
  averageWatts    Float?
  normalizedPower Float?
  maxWatts        Float?

  // Garmin-specific scores
  trainingEffect  Float? // Garmin Training Effect (0-5 scale)
  anaerobicEffect Float? // Garmin Anaerobic Training Effect
  calories        Float?

  // Activity flags
  indoor Boolean @default(false)
  manual Boolean @default(false)

  // Calculated metrics
  tss   Float? // Training Stress Score
  trimp Float? // Training Impulse

  // Mapped to our internal types
  mappedType      String? // RUNNING, CYCLING, STRENGTH, etc.
  mappedIntensity String? // EASY, MODERATE, HARD

  // Detailed data (JSON)
  laps   Json? // Lap data from Garmin
  splits Json? // Split data

  // HR Zone data from Garmin activity details
  hrZoneSeconds Json? // { zone1: 120, zone2: 300, ... }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client           Client                      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  zoneDistribution ActivityHRZoneDistribution?

  @@index([clientId])
  @@index([startDate])
  @@index([type])
  @@index([mappedType])
}

/// Concept2 Logbook workout results (rowing, SkiErg, BikeErg)
model Concept2Result {
  id         String @id @default(uuid())
  clientId   String
  concept2Id Int    @unique // Concept2 result ID

  // Equipment & workout info
  type        String // rower, skierg, bike, dynamic, etc.
  workoutType String? // JustRow, FixedDistanceSplits, etc.
  date        DateTime
  timezone    String?
  comments    String?  @db.Text

  // Core metrics
  distance   Int // meters
  time       Int // tenths of seconds
  calories   Int?
  strokeRate Float? // avg strokes/min (or rpm for bike)
  dragFactor Int?

  // Heart rate
  avgHeartRate Float?
  maxHeartRate Float?
  minHeartRate Float?

  // Pace (derived - seconds per 500m for rowing/ski, or calculated for bike)
  pace Float?

  // Splits/intervals (JSON)
  splits    Json?
  intervals Json?

  // Stroke data availability
  hasStrokeData Boolean @default(false)

  // Calculated metrics
  tss   Float? // Training Stress Score
  trimp Float? // Training Impulse

  // Mapped to our internal types
  mappedType      String? // ROWING, SKIING, CYCLING
  mappedIntensity String? // EASY, MODERATE, HARD

  // Verification status from Concept2
  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([date])
  @@index([type])
  @@index([mappedType])
}

// ==================== INVITATIONS & REFERRALS ====================

/// Invitations and referral codes
model Invitation {
  id   String         @id @default(uuid())
  code String         @unique
  type InvitationType

  // Sender (optional)
  senderId   String? // User who sent invitation
  businessId String? // Business context

  // Recipient
  recipientEmail String?
  recipientName  String?

  // Usage
  usedAt         DateTime?
  usedByClientId String? // Client who used the invitation

  // Expiry
  expiresAt   DateTime?
  maxUses     Int       @default(1)
  currentUses Int       @default(0)

  // Referral bonus tracking
  bonusAwarded Boolean @default(false)
  bonusAmount  Float?

  // Metadata
  metadata Json? // Additional context data

  createdAt DateTime @default(now())

  business Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)

  @@index([code])
  @@index([type])
  @@index([senderId])
  @@index([businessId])
  @@index([expiresAt])
}

// ==================== ATHLETE ACCOUNTS ====================

// Links a Client to an Athlete User account (1-to-1)
model AthleteAccount {
  id       String @id @default(uuid())
  clientId String @unique
  userId   String @unique

  // Athlete preferences
  notificationPrefs     Json?   // { email: boolean, push: boolean, workoutReminders: boolean }
  preferredLocationId   String? // Preferred gym location for WOD generation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client            Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  preferredLocation Location? @relation("AthletePreferredLocation", fields: [preferredLocationId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([userId])
  @@index([preferredLocationId])
}

// ==================== TRAINING PROGRAMS ====================

model TrainingProgram {
  id       String  @id @default(uuid())
  clientId String
  coachId  String // User who created it
  testId   String? // Optional: linked to specific test results

  name        String // "Marathon Training - Spring 2025"
  description String?   @db.Text
  goalRace    String? // "Stockholm Marathon", "Get in shape", "5K PR"
  goalDate    DateTime?
  goalType    String? // "marathon", "half-marathon", "10k", "5k", "fitness", "cycling", "skiing"

  startDate DateTime
  endDate   DateTime

  // Metadata
  isActive   Boolean @default(true)
  isTemplate Boolean @default(false) // Can be reused as template

  // Generated from which test?
  generatedFromTest Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  coach  User   @relation("CoachPrograms", fields: [coachId], references: [id])
  test   Test?  @relation(fields: [testId], references: [id], onDelete: SetNull)

  weeks TrainingWeek[]

  // Data Moat System relations
  coachDecisions CoachDecision[] @relation("ProgramDecisions")

  // Data Moat Phase 2: Training-Performance Correlation
  programOutcomes TrainingPeriodOutcome[] @relation("ProgramOutcomes")

  @@index([clientId])
  @@index([coachId])
  @@index([testId])
  @@index([startDate, endDate])
  @@index([isActive])
}

model TrainingWeek {
  id        String @id @default(uuid())
  programId String

  weekNumber Int // 1, 2, 3...
  startDate  DateTime
  endDate    DateTime

  phase        PeriodPhase
  focus        String? // "Build endurance", "Taper week", "Recovery"
  weeklyVolume Float? // Planned total hours or km

  notes String? @db.Text

  program TrainingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  days    TrainingDay[]

  @@unique([programId, weekNumber])
  @@index([programId])
  @@index([startDate, endDate])
}

model TrainingDay {
  id     String @id @default(uuid())
  weekId String

  dayNumber Int // 1=Monday, 2=Tuesday, etc.
  date      DateTime

  notes String? @db.Text

  week     TrainingWeek @relation(fields: [weekId], references: [id], onDelete: Cascade)
  workouts Workout[]

  @@unique([weekId, dayNumber])
  @@index([weekId])
  @@index([date])
}

model Workout {
  id    String @id @default(uuid())
  dayId String

  type        WorkoutType
  name        String // "Long Run", "Tempo Run", "Upper Body Strength"
  description String?     @db.Text
  status      String      @default("PLANNED") // "PLANNED", "MODIFIED", "CANCELLED", "COMPLETED"

  intensity WorkoutIntensity
  duration  Int? // Planned minutes
  distance  Float? // Planned km (for running)

  // Coach instructions
  instructions String? @db.Text
  coachNotes   String? @db.Text

  // Ordering (if multiple workouts in one day)
  order Int @default(1)

  // Is this a custom workout added by athlete?
  isCustom Boolean @default(false)

  // Ad-hoc workout flag (logged outside of program)
  isAdHoc      Boolean       @default(false)
  adHocSource  AdHocWorkout? @relation("AdHocSourceWorkout")

  // Hero Card Fields (AI-generated or rule-based)
  heroTitle        String? // "Posterior Chain Focus"
  heroDescription  String?   @db.Text // "Focus on hinge movements. Primary lift: Deadlift"
  heroCategory     String? // "HEAVY_LOWER_BODY", "QUAD_DOMINANT", etc.
  heroImageKey     String? // Key for exercise image lookup
  focusGeneratedAt DateTime?
  focusGeneratedBy String? // "AI" | "RULE_BASED"

  day      TrainingDay      @relation(fields: [dayId], references: [id], onDelete: Cascade)
  segments WorkoutSegment[]
  logs     WorkoutLog[]
  messages Message[]

  // Data Moat System relations
  coachDecisions CoachDecision[] @relation("WorkoutDecisions")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dayId, order])
  @@index([type])
  @@index([isCustom])
  @@index([isAdHoc])
  @@index([status]) // Filter by workout status
}

model WorkoutSegment {
  id        String @id @default(uuid())
  workoutId String

  order Int // 1, 2, 3...
  type  String // "warmup", "interval", "cooldown", "exercise", "rest", "work"

  // Running/Cycling specific
  duration  Int? // minutes
  distance  Float? // km
  pace      String? // "5:00/km" or calculated from zone
  zone      Int? // Training zone 1-5
  heartRate String? // "140-150 bpm" or zone-based
  power     Int? // watts (cycling)

  // Interval-specific
  reps Int? // Number of repetitions (for intervals)

  // Strength/Plyo/Core specific
  exerciseId String? // FK to Exercise library
  sets       Int?
  repsCount  String? // "10" or "10-12" or "AMRAP" or "30 seconds"
  weight     String? // "80kg" or "BW" or "50% 1RM"
  tempo      String? // "3-1-1" (eccentric-pause-concentric)
  rest       Int? // seconds between sets

  // Section grouping (for structured strength workouts)
  section WorkoutSectionType @default(MAIN)

  // General
  description String? @db.Text
  notes       String? @db.Text

  workout  Workout   @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exercise Exercise? @relation(fields: [exerciseId], references: [id], onDelete: SetNull)
  setLogs  SetLog[] // Per-set logging data

  createdAt DateTime @default(now())

  @@index([workoutId, order])
  @@index([exerciseId])
}

// ==================== EXERCISE LIBRARY ====================

model Exercise {
  id          String      @id @default(uuid())
  coachId     String? // NULL = system exercise, else custom
  name        String // "Back Squat", "Box Jump", "Plank"
  category    WorkoutType // STRENGTH, PLYOMETRIC, CORE
  muscleGroup String? // "Legs", "Core", "Upper Body"

  description  String? @db.Text
  instructions String? @db.Text
  videoUrl     String? // YouTube/Vimeo link
  equipment    String? // "Barbell, Rack", "Box", "None"

  difficulty String? // "Beginner", "Intermediate", "Advanced"

  isPublic Boolean @default(true) // System exercises vs coach-specific

  // Swedish/English names
  nameSv String?
  nameEn String?

  // Scientific Framework Fields
  biomechanicalPillar BiomechanicalPillar? // Primary movement pattern
  progressionLevel    ProgressionLevel? // Level 1-3 progression
  plyometricIntensity PlyometricIntensity? // For plyometric exercises only
  contactsPerRep      Int? // Ground contacts per rep (plyometric)

  // Exercise substitutions and progressions
  substitutes     String? // JSON array of alternative exercise IDs
  progressionPath String? // JSON array: [easier_id, current_id, harder_id]

  // Hybrid Studio Fields
  isHybridMovement     Boolean           @default(false) // Is this a CrossFit/HYROX movement?
  movementCategory     MovementCategory? // OLYMPIC_LIFT, POWERLIFTING, GYMNASTICS, etc.
  equipmentTypes       EquipmentType[]   @default([]) // Required equipment
  defaultReps          Int? // Default rep count for this movement
  defaultWeightMale    Float? // Default male Rx weight (kg)
  defaultWeightFemale  Float? // Default female Rx weight (kg)
  scaledWeightMale     Float? // Scaled male weight (kg)
  scaledWeightFemale   Float? // Scaled female weight (kg)
  foundationMovement   String? // Alternative for Foundations level
  standardAbbreviation String? // e.g., "C&J" for Clean & Jerk, "MU" for Muscle-Up

  // Icon fields for themed workout display
  iconUrl      String? // URL to exercise-specific icon
  iconCategory String? // Category for fallback icon: "strength", "cardio", "core", "plyometric", "olympic", "gymnastics"

  // Exercise images (AI-generated, stored in Supabase)
  imageUrls         Json? // Array of image paths: ["system/posterior-chain/squat-1.webp", ...]
  primaryImageIndex Int?  @default(0) // Index of primary image for thumbnails

  coach               User?                 @relation(fields: [coachId], references: [id], onDelete: SetNull)
  segments            WorkoutSegment[]
  progressionTracking ProgressionTracking[]
  oneRepMaxHistory    OneRepMaxHistory[]

  // AI Studio relations
  videoAnalyses VideoAnalysis[]

  // Hybrid Studio relations
  hybridMovements HybridMovement[]

  // VBT (Velocity-Based Training) relations
  vbtMeasurements      VBTMeasurement[]
  loadVelocityProfiles LoadVelocityProfile[]

  // Per-set logging
  setLogs SetLog[]

  // Data Moat Phase 2: Exercise Effectiveness Tracking
  effectivenessRecords ExerciseEffectiveness[] @relation("ExerciseEffectivenessRecords")
  outcomePatterns      ExerciseOutcomePattern[] @relation("ExerciseOutcomePatterns")

  // Physiotherapist System relations
  rehabExercises RehabExercise[] @relation("RehabExerciseRef")

  // Rehab Exercise Library Fields (Phase 6)
  isRehabExercise         Boolean       @default(false) // Is this a rehab-specific exercise?
  rehabPhases             RehabPhase[]  @default([]) // Which phases is this exercise suitable for?
  targetBodyParts         String[]      @default([]) // Body parts this exercise targets/rehabilitates
  contraindications       String[]      @default([]) // Conditions where this exercise should be avoided
  progressionExerciseId   String?       // ID of harder progression exercise
  regressionExerciseId    String?       // ID of easier regression exercise

  // Self-relations for progression path
  progressionExercise   Exercise? @relation("ExerciseProgression", fields: [progressionExerciseId], references: [id])
  regressionExercise    Exercise? @relation("ExerciseRegression", fields: [regressionExerciseId], references: [id])
  progressionOf         Exercise[] @relation("ExerciseProgression")
  regressionOf          Exercise[] @relation("ExerciseRegression")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([category])
  @@index([name])
  @@index([isPublic])
  @@index([biomechanicalPillar])
  @@index([progressionLevel])
  @@index([isHybridMovement])
  @@index([movementCategory])
  @@index([isRehabExercise])
}

// ==================== WORKOUT LOGGING ====================

model WorkoutLog {
  id        String  @id @default(uuid())
  workoutId String
  athleteId String // User with ATHLETE role
  completed Boolean @default(false)

  completedAt DateTime?

  // Actual values
  duration Int? // actual minutes
  distance Float? // actual km
  avgPace  String? // "5:15/km"
  avgHR    Int? // bpm
  maxHR    Int? // bpm

  // Cycling-specific power data
  avgPower        Int? // average watts
  normalizedPower Int? // normalized power (NP)
  maxPower        Int? // peak power
  avgCadence      Int? // average RPM
  elevation       Int? // total elevation gain in meters
  tss             Float? // Training Stress Score
  intensityFactor Float? // IF (NP/FTP ratio)
  powerZone       Int? // primary zone trained in

  // Subjective feedback
  perceivedEffort Int? // 1-10 RPE scale
  difficulty      Int? // 1-5 stars
  feeling         String? // "Great", "Good", "Okay", "Tired", "Struggled"
  notes           String? @db.Text

  // File uploads (Garmin .fit, Strava link, etc.)
  dataFileUrl String?
  stravaUrl   String?

  // Coach feedback
  coachFeedback String?   @db.Text
  coachViewedAt DateTime?

  workout Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  athlete User     @relation(fields: [athleteId], references: [id])
  setLogs SetLog[] // Per-set logging data for strength exercises

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workoutId])
  @@index([athleteId])
  @@index([completedAt])
  @@index([completed])
}

// ==================== PER-SET LOGGING ====================

model SetLog {
  id String @id @default(uuid())

  // Parent relationships (at least one should be set)
  workoutLogId String? // For WorkoutLog-based logging
  segmentId    String? // Link to specific segment
  assignmentId String? // For StrengthSessionAssignment-based logging

  // Exercise identification
  exerciseId String
  setNumber  Int // 1, 2, 3...

  // Core metrics
  weight        Float // kg
  repsCompleted Int
  repsTarget    Int?
  rpe           Int? // 1-10

  // VBT metrics (optional manual entry)
  meanVelocity Float? // m/s
  peakVelocity Float? // m/s
  meanPower    Float? // watts
  peakPower    Float? // watts

  // Timing
  restTaken Int? // seconds of rest taken after this set

  // Calculated fields
  estimated1RM Float? // calculated from weight/reps
  velocityZone String? // STRENGTH, POWER, SPEED based on velocity

  // Notes
  notes String? @db.Text

  completedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  // Relations
  exercise   Exercise                   @relation(fields: [exerciseId], references: [id])
  workoutLog WorkoutLog?                @relation(fields: [workoutLogId], references: [id], onDelete: Cascade)
  segment    WorkoutSegment?            @relation(fields: [segmentId], references: [id], onDelete: SetNull)
  assignment StrengthSessionAssignment? @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([workoutLogId])
  @@index([segmentId])
  @@index([assignmentId])
  @@index([exerciseId])
  @@index([completedAt])
}

// ==================== MESSAGING ====================

model Message {
  id         String @id @default(uuid())
  senderId   String
  receiverId String

  subject String?
  content String  @db.Text

  // Optional: link to specific workout
  workoutId String?

  isRead Boolean   @default(false)
  readAt DateTime?

  sender   User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  workout  Workout? @relation(fields: [workoutId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@index([workoutId])
  @@index([createdAt])
  @@index([isRead])
}

// ============================================
// TRAINING ENGINE MODELS
// Added: 2025-11-14
// Purpose: Elite training program generation with monitoring and adaptation
// ============================================

// ============================================
// ENHANCED THRESHOLD CALCULATIONS
// ============================================

/// Stores results from D-max, Mod-Dmax, and field test threshold calculations
model ThresholdCalculation {
  id         String @id @default(uuid())
  testId     String @unique
  method     String // "D-MAX", "MOD-DMAX", "OBLA", "FIELD_TEST", "SELF_REPORTED"
  confidence String // "VERY_HIGH", "HIGH", "MEDIUM", "LOW"

  // D-max specific data
  polynomialCoeffs Json? // {a: number, b: number, c: number, d: number}
  r2               Float? // Goodness of fit (require â‰¥0.90 for high confidence)
  dmaxIntensity    Float? // Intensity at D-max point
  dmaxLactate      Float? // Lactate at D-max point
  dmaxHr           Float? // Heart rate at D-max point

  // LT1 (Aerobic Threshold) data
  lt1Intensity Float // km/h, watts, or m/s
  lt1Lactate   Float // mmol/L
  lt1Hr        Float // bpm
  lt1Method    String // "BASELINE_PLUS_0.5", "HR_DRIFT", "TALK_TEST"

  // LT2 (Anaerobic Threshold) data
  lt2Intensity     Float
  lt2Lactate       Float
  lt2Hr            Float
  lt2PercentVO2max Float? // LT2 as % of VO2max (for categorization)

  // Metadata
  testDate DateTime
  notes    String?
  warnings Json? // Array of validation warnings

  test      Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([testId])
  @@index([method, confidence]) // Filter by calculation method and confidence level
  @@index([testDate]) // Sort by test date for temporal queries
}

// ============================================
// ATHLETE PROFILING & CATEGORIZATION
// ============================================

/// Central profile for each athlete with categorization and baselines
model AthleteProfile {
  id       String @id @default(uuid())
  clientId String @unique

  // Categorization (affects methodology selection)
  category           String // "BEGINNER", "RECREATIONAL", "ADVANCED", "ELITE"
  vo2maxPercentile   Float? // Percentile for age/gender
  lt2AsPercentVO2max Float? // Key categorization metric

  // VDOT-based training data (from race performance)
  currentVDOT        Float? // Most recent VDOT calculation
  vdotSource         String? // "RACE_5K", "RACE_10K", "RACE_HM", "RACE_MARATHON", "ESTIMATED"
  vdotConfidence     String? // "VERY_HIGH", "HIGH", "MEDIUM", "LOW"
  vdotLastUpdated    DateTime?
  vdotAgeAdjusted    Boolean   @default(false) // Whether age adjustment was applied
  vdotGenderAdjusted Boolean   @default(false) // Whether gender adjustment was applied

  // Lactate profile data (from lab or field tests)
  maxLactate        Float? // Maximum lactate achieved (mmol/L)
  lt2LactateRatio   Float? // LT2 as % of max lactate (individual ratio)
  lt2Speed          Float? // LT2 speed (km/h)
  lt2HeartRate      Int? // LT2 heart rate (bpm)
  lactateTestDate   DateTime? // Date of most recent lactate test
  lactateConfidence String? // "VERY_HIGH", "HIGH", "MEDIUM", "LOW"

  // Metabolic type (affects training recommendations)
  metabolicType       String? // "SLOW_TWITCH", "FAST_TWITCH_ENDURANCE", "FAST_TWITCH_POWER", "MIXED"
  metabolicTypeSource String? // "LACTATE_PROFILE", "RACE_PATTERN", "ESTIMATED"

  // Dynamic compression factor (for marathon pace calculation)
  compressionFactor Float? // MP as % of LT2 pace (0.75-0.98)
  compressionSource String? // "LEVEL_BASED", "AGE_ADJUSTED", "GENDER_ADJUSTED", "CUSTOM"

  // Complete pace zones (stored for quick access)
  danielsZones       Json? // DanielsZones object
  canovaZones        Json? // CanovaZones object
  norwegianZones     Json? // NorwegianZones object
  hrZones            Json? // HRZones object
  zonesLastUpdated   DateTime?
  zonesPrimarySource String? // "VDOT", "LACTATE_RATIO", "HR_ESTIMATION", "PROFILE_ESTIMATION"

  // Monitoring baselines (established over 14-21 days)
  hrvBaseline    Float? // RMSSD in ms
  hrvStdDev      Float? // Standard deviation for thresholds
  hrvLastUpdated DateTime?
  rhrBaseline    Float? // bpm
  rhrLastUpdated DateTime?

  // Current training zones (DEPRECATED - use specific zone fields above)
  trainingZones Json?

  // Equipment & capabilities
  hasLactateMeter Boolean @default(false)
  hasHRVMonitor   Boolean @default(false)
  hasPowerMeter   Boolean @default(false)

  // Cross-training preferences (JSON: preferredOrder, equipment, limitations, injuryOverrides)
  crossTrainingPreferences Json?

  // Training history context
  yearsRunning    Int?
  typicalWeeklyKm Float?
  longestLongRun  Float?

  // Norwegian Method tracking
  norwegianPhase Int? // Current phase (1-4) in Norwegian transition

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([category])
  @@index([hasLactateMeter, hasHRVMonitor]) // Filter athletes by monitoring capabilities
  @@index([vo2maxPercentile]) // Rank athletes by VO2max
  @@index([norwegianPhase]) // Track Norwegian Method progression
  @@index([currentVDOT]) // Rank athletes by VDOT
  @@index([metabolicType]) // Group by metabolic profile
  @@index([vdotLastUpdated]) // Find stale VDOT data
}

// ============================================
// DAILY MONITORING SYSTEM
// ============================================

/// Quick daily check-in for athletes (<2 minutes)
model DailyCheckIn {
  id       String   @id @default(uuid())
  clientId String
  date     DateTime @db.Date

  // Optional HRV/RHR (if athlete has monitors)
  hrv       Float? // RMSSD in ms
  restingHR Float? // bpm

  // Wellness questionnaire (1-10 scale, 7 questions)
  sleepQuality Int // 1=terrible, 10=perfect
  sleepHours   Float? // Actual hours slept
  soreness     Int // 1=none, 10=severe
  fatigue      Int // 1=none, 10=extreme
  stress       Int // 1=none, 10=extreme
  mood         Int // 1=terrible, 10=excellent
  motivation   Int // 1=none, 10=extremely motivated

  // Derived readiness score (0-100)
  readinessScore    Int?
  readinessDecision String? // "PROCEED", "REDUCE", "EASY", "REST"

  // Notes
  notes String?

  // Audio journal (if populated from voice input)
  audioJournal AudioJournal?

  // Rehab Compliance (Phase 7 - Physio System)
  rehabExercisesDone  Boolean @default(false) // Did athlete complete rehab exercises today?
  rehabPainDuring     Int?    // Pain during rehab exercises (0-10)
  rehabPainAfter      Int?    // Pain after rehab exercises (0-10)
  rehabNotes          String? @db.Text // Notes about rehab session
  requestPhysioContact Boolean @default(false) // Athlete requests physio contact
  physioContactReason String? @db.Text // Why the athlete wants to contact physio

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, date])
  @@index([clientId, date])
  @@index([readinessScore])
  @@index([readinessDecision])
  @@index([requestPhysioContact])
}

/// Field test schedule and reminders
model FieldTestSchedule {
  id            String   @id @default(uuid())
  clientId      String
  testType      String // "30MIN_TT", "HR_DRIFT", "CRITICAL_VELOCITY"
  scheduledDate DateTime
  required      Boolean  @default(false) // Critical tests must be completed

  completed     Boolean   @default(false)
  completedDate DateTime?
  fieldTestId   String? // Link to completed FieldTest

  // Reminders
  reminderSent Boolean   @default(false)
  reminderDate DateTime?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, scheduledDate])
  @@index([completed, scheduledDate])
  @@index([clientId, completed])
}

/// Daily metrics for athlete monitoring and readiness assessment
model DailyMetrics {
  id       String   @id @default(uuid())
  clientId String
  date     DateTime @db.Date

  // HRV data
  hrvRMSSD           Float? // Primary HRV metric (ms)
  hrvQuality         String? // "GOOD", "FAIR", "POOR"
  hrvArtifactPercent Float? // % of recording with artifacts
  hrvDuration        Float? // Duration of measurement in seconds
  hrvPosition        String? // "SUPINE", "SEATED"
  hrvStatus          String? // "EXCELLENT", "GOOD", "MODERATE", "FAIR", "POOR", "VERY_POOR"
  hrvPercent         Float? // % of baseline
  hrvTrend           String? // "IMPROVING", "STABLE", "DECLINING"

  // Resting Heart Rate
  restingHR       Float? // bpm
  restingHRDev    Float? // Deviation from baseline (bpm)
  restingHRStatus String? // Status based on deviation

  // Wellness questionnaire (1-10 scale)
  sleepQuality   Int? // 1=terrible, 10=perfect
  sleepHours     Float? // Actual hours slept
  muscleSoreness Int? // 1=none, 10=severe
  energyLevel    Int? // 1=exhausted, 10=energized
  mood           Int? // 1=terrible, 10=excellent
  stress         Int? // 1=none, 10=extreme
  injuryPain     Int? // 1=none, 10=severe

  // Derived scores
  wellnessScore  Float? // Weighted composite (0-10)
  wellnessStatus String? // "EXCELLENT" to "VERY_POOR"

  // Composite readiness
  readinessScore    Float? // 0-10 weighted composite
  readinessLevel    String? // "EXCELLENT", "GOOD", "MODERATE", "FAIR", "POOR", "VERY_POOR"
  recommendedAction String? // "PROCEED", "MODIFY_LIGHT", "MODIFY_MODERATE", "MODIFY_SIGNIFICANT", "REST_REQUIRED"

  // Detailed breakdown
  factorScores Json? // Factor contributions
  redFlags     Json? // Critical issues
  yellowFlags  Json? // Warnings

  // Notes
  athleteNotes String?
  coachNotes   String?

  // Injury details (when injuryPain >= 3)
  injuryBodyPart     String? // Body part selected: KNEE, LOWER_LEG, etc.
  injurySpecificType String? // Specific injury type: PATELLOFEMORAL, SHIN_SPLINTS, etc.
  injurySide         String? // LEFT, RIGHT, BOTH, NA
  isIllness          Boolean @default(false) // True if reporting illness vs injury
  illnessType        String? // FEVER, GASTROINTESTINAL, COLD, HEADACHE, GENERAL_ILLNESS

  // Keyword analysis from notes
  detectedKeywords Json? // Array of detected keywords with categories
  keywordBodyPart  String? // Body part detected from notes
  keywordSeverity  String? // Severity level from keywords: LOW, MEDIUM, HIGH
  keywordSummary   String? // Human-readable summary for coach

  // Rehab Compliance (Phase 7 - Physio System)
  rehabExercisesDone   Boolean @default(false) // Did athlete complete rehab exercises today?
  rehabPainDuring      Int?    // Pain during rehab exercises (0-10)
  rehabPainAfter       Int?    // Pain after rehab exercises (0-10)
  rehabNotes           String? @db.Text // Notes about rehab session
  requestPhysioContact Boolean @default(false) // Athlete requests physio contact
  physioContactReason  String? @db.Text // Why the athlete wants to contact physio

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, date])
  @@index([clientId, date])
  @@index([clientId, readinessScore]) // Filter athletes by readiness score
  @@index([clientId, readinessLevel]) // Filter by readiness level categories
  @@index([date, readinessLevel]) // Daily readiness overview across all athletes
  @@index([requestPhysioContact]) // Filter by physio contact requests
}

// ============================================
// TRAINING LOAD & ACWR TRACKING
// ============================================

/// Daily training load with ACWR calculation using EWMA method
model TrainingLoad {
  id       String   @id @default(uuid())
  clientId String
  date     DateTime @db.Date

  // Daily training load
  dailyLoad Float // TSS or TRIMP value
  loadType  String // "TSS", "TRIMP_EDWARDS", "TRIMP_BANISTER", "TRIMP_LUCIA"

  // ACWR calculations
  acuteLoad   Float? // 7-day EWMA
  chronicLoad Float? // 28-day EWMA
  acwr        Float? // Acute:Chronic ratio
  acwrZone    String? // "DETRAINING", "OPTIMAL", "CAUTION", "DANGER", "CRITICAL"
  injuryRisk  String? // "LOW", "MODERATE", "HIGH", "VERY_HIGH"

  // Session details
  duration  Float // minutes
  distance  Float? // km
  avgHR     Float? // bpm
  maxHR     Float? // bpm
  avgPace   Float? // sec/km
  intensity String // "RECOVERY", "EASY", "MODERATE", "HARD", "VERY_HARD"

  // Session type
  workoutType String? // "EASY", "LONG", "THRESHOLD", "INTERVALS", "TEMPO", "RECOVERY", "RACE"
  workoutId   String? // Link to planned workout

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([clientId, date])
  @@index([clientId, acwrZone]) // Filter by ACWR risk zone
  @@index([clientId, injuryRisk]) // Filter by injury risk level
}

// ============================================
// TRAINING SUMMARIES (Weekly & Monthly Aggregation)
// ============================================

/// Weekly aggregated training data for efficient trend analysis
model WeeklyTrainingSummary {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation("ClientWeeklySummaries", fields: [clientId], references: [id], onDelete: Cascade)

  // Week identification
  weekStart  DateTime @db.Date // Monday of the week
  weekEnd    DateTime @db.Date // Sunday of the week
  weekNumber Int // ISO week number (1-53)
  year       Int

  // Volume metrics
  totalTSS      Float @default(0)
  totalDistance Float @default(0) // km
  totalDuration Int   @default(0) // minutes
  totalCalories Int?

  // Workout counts
  workoutCount          Int    @default(0)
  plannedWorkoutCount   Int? // From program
  completedWorkoutCount Int? // Actual completed
  compliancePercent     Float? // completed/planned * 100

  // Breakdown by type (JSON maps)
  workoutsByType Json @default("{}") // { "RUNNING": 3, "STRENGTH": 2 }
  tssByType      Json @default("{}") // { "RUNNING": 450, "STRENGTH": 120 }
  distanceByType Json @default("{}") // { "RUNNING": 42.5, "CYCLING": 80 }
  durationByType Json @default("{}") // { "RUNNING": 240, "STRENGTH": 90 }

  // Intensity distribution (for 80/20 tracking)
  easyMinutes       Int    @default(0) // Zone 1-2
  moderateMinutes   Int    @default(0) // Zone 3
  hardMinutes       Int    @default(0) // Zone 4-5
  polarizationRatio Float? // easy% vs hard% (target: 80/20)

  // 5-Zone HR distribution (more granular than easy/moderate/hard)
  zone1Minutes Int @default(0) // Recovery zone
  zone2Minutes Int @default(0) // Aerobic base zone
  zone3Minutes Int @default(0) // Tempo zone
  zone4Minutes Int @default(0) // Threshold zone
  zone5Minutes Int @default(0) // VO2max zone

  // Load management
  avgDailyTSS   Float?
  peakDailyTSS  Float?
  acwrAtWeekEnd Float? // ACWR snapshot at end of week
  acwrZone      String? // OPTIMAL, CAUTION, DANGER

  // Readiness & wellness (weekly averages)
  avgReadiness    Float?
  avgSleepHours   Float?
  avgSleepQuality Float?
  avgFatigue      Float?
  avgSoreness     Float?

  // Strength training (if applicable)
  strengthSets   Int?
  strengthVolume Float? // Total tonnage (sets * reps * weight)

  // Data sources (for transparency)
  stravaActivities Int @default(0)
  garminActivities Int @default(0)
  manualActivities Int @default(0)
  programWorkouts  Int @default(0)

  // Timestamps
  calculatedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([clientId, weekStart])
  @@index([clientId, year])
  @@index([weekStart])
}

/// Monthly aggregated training data for long-term trend analysis
model MonthlyTrainingSummary {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation("ClientMonthlySummaries", fields: [clientId], references: [id], onDelete: Cascade)

  // Month identification
  month      Int // 1-12
  year       Int
  monthStart DateTime @db.Date
  monthEnd   DateTime @db.Date

  // Aggregated totals
  totalTSS      Float @default(0)
  totalDistance Float @default(0) // km
  totalDuration Int   @default(0) // minutes
  totalCalories Int?
  workoutCount  Int   @default(0)

  // Weekly averages
  avgWeeklyTSS      Float?
  avgWeeklyDistance Float?
  avgWeeklyDuration Float?
  avgWeeklyWorkouts Float?

  // Breakdown by type
  workoutsByType Json @default("{}")
  tssByType      Json @default("{}")

  // Intensity distribution
  avgPolarizationRatio Float?
  totalEasyMinutes     Int    @default(0)
  totalHardMinutes     Int    @default(0)

  // Load progression
  avgACWR          Float?
  peakACWR         Float?
  daysInDangerZone Int    @default(0)

  // Compliance
  avgCompliancePercent Float?

  // Readiness trends
  avgReadiness   Float?
  readinessTrend String? // IMPROVING, STABLE, DECLINING

  // Comparison to previous month
  tssChangePercent      Float?
  distanceChangePercent Float?

  // Timestamps
  calculatedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([clientId, month, year])
  @@index([clientId, year])
}

/// HR Zone distribution per activity (from Strava streams or Garmin zones)
model ActivityHRZoneDistribution {
  id String @id @default(uuid())

  // Link to source activity (one or the other, not both)
  stravaActivityId String? @unique
  garminActivityId String? @unique

  // Zone time distribution (seconds in each zone)
  zone1Seconds Int @default(0) // Recovery zone
  zone2Seconds Int @default(0) // Aerobic base
  zone3Seconds Int @default(0) // Tempo
  zone4Seconds Int @default(0) // Threshold
  zone5Seconds Int @default(0) // VO2max

  // Total tracked time (should equal sum of zones)
  totalTrackedSeconds Int @default(0)

  // Source metadata
  zoneSource   String // 'STRAVA_STREAM' | 'GARMIN_ZONES' | 'ESTIMATED'
  zoneConfig   Json // Snapshot of zone thresholds used: { zone1: {hrMin, hrMax}, ... }
  calculatedAt DateTime @default(now())

  // Relations
  stravaActivity StravaActivity? @relation(fields: [stravaActivityId], references: [id], onDelete: Cascade)
  garminActivity GarminActivity? @relation(fields: [garminActivityId], references: [id], onDelete: Cascade)
}

/// Yearly aggregated training summary for annual tracking
model YearlySummary {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation("ClientYearlySummaries", fields: [clientId], references: [id], onDelete: Cascade)

  year Int

  // Volume totals
  totalTSS      Float @default(0)
  totalDistance Float @default(0) // km
  totalDuration Int   @default(0) // minutes
  totalCalories Int?
  workoutCount  Int   @default(0)

  // 5-Zone distribution (minutes)
  zone1Minutes Int @default(0)
  zone2Minutes Int @default(0)
  zone3Minutes Int @default(0)
  zone4Minutes Int @default(0)
  zone5Minutes Int @default(0)

  // Monthly breakdown for charts (JSON arrays)
  monthlyHours            Json @default("[]") // [jan, feb, ..., dec] in hours
  monthlyZoneDistribution Json @default("[]") // [{z1, z2, z3, z4, z5}, ...] per month

  // Breakdown by type
  workoutsByType Json @default("{}")
  hoursByType    Json @default("{}") // { "RUNNING": 450, "CYCLING": 200 }

  // Polarization metrics
  avgPolarizationRatio Float? // Average (zone1+zone2) / total %

  // Timestamps
  calculatedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([clientId, year])
  @@index([clientId])
}

// ============================================
// ENHANCED TRAINING PROGRAMS
// ============================================

/// Complete training program with periodization and methodology
model TrainingProgramEngine {
  id       String @id @default(uuid())
  clientId String

  // Core settings
  name        String
  methodology String // "POLARIZED", "NORWEGIAN", "CANOVA", "PYRAMIDAL", "LYDIARD"
  status      String @default("DRAFT") // "DRAFT", "ACTIVE", "COMPLETED", "PAUSED", "ARCHIVED"

  // Timeline
  startDate    DateTime
  endDate      DateTime
  totalWeeks   Int
  currentWeek  Int      @default(1)
  currentPhase String? // "BASE", "BUILD", "PEAK", "TAPER", "RECOVERY"

  // Goals
  targetRaceDate DateTime?
  targetDistance String? // "5K", "10K", "HALF", "MARATHON", "ULTRA"
  targetTime     String? // HH:MM:SS

  // Program structure (JSON for flexibility)
  periodization Json
  weeklyPlans   Json

  // Methodology-specific settings
  methodologyConfig Json?

  // Generation metadata
  generatedBy   String // "COACH" or "AUTO"
  generatedFrom Json? // {testId, fieldTestId, thresholdData}

  // Tracking
  completedWeeks   Int @default(0)
  missedWorkouts   Int @default(0)
  modifiedWorkouts Int @default(0)

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, status])
  @@index([clientId, startDate, endDate])
  @@index([methodology, status]) // Filter programs by training methodology
  @@index([currentPhase]) // Track athletes in specific training phases
}

// ============================================
// WORKOUT MODIFICATIONS
// ============================================

/// Tracks automatic and manual workout modifications
model WorkoutModification {
  id        String   @id @default(uuid())
  workoutId String
  date      DateTime @default(now())

  // Decision
  decision      String // "PROCEED", "MINOR_MODIFICATION", "MODERATE_MODIFICATION", "MAJOR_MODIFICATION", "CANCEL"
  autoGenerated Boolean @default(true)

  // Original plan
  plannedType      String
  plannedDuration  Float // minutes
  plannedDistance  Float? // km
  plannedIntensity String
  plannedDetails   Json?

  // Modified plan
  modifiedType      String?
  modifiedDuration  Float?
  modifiedDistance  Float?
  modifiedIntensity String?
  modifiedDetails   Json?

  // Reasoning
  readinessScore Float?
  factors        Json // Array of {factor, weight, contribution, status}
  reasoning      String // Human-readable explanation
  methodology    String? // Methodology-specific guidance

  // References
  dailyMetricsId String?
  acwr           Float?

  createdAt DateTime @default(now())

  @@index([workoutId])
  @@index([date])
  @@index([decision])
  @@index([workoutId, date]) // Temporal workout modification history
  @@index([autoGenerated, decision]) // Filter manual vs automatic modifications
}

// ============================================
// FIELD TESTS
// ============================================

/// Results from field tests (alternative to lab testing)
model FieldTest {
  id       String   @id @default(uuid())
  clientId String
  testType String // "30MIN_TT", "20MIN_TT", "HR_DRIFT", "CRITICAL_VELOCITY", "TALK_TEST", "RACE_BASED"
  date     DateTime

  // Test conditions
  conditions Json? // {temperature, humidity, wind, terrain}

  // Raw results (JSON for flexibility across test types)
  results Json

  // Derived thresholds
  lt1Pace    Float? // sec/km
  lt1HR      Float? // bpm
  lt2Pace    Float? // sec/km
  lt2HR      Float? // bpm
  confidence String? // "VERY_HIGH", "HIGH", "MEDIUM", "LOW"

  // Validation
  valid    Boolean @default(true)
  warnings Json?
  errors   Json?

  notes String?

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([clientId, date])
  @@index([testType, date])
  @@index([clientId, testType, date]) // Composite index for test type filtering
  @@index([confidence, valid]) // Filter high-confidence valid tests
}

// ============================================
// SELF-REPORTED LACTATE MEASUREMENTS
// ============================================

/// Athletes can track their own lactate measurements between lab tests
model SelfReportedLactate {
  id       String   @id @default(uuid())
  clientId String
  date     DateTime

  // Measurement context
  measurementType String // "WORKOUT", "RACE", "STANDALONE_TEST"
  workoutType     String? // "EASY", "TEMPO", "THRESHOLD", "INTERVALS", "LONG"

  // Single measurement data
  intensity Float? // km/h, watts, or pace
  lactate   Float? // mmol/L
  heartRate Float? // bpm
  rpe       Int? // 1-10 scale

  // Multi-stage test data
  measurements Json? // [{stage, intensity, lactate, heartRate, rpe}]

  // Equipment & quality
  meterBrand    String? // "Lactate Plus", "Lactate Scout", etc.
  calibrated    Boolean @default(false)
  qualityRating String? // "GOOD", "FAIR", "POOR"

  // Derived insights
  estimatedLT1 Float?
  estimatedLT2 Float?
  confidence   String? // "LOW", "MEDIUM", "HIGH"

  // Context
  workoutId String?
  notes     String?
  photos    Json? // Array of photo URLs

  // Validation status
  validated       Boolean   @default(false)
  validatedBy     String? // Coach userId
  validatedAt     DateTime?
  validationNotes String?

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, date])
  @@index([clientId, measurementType])
  @@index([validated])
  @@index([validated, clientId]) // Coach validation workflow - pending validations
  @@index([validatedBy, validatedAt]) // Track coach validation activity
}

// ============================================
// RACE CALENDAR & MULTI-RACE PLANNING
// ============================================

/// Season-level race planning with A/B/C classification
model RaceCalendar {
  id         String   @id @default(uuid())
  clientId   String
  seasonName String // "Spring 2025", "Fall Marathon Build"
  startDate  DateTime
  endDate    DateTime

  races Race[]

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
}

/// Individual race with classification, goals, and results
model Race {
  id         String @id @default(uuid())
  calendarId String
  clientId   String

  // Race details
  name           String
  date           DateTime
  distance       String // "5K", "10K", "HALF", "MARATHON"
  classification String // "A", "B", "C"
  priority       Int      @default(1)

  // Goals
  targetTime String? // HH:MM:SS
  targetPace Float? // sec/km

  // Preparation
  taperWeeks      Int?
  lastQualityDate DateTime?

  // Results
  actualTime String?
  actualPace Float?
  place      Int?
  avgHR      Float?
  maxHR      Float?
  splits     Json?
  conditions Json?

  // Analysis
  vdot        Float?
  equivalents Json?
  assessment  String? // "EXCEEDED", "MET", "CLOSE", "MISSED"

  notes  String?
  photos Json?

  calendar  RaceCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  client    Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([clientId, date])
  @@index([classification, date])
}

// ============================================
// INJURY MANAGEMENT SYSTEM
// ============================================

/// Injury assessment and pain tracking (University of Delaware Soreness Rules)
model InjuryAssessment {
  id           String   @id @default(uuid())
  clientId     String
  assessedById String?  // User who created the assessment
  date         DateTime @default(now())
  detectedAt   DateTime @default(now()) // Timestamp of injury detection

  // Injury classification
  bodyPart    String?  // "KNEE", "ANKLE", "SHOULDER", etc.
  side        String?  // "LEFT", "RIGHT", "BILATERAL", "CENTRAL"
  mechanism   String?  // How the injury occurred
  description String?  // Detailed description

  // Pain assessment (0-10 scale)
  painLevel    Int // 0=none, 10=severe
  painLocation String? // "PLANTAR_FASCIA", "ACHILLES", "IT_BAND", etc.
  painTiming   String? // "DURING_WARMUP", "DURING_WORKOUT", etc.
  gaitAffected Boolean @default(false) // RED FLAG if true

  // Soreness rules assessment
  painDuringWarmup          Boolean @default(false)
  painContinuesThroughout   Boolean @default(false)
  painDisappearsAfterWarmup Boolean @default(false)
  painRedevelopsLater       Boolean @default(false)
  painPersists1HourPost     Boolean @default(false)

  // Delaware pain rule
  delawarePainRuleTriggered Boolean @default(false)
  delawareRule              String? // Which Delaware rule was triggered

  // Functional assessment
  rangeOfMotion        String?  // "NORMAL", "SLIGHTLY_LIMITED", etc.
  swelling             Boolean  @default(false)
  discoloration        Boolean  @default(false)
  weightBearing        String?  // "NORMAL", "SLIGHTLY_AFFECTED", "LIMPING", "UNABLE"
  functionalLimitations Json?   // Array of functional limitations
  redFlags              Json?   // Array of red flag indicators

  // Assessment result
  assessment String? // "CONTINUE", "MODIFY", "REST_1_DAY", etc.
  status     String  @default("ACTIVE") // "ACTIVE", "MONITORING", "RESOLVED"
  injuryType String?
  phase      String? // "ACUTE", "SUBACUTE", "CHRONIC", "RECOVERY"

  // Protocol recommendations
  recommendedProtocol Json?
  estimatedTimeOff    String?

  // Follow-up
  resolved     Boolean   @default(false)
  resolvedDate DateTime?
  notes        String?

  client     Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  assessedBy User?  @relation("AssessedInjuries", fields: [assessedById], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([clientId, date])
  @@index([painLevel, gaitAffected])
  @@index([clientId, resolved]) // Track active vs resolved injuries
  @@index([injuryType, phase]) // Track injury types and phases across athletes
  @@index([clientId, injuryType, resolved]) // Track specific injury resolution

  // Relations to physio system
  treatmentSessions TreatmentSession[]
  trainingRestrictions TrainingRestriction[]
  rehabPrograms     RehabProgram[]
  acuteInjuryReports AcuteInjuryReport[]
  careTeamThreads   CareTeamThread[] @relation("InjuryCareTeamThreads")
}

// ============================================
// PHYSIOTHERAPIST SYSTEM
// Added: 2025-01
// Purpose: Injury management, rehabilitation, and care team communication
// ============================================

/// Treatment type for physiotherapy sessions
enum TreatmentType {
  ASSESSMENT          // Initial or follow-up assessment
  MANUAL_THERAPY      // Hands-on treatment (massage, mobilization)
  DRY_NEEDLING        // Acupuncture/dry needling
  EXERCISE_THERAPY    // Supervised exercise session
  ELECTROTHERAPY      // TENS, ultrasound, etc.
  TAPING              // Kinesio or rigid taping
  EDUCATION           // Patient education session
  DISCHARGE           // Final session/discharge
  OTHER               // Other treatment type
}

/// Physio assignment role type
enum PhysioAssignmentRole {
  PRIMARY             // Primary physiotherapist
  SECONDARY           // Secondary/backup physiotherapist
  CONSULTANT          // Consulting physiotherapist
}

/// Rehabilitation phase
enum RehabPhase {
  ACUTE               // 0-7 days post-injury, focus on protection
  SUBACUTE            // 7-21 days, controlled loading begins
  REMODELING          // 3-12 weeks, progressive loading
  FUNCTIONAL          // 12+ weeks, sport-specific training
  RETURN_TO_SPORT     // Final phase, full activity clearance
}

/// Training restriction type
enum RestrictionType {
  NO_RUNNING          // No running allowed
  NO_JUMPING          // No jumping/plyometrics
  NO_IMPACT           // No high-impact activities
  NO_UPPER_BODY       // No upper body exercises
  NO_LOWER_BODY       // No lower body exercises
  REDUCED_VOLUME      // Reduce training volume by percentage
  REDUCED_INTENSITY   // Cap intensity (e.g., no Zone 4-5)
  MODIFIED_ONLY       // Only modified exercises allowed
  SPECIFIC_EXERCISES  // Block specific exercises only
  CUSTOM              // Custom restriction
}

/// Restriction severity level
enum RestrictionSeverity {
  MILD                // Minor modification needed
  MODERATE            // Significant modification needed
  SEVERE              // Major restriction on activity
  COMPLETE            // No activity allowed
}

/// Source of the restriction
enum RestrictionSource {
  INJURY_CASCADE      // Auto-created from injury check-in
  PHYSIO_MANUAL       // Manually set by physiotherapist
  COACH_MANUAL        // Manually set by coach
  SYSTEM_AUTO         // System-generated (e.g., ACWR)
}

/// Injury mechanism for acute reports
enum InjuryMechanism {
  CONTACT             // Contact injury (collision)
  NON_CONTACT         // Non-contact injury (twist, sudden movement)
  OVERUSE             // Gradual onset from overuse
  UNKNOWN             // Unknown mechanism
}

/// Urgency level for acute injuries
enum InjuryUrgency {
  EMERGENCY           // Requires immediate medical attention
  URGENT              // Needs same-day assessment
  MODERATE            // Needs assessment within 24-48h
  LOW                 // Can wait for scheduled appointment
}

/// Care team thread status
enum CareTeamThreadStatus {
  OPEN                // Active discussion
  RESOLVED            // Issue resolved
  ARCHIVED            // Archived for reference
}

/// Care team thread priority
enum CareTeamThreadPriority {
  URGENT              // Requires immediate attention
  HIGH                // High priority
  NORMAL              // Normal priority
  LOW                 // Low priority
}

/// Movement screen type
enum MovementScreenType {
  FMS                 // Functional Movement Screen
  SFMA                // Selective Functional Movement Assessment
  Y_BALANCE           // Y-Balance Test
  CUSTOM              // Custom screening protocol
}

/// Physio assignment - links physiotherapists to athletes/teams/organizations
model PhysioAssignment {
  id      String @id @default(uuid())
  physioUserId String // User with PHYSIO role

  // Scope (one of these should be set)
  clientId       String?   // Individual athlete assignment
  teamId         String?   // Entire team assignment
  organizationId String?   // All teams in organization
  businessId     String?   // All athletes in business (enterprise)
  locationId     String?   // All athletes at specific location

  // Role and permissions
  role PhysioAssignmentRole @default(PRIMARY)
  canModifyPrograms     Boolean @default(false) // Can modify training programs
  canCreateRestrictions Boolean @default(true)  // Can create training restrictions
  canViewFullHistory    Boolean @default(true)  // Can view full injury/medical history

  // Status
  isActive Boolean @default(true)
  startDate DateTime @default(now())
  endDate   DateTime?

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  physio       User          @relation("PhysioAssignments", fields: [physioUserId], references: [id], onDelete: Cascade)
  client       Client?       @relation("ClientPhysioAssignments", fields: [clientId], references: [id], onDelete: Cascade)
  team         Team?         @relation("TeamPhysioAssignments", fields: [teamId], references: [id], onDelete: Cascade)
  organization Organization? @relation("OrgPhysioAssignments", fields: [organizationId], references: [id], onDelete: Cascade)
  business     Business?     @relation("BusinessPhysioAssignments", fields: [businessId], references: [id], onDelete: Cascade)
  location     Location?     @relation("LocationPhysioAssignments", fields: [locationId], references: [id], onDelete: Cascade)

  @@index([physioUserId])
  @@index([clientId])
  @@index([teamId])
  @@index([organizationId])
  @@index([businessId])
  @@index([locationId])
  @@index([isActive])
}

/// Treatment session with SOAP notes format
model TreatmentSession {
  id          String        @id @default(uuid())
  physioUserId String       // Treating physiotherapist
  clientId    String        // Athlete being treated
  injuryId    String?       // Link to InjuryAssessment if applicable

  sessionDate DateTime @default(now())
  duration    Int?     // Session duration in minutes
  treatmentType TreatmentType

  // SOAP Notes format
  subjective  String? @db.Text // Patient's symptoms, history, complaints
  objective   String? @db.Text // Measurable/observable findings
  assessment  String? @db.Text // Clinical reasoning/diagnosis
  plan        String? @db.Text // Treatment plan going forward

  // Pain tracking (0-10 scale)
  painBefore  Int?
  painAfter   Int?

  // Range of Motion measurements (JSON for flexibility)
  romMeasurements Json? // { "shoulderFlexion": { "left": 170, "right": 165 }, ... }

  // Treatment modalities used
  modalitiesUsed String[] @default([]) // Array of treatment modalities applied

  // Follow-up
  followUpRequired Boolean @default(false)
  followUpDate     DateTime?
  followUpNotes    String?

  // Billing/admin
  isBillable Boolean @default(true)
  billingCode String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  physio User              @relation("PhysioTreatmentSessions", fields: [physioUserId], references: [id])
  client Client            @relation("ClientTreatmentSessions", fields: [clientId], references: [id], onDelete: Cascade)
  injury InjuryAssessment? @relation(fields: [injuryId], references: [id], onDelete: SetNull)

  @@index([physioUserId])
  @@index([clientId])
  @@index([injuryId])
  @@index([sessionDate])
  @@index([treatmentType])
}

/// Rehabilitation program with phases and milestones
model RehabProgram {
  id          String @id @default(uuid())
  physioUserId String // Creating physiotherapist
  clientId    String
  injuryId    String? // Link to InjuryAssessment

  name        String
  description String? @db.Text

  // Phase management
  currentPhase RehabPhase @default(ACUTE)
  phaseStartDate DateTime @default(now())

  // Timeline
  startDate     DateTime @default(now())
  estimatedEndDate DateTime?
  actualEndDate DateTime?

  // Goals
  shortTermGoals String[] @default([]) // Goals for current phase
  longTermGoals  String[] @default([]) // Final outcome goals

  // Contraindications and precautions
  contraindications String[] @default([]) // Movements/activities to avoid
  precautions       String[] @default([]) // Cautions to observe

  // Pain thresholds
  acceptablePainDuring Int @default(3)  // Max pain during exercise (0-10)
  acceptablePainAfter  Int @default(5)  // Max pain allowed 24h post (0-10)

  // Status
  status String @default("ACTIVE") // ACTIVE, PAUSED, COMPLETED, DISCONTINUED

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  physio     User                @relation("PhysioRehabPrograms", fields: [physioUserId], references: [id])
  client     Client              @relation("ClientRehabPrograms", fields: [clientId], references: [id], onDelete: Cascade)
  injury     InjuryAssessment?   @relation(fields: [injuryId], references: [id], onDelete: SetNull)
  exercises  RehabExercise[]
  milestones RehabMilestone[]
  progressLogs RehabProgressLog[]
  careTeamThreads CareTeamThread[] @relation("RehabProgramCareTeamThreads")

  @@index([physioUserId])
  @@index([clientId])
  @@index([injuryId])
  @@index([status])
  @@index([currentPhase])
}

/// Exercise prescription within a rehab program
model RehabExercise {
  id        String @id @default(uuid())
  programId String
  exerciseId String // Link to Exercise library

  // Prescription
  sets      Int?
  reps      String? // "10-12", "AMRAP", "30 sec hold"
  duration  Int?    // Duration in seconds (for timed exercises)
  frequency String? // "Daily", "3x/week", "Every other day"
  intensity String? // "Light", "Moderate", "As tolerated"

  // Progression criteria
  progressionCriteria String? @db.Text // When to progress to next level
  regressionCriteria  String? @db.Text // When to regress

  // Phase applicability
  phases RehabPhase[] @default([]) // Which phases this exercise applies to

  // Order within program
  order Int @default(0)

  // Notes
  notes String? @db.Text
  cuePoints String[] @default([]) // Key coaching cues

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  program  RehabProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  exercise Exercise     @relation("RehabExerciseRef", fields: [exerciseId], references: [id])

  @@index([programId])
  @@index([exerciseId])
  @@index([isActive])
}

/// Milestones for tracking rehab progress
model RehabMilestone {
  id        String @id @default(uuid())
  programId String

  name        String
  description String? @db.Text

  // Criteria for achievement
  criteria    String? @db.Text // Description of what needs to be achieved
  criteriaJson Json?  // Structured criteria: { "painLevel": "<=2", "romFlexion": ">=160" }

  // Phase association
  phase RehabPhase

  // Target and actual dates
  targetDate   DateTime?
  achievedDate DateTime?

  // Status
  isAchieved Boolean @default(false)
  notes      String? @db.Text

  order Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  program RehabProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([programId])
  @@index([phase])
  @@index([isAchieved])
}

/// Progress log for athlete rehab exercise completion
model RehabProgressLog {
  id        String @id @default(uuid())
  programId String
  clientId  String

  date DateTime @default(now())

  // Completion
  exercisesCompleted String[] @default([]) // Array of exercise IDs completed
  completionPercent  Float?   // Overall completion percentage

  // Pain tracking
  painDuring Int? // Pain during exercises (0-10)
  painAfter  Int? // Pain 24h after (0-10)

  // Self-assessment
  difficultyRating Int?    // 1-5 how difficult was it
  notes            String? @db.Text

  // Physio review
  physioReviewed   Boolean   @default(false)
  physioNotes      String?   @db.Text
  physioReviewedAt DateTime?
  physioReviewedBy String?   // Physio userId who reviewed

  createdAt DateTime @default(now())

  // Relations
  program RehabProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  client  Client       @relation("ClientRehabProgressLogs", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([programId])
  @@index([clientId])
  @@index([date])
  @@index([physioReviewed])
}

/// Training restrictions applied to athletes
model TrainingRestriction {
  id           String @id @default(uuid())
  clientId     String
  createdById  String // Physio or Coach who created it
  injuryId     String? // Link to InjuryAssessment if applicable

  // Restriction details
  type     RestrictionType
  severity RestrictionSeverity @default(MODERATE)
  source   RestrictionSource   @default(PHYSIO_MANUAL)

  // Affected areas
  bodyParts String[] @default([]) // Affected body parts
  affectedWorkoutTypes String[] @default([]) // Workout types affected (RUNNING, STRENGTH, etc.)
  affectedExerciseIds  String[] @default([]) // Specific exercises blocked

  // Duration
  startDate DateTime @default(now())
  endDate   DateTime? // null = indefinite until cleared

  // For volume/intensity restrictions
  volumeReductionPercent   Int? // e.g., 50 = reduce volume by 50%
  maxIntensityZone         Int? // e.g., 3 = no Zone 4-5 work

  // Description
  description String? @db.Text
  reason      String? // Brief reason for restriction

  // Status
  isActive    Boolean   @default(true)
  clearedAt   DateTime?
  clearedById String?   // Who cleared the restriction

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client    Client            @relation("ClientTrainingRestrictions", fields: [clientId], references: [id], onDelete: Cascade)
  createdBy User              @relation("UserCreatedRestrictions", fields: [createdById], references: [id])
  injury    InjuryAssessment? @relation(fields: [injuryId], references: [id], onDelete: SetNull)
  careTeamThreads CareTeamThread[] @relation("RestrictionCareTeamThreads")

  @@index([clientId])
  @@index([createdById])
  @@index([injuryId])
  @@index([isActive])
  @@index([type])
  @@index([endDate])
}

/// Movement screening assessments
model MovementScreen {
  id           String @id @default(uuid())
  physioUserId String
  clientId     String

  screenDate DateTime @default(now())
  screenType MovementScreenType

  // Results (flexible JSON structure for different screen types)
  results Json // { "deepSquat": 2, "hurdleStep": { "left": 2, "right": 3 }, ... }

  // Scores
  totalScore    Int?   // Overall score if applicable
  asymmetryFlag Boolean @default(false) // Any significant L/R asymmetries

  // Comparison
  previousScreenId String? // Link to previous screen for comparison
  improvement      String? // IMPROVED, STABLE, DECLINED

  // Recommendations
  recommendations String[] @default([]) // Exercise/intervention recommendations
  priorityAreas   String[] @default([]) // Areas needing attention

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  physio User   @relation("PhysioMovementScreens", fields: [physioUserId], references: [id])
  client Client @relation("ClientMovementScreens", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([physioUserId])
  @@index([clientId])
  @@index([screenDate])
  @@index([screenType])
}

/// Acute injury reports for match-day injuries
model AcuteInjuryReport {
  id         String @id @default(uuid())
  reporterId String // Who reported (coach, physio, or athlete)
  clientId   String
  injuryId   String? // Link to created InjuryAssessment

  reportDate  DateTime @default(now())
  incidentDate DateTime // When injury occurred
  incidentTime String?  // Time of incident

  // Injury details
  mechanism   InjuryMechanism
  bodyPart    String          // Primary body part affected
  side        String?         // LEFT, RIGHT, BOTH, N/A
  description String?         @db.Text // Description of what happened

  // Urgency and severity
  urgency         InjuryUrgency @default(MODERATE)
  initialSeverity Int           @default(5) // 1-10 scale

  // Context
  activityType String?  // "MATCH", "TRAINING", "WARMUP", etc.
  surfaceType  String?  // "GRASS", "INDOOR", "ARTIFICIAL", etc.
  equipmentInvolved String? // Any equipment involved

  // Immediate care
  immediateCareGiven String? @db.Text // What first aid was provided
  iceApplied        Boolean @default(false)
  removedFromPlay   Boolean @default(false)
  ambulanceCalled   Boolean @default(false)

  // Referral
  referralNeeded  Boolean @default(false)
  referralType    String? // "HOSPITAL", "IMAGING", "SPECIALIST"
  referralUrgency String? // "IMMEDIATE", "SAME_DAY", "WITHIN_WEEK"

  // Follow-up
  physioNotified    Boolean   @default(false)
  physioNotifiedAt  DateTime?
  coachNotified     Boolean   @default(false)
  coachNotifiedAt   DateTime?
  followUpScheduled DateTime?

  // Status
  status String @default("PENDING_REVIEW") // PENDING_REVIEW, REVIEWED, ASSESSED, CLOSED

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  reporter User              @relation("UserAcuteInjuryReports", fields: [reporterId], references: [id])
  client   Client            @relation("ClientAcuteInjuryReports", fields: [clientId], references: [id], onDelete: Cascade)
  injury   InjuryAssessment? @relation(fields: [injuryId], references: [id], onDelete: SetNull)

  @@index([reporterId])
  @@index([clientId])
  @@index([injuryId])
  @@index([reportDate])
  @@index([urgency])
  @@index([status])
}

/// Care team communication thread
model CareTeamThread {
  id       String @id @default(uuid())
  clientId String // Athlete being discussed
  createdById String // Who created the thread

  // Context
  subject     String
  description String? @db.Text

  // Linked items (optional context)
  injuryId      String? // Link to injury being discussed
  rehabProgramId String? // Link to rehab program
  restrictionId String? // Link to restriction

  // Status
  status   CareTeamThreadStatus   @default(OPEN)
  priority CareTeamThreadPriority @default(NORMAL)

  // Timestamps
  lastMessageAt DateTime?
  resolvedAt    DateTime?
  resolvedById  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client      Client              @relation("ClientCareTeamThreads", fields: [clientId], references: [id], onDelete: Cascade)
  createdBy   User                @relation("UserCreatedCareTeamThreads", fields: [createdById], references: [id])
  injury      InjuryAssessment?   @relation("InjuryCareTeamThreads", fields: [injuryId], references: [id])
  rehabProgram RehabProgram?      @relation("RehabProgramCareTeamThreads", fields: [rehabProgramId], references: [id])
  restriction TrainingRestriction? @relation("RestrictionCareTeamThreads", fields: [restrictionId], references: [id])
  messages    CareTeamMessage[]
  participants CareTeamParticipant[]

  @@index([clientId])
  @@index([createdById])
  @@index([injuryId])
  @@index([rehabProgramId])
  @@index([restrictionId])
  @@index([status])
  @@index([priority])
  @@index([lastMessageAt])
}

/// Messages within care team threads
model CareTeamMessage {
  id       String @id @default(uuid())
  threadId String
  senderId String

  content String @db.Text

  // Mentions
  mentionedUserIds String[] @default([]) // Users @mentioned in message

  // Attachments
  attachments Json? // Array of { url, name, type }

  // Read tracking
  readByUserIds String[] @default([]) // Users who have read this message

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  thread CareTeamThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender User           @relation("UserCareTeamMessages", fields: [senderId], references: [id])

  @@index([threadId])
  @@index([senderId])
  @@index([createdAt])
}

/// Participants in care team threads
model CareTeamParticipant {
  id       String @id @default(uuid())
  threadId String
  userId   String

  // Role in thread
  role String @default("PARTICIPANT") // OWNER, PHYSIO, COACH, ATHLETE

  // Notification preferences
  notifyEmail Boolean @default(true)
  notifyPush  Boolean @default(true)

  // Activity tracking
  lastReadAt DateTime?
  lastViewedAt DateTime?

  // Status
  isActive Boolean @default(true)
  mutedUntil DateTime?

  joinedAt DateTime @default(now())

  // Relations
  thread CareTeamThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User           @relation("UserCareTeamParticipations", fields: [userId], references: [id])

  @@unique([threadId, userId])
  @@index([threadId])
  @@index([userId])
  @@index([isActive])
}

// ============================================
// CROSS-TRAINING SYSTEM
// ============================================

/// Cross-training sessions with running equivalencies
model CrossTrainingSession {
  id        String   @id @default(uuid())
  clientId  String
  date      DateTime
  workoutId String? // Link to replaced running workout

  // Session details
  modality String // "DEEP_WATER_RUNNING", "CYCLING", "ELLIPTICAL", etc.
  duration Float // minutes
  distance Float? // km (if applicable)
  avgHR    Float? // bpm
  maxHR    Float? // bpm
  avgPower Float? // watts (cycling)
  rpe      Int? // 1-10 scale

  // Intensity structure
  intensity String // "EASY", "MODERATE", "HARD"
  structure Json? // Intervals, rest periods

  // Equipment specific
  bodyWeightSupport Float? // % for AlterG
  resistance        String?
  strokeRate        Float? // Swimming

  // Conversion calculations
  runningEquivalent Json // {estimatedTSS, runningDistance, runningDuration, fitnessRetention}
  tssEquivalent     Float?

  // Context
  reason        String? // "INJURY", "VARIETY", "WEATHER", "PREFERENCE"
  injuryType    String?
  effectiveness String? // "EXCELLENT", "GOOD", "MODERATE", "POOR"

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, date])
  @@index([modality, date])
  @@index([clientId, modality]) // Track preferred/used modalities per athlete
  @@index([reason, injuryType]) // Analyze cross-training usage patterns
}

// ============================================
// STRENGTH TRAINING & PLYOMETRICS
// ============================================

/// Periodized strength training sessions integrated with running
model StrengthTrainingSession {
  id       String   @id @default(uuid())
  clientId String
  date     DateTime

  // Session type
  phase       String // "ANATOMICAL_ADAPTATION", "MAXIMUM_STRENGTH", "POWER", "MAINTENANCE"
  sessionType String // "STRENGTH_A", "STRENGTH_B", "PLYOMETRICS", "COMBINED"

  // Timing relative to running
  timingRelativeToRun String? // "BEFORE_RUN", "AFTER_RUN_6H", "SEPARATE_DAY"
  runningWorkoutId    String?

  // Exercises (JSON arrays)
  strengthExercises   Json? // [{exercise, sets, reps, load, rpe, rest}]
  plyometricExercises Json? // [{exercise, sets, reps, height, contacts, rest}]
  runningDrills       Json? // [{drill, sets, distance, focus}]

  // Volume tracking
  totalSets     Int?
  totalContacts Int? // Plyometric contacts
  duration      Float // minutes
  rpe           Int? // Overall session RPE

  // Load progression
  strengthLoad   Float? // Volume load (sets Ã— reps Ã— weight)
  plyometricLoad Float?

  // Integration with running
  runningPhase  String? // "BASE", "BUILD", "PEAK", "COMPETITION", "RECOVERY"
  priorityLevel String // "PRIMARY", "SECONDARY", "MAINTENANCE"

  // Effectiveness
  completionRate Float? // % of planned exercises completed
  qualityRating  String? // "EXCELLENT", "GOOD", "MODERATE", "POOR"

  notes String?

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, date])
  @@index([phase, date])
  @@index([clientId, phase]) // Track strength phase progression per athlete
  @@index([runningPhase, priorityLevel]) // Analyze strength integration with running
}

// ============================================
// AUTOMATIC PROGRESSION TRACKING
// ============================================

/// Tracks load progression for strength exercises with 1RM estimation
model ProgressionTracking {
  id         String   @id @default(uuid())
  clientId   String
  exerciseId String
  date       DateTime

  // Workout data
  sets          Int
  repsCompleted Int // Actual reps achieved
  repsTarget    Int // Target reps prescribed
  actualLoad    Float // Weight used (kg)
  rpe           Int? // 1-10 rate of perceived exertion

  // 1RM estimation (calculated)
  estimated1RM     Float // Calculated from Epley/Brzycki formulas
  estimationMethod String // "EPLEY", "BRZYCKI", "AVERAGE"

  // Progression tracking
  progressionStatus   ProgressionStatus @default(ON_TRACK)
  weeksAtCurrentLoad  Int               @default(0)
  lastIncrease        DateTime? // Date when load was last increased
  nextRecommendedLoad Float? // Auto-calculated next load

  // Phase context
  strengthPhase StrengthPhase?

  // 2-for-2 rule tracking
  consecutiveSessionsWithExtraReps Int     @default(0)
  readyForIncrease                 Boolean @default(false)

  // Plateau detection
  plateauWeeks      Int     @default(0)
  deloadRecommended Boolean @default(false)

  // Notes and overrides
  notes          String? @db.Text
  manualOverride Boolean @default(false) // Coach manually adjusted
  locked         Boolean @default(false) // Prevent auto-progression

  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, exerciseId, date])
  @@index([clientId, progressionStatus])
  @@index([exerciseId, date])
  @@index([readyForIncrease])
  @@index([plateauWeeks])
  @@index([clientId, strengthPhase])
}

/// Historical 1RM records for tracking strength gains over time
model OneRepMaxHistory {
  id         String   @id @default(uuid())
  clientId   String
  exerciseId String
  date       DateTime

  oneRepMax Float // Actual tested or estimated 1RM
  source    String // "TESTED", "ESTIMATED", "CALCULATED"

  // Context
  bodyWeight    Float? // kg at time of test
  strengthPhase StrengthPhase?

  notes String? @db.Text

  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([clientId, exerciseId, date])
  @@index([clientId, date])
}

// ============================================
// RACE RESULTS & PERFORMANCE TRACKING
// ============================================

/// Race results for VDOT calculation and pace zone determination
model RaceResult {
  id       String @id @default(uuid())
  clientId String

  // Race details
  raceName         String? // "Stockholm Marathon", "Local 5K"
  raceDate         DateTime
  distance         String // "5K", "10K", "HALF_MARATHON", "MARATHON", "CUSTOM"
  customDistanceKm Float? // For CUSTOM distance

  // Performance
  timeMinutes   Float // Total race time in minutes
  timeFormatted String // "1:28:00", "45:30", etc.

  // Environmental conditions
  temperature Float? // Celsius
  humidity    Float? // Percentage
  windSpeed   Float? // m/s
  elevation   Float? // Meters above sea level
  terrain     String? // "FLAT", "ROLLING", "HILLY", "TRAIL"

  // Calculated VDOT data (stored for historical tracking)
  vdot         Float? // Calculated VDOT value
  vdotAdjusted Float? // Gender/age adjusted VDOT
  confidence   String? // "VERY_HIGH", "HIGH", "MEDIUM", "LOW"
  ageInDays    Int? // Age of result (for confidence decay)

  // Training paces (stored snapshot at time of race)
  trainingPaces   Json? // Complete DanielsTrainingPaces snapshot
  equivalentTimes Json? // Equivalent race times for other distances

  // Race context
  goalTime     String? // Intended goal time
  goalAchieved Boolean @default(false)
  raceType     String? // "TRAINING_RACE", "B_RACE", "A_RACE", "TIME_TRIAL"

  // Performance analysis
  avgHeartRate Int? // bpm
  maxHeartRate Int? // bpm
  avgPace      String? // "4:30/km"
  splits       Json? // Array of split times

  // Notes and feedback
  conditions   String? @db.Text // Weather, course, etc.
  athleteNotes String? @db.Text // How they felt
  coachNotes   String? @db.Text // Coach analysis

  // Integration
  usedForZones      Boolean @default(false) // Is this being used for current training zones?
  trainingProgramId String? // Link to program this race was part of

  // Data Moat: Prediction validation & outcome tracking
  linkedPredictionId String? // Link to AI prediction that was made for this race
  linkedPrediction   AIPrediction? @relation("RacePredictionValidation", fields: [linkedPredictionId], references: [id])
  satisfactionScore  Int? // 1-5 athlete satisfaction with performance
  conditionFactors   Json? // Structured factors: { heat: true, altitude: false, illness: false, ... }
  coachAnalysis      Json? // Structured post-race analysis: { pacing, execution, nutrition, mental, recommendations }

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, raceDate])
  @@index([clientId, usedForZones]) // Find active race results
  @@index([distance, raceDate]) // Compare performances by distance
  @@index([vdot]) // Rank athletes by VDOT
  @@index([confidence]) // Filter high-confidence results
  @@index([linkedPredictionId]) // Find races linked to predictions
}

/// Sport-specific performance results (Cycling, Swimming, Triathlon, HYROX, Skiing)
/// Unified model for tracking PRs and performance metrics across all sports
model SportPerformance {
  id       String @id @default(uuid())
  clientId String

  // Core fields
  sport     SportType // CYCLING, SWIMMING, TRIATHLON, HYROX, SKIING
  eventType String // Sport-specific: "FTP_TEST", "CSS_TEST", "HYROX_RACE", etc.
  eventName String? // "VÃ¤tternrundan", "SM 50m", etc.
  eventDate DateTime

  // Primary result (time-based events)
  timeSeconds    Float? // Total time in seconds
  timeFormatted  String? // "1:28:00", "25:30", etc.
  distanceMeters Float? // Distance in meters

  // Power metrics (Cycling)
  powerWatts      Float? // Average power
  powerMax        Float? // Max power
  ftp             Float? // Functional Threshold Power
  wattsPerKg      Float? // W/kg
  normalizedPower Float? // NP for cycling

  // Pace metrics (Swimming, Running)
  pacePerHundred Float? // Swimming: seconds per 100m
  css            Float? // Critical Swim Speed (m/s)
  strokeRate     Float? // Strokes per minute
  strokeType     String? // "FREESTYLE", "BACKSTROKE", etc.
  poolLength     Int? // 25 or 50 meters

  // HYROX specific
  hyroxDivision  String? // "OPEN", "PRO", "DOUBLES"
  hyroxStations  Json? // { skiErg: 120, sled: 90, ... } times in seconds
  hyroxRunSplits Json? // Array of 8 run split times
  hyroxTotalTime Float? // Total race time in seconds

  // Triathlon specific
  swimTime          Float? // Swim leg in seconds
  bikeTime          Float? // Bike leg in seconds
  runTime           Float? // Run leg in seconds
  t1Time            Float? // Transition 1 in seconds
  t2Time            Float? // Transition 2 in seconds
  triathlonDistance String? // "SPRINT", "OLYMPIC", "HALF", "FULL"

  // Skiing specific
  skiingTechnique String? // "CLASSIC", "SKATE", "BOTH"
  skiingTerrain   String? // "FLAT", "ROLLING", "HILLY"
  snowConditions  String? // "HARD", "SOFT", "WET", "ICY"

  // Heart rate data
  avgHeartRate Int?
  maxHeartRate Int?

  // Environmental
  temperature Float?
  humidity    Float?
  altitude    Float?
  conditions  String? @db.Text

  // Notes
  athleteNotes String? @db.Text
  coachNotes   String? @db.Text
  isPR         Boolean @default(false) // Mark as personal record
  usedForZones Boolean @default(false) // Used for training zone calculation

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, sport])
  @@index([clientId, eventType])
  @@index([sport, eventDate])
  @@index([clientId, isPR])
}

// ============================================
// MULTI-SPORT PROFILE SYSTEM
// Added: 2025-11
// Purpose: Sport-specific athlete profiles for multi-sport platform
// ============================================

/// Central sport profile for each athlete - determines UI, zones, and program types
model SportProfile {
  id       String @id @default(uuid())
  clientId String @unique

  // Primary sport (determines dashboard variant)
  primarySport SportType @default(RUNNING)

  // Secondary sports (for cross-training or multi-sport athletes)
  secondarySports SportType[] @default([])

  // Onboarding completed
  onboardingCompleted Boolean @default(false)
  onboardingStep      Int     @default(0)

  // LTAD (Long-Term Athlete Development)
  developmentStage    DevelopmentStage? // Current LTAD stage
  peakHeightVelocity  DateTime?         // Estimated PHV date (for youth athletes)
  biologicalAge       Float?            // Biological vs chronological age offset

  // Sport-specific settings (JSON for flexibility)
  runningSettings           Json? // { preferredDistances, terrainPrefs, shoeRotation, etc. }
  cyclingSettings           Json? // { bikeType, ftpHistory, indoorOutdoorRatio, etc. }
  skiingSettings            Json? // { technique: 'CLASSIC' | 'SKATE', skiLength, etc. }
  triathlonSettings         Json? // { primaryDistance: 'SPRINT' | 'OLYMPIC' | 'HALF' | 'FULL', swimCss, etc. }
  hyroxSettings             Json? // { division, stationWeaknesses, bestTime, etc. }
  generalFitnessSettings    Json? // { preferredFormats, equipmentAccess, etc. }
  functionalFitnessSettings Json? // { benchmarks, gymnasticsSkills, olympicLiftingLevel, etc. }
  swimmingSettings          Json? // { poolLength, cssSpeed, strokePrefs, etc. }
  ergometerSettings         Json? // { preferredModalities, dragFactors, equipmentAccess, bikeBrand, etc. }

  // Team Sports Settings
  hockeySettings     Json? // { position, teamName, leagueLevel, seasonPhase, averageIceTimeMinutes, etc. }
  footballSettings   Json? // { position, teamName, leagueLevel, avgMatchDistanceKm, gpsProvider, etc. }
  handballSettings   Json? // { position, clubName, leagueLevel, seasonPhase, matchesPerWeek, etc. }
  floorballSettings  Json? // { position, clubName, leagueLevel, seasonPhase, matchesPerWeek, etc. }
  basketballSettings Json? // { position, clubName, leagueLevel, seasonPhase, matchesPerWeek, etc. }
  volleyballSettings Json? // { position, clubName, leagueLevel, seasonPhase, matchesPerWeek, etc. }

  // Racket Sports Settings
  tennisSettings Json? // { playStyle, clubName, leagueLevel, seasonPhase, preferredSurface, etc. }
  padelSettings  Json? // { position, clubName, leagueLevel, seasonPhase, preferredPartner, etc. }

  // Equipment access (affects workout generation)
  equipment Json? // { treadmill, bike, rower, skiErg, pool, gym, etc. }

  // Training availability (weekly schedule)
  weeklyAvailability     Json? // { monday: { available: true, maxHours: 2 }, ... }
  preferredSessionLength Int? // minutes

  // Goals and targets
  currentGoal  String? // "Marathon PR", "Finish HYROX", "Lose weight", etc.
  targetDate   DateTime?
  targetMetric Json? // { type: 'TIME' | 'DISTANCE' | 'WEIGHT', value, unit }

  // Theme preferences for workout display
  themePreferences Json? // { appTheme: 'FITAPP_DARK' | 'MINIMALIST_WHITE', pdfTheme: 'FITAPP_DARK' | 'MINIMALIST_WHITE' }

  // Biometrics for fitness estimation (training zone calculation)
  biometrics Json? // { restingHR, maxHR, watchVO2maxEstimate, watchBrand }

  // Recent race time for VDOT calculation
  recentRaceTime Json? // { distance: '5K' | '10K' | etc., timeMinutes: number }

  // Calculated fitness estimate (stored for quick access)
  fitnessEstimate Json? // { level, estimatedVO2max, confidence, source, lt1PercentHRmax, lt2PercentHRmax }

  // Experience levels per sport
  runningExperience           String? // "BEGINNER" | "INTERMEDIATE" | "ADVANCED" | "ELITE"
  cyclingExperience           String?
  swimmingExperience          String?
  strengthExperience          String?
  functionalFitnessExperience String?

  // Active subscription/program info
  activeStandardProgram String? // ID of purchased standard program template
  hasCustomProgram      Boolean @default(false)

  // AI preferences
  preferredAIModelId String? // Preferred AI model for WOD and assistant (e.g., 'gemini-3-flash')

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([primarySport])
  @@index([onboardingCompleted])
}

// ============================================
// AI STUDIO MODELS
// Added: 2024-12
// Purpose: AI-powered training program generation with RAG
// ============================================

/// Provider for AI models
enum AIProvider {
  ANTHROPIC // Claude models
  GOOGLE // Gemini models
  OPENAI // GPT models & embeddings
}

/// Document types for coach uploads
enum DocumentType {
  PDF
  EXCEL
  MARKDOWN
  VIDEO
  TEXT
  RESEARCH_REPORT // AI Deep Research generated reports
}

/// Coach document library for RAG knowledge base
model CoachDocument {
  id          String       @id @default(uuid())
  coachId     String
  name        String // Display name
  description String?      @db.Text
  fileType    DocumentType
  fileUrl     String // Supabase Storage URL
  fileSize    Int? // bytes
  mimeType    String? // e.g., "application/pdf"

  // System vs coach uploaded
  isSystem Boolean @default(false)

  // Processing status
  processingStatus String  @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  processingError  String?
  chunkCount       Int     @default(0)

  // Metadata
  metadata Json? // page count, sheet names, duration, etc.

  coach  User             @relation("CoachDocuments", fields: [coachId], references: [id], onDelete: Cascade)
  chunks KnowledgeChunk[]

  // Deep Research - link if this document was created from research
  researchSession DeepResearchSession? @relation("ResearchDocument")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([fileType])
  @@index([isSystem])
  @@index([processingStatus])
}

/// Knowledge chunks for RAG - embeddings stored separately via pgvector
model KnowledgeChunk {
  id         String @id @default(uuid())
  documentId String
  coachId    String

  content    String @db.Text // Actual text content
  chunkIndex Int // Order within document

  // Embedding stored via raw SQL (pgvector)
  // embedding    vector(1536) -- Added via migration
  embeddingModel String? // e.g., "text-embedding-ada-002"

  // Chunk metadata
  metadata   Json? // page number, section header, etc.
  tokenCount Int? // Tokens in this chunk

  document CoachDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([documentId])
  @@index([coachId])
  @@index([chunkIndex])
}

/// AI conversation sessions in AI Studio
model AIConversation {
  id        String  @id @default(uuid())
  coachId   String
  athleteId String? // Optional - can be general knowledge query

  title     String? // Auto-generated or user-set
  modelUsed String // e.g., "claude-4.5-opus", "gemini-3-pro"
  provider  AIProvider @default(ANTHROPIC)

  // Context configuration
  contextDocuments    String[] @default([]) // Array of document IDs included
  athleteDataIncluded Json? // Which athlete data points are included
  webSearchEnabled    Boolean  @default(false)

  // Usage tracking
  totalTokensUsed Int   @default(0)
  totalCost       Float @default(0) // Estimated cost in USD

  // Status
  status String @default("ACTIVE") // ACTIVE, ARCHIVED, DELETED

  coach                     User                       @relation("CoachConversations", fields: [coachId], references: [id], onDelete: Cascade)
  athlete                   Client?                    @relation("AthleteConversations", fields: [athleteId], references: [id], onDelete: SetNull)
  messages                  AIMessage[]
  generatedPrograms         AIGeneratedProgram[]
  programGenerationSessions ProgramGenerationSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([athleteId])
  @@index([status])
  @@index([createdAt])
}

/// Individual messages in AI conversations
model AIMessage {
  id             String @id @default(uuid())
  conversationId String

  role    String // "user", "assistant", "system"
  content String @db.Text

  // Token usage for this message
  inputTokens  Int?
  outputTokens Int?

  // If assistant used tools
  toolCalls   Json? // Array of tool calls made
  toolResults Json? // Results from tools

  // Metadata
  modelUsed String? // Model that generated this (for assistant messages)
  latencyMs Int? // Response time

  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([role])
  @@index([createdAt])
}

/// Programs generated by AI (before saving to TrainingProgram)
model AIGeneratedProgram {
  id             String  @id @default(uuid())
  conversationId String
  programId      String? // Link to TrainingProgram if saved

  // Program data (JSON structure matching TrainingProgram)
  programJson Json

  // Generation metadata
  prompt    String? @db.Text // The prompt that generated this
  reasoning String? @db.Text // AI's reasoning/explanation

  // Status
  isSaved Boolean @default(false)

  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId])
  @@index([programId])
  @@index([isSaved])
}

/// WOD (Workout of the Day) generation mode
enum WODMode {
  STRUCTURED // Science-based, periodization-aware
  CASUAL // Lower pressure, flexible
  FUN // Variety-focused, gamified
}

/// WOD execution status
enum WODStatus {
  GENERATED // Created but not started
  STARTED // In progress
  COMPLETED // Finished
  ABANDONED // Started but not finished
}

/// AI-generated Workout of the Day for athletes
model AIGeneratedWOD {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation("ClientWODs", fields: [clientId], references: [id], onDelete: Cascade)

  // Generation configuration
  mode              WODMode  @default(STRUCTURED)
  requestedDuration Int      @default(45) // Minutes
  equipment         String[] @default([])
  focusArea         String? // "upper_body", "lower_body", "full_body", "cardio", "recovery"

  // AI-generated content
  title       String // Swedish title
  subtitle    String? // Motivational tagline
  description String? @db.Text // What the workout targets
  workoutJson Json // Full workout structure with sections/exercises
  coachNotes  String? @db.Text // AI reasoning for the workout

  // Context at generation time
  readinessAtGeneration Float?
  intensityAdjusted     String? // "recovery", "easy", "moderate", "threshold"
  guardrailsApplied     String[] @default([]) // E.g., "ACWR_WARNING", "INJURY_MODIFIED"
  primarySport          String? // Sport used for generation

  // Execution tracking
  status         WODStatus @default(GENERATED)
  startedAt      DateTime?
  completedAt    DateTime?
  actualDuration Int? // Actual time taken (minutes)
  sessionRPE     Int? // 1-10 perceived effort
  exerciseLogs   Json? // Per-exercise completion data

  // Usage & metrics
  tokensUsed       Int?
  generationTimeMs Int?
  modelUsed        String? // e.g., "claude-sonnet-4-5-20250929"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([status])
  @@index([createdAt])
  @@index([mode])
}

/// Video analysis results (technique analysis using Gemini)
model VideoAnalysis {
  id         String  @id @default(uuid())
  coachId    String
  athleteId  String?
  exerciseId String? // Link to exercise from library

  // Video source
  videoUrl     String // Supabase Storage URL
  videoType    String // "STRENGTH", "RUNNING_GAIT", "SPORT_SPECIFIC", "SKIING_*", "HYROX_STATION"
  hyroxStation String? // For HYROX_STATION: "SKIERG", "SLED_PUSH", "SLED_PULL", etc.
  cameraAngle  String? // "FRONT", "SIDE", "BACK" - camera angle for view-specific analysis
  duration     Int? // seconds

  // MediaPipe landmarks data (if processed locally)
  landmarksData Json? // Skeletal tracking data

  // AI analysis results
  aiAnalysis     String?    @db.Text
  aiPoseAnalysis Json? // Structured AI pose analysis from Gemini (interpretation, technicalFeedback, patterns, recommendations, score)
  aiProvider     AIProvider @default(GOOGLE)
  modelUsed      String? // e.g., "gemini-3-pro"

  // Structured results
  formScore       Int? // 0-100
  issuesDetected  Json? // Array of {issue, severity, timestamp}
  recommendations Json? // Array of recommended corrections
  comparisonData  Json? // If comparing to previous video

  // Processing status
  status          String  @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  processingError String?

  coach    User      @relation("CoachVideoAnalyses", fields: [coachId], references: [id], onDelete: Cascade)
  athlete  Client?   @relation("AthleteVideoAnalyses", fields: [athleteId], references: [id], onDelete: SetNull)
  exercise Exercise? @relation(fields: [exerciseId], references: [id], onDelete: SetNull)

  // Extended analysis (for RUNNING_GAIT type)
  runningGaitAnalysis RunningGaitAnalysis?

  // Extended analysis (for SKIING_* types)
  skiingTechniqueAnalysis SkiingTechniqueAnalysis?

  // Extended analysis (for HYROX_STATION type)
  hyroxStationAnalysis HyroxStationAnalysis?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([athleteId])
  @@index([exerciseId])
  @@index([status])
}

/// Body composition tracking (bioimpedance measurements)
model BodyComposition {
  id       String @id @default(uuid())
  clientId String

  measurementDate DateTime @db.Date

  // Core measurements
  weightKg       Float?
  bodyFatPercent Float?
  muscleMassKg   Float?

  // Additional bioimpedance data
  visceralFat               Int? // Scale typically 1-59
  boneMassKg                Float?
  waterPercent              Float? // Total body water
  intracellularWaterPercent Float? // ICW - water inside cells
  extracellularWaterPercent Float? // ECW - water outside cells

  // Metabolic data
  bmrKcal      Int? // Basal Metabolic Rate
  metabolicAge Int?

  // Calculated fields
  bmi  Float? // Calculated from weight/height
  ffmi Float? // Fat-Free Mass Index

  // Source and quality
  deviceBrand     String? // "Tanita", "InBody", "Omron", etc.
  measurementTime String? // "MORNING_FASTED", "POST_WORKOUT", etc.

  notes String? @db.Text

  client Client @relation("ClientBodyComposition", fields: [clientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, measurementDate])
  @@index([clientId])
  @@index([measurementDate])
}

/// User API keys for BYOK (Bring Your Own Key) model
model UserApiKey {
  id     String @id @default(uuid())
  userId String @unique

  // Encrypted API keys (encrypted at application level)
  anthropicKeyEncrypted String? // Claude API key
  googleKeyEncrypted    String? // Gemini API key
  openaiKeyEncrypted    String? // OpenAI API key (for embeddings)

  // Key status (validated = successfully tested)
  anthropicKeyValid Boolean @default(false)
  googleKeyValid    Boolean @default(false)
  openaiKeyValid    Boolean @default(false)

  // Last validation timestamps
  anthropicKeyLastValidated DateTime?
  googleKeyLastValidated    DateTime?
  openaiKeyLastValidated    DateTime?

  // Default AI model preference (used across all AI features)
  defaultModelId String?
  defaultModel   AIModel? @relation("UserDefaultModel", fields: [defaultModelId], references: [id], onDelete: SetNull)

  // Athlete AI settings (which models athletes can choose from)
  // Empty array = all available models allowed
  allowedAthleteModelIds String[] @default([])
  athleteDefaultModelId  String? // Default model for athletes if not selected

  user User @relation("UserApiKeys", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

/// Available AI models (admin-configurable)
model AIModel {
  id String @id @default(uuid())

  provider    AIProvider
  modelId     String     @unique // e.g., "claude-4.5-opus-20250101"
  displayName String // e.g., "Claude 4.5 Opus"
  description String?

  // Capabilities
  capabilities    String[] @default([]) // ["text", "vision", "code", "web_search"]
  maxTokens       Int? // Max context window
  maxOutputTokens Int? // Max output tokens

  // Pricing (per 1K tokens)
  inputCostPer1k  Float?
  outputCostPer1k Float?

  // Availability
  isActive  Boolean @default(true)
  isDefault Boolean @default(false) // Default model for new conversations

  // Versioning
  releasedAt   DateTime?
  deprecatedAt DateTime?

  // User preferences
  userDefaults UserApiKey[] @relation("UserDefaultModel")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([provider])
  @@index([isActive])
  @@index([isDefault])
}

// ==================== GEMINI 3 PRO FEATURES ====================

/// Extended running gait analysis data (Gemini 3 Pro structured output)
model RunningGaitAnalysis {
  id              String @id @default(uuid())
  videoAnalysisId String @unique

  // Biometric data (structured from video)
  cadence             Int? // steps per minute
  groundContactTime   Float? // milliseconds
  verticalOscillation Float? // centimeters
  strideLength        Float? // meters
  footStrikePattern   String? // "HEEL", "MIDFOOT", "FOREFOOT"

  // Asymmetry data (left/right differences)
  asymmetryPercent  Float? // overall asymmetry %
  leftContactTime   Float?
  rightContactTime  Float?
  leftStrideLength  Float?
  rightStrideLength Float?

  // Injury risk assessment
  injuryRiskLevel   String? // "LOW", "MODERATE", "HIGH"
  injuryRiskScore   Int? // 0-10
  injuryRiskFactors Json? // Array of risk factor objects

  // Efficiency metrics
  runningEfficiency String? // "EXCELLENT", "GOOD", "MODERATE", "POOR"
  energyLeakages    Json? // Array of identified inefficiencies

  // Phase-specific analysis
  stancePhaseData Json? // { duration, issues, recommendations }
  swingPhaseData  Json? // { duration, issues, recommendations }

  // Coaching cues (Swedish)
  coachingCues         Json? // Array of { cue, priority, drillName, explanation }
  drillRecommendations Json? // Array of corrective drills

  // Comparison data
  previousComparison Json? // Delta from previous analysis

  // Overall assessment
  overallScore Int? // 0-100
  summary      String? @db.Text // Swedish summary

  videoAnalysis VideoAnalysis @relation(fields: [videoAnalysisId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([videoAnalysisId])
  @@index([injuryRiskLevel])
  @@index([cadence])
}

/// Skiing technique analysis (for SKIING_CLASSIC, SKIING_SKATING, SKIING_DOUBLE_POLE types)
model SkiingTechniqueAnalysis {
  id              String @id @default(uuid())
  videoAnalysisId String @unique

  // Technique context
  techniqueType  String // CLASSIC, SKATING, DOUBLE_POLE
  skatingVariant String? // V1, V2, V2_ALT (only for SKATING)
  terrainType    String? // FLAT, UPHILL, DOWNHILL

  // Overall scores (0-100)
  overallScore    Float?
  balanceScore    Float? // Classic/Skating only
  timingScore     Float? // Classic/Skating only
  efficiencyScore Float?
  powerScore      Float? // Double pole only
  rhythmScore     Float? // Double pole only

  // Pole mechanics (all techniques)
  poleAngleAtPlant     Float? // degrees
  poleAngleAtRelease   Float? // degrees
  polePlantTiming      String? // EARLY, ON_TIME, LATE
  poleForceApplication String? // GOOD, WEAK, INCONSISTENT
  armSwingSymmetry     Float? // 0-100 percentage

  // Hip and core position (all techniques)
  hipPositionScore     Float? // 0-100
  hipHeightConsistency Float? // 0-100
  coreEngagement       String? // GOOD, MODERATE, POOR
  forwardLean          Float? // degrees from vertical

  // Weight transfer (all techniques)
  weightTransferScore Float? // 0-100
  weightShiftTiming   String? // EARLY, ON_TIME, LATE
  lateralStability    Float? // 0-100

  // Classic-specific metrics
  kickTimingScore     Float? // 0-100
  kickExtension       String? // FULL, PARTIAL, INCOMPLETE
  glidePhaseDuration  Float? // seconds
  legRecoveryPattern  String? // EFFICIENT, MODERATE, INEFFICIENT
  waxPocketEngagement String? // GOOD, PARTIAL, POOR

  // Skating-specific metrics
  edgeAngleLeft     Float? // degrees
  edgeAngleRight    Float? // degrees
  edgeAngleSymmetry Float? // 0-100
  pushOffAngle      Float? // degrees from ski direction
  vPatternWidth     Float? // cm estimated
  skateFrequency    Float? // cycles per second
  recoveryLegPath   String? // COMPACT, WIDE, INCONSISTENT

  // Double pole-specific metrics
  trunkFlexionRange    Float? // degrees
  compressionDepth     String? // SHALLOW, OPTIMAL, EXCESSIVE
  returnPhaseSpeed     String? // FAST, MODERATE, SLOW
  legDriveContribution String? // SIGNIFICANT, MODERATE, MINIMAL
  rhythmConsistency    Float? // 0-100

  // AI insights (Swedish)
  primaryStrengths  Json? // string[]
  primaryWeaknesses Json? // string[]
  techniqueDrills   Json? // { drill: string, focus: string, priority: number }[]
  comparisonToElite String? @db.Text // narrative comparison

  videoAnalysis VideoAnalysis @relation(fields: [videoAnalysisId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([videoAnalysisId])
  @@index([techniqueType])
  @@index([overallScore])
}

/// HYROX station analysis (for HYROX_STATION video type)
/// Covers all 8 HYROX stations: SkiErg, Sled Push, Sled Pull, Burpee Broad Jump, Rowing, Farmers Carry, Sandbag Lunge, Wall Balls
model HyroxStationAnalysis {
  id              String @id @default(uuid())
  videoAnalysisId String @unique

  // Station identification
  stationType String // SKIERG, SLED_PUSH, SLED_PULL, BURPEE_BROAD_JUMP, ROWING, FARMERS_CARRY, SANDBAG_LUNGE, WALL_BALLS

  // Overall assessment (0-100)
  overallScore    Float?
  efficiencyScore Float?
  formScore       Float?
  paceConsistency Float?

  // Movement quality
  coreStability    Float? // 0-100
  breathingPattern String? // GOOD, INCONSISTENT, POOR
  movementEconomy  Float? // 0-100

  // Pace analysis
  movementCadence  Float? // reps per minute or strokes per minute
  cadenceVariation Float? // percentage variation
  restPauses       Int? // number of pauses detected

  // Fatigue indicators
  fatigueIndicators Json? // { earlyPhase: string[], latePhase: string[] }
  formDegradation   Float? // percentage decline from start to end

  // Station-specific metrics (JSON - varies by station)
  stationMetrics Json?

  // SkiErg specific
  pullLength           String? // SHORT, OPTIMAL, LONG
  hipHingeDepth        String? // SHALLOW, OPTIMAL, EXCESSIVE
  armExtension         String? // INCOMPLETE, FULL, OVEREXTENDED
  legDriveContribution String? // MINIMAL, MODERATE, SIGNIFICANT

  // Sled Push specific
  bodyAngle    Float? // degrees from vertical
  armLockout   String? // BENT, LOCKED, OVEREXTENDED
  strideLength String? // SHORT, OPTIMAL, OVERSTRIDING
  drivePhase   String? // WEAK, GOOD, POWERFUL

  // Sled Pull specific
  pullTechnique   String? // ARM_DOMINANT, HIP_DRIVEN, MIXED
  ropePath        String? // STRAIGHT, DIAGONAL, INCONSISTENT
  anchorStability String? // STABLE, SHIFTING, UNSTABLE

  // Burpee Broad Jump specific
  burpeeDepth      String? // SHALLOW, FULL, EXCESSIVE
  jumpDistance     String? // SHORT, GOOD, EXCELLENT
  transitionSpeed  String? // SLOW, MODERATE, FAST
  landingMechanics String? // POOR, ACCEPTABLE, GOOD

  // Rowing specific
  driveSequence    String? // CORRECT, ARMS_EARLY, BACK_EARLY
  laybackAngle     Float? // degrees
  catchPosition    String? // COMPRESSED, OPTIMAL, OVERREACHING
  strokeRate       Float? // strokes per minute
  powerApplication String? // FRONT_LOADED, EVEN, BACK_LOADED

  // Farmers Carry specific
  shoulderPack  String? // ELEVATED, PACKED, DEPRESSED
  trunkPosture  String? // UPRIGHT, LEANING, SWAYING
  stridePattern String? // SHORT_CHOPPY, SMOOTH, OVERSTRIDING
  gripFatigue   String? // NONE, MODERATE, SIGNIFICANT

  // Sandbag Lunge specific
  bagPosition   String? // HIGH_CHEST, SHOULDER, DROPPING
  kneeTracking  String? // GOOD, VALGUS, VARUS
  stepLength    String? // SHORT, OPTIMAL, OVERSTRIDING
  torsoPosition String? // UPRIGHT, FORWARD_LEAN, EXCESSIVE_LEAN

  // Wall Balls specific
  squatDepth          String? // SHALLOW, PARALLEL, DEEP
  throwMechanics      String? // ARM_DOMINANT, HIP_DRIVEN, COORDINATED
  wallBallCatchHeight String? // HIGH, OPTIMAL, LOW
  rhythmConsistency   Float? // 0-100

  // Benchmark comparison
  benchmarkLevel       String? // BEGINNER, INTERMEDIATE, ADVANCED, ELITE
  estimatedStationTime Int? // seconds (projected time for standard reps)

  // Athlete profile integration
  isWeakStation   Boolean @default(false)
  isStrongStation Boolean @default(false)

  // AI insights (Swedish)
  primaryStrengths  Json? // string[]
  primaryWeaknesses Json? // string[]
  improvementDrills Json? // { drill: string, focus: string, priority: number }[]
  raceStrategyTips  Json? // string[]

  videoAnalysis VideoAnalysis @relation(fields: [videoAnalysisId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([videoAnalysisId])
  @@index([stationType])
  @@index([overallScore])
}

/// Audio recordings for voice-based daily check-in (Gemini 3 Pro transcription)
model AudioJournal {
  id       String   @id @default(uuid())
  clientId String
  date     DateTime @db.Date

  // Audio file data
  audioUrl String // Supabase Storage URL
  duration Int // seconds (30-60 typical)
  mimeType String? // "audio/webm", "audio/mp4", etc.
  fileSize Int? // bytes

  // Transcription
  transcription           String? @db.Text // Full text from Gemini
  transcriptionModel      String? // "gemini-3-pro"
  transcriptionConfidence Float?

  // Structured extraction (from transcription)
  extractedData        Json? // { rpe, sleepQuality, soreness, energy, etc. }
  extractionConfidence Float?

  // AI interpretation
  aiInterpretation Json? // { readinessEstimate, recommendedAction, flaggedConcerns }

  // Link to DailyCheckIn (if populated from audio)
  dailyCheckInId String? @unique

  // Processing status
  status           String  @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  processingError  String?
  processingTimeMs Int?

  client       Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  dailyCheckIn DailyCheckIn? @relation(fields: [dailyCheckInId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, date])
  @@index([clientId, date])
  @@index([status])
}

/// Menstrual cycle tracking for female athletes
model MenstrualCycle {
  id       String @id @default(uuid())
  clientId String

  // Cycle metadata
  cycleNumber Int? // Sequential cycle number
  startDate   DateTime  @db.Date
  endDate     DateTime? @db.Date
  cycleLength Int? // days

  // Phase tracking
  currentPhase  String? // "MENSTRUAL", "FOLLICULAR", "OVULATORY", "LUTEAL"
  ovulationDate DateTime? @db.Date

  // AI-generated insights
  phaseRecommendations Json? // { phase: { intensityModifier, volumeModifier, focusAreas } }
  aiInsights           Json? // Patterns, predictions, recommendations

  // Notes
  notes String? @db.Text

  client    Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  dailyLogs MenstrualDailyLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, startDate])
  @@index([currentPhase])
}

/// Daily menstrual symptom log
model MenstrualDailyLog {
  id       String   @id @default(uuid())
  clientId String
  cycleId  String?
  date     DateTime @db.Date

  // Current phase (auto-calculated)
  cycleDay Int? // Day 1-28+ in current cycle
  phase    String? // Current phase

  // Symptom tracking (1-5 scale)
  flowIntensity    Int? // 0=none, 1-5 for flow days
  cramps           Int? // 1=none, 5=severe
  bloating         Int?
  breastTenderness Int?
  headache         Int?
  fatigue          Int? // 1=low fatigue, 5=extreme
  moodScore        Int? // 1=very low, 5=excellent
  cravings         Int?

  // Training performance
  perceivedEffort Int? // RPE for that day
  actualVsPlanned String? // "EXCEEDED", "MET", "REDUCED", "SKIPPED"

  // Notes
  notes String? @db.Text

  // AI flags
  aiWarnings Json? // Flagged patterns

  client Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  cycle  MenstrualCycle? @relation(fields: [cycleId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, date])
  @@index([clientId, date])
  @@index([phase])
  @@index([cycleId])
}

// ==================== HYBRID STUDIO ====================

/// Hybrid workout formats (CrossFit, HYROX, functional fitness)
enum HybridFormat {
  AMRAP // As Many Rounds As Possible
  FOR_TIME // Complete work as fast as possible
  EMOM // Every Minute On the Minute
  TABATA // 20s work / 10s rest Ã— 8
  CHIPPER // Long sequence of movements done once
  LADDER // Ascending/descending rep scheme
  INTERVALS // Work/rest intervals with movements
  HYROX_SIM // HYROX simulation (run + stations)
  CUSTOM // Custom format
}

/// Scaling levels for hybrid workouts
enum ScalingLevel {
  RX // Prescribed/competition standard
  SCALED // Reduced load/modified movements
  FOUNDATIONS // Beginner-friendly version
  CUSTOM // Custom modifications for individual athlete
}

/// Score types for hybrid workout results
enum HybridScoreType {
  TIME // Completion time (For Time, Chipper)
  ROUNDS_REPS // Rounds + extra reps (AMRAP)
  LOAD // Weight lifted (max effort)
  REPS // Total reps (Tabata)
  CALORIES // Total calories
  COMPLETION // Pass/fail (EMOM)
}

/// Equipment types for movements
enum EquipmentType {
  BARBELL
  KETTLEBELL
  DUMBBELL
  BODYWEIGHT
  PULL_UP_BAR
  RINGS
  BOX
  ROPE
  GHD
  MACHINE_ROW
  MACHINE_BIKE
  MACHINE_SKI
  ASSAULT_BIKE
  WALL_BALL
  MEDICINE_BALL
  SANDBAG
  SLED
  RUNNING
  JUMP_ROPE
  YOKE
  SWIMMING
  PARALLETTES
}

/// Movement categories for hybrid workouts
enum MovementCategory {
  OLYMPIC_LIFT // Clean, Snatch, Jerk variations
  POWERLIFTING // Squat, Deadlift, Bench
  GYMNASTICS // Pull-ups, Muscle-ups, HSPU
  MONOSTRUCTURAL // Run, Row, Bike, Ski
  KETTLEBELL_WORK // Swings, Turkish Get-up
  STRONGMAN // Carries, Sled work
  CORE_WORK // Sit-ups, Toes-to-Bar, Planks
  ACCESSORY // Lunges, Step-ups
  HYROX_STATION // HYROX-specific movements
}

/// Hybrid workout template (AMRAP, For Time, EMOM, etc.)
model HybridWorkout {
  id          String  @id @default(uuid())
  name        String
  description String? @db.Text

  // Workout format
  format HybridFormat

  // Time configuration
  timeCap      Int? // seconds (0 = no cap)
  workTime     Int? // EMOM/Tabata work portion (seconds)
  restTime     Int? // EMOM/Tabata rest portion (seconds)
  totalRounds  Int? // for fixed round workouts
  totalMinutes Int? // for EMOM total duration

  // Rep scheme (for display)
  repScheme String? // "21-15-9", "10-9-8-7-6-5-4-3-2-1", etc.

  // Movements in this workout
  movements HybridMovement[]

  // Scaling
  scalingLevel   ScalingLevel    @default(RX)
  rxVersionId    String?
  rxVersion      HybridWorkout?  @relation("WorkoutScaling", fields: [rxVersionId], references: [id], onDelete: SetNull)
  scaledVersions HybridWorkout[] @relation("WorkoutScaling")

  // Benchmark/Template info
  isBenchmark     Boolean @default(false)
  benchmarkSource String? // "CrossFit", "HYROX", "Hero WOD", "The Girls", "Open"
  benchmarkYear   Int? // e.g., 2024 for Open 24.1

  // Ownership
  coachId  String?
  coach    User?   @relation("CoachHybridWorkouts", fields: [coachId], references: [id], onDelete: SetNull)
  isPublic Boolean @default(false)

  // Stats
  results     HybridWorkoutResult[]
  assignments HybridWorkoutAssignment[]
  workoutLogs HybridWorkoutLog[]

  // Team workout broadcasts
  teamWorkoutBroadcasts TeamWorkoutBroadcast[]

  // Tags for filtering
  tags String[] @default([])

  // Section data (JSON for flexibility)
  warmupData   Json? // {notes?: string, movements?: [...]}
  strengthData Json? // {notes?: string, movements?: [{sets, reps, rest, ...}]}
  cooldownData Json? // {notes?: string, movements?: [...]}
  // Note: existing 'movements' relation is the METCON section

  // Versioning
  version        Int                    @default(1)
  versionNotes   String?                @db.Text
  parentId       String? // Original workout this was versioned from
  parent         HybridWorkout?         @relation("WorkoutVersions", fields: [parentId], references: [id], onDelete: SetNull)
  versions       HybridWorkout[]        @relation("WorkoutVersions")
  versionHistory HybridWorkoutVersion[]

  // Voice workout creation
  voiceWorkoutSessions VoiceWorkoutSession[] @relation("HybridWorkoutVoiceWorkouts")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([isBenchmark])
  @@index([benchmarkSource])
  @@index([format])
  @@index([scalingLevel])
  @@index([parentId])
}

/// Version history for workout changes
model HybridWorkoutVersion {
  id String @id @default(uuid())

  workout   HybridWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId String

  // Version info
  versionNumber Int
  changeType    String // "CREATED", "MODIFIED", "MOVEMENTS_CHANGED", "SCALING_UPDATED"
  changeNotes   String? @db.Text
  changedBy     String? // User ID who made the change

  // Snapshot of workout at this version
  snapshot Json // Full workout data at this point in time

  createdAt DateTime @default(now())

  @@index([workoutId])
  @@index([versionNumber])
}

/// Movement within a hybrid workout
model HybridMovement {
  id String @id @default(uuid())

  workout   HybridWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId String

  exercise   Exercise @relation(fields: [exerciseId], references: [id])
  exerciseId String

  // Position in workout
  order       Int
  roundNumber Int? // for EMOM alternating minutes (1=odd, 2=even)
  setNumber   Int? // for rep schemes (1=first set of 21, 2=second set of 15, etc.)

  // Movement prescription
  reps     Int?
  calories Int?
  distance Float? // meters
  duration Int? // seconds (for holds, cardio)

  // Load
  weightMale   Float? // kg
  weightFemale Float? // kg
  weightUnit   String? @default("kg") // "kg" or "lb"
  percentOfMax Float? // e.g., 0.7 for 70% of 1RM

  // Special modifiers
  isUnbroken     Boolean @default(false) // Must complete without rest
  alternateSides Boolean @default(false) // e.g., single-arm DB snatch

  // Notes for this specific movement
  notes String?

  @@index([workoutId])
  @@index([exerciseId])
}

/// Athlete's workout result/score
model HybridWorkoutResult {
  id String @id @default(uuid())

  workout   HybridWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId String

  athlete   Client @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId String

  // Score
  scoreType       HybridScoreType
  timeScore       Int? // seconds (for time-based)
  roundsCompleted Int? // for AMRAP
  repsCompleted   Int? // additional reps in AMRAP, or total for Tabata
  loadUsed        Float? // kg (for max effort)
  caloriesScore   Int? // for calorie-based workouts

  // Scaling used
  scalingLevel        ScalingLevel
  scalingNotes        String? // e.g., "Used 30kg instead of 43kg"
  customModifications Json? // For CUSTOM scaling: [{movementId, modification, originalValue, newValue}]

  // Context
  completedAt DateTime  @default(now())
  workoutDate DateTime? @db.Date // When they did it (may differ from logged time)

  // PR tracking
  isPR           Boolean @default(false)
  previousBestId String? // ID of previous best result

  // Notes and feedback
  notes           String? @db.Text
  coachFeedback   String? @db.Text
  perceivedEffort Int? // RPE 1-10
  difficulty      Int? // 1-10 how hard vs expected

  // Optional detailed splits
  movementSplits Json? // [{movementId, time, reps, notes}]

  // Video link
  videoUrl String?

  @@unique([workoutId, athleteId, completedAt])
  @@index([workoutId])
  @@index([athleteId])
  @@index([completedAt])
  @@index([isPR])
}

/// Workout assignment - coach assigns workout to athlete(s) for specific date
model HybridWorkoutAssignment {
  id String @id @default(uuid())

  workout   HybridWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId String

  athlete   Client @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId String

  // Assignment details
  assignedDate DateTime @db.Date // When workout should be done
  assignedBy   String // Coach user ID
  notes        String?  @db.Text // Coach notes for athlete

  // Status tracking
  status      AssignmentStatus @default(PENDING)
  completedAt DateTime? // When athlete marked it complete
  resultId    String? // Link to the result if completed

  // Customization
  customScaling String? // Suggested scaling for this athlete
  scalingNotes  String? // "Use 30kg for thrusters"

  // Team broadcast tracking (null if individual assignment)
  teamBroadcastId String?
  teamBroadcast   TeamWorkoutBroadcast? @relation(fields: [teamBroadcastId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workoutId, athleteId, assignedDate])
  @@index([workoutId])
  @@index([athleteId])
  @@index([assignedDate])
  @@index([status])
  @@index([teamBroadcastId])
}

enum AssignmentStatus {
  PENDING // Not started
  SCHEDULED // Athlete acknowledged
  COMPLETED // Done
  SKIPPED // Athlete skipped
  MODIFIED // Coach modified assignment
}

/// Hybrid workout log - tracks Focus Mode execution
model HybridWorkoutLog {
  id String @id @default(uuid())

  workout   HybridWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId String

  athlete   Client @relation("AthleteHybridLogs", fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId String

  // Optional link to assignment if this was assigned
  assignmentId String?

  // Execution timing
  startedAt   DateTime         @default(now())
  completedAt DateTime?
  status      AssignmentStatus @default(PENDING)

  // Results (depending on format)
  totalTime   Int? // seconds (for FOR_TIME)
  totalRounds Int? // completed rounds (for AMRAP)
  extraReps   Int? // partial reps in last round

  // Scaling used
  scalingLevel ScalingLevel @default(RX)
  scalingNotes String?

  // Round logs
  roundLogs HybridRoundLog[]

  // Session feedback
  sessionRPE    Int? // 1-10
  notes         String? @db.Text
  focusModeUsed Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workoutId])
  @@index([athleteId])
  @@index([startedAt])
  @@index([status])
}

/// Per-round log within a Hybrid workout
model HybridRoundLog {
  id String @id @default(uuid())

  hybridWorkoutLog   HybridWorkoutLog @relation(fields: [hybridWorkoutLogId], references: [id], onDelete: Cascade)
  hybridWorkoutLogId String

  roundNumber Int

  // Timing
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int? // seconds

  // Movement tracking
  movements Json // Array of { movementId, movementName, reps, completed, notes }

  // Status
  completed Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([hybridWorkoutLogId])
  @@index([roundNumber])
}

// ============================================
// STRENGTH SESSION LIBRARY
// ============================================

/// Coach-owned strength session template
model StrengthSession {
  id          String  @id @default(uuid())
  name        String
  description String? @db.Text

  // Session configuration
  phase               StrengthPhase @default(ANATOMICAL_ADAPTATION)
  timingRelativeToRun String? // "BEFORE_RUN", "AFTER_RUN_6H", "SEPARATE_DAY"
  estimatedDuration   Int? // minutes

  // Exercise data (JSON for flexibility) - MAIN section (required)
  exercises Json // [{exerciseId, exerciseName, sets, reps, weight, restSeconds, notes, section?}]

  // Optional section data (JSON)
  warmupData   Json? // {notes?, duration?, exercises?: [{exerciseId, exerciseName, sets, reps, notes}]}
  coreData     Json? // {notes?, duration?, exercises?: [{exerciseId, exerciseName, sets, reps, restSeconds, notes}]}
  cooldownData Json? // {notes?, duration?, exercises?: [{exerciseId, exerciseName, duration, notes}]}

  // Computed metadata
  totalSets      Int?
  totalExercises Int?
  volumeLoad     Float?

  // Ownership
  coachId  String
  coach    User    @relation("CoachStrengthSessions", fields: [coachId], references: [id], onDelete: Cascade)
  isPublic Boolean @default(false)

  // Tags for filtering
  tags String[] @default([])

  // Assignments
  assignments StrengthSessionAssignment[]

  // Team workout broadcasts
  teamWorkoutBroadcasts TeamWorkoutBroadcast[]

  // Voice workout creation
  voiceWorkoutSessions VoiceWorkoutSession[] @relation("StrengthSessionVoiceWorkouts")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([phase])
  @@index([isPublic])
}

/// Assignment of strength session to athlete
model StrengthSessionAssignment {
  id String @id @default(uuid())

  session   StrengthSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId String

  athlete   Client @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId String

  // Assignment details
  assignedDate DateTime @db.Date
  assignedBy   String // Coach user ID
  notes        String?  @db.Text

  // Status tracking
  status      AssignmentStatus @default(PENDING)
  completedAt DateTime?

  // Logged workout data
  actualExercises Json? // Logged exercise data with actual weight/reps
  rpe             Int? // Overall session RPE
  duration        Int? // Actual duration in minutes

  // Per-set logging (detailed)
  setLogs SetLog[]

  // Team broadcast tracking (null if individual assignment)
  teamBroadcastId String?
  teamBroadcast   TeamWorkoutBroadcast? @relation(fields: [teamBroadcastId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, athleteId, assignedDate])
  @@index([sessionId])
  @@index([athleteId])
  @@index([assignedDate])
  @@index([status])
  @@index([teamBroadcastId])
}

/// Pre-built strength program templates for quick program generation
model StrengthTemplate {
  id          String  @id @default(uuid())
  name        String
  description String? @db.Text

  // Template metadata
  phase           StrengthPhase    @default(ANATOMICAL_ADAPTATION)
  durationWeeks   Int              @default(4)
  sessionsPerWeek Int              @default(2)
  level           ProgressionLevel @default(LEVEL_1)

  // Target demographics
  targetSport SportType?
  targetGoal  String? // "strength", "power", "endurance", "hypertrophy"

  // Template content (JSON for flexibility)
  sessions         Json // Array of session templates with exercises
  progressionRules Json? // Automatic progression configuration

  // Ownership
  coachId          String? // null = system template
  coach            User?   @relation("StrengthTemplateOwner", fields: [coachId], references: [id], onDelete: SetNull)
  isPublic         Boolean @default(false)
  isSystemTemplate Boolean @default(false)

  // Usage tracking
  usageCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([phase])
  @@index([targetSport])
  @@index([isPublic])
  @@index([isSystemTemplate])
}

// ============================================
// CARDIO SESSION LIBRARY
// ============================================

/// Coach-owned cardio session template
model CardioSession {
  id          String  @id @default(uuid())
  name        String
  description String? @db.Text

  // Session configuration
  sport SportType @default(RUNNING)

  // Segment data (JSON for flexibility)
  segments Json // [{type, duration, distance, pace, zone, notes}]

  // Computed totals
  totalDuration Int? // seconds
  totalDistance Float? // meters
  avgZone       Float?

  // Ownership
  coachId  String
  coach    User    @relation("CoachCardioSessions", fields: [coachId], references: [id], onDelete: Cascade)
  isPublic Boolean @default(false)

  // Tags for filtering
  tags String[] @default([])

  // Assignments
  assignments CardioSessionAssignment[]

  // Focus Mode logs
  sessionLogs CardioSessionLog[]

  // Team workout broadcasts
  teamWorkoutBroadcasts TeamWorkoutBroadcast[]

  // Voice workout creation
  voiceWorkoutSessions VoiceWorkoutSession[] @relation("CardioSessionVoiceWorkouts")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([sport])
  @@index([isPublic])
}

/// Assignment of cardio session to athlete
model CardioSessionAssignment {
  id String @id @default(uuid())

  session   CardioSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId String

  athlete   Client @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId String

  // Assignment details
  assignedDate DateTime @db.Date
  assignedBy   String // Coach user ID
  notes        String?  @db.Text

  // Status tracking
  status      AssignmentStatus @default(PENDING)
  completedAt DateTime?

  // Logged workout data
  actualDuration Int? // seconds
  actualDistance Float? // meters
  avgHeartRate   Int?
  actualSegments Json? // Logged segment data

  // Team broadcast tracking (null if individual assignment)
  teamBroadcastId String?
  teamBroadcast   TeamWorkoutBroadcast? @relation(fields: [teamBroadcastId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, athleteId, assignedDate])
  @@index([sessionId])
  @@index([athleteId])
  @@index([assignedDate])
  @@index([status])
  @@index([teamBroadcastId])
}

/// Cardio session log - tracks Focus Mode execution
model CardioSessionLog {
  id String @id @default(uuid())

  session   CardioSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId String

  athlete   Client @relation("AthleteCardioLogs", fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId String

  // Optional link to assignment if this was assigned
  assignmentId String?

  // Execution timing
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  // Overall session metrics
  status         AssignmentStatus @default(PENDING)
  actualDuration Int? // total seconds
  actualDistance Float? // total km
  avgHeartRate   Int?
  maxHeartRate   Int?

  // Segment logs
  segmentLogs CardioSegmentLog[]

  // Session feedback
  sessionRPE    Int? // 1-10
  notes         String? @db.Text
  focusModeUsed Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([athleteId])
  @@index([startedAt])
  @@index([status])
}

/// Per-segment log within a Cardio session
model CardioSegmentLog {
  id String @id @default(uuid())

  cardioSessionLog   CardioSessionLog @relation(fields: [cardioSessionLogId], references: [id], onDelete: Cascade)
  cardioSessionLogId String

  segmentIndex Int
  segmentType  CardioSegmentType

  // Planned values (copied from session definition)
  plannedDuration Int? // seconds
  plannedDistance Float? // km
  plannedPace     Int? // sec/km
  plannedZone     Int? // 1-5

  // Actual values logged
  actualDuration Int? // seconds
  actualDistance Float? // km
  actualPace     Int? // sec/km
  actualAvgHR    Int?
  actualMaxHR    Int?

  // Status
  completed Boolean @default(false)
  skipped   Boolean @default(false)
  notes     String?

  startedAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cardioSessionLogId])
  @@index([segmentIndex])
}

enum CardioSegmentType {
  WARMUP
  COOLDOWN
  INTERVAL
  STEADY
  RECOVERY
  HILL
  DRILLS
}

// ==================== NUTRITION TIMING SYSTEM ====================

/// Athlete dietary preferences for nutrition guidance personalization
model DietaryPreferences {
  id       String @id @default(uuid())
  clientId String @unique

  // Dietary style
  dietaryStyle String? // OMNIVORE | VEGETARIAN | VEGAN | PESCATARIAN | FLEXITARIAN

  // Allergies & intolerances (JSON arrays for flexibility)
  allergies    Json? // ["NUTS", "SHELLFISH", "DAIRY", "GLUTEN", "SOY", "EGGS", "FISH"]
  intolerances Json? // ["LACTOSE", "FRUCTOSE", "HISTAMINE"]

  // Food dislikes (for suggestion filtering)
  dislikedFoods Json? // ["oatmeal", "fish", "beans"]

  // Preferences
  preferLowFODMAP    Boolean @default(false)
  preferWholeGrain   Boolean @default(true)
  preferSwedishFoods Boolean @default(true) // Prioritize Swedish food suggestions

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
}

/// Athlete nutrition goals (weight, body composition, macro preferences)
model NutritionGoal {
  id       String @id @default(uuid())
  clientId String @unique

  // Weight goals
  goalType       String // WEIGHT_LOSS | WEIGHT_GAIN | MAINTAIN | BODY_RECOMP
  targetWeightKg Float?
  weeklyChangeKg Float? // Target weekly change: 0.25, 0.5, 0.75 kg/week
  targetDate     DateTime?

  // Body composition goals
  targetBodyFatPercent Float?

  // Macro preference (overrides sport-based defaults)
  macroProfile String? // BALANCED | HIGH_PROTEIN | LOW_CARB | ENDURANCE | STRENGTH

  // Activity level (for TDEE calculation)
  activityLevel String @default("ACTIVE") // SEDENTARY | LIGHTLY_ACTIVE | ACTIVE | VERY_ACTIVE | ATHLETE

  // Custom protein target (g per kg body weight, overrides calculated value)
  customProteinPerKg Float?

  // Display preferences
  showMacroTargets Boolean @default(true)
  showHydration    Boolean @default(true)

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
}

// ==================== MEAL LOGGING SYSTEM ====================

/// Meal type enum for categorizing meals
enum MealType {
  BREAKFAST
  MORNING_SNACK
  LUNCH
  AFTERNOON_SNACK
  PRE_WORKOUT
  POST_WORKOUT
  DINNER
  EVENING_SNACK
}

/// MealLog for tracking daily food intake
model MealLog {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Meal info
  date        DateTime @db.Date
  mealType    MealType
  time        String? // "08:30", "12:00" etc.
  description String // "Havregrynsgröt med banan och nötter"

  // Macros (optional - can be estimated or precise)
  calories     Int?
  proteinGrams Float?
  carbsGrams   Float?
  fatGrams     Float?
  fiberGrams   Float?

  // Hydration (optional)
  waterMl Int?

  // Meal quality indicators
  isHighProtein Boolean @default(false) // 20g+ protein
  isPreWorkout  Boolean @default(false)
  isPostWorkout Boolean @default(false)

  // Photo (optional - stored as URL)
  photoUrl String?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, date])
  @@index([date])
}

// ==================== VELOCITY-BASED TRAINING (VBT) SYSTEM ====================
// Purpose: Import and analyze data from VBT devices (Vmaxpro, Vitruve, GymAware)
// Added: 2025-12

/// VBT device types for data import
enum VBTDeviceType {
  VMAXPRO // Vmaxpro/Enode sensor
  VITRUVE // Vitruve encoder
  GYMAWARE // GymAware PowerTool
  PUSH // PUSH Band
  PERCH // Perch system
  TENDO // Tendo unit
  GENERIC // Unknown/generic CSV format
}

/// VBT session - container for uploaded training session data
model VBTSession {
  id       String  @id @default(uuid())
  clientId String
  coachId  String? // Coach who uploaded (null if athlete self-upload)

  // Session info
  sessionDate DateTime // Date/time of training session
  deviceType  VBTDeviceType @default(GENERIC)
  deviceName  String? // Device model/name from CSV
  fileName    String? // Original uploaded filename

  // Session summary (calculated from measurements)
  totalSets     Int @default(0)
  totalReps     Int @default(0)
  exerciseCount Int @default(0)

  // Notes and context
  notes      String? @db.Text
  sessionRPE Int? // Overall session RPE 1-10
  bodyWeight Float? // kg at time of session

  // Import metadata
  rawData     Json? // Original CSV data preserved
  parseErrors Json? // Any parsing errors encountered

  client       Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  measurements VBTMeasurement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([sessionDate])
  @@index([deviceType])
  @@index([clientId, sessionDate])
}

/// Individual VBT rep measurement from device
model VBTMeasurement {
  id         String  @id @default(uuid())
  sessionId  String
  exerciseId String? // Linked to our Exercise library (optional)

  // Exercise identification
  exerciseName    String // Exercise name from CSV
  exerciseMatched Boolean @default(false) // Whether auto-matched to Exercise

  // Set/rep info
  setNumber Int
  repNumber Int

  // Core velocity metrics (all in m/s)
  meanVelocity     Float? // Average velocity during concentric phase
  peakVelocity     Float? // Maximum velocity achieved
  meanVelocityDown Float? // Eccentric mean velocity (if tracked)
  peakVelocityDown Float? // Eccentric peak velocity (if tracked)

  // Power metrics (all in Watts)
  meanPower     Float? // Average power output
  peakPower     Float? // Maximum power output
  meanPowerDown Float? // Eccentric mean power
  peakPowerDown Float? // Eccentric peak power

  // Load and ROM
  load          Float? // Weight/load in kg
  rom           Float? // Range of motion in cm
  romPercentage Float? // ROM as % of max ROM for exercise

  // Time metrics (all in seconds)
  concentricTime Float? // Duration of concentric phase
  eccentricTime  Float? // Duration of eccentric phase
  totalRepTime   Float? // Total rep duration
  timeToPeakVel  Float? // Time to reach peak velocity

  // Velocity loss tracking (for fatigue monitoring)
  velocityLoss    Float? // % velocity loss from first rep in set
  velocityLossSet Float? // % velocity loss across entire set (last vs first)

  // Calculated metrics
  estimatedE1RM Float? // Estimated 1RM from load-velocity profile
  velocityZone  String? // "STRENGTH", "POWER", "SPEED", "SPEED_STRENGTH"
  repQuality    String? // "GOOD", "FATIGUE", "COMPENSATING", "FAILED"

  // Device-specific raw data
  rawMetrics Json? // Preserve all original metrics from device

  session  VBTSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exercise Exercise?  @relation(fields: [exerciseId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([exerciseId])
  @@index([exerciseName])
  @@index([sessionId, setNumber, repNumber])
  @@index([exerciseId, load])
}

/// Load-Velocity Profile for exercise-specific 1RM estimation
model LoadVelocityProfile {
  id         String @id @default(uuid())
  clientId   String
  exerciseId String

  // Profile data points (array of {load, velocity} pairs)
  dataPoints Json // [{load: 80, velocity: 0.55}, {load: 100, velocity: 0.35}, ...]

  // Linear regression coefficients (velocity = slope * load + intercept)
  slope     Float? // Negative value (velocity decreases with load)
  intercept Float? // y-intercept (theoretical 0-load velocity)
  rSquared  Float? // RÂ² goodness of fit

  // Calculated 1RM at different velocity thresholds
  e1RM_0_3  Float? // e1RM at 0.3 m/s (strength-speed)
  e1RM_0_2  Float? // e1RM at 0.2 m/s (typical 1RM velocity for most lifts)
  e1RM_0_15 Float? // e1RM at 0.15 m/s (true max, may fail)

  // Exercise-specific MVT (Minimum Velocity Threshold)
  mvt Float? // m/s - velocity at which exercise fails

  // Profile validity
  minLoad        Float? // Minimum load in profile
  maxLoad        Float? // Maximum load in profile
  loadRange      Float? // % of 1RM range covered
  dataPointCount Int     @default(0)
  isValid        Boolean @default(false) // Enough data points and good RÂ²

  // When this profile was last updated
  lastMeasurementAt DateTime?

  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, exerciseId])
  @@index([clientId])
  @@index([exerciseId])
  @@index([isValid])
}

// ==================== CALENDAR SYSTEM ====================

/// Calendar events for tracking non-training activities (travel, camps, illness, vacation)
model CalendarEvent {
  id       String @id @default(uuid())
  clientId String

  // Event basics
  type        CalendarEventType
  title       String
  description String?             @db.Text
  status      CalendarEventStatus @default(SCHEDULED)

  // Date/time
  startDate DateTime @db.Date
  endDate   DateTime @db.Date
  allDay    Boolean  @default(true)
  startTime String? // "HH:mm" if not all-day
  endTime   String? // "HH:mm" if not all-day

  // Training impact
  trainingImpact EventImpact @default(NO_TRAINING)
  impactNotes    String? // "Morning sessions only", etc.

  // Altitude-specific (when type = ALTITUDE_CAMP)
  altitude           Int? // meters above sea level
  adaptationPhase    AltitudeAdaptationPhase?
  seaLevelReturnDate DateTime? // When athlete returns to sea level

  // Illness-specific (when type = ILLNESS)
  illnessType          String? // "RESPIRATORY", "GI", "FEVER", etc.
  returnToTrainingDate DateTime?
  medicalClearance     Boolean   @default(false)

  // External calendar integration
  externalCalendarId   String? // ID in external system
  externalCalendarType String? // "GOOGLE", "OUTLOOK", "APPLE"
  externalCalendarName String? // "Work Calendar", etc.
  lastSyncedAt         DateTime?
  isReadOnly           Boolean   @default(false) // Imported events cannot be edited

  // Recurrence (future phase)
  isRecurring        Boolean @default(false)
  recurrenceRule     String? // iCal RRULE format
  recurrenceParentId String? // Link to parent event

  // Metadata
  createdById      String
  lastModifiedById String?
  color            String? // Custom color override

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client         Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy      User                  @relation("CreatedCalendarEvents", fields: [createdById], references: [id])
  lastModifiedBy User?                 @relation("ModifiedCalendarEvents", fields: [lastModifiedById], references: [id])
  changeHistory  CalendarEventChange[]

  @@index([clientId, startDate, endDate])
  @@index([clientId, type])
  @@index([externalCalendarId, externalCalendarType])
  @@index([createdById])
  @@index([status])
}

/// Change history for calendar events (for notifications and audit trail)
model CalendarEventChange {
  id       String  @id @default(uuid())
  eventId  String?
  clientId String

  // Change details
  changeType  String // EVENT_CREATED, EVENT_UPDATED, EVENT_DELETED, WORKOUT_RESCHEDULED, CONFLICT_DETECTED
  changedById String
  description String @db.Text

  // Snapshot data
  previousData Json? // Snapshot of old state
  newData      Json? // Snapshot of new state

  // Notification tracking
  notificationRead   Boolean   @default(false)
  notificationReadAt DateTime?

  createdAt DateTime @default(now())

  // Relations
  event     CalendarEvent? @relation(fields: [eventId], references: [id], onDelete: SetNull)
  client    Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  changedBy User           @relation("CalendarChanges", fields: [changedById], references: [id])

  @@index([clientId, notificationRead, createdAt])
  @@index([eventId])
  @@index([changedById])
}

/// External calendar connections (Google, Outlook, Apple iCal)
model ExternalCalendarConnection {
  id       String @id @default(uuid())
  clientId String

  // Provider info
  provider     String // GOOGLE, OUTLOOK, APPLE, ICAL_URL
  calendarName String // Display name
  calendarId   String // External calendar ID

  // OAuth tokens (Google/Outlook)
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?

  // iCal URL (Apple/generic)
  icalUrl String? @db.Text

  // Sync settings
  syncEnabled   Boolean   @default(true)
  lastSyncAt    DateTime?
  lastSyncError String?

  // Import settings
  importAsType  CalendarEventType @default(EXTERNAL_EVENT)
  defaultImpact EventImpact       @default(NORMAL)

  // Color coding
  color String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, provider, calendarId])
  @@index([clientId])
  @@index([provider])
}

// ==================== ERGOMETER FIELD TESTING SYSTEM ====================
// Purpose: Field tests for ergometer-based conditioning
// Supports: Wattbike, Concept2 Row/SkiErg/BikeErg, Assault/Air Bikes
// Primary users: Team sports (hockey, football, handball) and functional fitness (HYROX, CrossFit)

model ErgometerFieldTest {
  id            String                @id @default(uuid())
  clientId      String
  ergometerType ErgometerType
  testProtocol  ErgometerTestProtocol
  testDate      DateTime

  // Equipment Settings
  dragFactor       Int? // Concept2: 80-200 (Row: 110-130, Ski: 80-100)
  damperSetting    Int? // Concept2: 1-10
  airResistance    Int? // Wattbike: 1-10
  magnetResistance Int? // Wattbike: 1-4
  bikeBrand        String? // Air bike brand: ASSAULT, ECHO, SCHWINN (brand-agnostic storage)

  // Environmental Conditions
  conditions Json? // { temperature, humidity, altitude }

  // Raw Test Data (flexible JSON per protocol)
  rawData Json // Protocol-specific raw data

  // Derived Metrics - Power
  peakPower       Float? // Watts (instantaneous max)
  avgPower        Float? // Watts (test average)
  endPower        Float? // Watts (last 30s for CP tests)
  normalizedPower Float? // Watts (NP calculation)

  // Derived Metrics - Pace (Concept2 only)
  avgPace  Float? // seconds per 500m
  bestPace Float? // seconds per 500m (fastest split)

  // Derived Metrics - Critical Power Model
  criticalPower Float? // CP in Watts
  wPrime        Float? // W' in Joules (anaerobic work capacity)
  wPrimeKJ      Float? // W' in kJ (for display)

  // Derived Metrics - Distance/Time/Calories
  totalDistance Float? // meters
  totalTime     Float? // seconds
  totalCalories Float? // for Air Bike tests
  strokeRate    Float? // strokes/min or RPM

  // Heart Rate Data
  avgHR   Float? // bpm
  maxHR   Float? // bpm
  hrAtEnd Float? // bpm (threshold estimation)

  // Interval Test Data (4Ã—4min etc)
  intervalData Json? // Array of { avgPower, avgHR, duration }

  // Model Quality & Confidence
  r2         Float? // RÂ² for CP model fit (0-1)
  confidence String? // VERY_HIGH, HIGH, MEDIUM, LOW
  modelFit   String? // EXCELLENT, GOOD, FAIR, POOR

  // Validation
  valid    Boolean @default(true)
  warnings Json? // Array of warning strings
  errors   Json? // Array of error strings
  notes    String?
  rpe      Int? // 1-10 perceived exertion

  // Relationships
  client    Client   @relation("ClientErgometerTests", fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, ergometerType])
  @@index([clientId, testDate])
  @@index([ergometerType, testProtocol])
  @@index([confidence, valid])
}

model ErgometerThreshold {
  id            String        @id @default(uuid())
  clientId      String
  ergometerType ErgometerType

  // Source test reference
  sourceTestId String? // ErgometerFieldTest ID
  sourceMethod String // CP_MODEL, FTP_TEST, MAP_RAMP, TT_BASED, INTERVAL_TEST

  // Critical Power Model Parameters
  criticalPower Float? // CP in Watts
  wPrime        Float? // W' in Joules
  wPrimeKJ      Float? // W' in kJ

  // FTP-based (Wattbike mainly)
  ftp                 Float? // Functional Threshold Power
  ftpCorrectionFactor Float? // 0.90 for non-cyclists, 0.95 for cyclists

  // MAP-based
  mapWatts Float? // Maximal Aerobic Power

  // Peak Power
  peakPower         Float? // Peak power (6s or 30s)
  peakPowerDuration String? // 6S, 30S, 7_STROKE

  // HR at threshold
  thresholdHR Float? // bpm at CP/FTP

  // Pace (Concept2 only)
  thresholdPace Float? // sec/500m at threshold

  // Validity
  testDate   DateTime
  expiresAt  DateTime? // Suggest retest after 8-12 weeks
  confidence String? // VERY_HIGH, HIGH, MEDIUM, LOW
  valid      Boolean   @default(true)

  // Relationships
  client    Client          @relation("ClientErgometerThresholds", fields: [clientId], references: [id], onDelete: Cascade)
  zones     ErgometerZone[] @relation("ThresholdZones")
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([clientId, ergometerType])
  @@index([clientId, ergometerType])
  @@index([testDate])
}

model ErgometerZone {
  id            String        @id @default(uuid())
  clientId      String
  ergometerType ErgometerType

  // Zone definition (1-6 standard, 1-7 for detailed)
  zone        Int // 1-6 (or 1-7)
  name        String // Recovery, Endurance, Tempo, Threshold, VO2max, Anaerobic
  nameSwedish String // Ã…terhÃ¤mtning, UthÃ¥llighet, Tempo, TrÃ¶skel, VO2max, Anaerob

  // Power targets
  powerMin   Float // Watts (lower bound)
  powerMax   Float // Watts (upper bound)
  percentMin Float // % of CP/FTP (lower)
  percentMax Float // % of CP/FTP (upper)

  // Pace targets (Concept2 only) - note: lower pace = faster
  paceMin Float? // sec/500m (faster, lower number)
  paceMax Float? // sec/500m (slower, higher number)

  // HR targets (optional)
  hrMin Float? // bpm (lower)
  hrMax Float? // bpm (upper)

  // Training application
  description        String // Training effect/application
  descriptionSwedish String? // Swedish description
  typicalDuration    String? // Typical interval duration (e.g., "4-8 min")

  // Source
  sourceThresholdId String
  calculationMethod String // CP_BASED, FTP_BASED, MAP_BASED, TT_BASED

  // Relationships
  client          Client             @relation("ClientErgometerZones", fields: [clientId], references: [id], onDelete: Cascade)
  sourceThreshold ErgometerThreshold @relation("ThresholdZones", fields: [sourceThresholdId], references: [id], onDelete: Cascade)
  createdAt       DateTime           @default(now())

  @@index([clientId, ergometerType])
  @@index([zone])
  @@index([sourceThresholdId])
}

model ErgometerBenchmark {
  id            String                @id @default(uuid())
  ergometerType ErgometerType
  testProtocol  ErgometerTestProtocol
  sport         SportType? // NULL = general, or specific sport context
  gender        String // MALE, FEMALE
  tier          String // ELITE, ADVANCED, INTERMEDIATE, BEGINNER

  // Benchmark values - Power
  powerMin Float? // Watts (lower bound for tier)
  powerMax Float? // Watts (upper bound for tier)

  // Benchmark values - Pace (Concept2)
  paceMin Float? // sec/500m (faster, lower = better)
  paceMax Float? // sec/500m (slower)

  // Benchmark values - Time (for TT tests)
  timeMin Float? // seconds (faster, lower = better)
  timeMax Float? // seconds (slower)

  // Benchmark values - Calories (Air Bike)
  caloriesMin Float? // calories (lower bound)
  caloriesMax Float? // calories (upper bound)

  // Relative benchmarks
  wattsPerKg Float? // W/kg (relative power)

  // Metadata
  description        String? // Description of benchmark tier
  descriptionSwedish String? // Swedish description
  source             String? // Reference source for benchmark data

  createdAt DateTime @default(now())

  @@unique([ergometerType, testProtocol, sport, gender, tier])
  @@index([ergometerType, gender, tier])
  @@index([sport, gender])
}

// ============================================
// DEEP RESEARCH SYSTEM
// Added: 2026-01
// Purpose: AI-powered autonomous research with budget management
// ============================================

/// Provider for deep research operations
enum DeepResearchProvider {
  GEMINI // Gemini Deep Research (Interactions API)
  OPENAI_QUICK // GPT-5 Mini + web_search
  OPENAI_STANDARD // GPT-5.2 Thinking + web_search
  OPENAI_DEEP // o4-mini-deep-research
  OPENAI_EXPERT // o3-deep-research
  LANGCHAIN // LangChain open_deep_research (future)
}

/// Status for deep research sessions
enum DeepResearchStatus {
  PENDING // Created, not started
  RUNNING // Research in progress
  COMPLETED // Research finished successfully
  FAILED // Research failed
  CANCELLED // User cancelled
  TIMEOUT // Exceeded max duration
}

/// Deep Research sessions
model DeepResearchSession {
  id        String  @id @default(uuid())
  coachId   String
  athleteId String? // Optional - for athlete-specific research

  // Configuration
  provider         DeepResearchProvider
  query            String               @db.Text
  systemPrompt     String?              @db.Text
  contextDocuments String[]             @default([]) // CoachDocument IDs
  athleteContext   Json? // Snapshot of athlete data at research time

  // Progress tracking
  status          DeepResearchStatus @default(PENDING)
  startedAt       DateTime?
  completedAt     DateTime?
  progressPercent Int? // 0-100
  progressMessage String? // Human-readable status
  currentStep     String? // "searching", "analyzing", "synthesizing"

  // External tracking (provider-specific)
  externalJobId String? // Gemini interaction ID or OpenAI response ID

  // Results
  report    String? @db.Text // Final markdown report
  sources   Json? // Array of source citations
  reasoning String? @db.Text // Chain of thought (if available)

  // Document integration
  savedDocumentId String?        @unique // Link to CoachDocument if saved
  savedDocument   CoachDocument? @relation("ResearchDocument", fields: [savedDocumentId], references: [id], onDelete: SetNull)

  // Athlete sharing
  sharedWithAthletes String[] @default([]) // Client IDs with access
  isPublicToAthlete  Boolean  @default(false) // Share with linked athlete automatically

  // Usage & costs
  tokensUsed      Int?
  estimatedCost   Float? // USD
  searchQueries   Int? // Number of web searches performed
  sourcesAnalyzed Int? // Number of sources analyzed

  // Error handling
  errorMessage String?
  errorCode    String?
  retryCount   Int     @default(0)

  // Relationships
  coach           User                   @relation("CoachResearchSessions", fields: [coachId], references: [id], onDelete: Cascade)
  athlete         Client?                @relation("AthleteResearchSessions", fields: [athleteId], references: [id], onDelete: SetNull)
  progressUpdates DeepResearchProgress[]
  sharedAccess    SharedResearchAccess[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([athleteId])
  @@index([status])
  @@index([provider])
  @@index([externalJobId])
  @@index([createdAt])
}

/// Progress updates for deep research (for SSE streaming)
model DeepResearchProgress {
  id        String @id @default(uuid())
  sessionId String

  timestamp DateTime @default(now())
  step      String // "initializing", "searching", "reading", "analyzing", "synthesizing"
  message   String // Human-readable progress message
  percent   Int? // 0-100
  metadata  Json? // Additional step-specific data

  session DeepResearchSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
}

/// Shared research access for athletes
model SharedResearchAccess {
  id        String   @id @default(uuid())
  sessionId String
  clientId  String
  sharedAt  DateTime @default(now())
  notified  Boolean  @default(false) // Email notification sent

  session DeepResearchSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  client  Client              @relation("SharedResearchAccess", fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([sessionId, clientId])
  @@index([clientId])
  @@index([sharedAt])
}

/// AI usage budget management per coach
model AIUsageBudget {
  id     String @id @default(uuid())
  userId String @unique

  // Monthly limits (in USD)
  monthlyBudget Float? // null = unlimited

  // Current period tracking
  periodStart DateTime @default(now())
  periodSpent Float    @default(0)

  // Alerts
  alertThreshold Float   @default(0.8) // Alert at 80% of budget
  alertSent      Boolean @default(false)

  // Category-specific limits (optional granularity)
  researchBudget Float? // Specific limit for deep research
  chatBudget     Float? // Specific limit for AI chat

  user User @relation("UserAIBudget", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([periodStart])
}

/// AI usage logging for cost tracking
model AIUsageLog {
  id     String @id @default(uuid())
  userId String

  category String // "research", "chat", "embedding"
  provider String // "GEMINI", "OPENAI", "ANTHROPIC"
  model    String // Specific model used

  inputTokens   Int
  outputTokens  Int
  estimatedCost Float // USD

  // Link to source (optional)
  researchSessionId String?
  conversationId    String?

  user User @relation("UserAIUsageLogs", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([category])
  @@index([provider])
  @@index([createdAt])
}

// ==================== MULTI-PART PROGRAM GENERATION ====================

/// Status for multi-part program generation sessions
enum ProgramGenerationStatus {
  PENDING // Created, not started
  GENERATING_OUTLINE // Creating program structure
  GENERATING_PHASE // Generating a phase
  MERGING // Merging all phases
  COMPLETED // Generation finished successfully
  FAILED // Generation failed
}

/// Multi-part program generation sessions
/// Splits long programs (>8 weeks) into phases and generates each sequentially
model ProgramGenerationSession {
  id             String  @id @default(uuid())
  coachId        String
  conversationId String?

  // Request configuration
  query          String  @db.Text // Original request/prompt
  totalWeeks     Int // Target program length
  sport          String // Primary sport
  methodology    String? // POLARIZED, NORWEGIAN, etc.
  athleteContext Json? // Snapshot of athlete data
  athleteId      String? // Target athlete (optional)

  // Progress tracking
  status          ProgramGenerationStatus @default(PENDING)
  currentPhase    Int                     @default(0)
  totalPhases     Int                     @default(1)
  progressPercent Int                     @default(0) // 0-100
  progressMessage String? // Human-readable status

  // Generation results (phases stored as they complete)
  programOutline Json? // Initial outline with phase structure
  phases         Json[] @default([]) // Completed phases
  mergedProgram  Json? // Final merged program

  // AI model configuration
  modelUsed String? // Model used for generation
  provider  String? // ANTHROPIC, GOOGLE, OPENAI

  // Timing
  startedAt   DateTime?
  completedAt DateTime?

  // Error handling & retries
  errorMessage String?
  errorCode    String?
  retryCount   Int       @default(0)
  lastRetryAt  DateTime?

  // Usage tracking
  totalTokensUsed Int   @default(0)
  estimatedCost   Float @default(0)

  // Relationships
  coach           User                        @relation("CoachProgramGenSessions", fields: [coachId], references: [id], onDelete: Cascade)
  conversation    AIConversation?             @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  progressUpdates ProgramGenerationProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([conversationId])
  @@index([status])
  @@index([createdAt])
}

/// Progress updates for program generation (for SSE streaming)
model ProgramGenerationProgress {
  id        String @id @default(uuid())
  sessionId String

  timestamp   DateTime @default(now())
  step        String // "outline", "phase_1", "phase_2", "merging", etc.
  message     String // Human-readable progress message
  percent     Int? // 0-100
  phaseNumber Int? // Which phase (1, 2, 3...)
  metadata    Json? // Additional step-specific data (e.g., phase preview)

  session ProgramGenerationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
}

// ==================== CONVERSATIONAL MEMORY SYSTEM ====================
// Purpose: AI remembers important facts from conversations with athletes
// Enables personalized, relationship-building AI interactions

/// Individual memory items extracted from conversations
model ConversationMemory {
  id       String @id @default(uuid())
  clientId String

  // Memory content
  memoryType String // INJURY_MENTION, GOAL_STATEMENT, PREFERENCE, LIFE_EVENT, etc.
  category   String? // Sub-category: "injury", "goal", "preference", "life_event"
  content    String  @db.Text // "Mentioned knee discomfort after long runs"
  context    String? @db.Text // Additional context if needed

  // Importance and lifecycle
  importance  Int       @default(3) // 1-5 for retrieval priority
  extractedAt DateTime  @default(now())
  expiresAt   DateTime? // Some memories fade (e.g., temporary injury)

  // Source tracking
  sourceMessageId String? // Link to original AI message if available

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client Client @relation("ClientMemories", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, memoryType])
  @@index([clientId, importance])
  @@index([clientId, expiresAt])
}

/// Weekly conversation summaries for context
model ConversationSummary {
  id       String @id @default(uuid())
  clientId String

  // Time period
  weekStart DateTime @db.Date // Monday of the week
  weekEnd   DateTime @db.Date // Sunday of the week

  // AI-generated content
  summary   String   @db.Text // Summary of week's conversations
  keyTopics String[] @default([]) // ["recovery", "nutrition", "race prep"]
  sentiment String? // "positive", "neutral", "concerned", "frustrated"

  // Extracted highlights
  highlights String[] @default([]) // Key achievements or positive moments
  concerns   String[] @default([]) // Issues raised by athlete

  // Metadata
  messageCount Int @default(0) // Number of messages summarized

  createdAt DateTime @default(now())

  // Relations
  client Client @relation("ClientConversationSummaries", fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, weekStart])
  @@index([clientId, weekStart])
}

/// AI-generated daily briefings for athletes
model AIBriefing {
  id       String @id @default(uuid())
  clientId String

  // Briefing content
  briefingType String   @default("MORNING") // MORNING, PRE_WORKOUT, POST_WORKOUT, WEEKLY_RECAP
  title        String // "God morgon Henrik!"
  content      String   @db.Text // Full briefing text
  highlights   String[] @default([]) // Key points as bullet items

  // Structured data for UI
  readinessScore Float? // Today's readiness if available
  todaysWorkout  String? // Brief workout summary
  alerts         Json? // { type: "warning" | "info", message: string }[]
  quickActions   Json? // { label: string, action: string }[]

  // Delivery
  scheduledFor DateTime // When to show the briefing
  deliveredAt  DateTime? // When actually shown to user
  readAt       DateTime? // When user engaged with it
  dismissedAt  DateTime? // When user dismissed

  // Generation metadata
  modelUsed   String? // AI model used for generation
  generatedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client Client @relation("ClientBriefings", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, scheduledFor])
  @@index([clientId, briefingType, scheduledFor])
  @@index([clientId, readAt])
}

/// Proactive AI notifications and nudges
model AINotification {
  id       String @id @default(uuid())
  clientId String

  // Notification type and priority
  notificationType String // PRE_WORKOUT, PATTERN_ALERT, MILESTONE, RECOVERY_CHECK, WEATHER_ALERT
  priority         String @default("NORMAL") // LOW, NORMAL, HIGH, URGENT

  // Content
  title       String
  message     String  @db.Text
  icon        String? // Emoji or icon name
  actionUrl   String? // Deep link if applicable
  actionLabel String? // "Se detaljer", "Chatta med AI"

  // Context data
  contextData Json? // Additional data for the notification

  // Trigger info
  triggeredBy   String? // "cron", "event", "pattern_detection"
  triggerReason String? // Human-readable explanation

  // Delivery status
  scheduledFor  DateTime? // For scheduled notifications
  deliveredAt   DateTime?
  readAt        DateTime?
  dismissedAt   DateTime?
  actionTakenAt DateTime? // If user clicked action

  // Expiry
  expiresAt DateTime? // Auto-dismiss after this time

  createdAt DateTime @default(now())

  // Relations
  client Client @relation("ClientAINotifications", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, createdAt])
  @@index([clientId, notificationType])
  @@index([clientId, readAt])
  @@index([clientId, expiresAt])
}

/// AI notification preferences per athlete
model AINotificationPreferences {
  id       String @id @default(uuid())
  clientId String @unique

  // Feature toggles
  morningBriefingEnabled  Boolean @default(true)
  preWorkoutNudgeEnabled  Boolean @default(true)
  postWorkoutCheckEnabled Boolean @default(true)
  patternAlertsEnabled    Boolean @default(true)
  milestoneAlertsEnabled  Boolean @default(true)
  weatherAlertsEnabled    Boolean @default(false)

  // Timing preferences
  morningBriefingTime String @default("07:00") // HH:mm format
  preWorkoutLeadTime  Int    @default(120) // Minutes before workout
  timezone            String @default("Europe/Stockholm")

  // Communication style
  verbosityLevel  String @default("NORMAL") // BRIEF, NORMAL, DETAILED
  motivationStyle String @default("BALANCED") // SUPPORTIVE, BALANCED, DIRECT

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client Client @relation("ClientAINotificationPrefs", fields: [clientId], references: [id], onDelete: Cascade)
}

// ============================================================================
// COACH-AI COLLABORATION SYSTEM
// ============================================================================

/// Alerts generated by AI for coaches about athletes needing attention
model CoachAlert {
  id       String @id @default(uuid())
  coachId  String // Coach's user ID
  clientId String // Athlete's client ID

  // Alert classification
  alertType   String // READINESS_DROP, MISSED_CHECKINS, MISSED_WORKOUTS, PAIN_MENTION, HIGH_ACWR
  severity    String // LOW, MEDIUM, HIGH, CRITICAL
  title       String
  message     String  @db.Text
  contextData Json? // Additional structured data
  sourceId    String? // Link to source record (ConversationMemory.id, etc.)

  // Status tracking
  status      String    @default("ACTIVE") // ACTIVE, DISMISSED, RESOLVED, ACTIONED
  dismissedAt DateTime?
  resolvedAt  DateTime?
  actionedAt  DateTime?
  actionNote  String?   @db.Text

  // Timestamps
  createdAt DateTime  @default(now())
  expiresAt DateTime? // Auto-expire old alerts

  // Relations
  client Client @relation("ClientCoachAlerts", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([coachId, status])
  @@index([coachId, createdAt])
  @@index([clientId])
  @@index([alertType])
  @@index([severity])
}

// ==================== LIVE HR STREAMING SYSTEM ====================

/// Live HR monitoring session - coach creates to start monitoring athletes in real-time
model LiveHRSession {
  id      String @id @default(uuid())
  coachId String
  coach   User   @relation("CoachLiveHRSessions", fields: [coachId], references: [id])

  name   String? // Optional session name
  teamId String? // Optional: monitor a team
  team   Team?   @relation(fields: [teamId], references: [id])

  status    String    @default("ACTIVE") // ACTIVE, PAUSED, ENDED
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  participants LiveHRParticipant[]

  @@index([coachId])
  @@index([teamId])
  @@index([status])
}

/// Athletes participating in a live HR monitoring session
model LiveHRParticipant {
  id        String        @id @default(uuid())
  sessionId String
  session   LiveHRSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  clientId  String
  client    Client        @relation(fields: [clientId], references: [id])

  joinedAt    DateTime  @default(now())
  lastReading DateTime?

  readings LiveHRReading[]

  @@unique([sessionId, clientId])
  @@index([sessionId])
  @@index([clientId])
}

/// Individual HR readings pushed by athletes during live sessions
model LiveHRReading {
  id            String            @id @default(uuid())
  participantId String
  participant   LiveHRParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  heartRate Int // BPM
  timestamp DateTime @default(now())

  zone     Int? // 1-5 calculated from athlete's zones
  deviceId String? // Future: identify source device

  @@index([participantId, timestamp])
}

// ==================== HABIT FORMATION SYSTEM ====================

/// Habits for behavior tracking and formation (gym attendance, nutrition, sleep, etc.)
model Habit {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  name       String // e.g., "Drink 2L water", "Go to gym"
  category   HabitCategory
  frequency  HabitFrequency
  targetDays Int[] // For SPECIFIC_DAYS: [1,3,5] = Mon, Wed, Fri; For X_TIMES_WEEK: [3] = 3 times/week
  targetTime String? // Optional time of day: "morning", "evening", specific time

  // Habit loop (based on behavioral science)
  trigger String? // What triggers the habit? "After waking up", "Before lunch"
  routine String? // The actual behavior
  reward  String? // The reward/benefit

  // Streak tracking
  currentStreak    Int @default(0)
  longestStreak    Int @default(0)
  totalCompletions Int @default(0)

  // Status
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  archivedAt DateTime?

  // Relations
  logs HabitLog[]

  @@index([clientId, isActive])
  @@index([category])
}

/// Daily log entries for habit completion
model HabitLog {
  id      String @id @default(cuid())
  habitId String
  habit   Habit  @relation(fields: [habitId], references: [id], onDelete: Cascade)

  date      DateTime @db.Date
  completed Boolean
  note      String? // Optional note for the day
  value     Float? // For quantifiable habits (e.g., 8 glasses of water)

  createdAt DateTime @default(now())

  @@unique([habitId, date])
  @@index([date])
}

// ==================== TEAM SPORTS - MATCH SCHEDULE ====================

/// External match schedule integration for team sports (hockey, football, etc.)
model ExternalMatchSchedule {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Match details
  externalMatchId String // ID from external source (league API, team app)
  opponent        String // Opponent team name
  isHome          Boolean // Home or away game
  scheduledDate   DateTime // Match date and time
  venue           String? // Arena/stadium name

  // Competition info
  competition String? // League name, cup name, etc.
  matchday    Int? // Round/matchday number

  // Post-match data
  result         String? // "3-2", "W 4-1", etc.
  minutesPlayed  Float? // Player's ice time / minutes on field
  goals          Int? // Goals scored
  assists        Int? // Assists
  plusMinus      Int? // +/- for hockey
  penaltyMinutes Int? // PIM for hockey

  // GPS/tracking data (for football)
  distanceKm     Float? // Total distance covered
  sprintDistance Float? // High-speed running distance
  maxSpeed       Float? // Max speed achieved (km/h)

  // Calendar integration
  calendarEventId String? // Link to CalendarEvent if synced

  // Source tracking
  externalSource String   @default("manual") // "manual", "hockey_app", "swehockey", "fogis", "gps_provider"
  lastSyncedAt   DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, externalMatchId, externalSource])
  @@index([clientId, scheduledDate])
  @@index([externalSource])
}

// ==================== SPORT-SPECIFIC TEST RESULTS ====================

/// Unified model for all sport-specific physical tests (power, speed, agility, strength, etc.)
model SportTest {
  id       String   @id @default(uuid())
  clientId String
  userId   String
  testDate DateTime

  // Test categorization
  category SportTestCategory
  protocol SportTestProtocol
  sport    SportType? // Optional sport context for benchmarking

  // Environmental conditions (JSON: temperature, humidity, surface, wind, etc.)
  conditions Json?

  // Raw test data (protocol-specific JSON structure)
  rawData Json

  // Primary result (main metric for this test type)
  primaryResult Float? // e.g., jump height (cm), sprint time (s), weight (kg)
  primaryUnit   String? // cm, s, kg, m/s, W, km/h, etc.

  // Secondary result (if applicable)
  secondaryResult Float? // e.g., contact time for DJ, reps for estimated 1RM
  secondaryUnit   String?

  // Power-specific derived metrics
  peakPower     Float? // Peak power in Watts
  avgPower      Float? // Average power in Watts
  relativePower Float? // Power per kg (W/kg)

  // Speed-specific derived metrics
  splits       Json? // Array of split times for sprint tests
  acceleration Float? // Acceleration in m/s²
  maxVelocity  Float? // Maximum velocity in m/s

  // Endurance-specific derived metrics
  estimatedVO2max Float? // Estimated VO2max from Yo-Yo/Beep test
  distance        Float? // Total distance covered (m)
  level           Float? // Yo-Yo/Beep test level achieved

  // Benchmarking results
  benchmarkTier String? // ELITE, ADVANCED, INTERMEDIATE, BEGINNER
  percentile    Float? // 0-100 percentile ranking
  positionRank  String? // Position-specific ranking (for team sports)

  // Validation
  valid    Boolean @default(true)
  warnings Json? // Array of warning messages
  notes    String? // Tester notes

  // Attempt tracking (for tests with multiple attempts)
  attemptNumber Int? // Which attempt this was (1, 2, 3...)
  bestAttempt   Boolean @default(false) // Is this the best attempt?

  // Link to existing ergometer test if applicable
  ergometerTestId String? @unique

  // Relations
  client Client @relation("ClientSportTests", fields: [clientId], references: [id], onDelete: Cascade)
  user   User   @relation("UserSportTests", fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, testDate])
  @@index([category, protocol])
  @@index([sport, category])
  @@index([clientId, protocol])
  @@index([benchmarkTier])
}

/// Benchmark reference data for sport-specific tests
model SportTestBenchmark {
  id       String            @id @default(uuid())
  protocol SportTestProtocol
  sport    SportType? // NULL = general benchmark, otherwise sport-specific
  gender   String // MALE, FEMALE

  // Position-specific benchmarks (for team sports)
  position String? // GK, DEF, MID, FWD, WING, BACK, CENTER, etc.

  // Age group (optional)
  ageGroupMin Int? // Minimum age for this benchmark
  ageGroupMax Int? // Maximum age for this benchmark

  // Tier classification
  tier String // ELITE, ADVANCED, INTERMEDIATE, BEGINNER

  // Benchmark thresholds
  valueMin Float? // Lower bound for this tier
  valueMax Float? // Upper bound for this tier
  unit     String // cm, s, kg, W, W/kg, m, level, etc.

  // Descriptive information
  description        String? // English description
  descriptionSwedish String? // Swedish description
  source             String? // Reference source (research paper, organization)

  createdAt DateTime @default(now())

  @@unique([protocol, sport, gender, position, tier, ageGroupMin])
  @@index([protocol, gender, tier])
  @@index([sport, protocol])
}

// ============================================
// AD-HOC WORKOUT LOGGING SYSTEM
// ============================================

/// Input method for ad-hoc workout logging
enum AdHocInputType {
  PHOTO           // Photo of whiteboard/paper
  SCREENSHOT      // Screenshot from app/website
  VOICE           // Voice recording
  TEXT            // Free-form text input
  STRAVA_IMPORT   // Imported from Strava activity
  GARMIN_IMPORT   // Imported from Garmin activity
  CONCEPT2_IMPORT // Imported from Concept2
  MANUAL_FORM     // Structured manual entry form
}

/// Processing status for ad-hoc workout
enum AdHocWorkoutStatus {
  PENDING          // Just created, awaiting AI parsing
  PROCESSING       // AI is parsing
  READY_FOR_REVIEW // Parsed, athlete needs to confirm
  CONFIRMED        // Athlete confirmed, workout created
  FAILED           // Parsing failed
}

/// Ad-hoc workout entry - captures workouts done outside of training programs
model AdHocWorkout {
  id        String @id @default(cuid())
  athleteId String

  // Input tracking
  inputType   AdHocInputType
  inputDate   DateTime         @default(now()) // When they captured it
  workoutDate DateTime                          // When they did the workout
  workoutName String?                           // Optional name for the workout

  // Raw input storage
  rawInputUrl      String?  // Photo/voice file URL (Supabase storage)
  rawInputText     String?  @db.Text // Transcription or typed text
  rawInputMetadata Json?    // External import raw data

  // AI parsing results
  parsedType        WorkoutType?
  parsedStructure   Json?    // Full workout structure (ParsedWorkout JSON)
  parsingModel      String?  // "gemini-3-flash", "gemini-3-pro", etc.
  parsingConfidence Float?
  parsingError      String?  @db.Text // If parsing failed

  // Athlete review
  status          AdHocWorkoutStatus @default(PENDING)
  athleteReviewed Boolean            @default(false)
  athleteEdits    Json?              // What they changed from AI interpretation

  // Link to created workout (after confirmation)
  createdWorkoutId String?  @unique
  createdWorkout   Workout? @relation("AdHocSourceWorkout", fields: [createdWorkoutId], references: [id])

  // Training load reference (created after confirmation)
  trainingLoadId String?

  // Relations
  athlete Client @relation("ClientAdHocWorkouts", fields: [athleteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([athleteId])
  @@index([workoutDate])
  @@index([status])
  @@index([athleteId, status])
}

// ==================== ADMIN SYSTEM - ENTERPRISE CONTRACTS ====================

/// Enterprise contract for business customers
model EnterpriseContract {
  id         String   @id @default(uuid())
  businessId String   @unique
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Contract info
  contractNumber String @unique // EC-2026-001
  contractName   String
  contactName    String
  contactEmail   String
  contactPhone   String?

  // Pricing
  monthlyFee          Float
  currency            String @default("SEK")
  revenueSharePercent Float  @default(75) // Business gets this %

  // Limits
  athleteLimit Int @default(-1) // -1 = unlimited
  coachLimit   Int @default(-1)

  // Terms
  billingCycle     String    @default("MONTHLY") // MONTHLY, QUARTERLY, YEARLY
  paymentTermDays  Int       @default(30)
  startDate        DateTime
  endDate          DateTime?
  autoRenew        Boolean   @default(true)
  noticePeriodDays Int       @default(90)

  // Status
  status EnterpriseContractStatus @default(DRAFT)

  // Features (JSON for flexibility)
  customFeatures Json?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  activatedAt DateTime?
  cancelledAt DateTime?

  changeHistory EnterpriseContractChange[]

  @@index([status])
  @@index([endDate])
}

/// Audit trail for enterprise contract changes
model EnterpriseContractChange {
  id         String             @id @default(uuid())
  contractId String
  contract   EnterpriseContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  changeType  String // CREATED, UPDATED, ACTIVATED, RENEWED, CANCELLED, SUSPENDED
  changedById String
  changedBy   User   @relation("ContractChanges", fields: [changedById], references: [id])

  previousData Json?
  newData      Json?
  notes        String? @db.Text

  createdAt DateTime @default(now())

  @@index([contractId, createdAt])
}

// ==================== ADMIN SYSTEM - PRICING MANAGEMENT ====================

/// Pricing tier configuration
model PricingTier {
  id String @id @default(uuid())

  tierType    String // COACH, ATHLETE
  tierName    String // FREE, BASIC, PRO, ENTERPRISE, STANDARD
  displayName String
  description String? @db.Text
  features    Json // ["Feature 1", "Feature 2", ...]

  // Pricing (in smallest currency unit, e.g., öre for SEK)
  monthlyPriceCents Int
  yearlyPriceCents  Int?
  currency          String @default("SEK")

  // Stripe
  stripeProductId      String?
  stripePriceIdMonthly String?
  stripePriceIdYearly  String?

  // Limits
  maxAthletes  Int @default(0)
  aiChatLimit  Int @default(0)

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  overrides PricingOverride[]

  @@unique([tierType, tierName])
  @@index([tierType, isActive])
}

/// Business-specific pricing overrides
model PricingOverride {
  id         String      @id @default(uuid())
  tierId     String
  tier       PricingTier @relation(fields: [tierId], references: [id], onDelete: Cascade)
  businessId String
  business   Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Overrides (null = use default)
  monthlyPriceCents Int?
  yearlyPriceCents  Int?
  maxAthletes       Int?
  aiChatLimit       Int?

  validFrom  DateTime  @default(now())
  validUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tierId, businessId])
}

// ==================== ADMIN SYSTEM - MONITORING ====================

/// System errors tracked for monitoring
model SystemError {
  id String @id @default(uuid())

  level   String  @default("ERROR") // ERROR, WARN, CRITICAL
  message String  @db.Text
  stack   String? @db.Text

  // Context
  userId     String?
  route      String?
  method     String?
  statusCode Int?
  userAgent  String?

  // Sentry link
  sentryEventId String?

  metadata Json?

  // Resolution
  isResolved   Boolean   @default(false)
  resolvedAt   DateTime?
  resolvedById String?
  resolvedBy   User?     @relation("ResolvedErrors", fields: [resolvedById], references: [id])

  createdAt DateTime @default(now())

  @@index([level, createdAt])
  @@index([isResolved, createdAt])
  @@index([route])
}

/// System metrics for dashboard
model SystemMetric {
  id String @id @default(uuid())

  metricName String // active_users, api_requests, error_rate, avg_response_time
  value      Float
  unit       String? // count, ms, percent

  dimensions Json? // { route: '/api/...', method: 'GET' }

  timestamp DateTime @default(now())

  @@index([metricName, timestamp])
}

// ==================== DATA MOAT SYSTEM ====================
// Platform-wide data collection for competitive advantage
// Applies to all customers - individual coaches, teams, and enterprise businesses

// ===== DATA MOAT ENUMS =====

enum AISuggestionType {
  WORKOUT
  ZONE_CALCULATION
  PROGRAM_PERIODIZATION
  RECOVERY_RECOMMENDATION
  LOAD_ADJUSTMENT
  EXERCISE_SELECTION
  INTENSITY_PRESCRIPTION
  VOLUME_PRESCRIPTION
  TAPER_PLAN
  OTHER
}

enum DecisionReason {
  ATHLETE_FEEDBACK
  FATIGUE_OBSERVED
  HRV_LOW
  SLEEP_POOR
  INJURY_CONCERN
  SCHEDULE_CONFLICT
  PROGRESSION_ADJUSTMENT
  WEATHER_CONDITIONS
  EQUIPMENT_UNAVAILABLE
  COACH_INTUITION
  ATHLETE_PREFERENCE
  TECHNIQUE_FOCUS
  MENTAL_FRESHNESS
  TRAVEL_FATIGUE
  ILLNESS_RECOVERY
  COMPETITION_PROXIMITY
  OTHER
}

enum OutcomeAssessment {
  BETTER_THAN_AI
  SAME_AS_AI
  WORSE_THAN_AI
  UNKNOWN
}

enum PredictionType {
  RACE_TIME
  THRESHOLD_POWER
  THRESHOLD_PACE
  THRESHOLD_HEART_RATE
  VO2MAX_ESTIMATE
  INJURY_RISK
  READINESS_SCORE
  RECOVERY_TIME
  IMPROVEMENT_RATE
  PEAK_TIMING
  OPTIMAL_TAPER
  FTP_ESTIMATE
  CRITICAL_POWER
  WEIGHT_PREDICTION
  BODY_COMPOSITION
}

enum PredictionUserAction {
  ACCEPTED
  IGNORED
  MODIFIED
  REJECTED
}

enum ValidationSource {
  AUTO_STRAVA_IMPORT
  AUTO_GARMIN_IMPORT
  AUTO_RACE_RESULT
  AUTO_TEST_RESULT
  MANUAL_ENTRY
  DEVICE_SYNC
}

// ===== DATA MOAT MODELS =====

/// Tracks when coaches modify AI suggestions - captures expertise for AI improvement
model CoachDecision {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  coach     User     @relation("CoachDecisions", fields: [coachId], references: [id])
  coachId   String
  athlete   Client   @relation("AthleteDecisions", fields: [athleteId], references: [id])
  athleteId String

  // AI Suggestion
  aiSuggestionType     AISuggestionType
  aiSuggestionData     Json      // Full AI suggestion
  aiConfidence         Float?    // AI's confidence (0-1)

  // Modification
  modificationData     Json      // What coach changed to
  modificationMagnitude Float?   // How different (0-1 scale)

  // Reasoning
  reasonCategory       DecisionReason
  reasonNotes          String?   @db.Text
  coachConfidence      Float?    // Coach's confidence (0-1)

  // Athlete context at decision time
  athleteContext       Json?     // HRV, sleep, fatigue, etc.

  // Outcome tracking
  outcomeAssessment    OutcomeAssessment?
  outcomeNotes         String?   @db.Text
  outcomeValidatedAt   DateTime?

  // Quality flags
  validated            Boolean   @default(false)
  usedForAITraining    Boolean   @default(false)

  // Related entities (optional links)
  workoutId            String?
  workout              Workout?  @relation("WorkoutDecisions", fields: [workoutId], references: [id], onDelete: SetNull)
  programId            String?
  program              TrainingProgram? @relation("ProgramDecisions", fields: [programId], references: [id], onDelete: SetNull)

  // Data Moat Phase 4: Feedback loops
  feedbackLoops        AIFeedbackLoop[] @relation("DecisionFeedback")

  @@index([coachId])
  @@index([athleteId])
  @@index([reasonCategory])
  @@index([createdAt])
  @@index([aiSuggestionType])
  @@index([validated])
}

/// Logs AI predictions for later validation and accuracy tracking
model AIPrediction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Prediction details
  predictionType     PredictionType
  predictedValue     Json          // Can be number, string, or complex object
  confidenceScore    Float         // 0-1
  confidenceLower    Float?        // Lower bound of CI
  confidenceUpper    Float?        // Upper bound of CI

  // Model info
  modelVersion       String
  modelParameters    Json?

  // Input snapshot for reproducibility
  inputDataSnapshot  Json

  // Context
  athlete            Client        @relation("AthletePredictions", fields: [athleteId], references: [id])
  athleteId          String
  coach              User?         @relation("CoachPredictions", fields: [coachId], references: [id])
  coachId            String?

  // Validity
  validUntil         DateTime?     // Prediction expiry

  // User interaction
  displayedToUser    Boolean       @default(false)
  userAction         PredictionUserAction?

  // Validation
  validation         PredictionValidation?
  validated          Boolean       @default(false)

  // Data Moat: Race result validation
  raceResults        RaceResult[] @relation("RacePredictionValidation")

  // Data Moat Phase 4: Feedback loops
  feedbackLoops      AIFeedbackLoop[] @relation("PredictionFeedback")

  @@index([athleteId])
  @@index([coachId])
  @@index([predictionType])
  @@index([createdAt])
  @@index([validated])
}

/// Links predictions to actual outcomes for accuracy measurement
model PredictionValidation {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())

  // Link to prediction
  prediction   AIPrediction @relation(fields: [predictionId], references: [id], onDelete: Cascade)
  predictionId String       @unique

  // Actual outcome
  actualValue  Json
  occurredAt   DateTime

  // Error metrics
  absoluteError          Float
  percentageError        Float
  withinConfidenceInterval Boolean

  // Context
  environmentalFactors   Json?     // Weather, altitude, illness, etc.

  // Quality
  validationSource       ValidationSource
  validationQuality      Float     // 0-1, reliability score

  // Analysis
  errorExplanation       String?   @db.Text
  usedForRetraining      Boolean   @default(false)

  @@index([predictionId])
  @@index([occurredAt])
  @@index([validationSource])
}

/// Manages athlete consent for data usage in the Data Moat system
model DataMoatConsent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Athlete
  athlete           Client   @relation("AthleteDataMoatConsent", fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId         String   @unique

  // Consent levels
  anonymizedBenchmarking   Boolean @default(true)
  patternContribution      Boolean @default(true)
  predictionValidation     Boolean @default(true)
  coachDecisionSharing     Boolean @default(true)

  // Opt-outs
  excludeFromResearch      Boolean @default(false)
  excludeFromPublicStats   Boolean @default(false)

  // Version tracking
  consentVersion           String  @default("1.0")
  acceptedAt               DateTime @default(now())

  @@index([athleteId])
}

// ============================================================================
// DATA MOAT: PHASE 2 - Training-Performance Correlation
// ============================================================================

/// Outcome classification for training periods
enum TrainingOutcome {
  EXCEEDED_GOALS    // Significantly better than expected
  MET_GOALS         // Achieved target metrics
  PARTIALLY_MET     // Some goals achieved
  MISSED_GOALS      // Did not achieve targets
  ABANDONED         // Program stopped early
  INJURED           // Training interrupted by injury
}

/// Tracks effectiveness of training periods/programs
model TrainingPeriodOutcome {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  athlete   Client   @relation("AthleteTrainingOutcomes", fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId String
  coach     User     @relation("CoachTrainingOutcomes", fields: [coachId], references: [id])
  coachId   String
  program   TrainingProgram? @relation("ProgramOutcomes", fields: [programId], references: [id])
  programId String?

  // Training period
  periodName        String        // "Marathon Build Phase 2", "Base Training"
  periodType        String?       // "BASE", "BUILD", "PEAK", "TAPER", "RECOVERY"
  startDate         DateTime
  endDate           DateTime
  durationWeeks     Int

  // Goals
  goalMetrics       Json          // { targetRaceTime: "3:30:00", targetFTP: 280, ... }
  goalDescription   String?       @db.Text

  // Actual outcomes
  actualMetrics     Json?         // { actualRaceTime: "3:28:15", actualFTP: 285, ... }
  outcomeClass      TrainingOutcome

  // Training summary
  totalVolume       Float?        // Total hours or km
  avgWeeklyVolume   Float?        // Average weekly hours/km
  compliance        Float?        // 0-1, how much of planned training was completed
  missedSessions    Int?          // Number of skipped workouts

  // Analysis
  contributingFactors Json?       // { injury: false, illness: true, travel: false, ... }
  coachAssessment   String?       @db.Text
  athleteFeedback   String?       @db.Text
  lessonsLearned    String?       @db.Text

  // Fingerprint link
  fingerprint       TrainingFingerprint? @relation("OutcomeFingerprint")

  // Data Moat Phase 4: Feedback loops
  feedbackLoops     AIFeedbackLoop[] @relation("OutcomeFeedback")

  @@index([athleteId])
  @@index([coachId])
  @@index([programId])
  @@index([startDate, endDate])
  @@index([outcomeClass])
}

/// Captures the "signature" of a training period for pattern matching
model TrainingFingerprint {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Link to outcome
  periodOutcome   TrainingPeriodOutcome @relation("OutcomeFingerprint", fields: [periodOutcomeId], references: [id], onDelete: Cascade)
  periodOutcomeId String                @unique

  // Zone distribution (percentage in each zone)
  zone1Percent    Float   // Recovery
  zone2Percent    Float   // Aerob bas
  zone3Percent    Float   // Tempo
  zone4Percent    Float   // Tröskel
  zone5Percent    Float   // VO2max

  // Volume patterns
  avgWeeklyHours        Float
  weeklyVolumeVariation Float   // Standard deviation of weekly volume
  longSessionRatio      Float   // % of sessions >90min

  // Intensity patterns
  intensityDistribution Json    // { easy: 0.7, moderate: 0.2, hard: 0.1 }
  avgSessionIntensity   Float   // 0-1 scale
  hardDayFrequency      Float   // Hard sessions per week

  // Session composition
  strengthSessionsPerWeek Float
  crossTrainingPercent    Float
  restDaysPerWeek         Float

  // Periodization pattern
  periodizationType     String?  // "LINEAR", "BLOCK", "POLARIZED", "PYRAMIDAL"
  progressionRate       Float?   // Weekly volume/intensity increase %

  // Key workout types
  keyWorkoutTypes       Json     // ["long_run", "tempo", "intervals", ...]

  @@index([periodOutcomeId])
  @@index([zone2Percent])  // For polarized training queries
  @@index([avgWeeklyHours])
}

/// Tracks which exercises improve specific metrics for specific athletes
model ExerciseEffectiveness {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relationships
  exercise   Exercise @relation("ExerciseEffectivenessRecords", fields: [exerciseId], references: [id])
  exerciseId String
  athlete    Client   @relation("AthleteExerciseEffectiveness", fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId  String

  // Target metric
  targetMetric      String    // "vertical_jump", "5k_time", "1rm_squat", ...
  baselineMeasure   Float     // Starting value
  baselineDate      DateTime

  // Training period
  trainingWeeks     Int
  volumeDescription String?   // "3x10 twice/week"
  avgIntensity      Float?    // 0-1 scale or % of 1RM

  // Post-period measurement
  postMeasure       Float?
  postDate          DateTime?

  // Results
  absoluteImprovement Float?   // postMeasure - baselineMeasure
  percentImprovement  Float?   // % improvement
  effectivenessScore  Float?   // Normalized 0-1 score

  // Confounding factors
  confoundingFactors Json?    // { other_exercises: [...], diet_change: false, ... }
  notes              String?  @db.Text

  @@unique([exerciseId, athleteId, targetMetric, baselineDate])
  @@index([exerciseId])
  @@index([athleteId])
  @@index([targetMetric])
  @@index([effectivenessScore])
}

/// Aggregated patterns across athletes for exercise effectiveness
model ExerciseOutcomePattern {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Exercise
  exercise   Exercise @relation("ExerciseOutcomePatterns", fields: [exerciseId], references: [id])
  exerciseId String

  // Target metric
  targetMetric      String    // "vertical_jump", "5k_time", etc.

  // Sample statistics
  sampleSize        Int       // Number of athletes
  avgImprovement    Float     // Mean improvement
  stdDeviation      Float     // Standard deviation
  confidenceLevel   Float     // Statistical confidence 0-1
  confidenceInterval Json     // { lower: 0.05, upper: 0.12 }

  // Athlete type modifiers
  athleteTypeModifiers Json?  // { "beginner": 1.2, "advanced": 0.8, "age>40": 0.9 }

  // Validity
  lastCalculated    DateTime
  isSignificant     Boolean   // p < 0.05

  @@unique([exerciseId, targetMetric])
  @@index([exerciseId])
  @@index([targetMetric])
  @@index([avgImprovement])
}

/// Validates that test metrics (lactate, VO2max) predict actual performance
model TestPredictiveValidation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Source test
  testType          String    // "LACTATE", "VO2MAX", "FTP", "CRITICAL_POWER"
  testId            String    // Reference to actual test record
  testDate          DateTime

  // Prediction made
  predictedMetric   String    // "10k_time", "marathon_time", "ftp"
  predictedValue    Float
  predictionDate    DateTime

  // Athlete
  athlete           Client    @relation("AthleteTestValidations", fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId         String

  // Validation event
  validationEventType String?  // "RACE", "TIME_TRIAL", "FTP_TEST"
  validationEventId   String?  // Reference to race result or test
  validationDate      DateTime?
  actualValue         Float?

  // Error metrics
  absoluteError       Float?
  percentageError     Float?

  // Environmental factors
  environmentalFactors Json?   // { heat: true, altitude: 1500, ... }

  // Quality
  validationQuality   Float?   // 0-1, reliability of the validation

  @@index([athleteId])
  @@index([testType])
  @@index([predictedMetric])
  @@index([validationDate])
}

// ============================================================================
// DATA MOAT: PHASE 3 - Cross-Athlete Intelligence
// ============================================================================

/// Experience level for cohort segmentation
enum ExperienceLevel {
  BEGINNER      // <1 year
  INTERMEDIATE  // 1-3 years
  ADVANCED      // 3-7 years
  ELITE         // 7+ years or competitive
}

/// Primary goal types for cohort segmentation
enum GoalType {
  GENERAL_FITNESS
  WEIGHT_LOSS
  ENDURANCE_PERFORMANCE
  STRENGTH_GAIN
  SPORT_SPECIFIC
  COMPETITION
  HEALTH_MAINTENANCE
}

/// Aggregated metrics for athlete cohorts (anonymized benchmarks)
model AthleteCohort {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Cohort definition
  sport             String          // "RUNNING", "CYCLING", "TRIATHLON", etc.
  ageRangeLower     Int             // e.g., 30
  ageRangeUpper     Int             // e.g., 39
  experienceLevel   ExperienceLevel
  weeklyVolumeMin   Float?          // Minimum weekly hours
  weeklyVolumeMax   Float?          // Maximum weekly hours
  primaryGoal       GoalType?
  gender            String?         // "MALE", "FEMALE", "ALL"

  // Sample info
  sampleSize        Int             // Number of athletes in cohort
  lastCalculated    DateTime

  // Aggregated metrics (all anonymized averages)
  avgWeeklyHours    Float?
  avgZone2Percent   Float?
  avgHighIntensityPercent Float?
  avgStrengthSessionsPerWeek Float?
  avgRestDaysPerWeek Float?

  // Performance benchmarks
  benchmarks        Json            // { "5k_time": { p10: X, p25: X, p50: X, p75: X, p90: X }, ... }

  // Outcome statistics
  avgSuccessRate    Float?          // % meeting/exceeding goals
  avgInjuryRate     Float?          // % with injury outcomes
  avgImprovement    Float?          // Average improvement %

  // Confidence
  confidenceLevel   Float           // Statistical confidence 0-1

  // Comparisons generated
  comparisons       BenchmarkComparison[] @relation("CohortComparisons")

  @@unique([sport, ageRangeLower, ageRangeUpper, experienceLevel, gender])
  @@index([sport])
  @@index([experienceLevel])
  @@index([sampleSize])
}

/// Individual athlete comparison to their cohort
model BenchmarkComparison {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Athlete
  athlete   Client   @relation("AthleteBenchmarks", fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId String

  // Cohort
  cohort    AthleteCohort @relation("CohortComparisons", fields: [cohortId], references: [id], onDelete: Cascade)
  cohortId  String

  // Comparison metrics
  metricName        String          // "5k_time", "weekly_volume", "zone2_percent"
  athleteValue      Float
  cohortPercentile  Float           // 0-100, where athlete ranks

  // Percentile details
  cohortP25         Float?
  cohortP50         Float?
  cohortP75         Float?

  // Interpretation
  interpretation    String?         // "Above average", "Top 10%", etc.
  recommendation    String?         @db.Text

  @@index([athleteId])
  @@index([cohortId])
  @@index([metricName])
  @@index([cohortPercentile])
}

/// Pattern confidence level
enum PatternConfidence {
  PRELIMINARY   // n < 20
  MODERATE      // n >= 20, p < 0.1
  HIGH          // n >= 50, p < 0.05
  VERY_HIGH     // n >= 100, p < 0.01
}

/// Cross-athlete performance patterns (what works across many athletes)
model PerformancePattern {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Pattern identification
  patternName       String          // "High Responder to Polarized Training"
  patternDescription String?        @db.Text

  // Pattern criteria (what defines this pattern)
  criteria          Json            // { zoneDistribution: { zone2: ">75%" }, consistency: ">85%" }

  // Outcome correlation
  outcomeType       String          // "improvement_rate", "injury_prevention", "goal_achievement"
  outcomeCorrelation Float          // Effect size
  outcomeDescription String?        // "14% higher improvement rate"

  // Statistical validity
  sampleSize        Int
  pValue            Float?
  effectSize        Float?
  confidenceLevel   PatternConfidence

  // Applicability
  applicableSports  String[]        // ["RUNNING", "CYCLING"] or ["ALL"]
  applicableAgeMin  Int?
  applicableAgeMax  Int?
  applicableExperience ExperienceLevel[]

  // Discovery metadata
  discoveredAt      DateTime        @default(now())
  lastValidated     DateTime?
  validationCount   Int             @default(1)

  // Status
  isActive          Boolean         @default(true)
  isPublished       Boolean         @default(false)  // Shown to users

  // Matches
  athleteMatches    AthletePatternMatch[] @relation("PatternMatches")

  // Data Moat Phase 4: Feedback loops
  feedbackLoops     AIFeedbackLoop[] @relation("PatternFeedback")

  @@index([patternName])
  @@index([outcomeType])
  @@index([confidenceLevel])
  @@index([isActive, isPublished])
}

/// Links athletes to patterns they match
model AthletePatternMatch {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Athlete
  athlete   Client   @relation("AthletePatternMatches", fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId String

  // Pattern
  pattern   PerformancePattern @relation("PatternMatches", fields: [patternId], references: [id], onDelete: Cascade)
  patternId String

  // Match quality
  matchScore        Float           // 0-1, how well athlete matches pattern criteria
  matchedCriteria   Json            // Which criteria were matched

  // Recommendation
  recommendation    String?         @db.Text
  recommendationAccepted Boolean?

  // Outcome tracking (if recommendation was applied)
  appliedAt         DateTime?
  outcomeTracked    Boolean         @default(false)
  outcomeResult     String?         // "POSITIVE", "NEGATIVE", "NEUTRAL"
  outcomeNotes      String?         @db.Text

  @@unique([athleteId, patternId])
  @@index([athleteId])
  @@index([patternId])
  @@index([matchScore])
  @@index([outcomeTracked])
}

// ==================== DATA MOAT PHASE 4: AI LEARNING LOOP ====================

enum FeedbackCategory {
  PREDICTION_ERROR       // AI prediction was wrong
  DECISION_OVERRIDE      // Coach overrode AI suggestion
  PATTERN_DISCOVERED     // New pattern identified
  ACCURACY_IMPROVEMENT   // Model accuracy improved
  USER_FEEDBACK          // Direct user feedback
  OUTCOME_MISMATCH       // Expected vs actual outcome mismatch
}

enum LessonStatus {
  IDENTIFIED            // Lesson extracted
  VALIDATED             // Confirmed by multiple sources
  APPLIED               // Applied to AI prompts
  DEPRECATED            // No longer valid
}

enum ModelStatus {
  DEVELOPMENT          // In development
  TESTING              // A/B testing
  ACTIVE               // Currently deployed
  DEPRECATED           // Phased out
  ARCHIVED             // Historical reference
}

/// Captures lessons learned from AI predictions and coach decisions
model AIFeedbackLoop {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Source of feedback
  feedbackCategory   FeedbackCategory

  // Links to source data (at least one should be present)
  coachDecision      CoachDecision?    @relation("DecisionFeedback", fields: [coachDecisionId], references: [id], onDelete: SetNull)
  coachDecisionId    String?
  prediction         AIPrediction?     @relation("PredictionFeedback", fields: [predictionId], references: [id], onDelete: SetNull)
  predictionId       String?
  trainingOutcome    TrainingPeriodOutcome? @relation("OutcomeFeedback", fields: [trainingOutcomeId], references: [id], onDelete: SetNull)
  trainingOutcomeId  String?
  pattern            PerformancePattern? @relation("PatternFeedback", fields: [patternId], references: [id], onDelete: SetNull)
  patternId          String?

  // Lesson learned
  lessonTitle        String            // "Athletes over 40 need longer recovery"
  lessonDescription  String            @db.Text
  lessonCategory     String            // "recovery", "intensity", "periodization"
  lessonConfidence   Float             // 0-1

  // Evidence
  evidenceCount      Int               @default(1)
  evidenceData       Json?             // Supporting data points
  contradictions     Int               @default(0)

  // Prompt adjustment (if applicable)
  promptAdjustment   String?           @db.Text  // New prompt text or modification
  affectedPrompts    String[]          // Which AI prompts this affects

  // Status tracking
  lessonStatus       LessonStatus      @default(IDENTIFIED)
  validatedAt        DateTime?
  appliedAt          DateTime?

  // Model version affected
  modelVersion       AIModelVersion?   @relation("VersionFeedback", fields: [modelVersionId], references: [id])
  modelVersionId     String?

  // Impact measurement (filled after application)
  impactMeasured     Boolean           @default(false)
  impactDescription  String?           @db.Text
  accuracyBefore     Float?
  accuracyAfter      Float?
  improvementPercent Float?

  @@index([feedbackCategory])
  @@index([lessonStatus])
  @@index([lessonCategory])
  @@index([createdAt])
  @@index([coachDecisionId])
  @@index([predictionId])
  @@index([modelVersionId])
}

/// Tracks AI model versions and their performance
model AIModelVersion {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Version identification
  versionName        String            // "v1.2.0", "race-prediction-v3"
  versionNumber      Int               // Sequential number
  modelType          String            // "race_prediction", "injury_risk", "workout_generation"

  // Description
  description        String?           @db.Text
  changelog          String?           @db.Text  // What changed from previous version

  // Training data
  trainingDataStart  DateTime?         // Start of training data period
  trainingDataEnd    DateTime?         // End of training data period
  trainingDataSize   Int?              // Number of samples
  trainingDataHash   String?           // Hash for data integrity

  // Prompt/Configuration
  promptTemplate     String?           @db.Text
  parameters         Json?             // Model parameters/settings

  // Status
  status             ModelStatus       @default(DEVELOPMENT)
  deployedAt         DateTime?
  deprecatedAt       DateTime?

  // Accuracy metrics (updated periodically)
  overallAccuracy    Float?            // 0-1
  accuracyByType     Json?             // { "5K": 0.92, "marathon": 0.87 }

  // Detailed metrics
  meanAbsoluteError  Float?
  meanSquaredError   Float?
  rSquared           Float?
  within5Percent     Float?            // % of predictions within 5%
  within10Percent    Float?            // % of predictions within 10%

  // Sample counts
  predictionCount    Int               @default(0)
  validatedCount     Int               @default(0)

  // A/B Testing
  abTestId           String?           // If part of an A/B test
  abTestVariant      String?           // "control", "treatment"
  abTestResult       Json?             // Test results

  // Feedback incorporated
  feedbackLoops      AIFeedbackLoop[]  @relation("VersionFeedback")

  // Relations
  previousVersion    AIModelVersion?   @relation("VersionHistory", fields: [previousVersionId], references: [id])
  previousVersionId  String?
  nextVersions       AIModelVersion[]  @relation("VersionHistory")

  @@unique([modelType, versionNumber])
  @@index([modelType])
  @@index([status])
  @@index([deployedAt])
  @@index([versionName])
}

/// Periodic snapshots of prediction accuracy for the dashboard
model AccuracySnapshot {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Snapshot period
  periodStart        DateTime
  periodEnd          DateTime
  snapshotType       String            // "daily", "weekly", "monthly", "all_time"

  // Race prediction accuracy
  racePredictions    Json?             // { total, mae, within5pct, within10pct, byDistance: {...} }

  // Threshold prediction accuracy
  thresholdPredictions Json?           // { total, meanError, correlation, byTestType: {...} }

  // Injury prediction accuracy
  injuryPredictions  Json?             // { total, sensitivity, specificity, falsePositiveRate, auc }

  // Readiness prediction accuracy
  readinessPredictions Json?           // { total, correlation, mae }

  // Program outcome accuracy
  programOutcomes    Json?             // { total, goalAchievementRate, avgImprovement, byProgramType: {...} }

  // Overall metrics
  overallSampleSize  Int
  overallAccuracy    Float?            // Weighted average
  confidenceLevel    Float?            // Statistical confidence

  // Comparison to previous period
  previousSnapshotId String?
  previousSnapshot   AccuracySnapshot? @relation("SnapshotHistory", fields: [previousSnapshotId], references: [id])
  nextSnapshots      AccuracySnapshot[] @relation("SnapshotHistory")
  changeFromPrevious Json?             // Delta metrics

  // Visibility
  isPublic           Boolean           @default(false)  // Shown on public dashboard

  @@unique([periodStart, periodEnd, snapshotType])
  @@index([snapshotType])
  @@index([createdAt])
  @@index([isPublic])
}

/// Stores AI prompt templates with version history
model AIPromptTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Identification
  promptName         String            // "workout_generation", "injury_risk_assessment"
  promptCategory     String            // "training", "health", "prediction"
  version            Int               @default(1)

  // Content
  systemPrompt       String            @db.Text
  userPromptTemplate String?           @db.Text  // Template with {{variables}}
  outputFormat       Json?             // Expected output structure

  // Metadata
  description        String?           @db.Text
  variables          String[]          // ["athleteName", "currentFitness", "goals"]

  // Status
  isActive           Boolean           @default(true)
  activatedAt        DateTime?
  deactivatedAt      DateTime?

  // Performance tracking
  usageCount         Int               @default(0)
  avgResponseQuality Float?            // Based on user feedback
  avgLatencyMs       Int?

  // A/B testing
  abTestGroup        String?           // "control", "variant_a", etc.
  abTestWeight       Float?            // Traffic allocation

  // Version history
  previousVersion    AIPromptTemplate? @relation("PromptVersionHistory", fields: [previousVersionId], references: [id])
  previousVersionId  String?
  nextVersions       AIPromptTemplate[] @relation("PromptVersionHistory")

  // Feedback that led to this version
  basedOnFeedback    String[]          // IDs of AIFeedbackLoop entries

  @@unique([promptName, version])
  @@index([promptName])
  @@index([promptCategory])
  @@index([isActive])
}

// ==================== AGILITY STUDIO SYSTEM ====================

/// Agility drill template in the drill library
model AgilityDrill {
  id          String  @id @default(uuid())
  name        String
  nameSv      String? // Swedish translation
  description String? @db.Text
  descriptionSv String? @db.Text

  // Drill configuration
  category    AgilityDrillCategory

  // Equipment requirements
  requiredEquipment String[] @default([]) // Equipment IDs or names that are mandatory
  optionalEquipment String[] @default([]) // Equipment IDs or names that enhance the drill

  // Drill parameters
  distanceMeters    Float?   // Total distance if applicable
  durationSeconds   Int?     // Typical duration per rep
  defaultReps       Int?     // Suggested rep count
  defaultSets       Int?     // Suggested set count
  restSeconds       Int?     // Suggested rest between reps

  // LTAD development stage restrictions
  minDevelopmentStage DevelopmentStage @default(FUNDAMENTALS)
  maxDevelopmentStage DevelopmentStage @default(ELITE)

  // Sport associations
  primarySports     SportType[] @default([])

  // Difficulty (1-5)
  difficultyLevel   Int @default(3)

  // Media
  videoUrl          String?
  animationUrl      String?
  diagramUrl        String?  // Setup diagram image

  // Instructions
  setupInstructions String? @db.Text
  executionCues     String[] @default([]) // Coaching cues

  // Progressions/Regressions
  progressionDrillId String?
  regressionDrillId  String?
  progressionDrill   AgilityDrill? @relation("DrillProgression", fields: [progressionDrillId], references: [id], onDelete: SetNull)
  regressionDrill    AgilityDrill? @relation("DrillRegression", fields: [regressionDrillId], references: [id], onDelete: SetNull)
  progressions       AgilityDrill[] @relation("DrillProgression")
  regressions        AgilityDrill[] @relation("DrillRegression")

  // Ownership
  coachId       String?
  coach         User?   @relation("CoachAgilityDrills", fields: [coachId], references: [id], onDelete: SetNull)
  isSystemDrill Boolean @default(false) // True for seeded/library drills

  // Usage in workouts
  workoutDrills AgilityWorkoutDrill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([coachId])
  @@index([isSystemDrill])
  @@index([difficultyLevel])
  @@index([minDevelopmentStage])
}

/// Agility workout template
model AgilityWorkout {
  id          String  @id @default(uuid())
  name        String
  description String? @db.Text

  // Workout configuration
  format        AgilityWorkoutFormat
  totalDuration Int?   // Estimated total duration in minutes
  restBetweenDrills Int? // Default rest between drills in seconds

  // Target audience
  developmentStage  DevelopmentStage?
  targetSports      SportType[] @default([])
  primaryFocus      AgilityDrillCategory?

  // Ownership
  coachId    String
  coach      User    @relation("CoachAgilityWorkouts", fields: [coachId], references: [id], onDelete: Cascade)
  isTemplate Boolean @default(false) // Reusable template
  isPublic   Boolean @default(false)

  // Tags for filtering
  tags String[] @default([])

  // Drills in this workout
  drills AgilityWorkoutDrill[]

  // Assignments and results
  assignments AgilityWorkoutAssignment[]
  results     AgilityWorkoutResult[]

  // Team workout broadcasts
  teamWorkoutBroadcasts TeamWorkoutBroadcast[] @relation("AgilityWorkoutBroadcasts")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([format])
  @@index([developmentStage])
  @@index([isTemplate])
  @@index([isPublic])
}

/// Link between workout and drill with configuration
model AgilityWorkoutDrill {
  id String @id @default(uuid())

  workout   AgilityWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId String

  drill   AgilityDrill @relation(fields: [drillId], references: [id], onDelete: Cascade)
  drillId String

  // Ordering
  order       Int
  sectionType WorkoutSectionType @default(MAIN) // WARMUP, MAIN, COOLDOWN

  // Drill parameters (override defaults)
  sets        Int?
  reps        Int?
  duration    Int? // seconds
  restSeconds Int?

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())

  @@unique([workoutId, order])
  @@index([workoutId])
  @@index([drillId])
}

/// Assignment of agility workout to athlete
model AgilityWorkoutAssignment {
  id String @id @default(uuid())

  workout   AgilityWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId String

  athlete   Client @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId String

  // Assignment details
  assignedDate DateTime @db.Date
  assignedBy   String   // Coach user ID
  notes        String?  @db.Text

  // Status tracking
  status      String   @default("ASSIGNED") // ASSIGNED, IN_PROGRESS, COMPLETED, SKIPPED
  startedAt   DateTime?
  completedAt DateTime?

  // Team broadcast link (if assigned via team)
  teamBroadcast   TeamWorkoutBroadcast? @relation(fields: [teamBroadcastId], references: [id], onDelete: SetNull)
  teamBroadcastId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workoutId, athleteId, assignedDate])
  @@index([workoutId])
  @@index([athleteId])
  @@index([assignedDate])
  @@index([status])
  @@index([teamBroadcastId])
}

/// Result from completed agility workout
model AgilityWorkoutResult {
  id String @id @default(uuid())

  workout   AgilityWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId String

  athlete   Client @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId String

  // Completion data
  completedAt   DateTime
  totalDuration Int?     // Actual duration in seconds

  // Subjective feedback
  perceivedEffort Int?   // RPE 1-10
  notes           String? @db.Text

  // Detailed drill results (JSON for flexibility)
  drillResults Json? // [{drillId, completed, timeSeconds, notes}]

  createdAt DateTime @default(now())

  @@index([workoutId])
  @@index([athleteId])
  @@index([completedAt])
}

/// Timing gate testing session
model TimingGateSession {
  id String @id @default(uuid())

  // Session info
  coachId     String
  coach       User     @relation("CoachTimingGateSessions", fields: [coachId], references: [id], onDelete: Cascade)
  sessionDate DateTime @db.Date
  sessionName String?

  // Import source
  importSource  TimingGateSource
  importedAt    DateTime?
  rawDataUrl    String?  // Link to original file in storage

  // Gate configuration
  gateCount         Int?       // Number of gates used
  intervalDistances Float[]    // Distances between gates in meters

  // Location
  locationId String?
  location   Location? @relation("TimingGateSessionLocation", fields: [locationId], references: [id], onDelete: SetNull)

  // Results
  results TimingGateResult[]

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([sessionDate])
  @@index([importSource])
  @@index([locationId])
}

/// Individual timing gate result
model TimingGateResult {
  id String @id @default(uuid())

  session   TimingGateSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId String

  // Athlete (can be null if not yet matched)
  athlete   Client? @relation(fields: [athleteId], references: [id], onDelete: SetNull)
  athleteId String?

  // Unmatched athlete info (from import)
  unmatchedAthleteName String?
  unmatchedAthleteId   String? // External ID from import

  // Test protocol
  testProtocol SportTestProtocol?
  attemptNumber Int @default(1)

  // Timing data
  splitTimes  Float[] // Times at each gate in seconds
  totalTime   Float   // Total time in seconds

  // Calculated metrics
  acceleration Float?  // Acceleration phase time
  maxVelocity  Float?  // Maximum velocity achieved (m/s)
  codDeficit   Float?  // Change of direction deficit (%)

  // Validity
  valid       Boolean @default(true)
  invalidReason String?

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([athleteId])
  @@index([testProtocol])
  @@index([valid])
}

// ==================== VOICE WORKOUT CREATION ====================

/// Voice-to-workout creation session
/// Tracks audio upload, transcription, intent parsing, and generated workout
model VoiceWorkoutSession {
  id      String @id @default(uuid())
  coachId String
  coach   User   @relation("CoachVoiceWorkouts", fields: [coachId], references: [id], onDelete: Cascade)

  // Audio file data
  audioUrl String // Supabase Storage URL
  duration Int // seconds
  mimeType String? // "audio/webm", "audio/mp4", etc.

  // Processing status
  status String @default("PENDING") // PENDING, PROCESSING, PARSED, CONFIRMED, FAILED

  // Transcription
  transcription String? @db.Text

  // Parsed intent (structured data from AI)
  parsedIntent Json? // VoiceWorkoutIntent structure

  // Generated workout (polymorphic - one will be set after confirmation)
  workoutType       String? // CARDIO, STRENGTH, HYBRID
  strengthSessionId String?
  cardioSessionId   String?
  hybridWorkoutId   String?

  strengthSession StrengthSession? @relation("StrengthSessionVoiceWorkouts", fields: [strengthSessionId], references: [id], onDelete: SetNull)
  cardioSession   CardioSession?   @relation("CardioSessionVoiceWorkouts", fields: [cardioSessionId], references: [id], onDelete: SetNull)
  hybridWorkout   HybridWorkout?   @relation("HybridWorkoutVoiceWorkouts", fields: [hybridWorkoutId], references: [id], onDelete: SetNull)

  // Assignment target
  targetType   String?   // ATHLETE, TEAM
  targetId     String?   // Client ID or Team ID
  assignedDate DateTime? @db.Date

  // Processing metadata
  processingTimeMs Int?
  modelUsed        String? // "gemini-2.0-flash"
  errorMessage     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([status])
  @@index([createdAt])
}

// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "../docs/database/erd.svg"
  theme    = "forest"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
}

enum TestType {
  RUNNING
  CYCLING
  SKIING
}

// ==================== MULTI-SPORT SYSTEM ====================

enum SportType {
  RUNNING           // Road, trail, track running
  CYCLING           // Road, indoor, MTB cycling
  SKIING            // Cross-country skiing (classic, skate)
  SWIMMING          // Pool/open water swimming
  TRIATHLON         // Swim/Bike/Run combined
  HYROX             // Functional fitness racing
  GENERAL_FITNESS   // CrossFit-style, general PT programs
  STRENGTH          // Standalone strength training programs
}

enum TestStatus {
  DRAFT
  COMPLETED
  ARCHIVED
}

enum InclineUnit {
  PERCENT
  DEGREES
}

enum UserRole {
  ADMIN
  COACH
  ATHLETE
}

enum WorkoutType {
  RUNNING
  STRENGTH
  PLYOMETRIC
  CORE
  RECOVERY
  CYCLING
  SKIING
  SWIMMING
  TRIATHLON
  HYROX
  ALTERNATIVE
  OTHER
}

enum WorkoutIntensity {
  RECOVERY      // Very easy
  EASY          // Zone 1-2
  MODERATE      // Zone 3
  THRESHOLD     // Zone 4
  INTERVAL      // Zone 5
  MAX           // All-out
}

enum PeriodPhase {
  BASE          // Building aerobic base
  BUILD         // Increasing intensity
  PEAK          // Race-specific training
  TAPER         // Pre-race recovery
  RECOVERY      // Post-race recovery
  TRANSITION    // Off-season
}

enum WorkoutSectionType {
  WARMUP        // Warm-up exercises, dynamic stretches, activation
  MAIN          // Primary strength exercises
  CORE          // Core-specific exercises
  COOLDOWN      // Cooldown, stretching, mobility
}

enum SubscriptionTier {
  FREE          // Basic features
  BASIC         // Up to 5 athletes
  PRO           // Up to 50 athletes
  ENTERPRISE    // Unlimited athletes
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

// ==================== ATHLETE SUBSCRIPTION TIERS ====================

enum AthleteSubscriptionTier {
  FREE      // View reports only - no AI access
  STANDARD  // Basic AI chat (50 msg/month), workout logging, daily check-in
  PRO       // Full AI agent, unlimited AI, video analysis, Strava/Garmin sync
}

enum PaymentSource {
  DIRECT    // Athlete pays directly - 100% to platform
  BUSINESS  // Athlete onboarded via business - revenue shared
}

enum IntegrationType {
  STRAVA    // Strava OAuth integration
  GARMIN    // Garmin Health API integration
  CONCEPT2  // Concept2 Logbook integration
}

enum InvitationType {
  ATHLETE_SIGNUP   // Invite athlete to create account
  REPORT_VIEW      // Public report link
  REFERRAL         // Referral bonus link
}

// ==================== REFERRAL SYSTEM ====================

enum ReferralStatus {
  PENDING     // User signed up but hasn't completed onboarding/subscription
  COMPLETED   // User completed signup and referral is valid
  EXPIRED     // Referral expired (e.g., user never completed signup)
  REVOKED     // Referral was revoked (e.g., refund, fraud)
}

enum ReferralRewardType {
  FREE_MONTH           // One month free subscription
  DISCOUNT_PERCENT     // Percentage discount on next billing
  EXTENDED_TRIAL       // Extended trial period
  ATHLETE_SLOTS        // Additional athlete slots
}

// ==================== CALENDAR SYSTEM ====================

enum CalendarEventType {
  ALTITUDE_CAMP         // Multi-day training camp at altitude
  TRAINING_CAMP         // Multi-day training camp (non-altitude)
  TRAVEL                // Travel days with reduced/no training
  ILLNESS               // Illness tracking with return-to-training protocol
  VACATION              // Personal time off
  WORK_BLOCKER          // Work commitments blocking training
  PERSONAL_BLOCKER      // Personal events (weddings, family, etc.)
  EXTERNAL_EVENT        // Imported from external calendar
}

enum CalendarEventStatus {
  SCHEDULED             // Future event
  ACTIVE                // Currently ongoing
  COMPLETED             // Past event
  CANCELLED             // Cancelled but kept for history
}

enum EventImpact {
  NO_TRAINING           // No training possible
  REDUCED               // Reduced training (50% or less)
  MODIFIED              // Training with modifications
  NORMAL                // Normal training continues
}

enum AltitudeAdaptationPhase {
  ACUTE                 // First 3-5 days (reduced intensity)
  ADAPTATION            // Days 6-14 (gradual increase)
  OPTIMAL               // Day 15+ (full adaptation)
  POST_CAMP             // Return to sea level (monitor for 14 days)
}

enum BiomechanicalPillar {
  POSTERIOR_CHAIN    // Hip dominance - glutes, hamstrings
  KNEE_DOMINANCE     // Quad strength & stiffness
  UNILATERAL         // Single-leg exercises
  FOOT_ANKLE         // Calf, ankle, foot strength
  ANTI_ROTATION_CORE // Core stability & anti-rotation
  UPPER_BODY         // Upper body strength (optional for runners)
}

enum ProgressionLevel {
  LEVEL_1            // Static/Stability - beginners
  LEVEL_2            // Strength/Loading - intermediate
  LEVEL_3            // Dynamic/Ballistic - advanced
}

enum PlyometricIntensity {
  LOW                // >250ms ground contact (pogo, squat jumps)
  MODERATE           // 150-250ms (countermovement, bounds)
  HIGH               // <150ms (depth jumps, max 27 contacts)
}

enum ProgressionStatus {
  ON_TRACK           // Progressing as expected
  PLATEAU            // No progress for 3+ weeks
  REGRESSING         // Performance declining
  DELOAD_NEEDED      // Volume/intensity too high
}

enum StrengthPhase {
  ANATOMICAL_ADAPTATION  // 4-6 weeks, 2-3×12-20 @ 40-60%
  MAXIMUM_STRENGTH       // 6-8 weeks, 3-5×3-6 @ 80-95%
  POWER                  // 3-4 weeks, 3-5×4-6 @ 30-60% max velocity
  MAINTENANCE            // Variable, 2×3-5 @ 80-85%
  TAPER                  // 1-2 weeks, 41-60% volume reduction
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      UserRole @default(COACH)
  language  String   @default("sv") // "sv" or "en"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Existing relations
  tests    Test[]
  clients  Client[]
  teams    Team[]

  // New relations for training programs
  coachPrograms     TrainingProgram[] @relation("CoachPrograms")
  exercises         Exercise[]
  workoutLogs       WorkoutLog[]
  sentMessages      Message[]         @relation("SentMessages")
  receivedMessages  Message[]         @relation("ReceivedMessages")
  athleteAccount    AthleteAccount?
  subscription      Subscription?
  videoImports      VideoImport[]

  // AI Studio relations
  coachDocuments    CoachDocument[]   @relation("CoachDocuments")
  aiConversations   AIConversation[]  @relation("CoachConversations")
  videoAnalyses     VideoAnalysis[]   @relation("CoachVideoAnalyses")
  apiKeys           UserApiKey?       @relation("UserApiKeys")

  // Hybrid Studio relations
  hybridWorkouts    HybridWorkout[]   @relation("CoachHybridWorkouts")

  // Strength & Cardio Studio relations
  strengthSessions  StrengthSession[] @relation("CoachStrengthSessions")
  cardioSessions    CardioSession[]   @relation("CoachCardioSessions")
  strengthTemplates StrengthTemplate[] @relation("StrengthTemplateOwner")

  // Business & Organization relations
  businessMemberships BusinessMember[]
  tester              Tester?

  // Calendar System relations
  createdCalendarEvents   CalendarEvent[]         @relation("CreatedCalendarEvents")
  modifiedCalendarEvents  CalendarEvent[]         @relation("ModifiedCalendarEvents")
  calendarChanges         CalendarEventChange[]   @relation("CalendarChanges")

  // Referral System relations
  referralCode            ReferralCode?           // Coach's unique referral code
  referralsMade           Referral[]              @relation("ReferrerUser")  // Referrals this user made
  referredBy              Referral[]              @relation("ReferredUser")  // How this user was referred
  referralRewards         ReferralReward[]        // Rewards received

  @@index([email])
  @@index([role])
}

model Team {
  id        String   @id @default(uuid())
  userId    String
  name      String
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  members   Client[]

  @@index([userId])
  @@index([name])
}

model Client {
  id        String   @id @default(uuid())
  userId    String
  teamId    String?
  name      String
  email     String?
  phone     String?
  gender    Gender
  birthDate DateTime
  height    Float    // cm
  weight    Float    // kg
  notes     String?

  // Direct athlete flag (not onboarded via coach)
  isDirect  Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user             User              @relation(fields: [userId], references: [id])
  team             Team?             @relation(fields: [teamId], references: [id], onDelete: SetNull)
  tests            Test[]
  trainingPrograms TrainingProgram[]
  athleteAccount   AthleteAccount?

  // Training Engine relationships
  athleteProfile       AthleteProfile?
  dailyMetrics         DailyMetrics[]
  trainingLoads        TrainingLoad[]
  programsEngine       TrainingProgramEngine[]
  fieldTests           FieldTest[]
  selfReportedLactates SelfReportedLactate[]
  raceCalendars        RaceCalendar[]
  races                Race[]
  injuryAssessments    InjuryAssessment[]
  crossTrainingSessions CrossTrainingSession[]
  strengthSessions     StrengthTrainingSession[]
  progressionTracking  ProgressionTracking[]
  oneRepMaxHistory     OneRepMaxHistory[]
  raceResults          RaceResult[]
  dailyCheckIns        DailyCheckIn[]
  sportProfile         SportProfile?
  sportPerformances    SportPerformance[]

  // AI Studio relations
  aiConversations      AIConversation[]  @relation("AthleteConversations")
  videoAnalyses        VideoAnalysis[]   @relation("AthleteVideoAnalyses")
  bodyCompositions     BodyComposition[] @relation("ClientBodyComposition")

  // Gemini 3 Pro features
  audioJournals        AudioJournal[]
  menstrualCycles      MenstrualCycle[]
  menstrualDailyLogs   MenstrualDailyLog[]

  // Hybrid Studio relations
  hybridWorkoutResults HybridWorkoutResult[]
  hybridWorkoutAssignments HybridWorkoutAssignment[]
  hybridWorkoutLogs    HybridWorkoutLog[]       @relation("AthleteHybridLogs")

  // Strength & Cardio Studio relations
  strengthSessionAssignments StrengthSessionAssignment[]
  cardioSessionAssignments   CardioSessionAssignment[]
  cardioSessionLogs          CardioSessionLog[]         @relation("AthleteCardioLogs")

  // Nutrition Timing System relations
  dietaryPreferences  DietaryPreferences?
  nutritionGoal       NutritionGoal?

  // Athlete Subscription & Integrations
  athleteSubscription  AthleteSubscription?
  integrationTokens    IntegrationToken[]
  stravaActivities     StravaActivity[]
  concept2Results      Concept2Result[]

  // VBT (Velocity-Based Training) relations
  vbtSessions          VBTSession[]
  loadVelocityProfiles LoadVelocityProfile[]

  // Calendar System relations
  calendarEvents           CalendarEvent[]
  calendarEventChanges     CalendarEventChange[]
  externalCalendarConnections ExternalCalendarConnection[]

  @@index([userId])
  @@index([teamId])
  @@index([name])
  @@index([email])
  @@index([isDirect])
}

model Test {
  id         String     @id @default(uuid())
  clientId   String
  userId     String
  testDate   DateTime
  testType   TestType
  status     TestStatus @default(DRAFT)

  // Test metadata (legacy string fields - prefer relations below)
  location    String?     // Piteå, Skellefteå, etc. (LEGACY - use locationId)
  testLeader  String?     // Name of test leader (LEGACY - use testerId)
  inclineUnit InclineUnit @default(PERCENT) // For running tests: % or degrees

  // Structured references (preferred over string fields)
  testerId    String?     // FK to Tester
  locationId  String?     // FK to Location

  // Public report sharing
  publicToken     String?   @unique  // Random token for public access
  publicExpiresAt DateTime?          // When public link expires

  // Pre-test baseline measurements
  restingLactate    Float?  // Resting lactate before test (mmol/L)
  restingHeartRate  Int?    // Resting heart rate before test (bpm)

  // Post-test measurements (to capture peak lactate, 1-5 min after test)
  postTestMeasurements Json?  // Array of {timeMin: number, lactate: number, heartRate?: number}

  // Beräknade värden
  maxHR      Int?
  maxLactate Float?
  vo2max     Float?

  // Tröskelvärden
  aerobicThreshold    Json?  // {hr: number, value: number, unit: string}
  anaerobicThreshold  Json?  // {hr: number, value: number, unit: string}

  // Manual threshold overrides (set by test leader when algorithm fails)
  manualLT1Lactate    Float?  // Manual LT1 lactate value (mmol/L)
  manualLT1Intensity  Float?  // Manual LT1 intensity (speed/power/pace)
  manualLT2Lactate    Float?  // Manual LT2 lactate value (mmol/L)
  manualLT2Intensity  Float?  // Manual LT2 intensity (speed/power/pace)

  // Träningszoner
  trainingZones Json?  // Array av zoner

  // Anteckningar
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client           Client            @relation(fields: [clientId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  testStages       TestStage[]
  report           Report?
  trainingPrograms TrainingProgram[]

  // Training Engine relationships
  thresholdCalculation ThresholdCalculation?

  // Tester & Location relations
  tester               Tester?   @relation(fields: [testerId], references: [id], onDelete: SetNull)
  testLocation         Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([userId])
  @@index([testDate])
  @@index([location])
  @@index([testerId])
  @@index([locationId])
  @@index([publicToken])
}

model TestStage {
  id       String @id @default(uuid())
  testId   String
  sequence Int    // Ordning i testet

  // Gemensamma fält
  duration    Float  // minuter
  heartRate   Int    // slag/min
  lactate     Float  // mmol/L
  vo2         Float? // ml/kg/min

  // Löpspecifika
  speed       Float? // km/h
  incline     Float? // procent

  // Cykelspecifika
  power       Float? // watt
  cadence     Int?   // rpm

  // Skidåkning (Cross-country skiing)
  pace        Float? // min/km

  // Beräknade värden
  economy     Float? // ml/kg/km för löpning
  wattsPerKg  Float? // watt/kg för cykling

  createdAt DateTime @default(now())

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@index([sequence])
}

model Report {
  id        String   @id @default(uuid())
  testId    String   @unique

  // Rapportdata
  htmlContent String  @db.Text
  pdfUrl      String?

  // Metadata
  generatedAt DateTime @default(now())
  generatedBy String

  // Anpassningar
  customNotes     String?
  recommendations String?

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)
}

model TestTemplate {
  id          String   @id @default(uuid())
  userId      String
  name        String
  testType    TestType
  description String?
  stages      Json     // Array of stage configurations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([testType])
  @@index([name])
}

// ==================== SUBSCRIPTION & BILLING ====================

model Subscription {
  id     String             @id @default(uuid())
  userId String             @unique
  tier   SubscriptionTier   @default(FREE)
  status SubscriptionStatus @default(TRIAL)

  // Limits based on tier
  maxAthletes      Int      @default(0) // 0=FREE, 5=BASIC, 50=PRO, -1=ENTERPRISE (unlimited)
  currentAthletes  Int      @default(0)

  // Billing
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  trialEndsAt DateTime?
  cancelAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([tier])
}

// ==================== REFERRAL SYSTEM ====================

/// Unique referral code for each coach
model ReferralCode {
  id        String   @id @default(uuid())
  userId    String   @unique  // One code per coach
  code      String   @unique  // e.g., "JOHN2024", "STAR-ABC123"
  isActive  Boolean  @default(true)

  // Usage tracking
  totalUses     Int  @default(0)  // Total times code was used
  successfulReferrals Int @default(0)  // Completed referrals

  // Optional limits
  maxUses   Int?     // null = unlimited
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  referrals Referral[]

  @@index([code])
  @@index([userId])
  @@index([isActive])
}

/// Tracks individual referrals (when someone signs up using a referral code)
model Referral {
  id              String         @id @default(uuid())
  referralCodeId  String
  referrerUserId  String         // Coach who made the referral
  referredUserId  String?        // User who signed up (null until they complete signup)
  referredEmail   String         // Email used during signup (for tracking before account created)

  status          ReferralStatus @default(PENDING)

  // Reward tracking
  referrerRewardGranted Boolean @default(false)
  referredRewardGranted Boolean @default(false)

  // Timestamps
  signupAt        DateTime?      // When referred user signed up
  completedAt     DateTime?      // When referral was marked complete
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  referralCode    ReferralCode   @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)
  referrerUser    User           @relation("ReferrerUser", fields: [referrerUserId], references: [id], onDelete: Cascade)
  referredUser    User?          @relation("ReferredUser", fields: [referredUserId], references: [id], onDelete: SetNull)
  rewards         ReferralReward[]

  @@unique([referralCodeId, referredEmail])  // Prevent duplicate referrals for same email
  @@index([referrerUserId])
  @@index([referredUserId])
  @@index([referredEmail])
  @@index([status])
}

/// Rewards granted for successful referrals
model ReferralReward {
  id          String             @id @default(uuid())
  referralId  String
  userId      String             // User who received the reward

  rewardType  ReferralRewardType
  value       Float              // e.g., 1 for 1 month, 20 for 20% discount, 5 for 5 athlete slots

  // Status
  applied     Boolean   @default(false)
  appliedAt   DateTime?
  expiresAt   DateTime?

  // For subscription-related rewards
  stripeDiscountId String?       // If using Stripe coupon

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  referral    Referral  @relation(fields: [referralId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([referralId])
  @@index([userId])
  @@index([applied])
}

// ==================== ATHLETE SUBSCRIPTION (Direct Athletes) ====================

/// Subscription for individual athletes (separate from coach Subscription)
model AthleteSubscription {
  id                     String                   @id @default(uuid())
  clientId               String                   @unique
  tier                   AthleteSubscriptionTier  @default(FREE)
  status                 SubscriptionStatus       @default(TRIAL)
  paymentSource          PaymentSource            @default(DIRECT)

  // Stripe integration
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  billingCycle           String?                  // "MONTHLY" | "YEARLY"

  // Revenue sharing (if paymentSource = BUSINESS)
  businessId             String?
  revenueSharePercent    Float?                   // Platform's share (e.g., 20 = 20%)

  // Feature flags (cached for performance)
  aiChatEnabled          Boolean                  @default(false)
  aiChatMessagesUsed     Int                      @default(0)
  aiChatMessagesLimit    Int                      @default(0)      // 0 = disabled, -1 = unlimited
  videoAnalysisEnabled   Boolean                  @default(false)
  garminEnabled          Boolean                  @default(false)
  stravaEnabled          Boolean                  @default(false)
  workoutLoggingEnabled  Boolean                  @default(false)
  dailyCheckInEnabled    Boolean                  @default(false)

  // Trial
  trialEndsAt            DateTime?

  // Timestamps
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt

  client                 Client                   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  business               Business?                @relation(fields: [businessId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([tier])
  @@index([status])
  @@index([businessId])
  @@index([paymentSource])
}

// ==================== BUSINESS & ORGANIZATION ====================

/// Business entity (gym, testing center, coaching company)
model Business {
  id                     String        @id @default(uuid())
  name                   String
  slug                   String        @unique    // URL-friendly identifier
  description            String?       @db.Text

  // Contact info
  email                  String?
  phone                  String?
  website                String?

  // Address
  address                String?
  city                   String?
  postalCode             String?
  country                String?       @default("SE")

  // Stripe Connect for revenue sharing
  stripeConnectAccountId String?
  stripeConnectStatus    String?                  // "PENDING", "ACTIVE", "RESTRICTED"
  defaultRevenueShare    Float         @default(20) // Default platform share %

  // Branding
  logoUrl                String?
  primaryColor           String?       @default("#3b82f6")

  // Settings
  isActive               Boolean       @default(true)
  settings               Json?                    // Business-specific settings

  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  members                BusinessMember[]
  testers                Tester[]
  locations              Location[]
  athleteSubscriptions   AthleteSubscription[]
  invitations            Invitation[]

  @@index([slug])
  @@index([isActive])
}

/// Links users to businesses with roles
model BusinessMember {
  id                     String        @id @default(uuid())
  businessId             String
  userId                 String

  // Role within business
  role                   String        @default("MEMBER") // "OWNER", "ADMIN", "MEMBER", "TESTER"

  // Permissions (JSON for flexibility)
  permissions            Json?         // { canManageTesters, canViewAllTests, canManageClients, etc. }

  // Status
  isActive               Boolean       @default(true)
  invitedAt              DateTime      @default(now())
  acceptedAt             DateTime?

  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  business               Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user                   User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([businessId, userId])
  @@index([businessId])
  @@index([userId])
  @@index([role])
}

// ==================== TESTERS & LOCATIONS ====================

/// Personnel who conduct tests (can have privacy restrictions)
model Tester {
  id                     String        @id @default(uuid())
  businessId             String?                  // Optional - can be independent
  userId                 String?       @unique    // Link to User if they have account
  name                   String
  email                  String?

  // Privacy settings
  isPrivate              Boolean       @default(false) // Only sees own tests

  // Stats (cached for performance)
  totalTests             Int           @default(0)
  lastTestAt             DateTime?

  // Contact info
  phone                  String?
  title                  String?                  // "Fysiolog", "Coach", etc.

  isActive               Boolean       @default(true)

  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  business               Business?     @relation(fields: [businessId], references: [id], onDelete: SetNull)
  user                   User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  tests                  Test[]

  @@index([businessId])
  @@index([userId])
  @@index([isActive])
}

/// Physical location where tests are conducted
model Location {
  id                     String        @id @default(uuid())
  businessId             String
  name                   String
  city                   String?

  // Address
  address                String?
  postalCode             String?

  // Coordinates (for map display)
  latitude               Float?
  longitude              Float?

  // Stats (cached for performance)
  totalTests             Int           @default(0)
  lastTestAt             DateTime?

  // Settings
  isActive               Boolean       @default(true)
  settings               Json?         // Location-specific settings

  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  business               Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  tests                  Test[]

  @@index([businessId])
  @@index([city])
  @@index([isActive])
}

// ==================== INTEGRATIONS (Strava, Garmin) ====================

/// OAuth tokens for external integrations
model IntegrationToken {
  id                     String          @id @default(uuid())
  clientId               String
  type                   IntegrationType

  // OAuth tokens (encrypted at application level)
  accessToken            String          @db.Text
  refreshToken           String?         @db.Text
  expiresAt              DateTime?

  // Integration-specific data
  externalUserId         String?         // Strava athlete ID, Garmin user ID
  scope                  String?         // OAuth scopes granted

  // Sync status
  lastSyncAt             DateTime?
  lastSyncError          String?
  syncEnabled            Boolean         @default(true)

  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  client                 Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, type])
  @@index([clientId])
  @@index([type])
  @@index([lastSyncAt])
}

/// Temporary OAuth 1.0a request tokens (for Garmin OAuth flow)
/// These are short-lived and cleaned up after use or expiration
model OAuthRequestToken {
  id           String   @id @default(uuid())
  clientId     String   // Client initiating the OAuth flow
  provider     String   // e.g., "GARMIN"
  requestToken String   // OAuth 1.0a request token
  tokenSecret  String   // OAuth 1.0a token secret
  createdAt    DateTime @default(now())
  expiresAt    DateTime // Auto-expire after 10 minutes

  @@unique([clientId, provider])
  @@index([expiresAt])
}

/// Synced Strava activities for training load analysis
model StravaActivity {
  id                     String          @id @default(uuid())
  clientId               String
  stravaId               String          @unique  // Strava activity ID

  // Basic activity info
  name                   String
  type                   String          // Strava activity type (Run, Ride, etc.)
  sportType              String?         // Strava sport_type
  startDate              DateTime
  description            String?         @db.Text

  // Metrics
  distance               Float?          // meters
  movingTime             Int?            // seconds
  elapsedTime            Int?            // seconds
  elevationGain          Float?          // meters
  averageSpeed           Float?          // m/s
  maxSpeed               Float?          // m/s

  // Heart rate
  averageHeartrate       Float?
  maxHeartrate           Float?

  // Cadence
  averageCadence         Float?

  // Power (cycling)
  averageWatts           Float?
  weightedAverageWatts   Float?
  kilojoules             Float?

  // Strava scores
  sufferScore            Int?
  calories               Float?

  // Activity flags
  trainer                Boolean         @default(false)
  manual                 Boolean         @default(false)

  // Map data
  mapPolyline            String?         @db.Text

  // Calculated metrics
  tss                    Float?          // Training Stress Score
  trimp                  Float?          // Training Impulse

  // Mapped to our internal types
  mappedType             String?         // RUNNING, CYCLING, etc.
  mappedIntensity        String?         // EASY, MODERATE, HARD

  // Detailed data (JSON)
  splitsMetric           Json?           // Kilometer splits
  laps                   Json?           // Lap data

  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  client                 Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([startDate])
  @@index([type])
  @@index([mappedType])
}

/// Concept2 Logbook workout results (rowing, SkiErg, BikeErg)
model Concept2Result {
  id                     String          @id @default(uuid())
  clientId               String
  concept2Id             Int             @unique  // Concept2 result ID

  // Equipment & workout info
  type                   String                   // rower, skierg, bike, dynamic, etc.
  workoutType            String?                  // JustRow, FixedDistanceSplits, etc.
  date                   DateTime
  timezone               String?
  comments               String?         @db.Text

  // Core metrics
  distance               Int                      // meters
  time                   Int                      // tenths of seconds
  calories               Int?
  strokeRate             Float?                   // avg strokes/min (or rpm for bike)
  dragFactor             Int?

  // Heart rate
  avgHeartRate           Float?
  maxHeartRate           Float?
  minHeartRate           Float?

  // Pace (derived - seconds per 500m for rowing/ski, or calculated for bike)
  pace                   Float?

  // Splits/intervals (JSON)
  splits                 Json?
  intervals              Json?

  // Stroke data availability
  hasStrokeData          Boolean         @default(false)

  // Calculated metrics
  tss                    Float?          // Training Stress Score
  trimp                  Float?          // Training Impulse

  // Mapped to our internal types
  mappedType             String?         // ROWING, SKIING, CYCLING
  mappedIntensity        String?         // EASY, MODERATE, HARD

  // Verification status from Concept2
  isVerified             Boolean         @default(false)

  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  client                 Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([date])
  @@index([type])
  @@index([mappedType])
}

// ==================== INVITATIONS & REFERRALS ====================

/// Invitations and referral codes
model Invitation {
  id                     String          @id @default(uuid())
  code                   String          @unique
  type                   InvitationType

  // Sender (optional)
  senderId               String?         // User who sent invitation
  businessId             String?         // Business context

  // Recipient
  recipientEmail         String?
  recipientName          String?

  // Usage
  usedAt                 DateTime?
  usedByClientId         String?         // Client who used the invitation

  // Expiry
  expiresAt              DateTime?
  maxUses                Int             @default(1)
  currentUses            Int             @default(0)

  // Referral bonus tracking
  bonusAwarded           Boolean         @default(false)
  bonusAmount            Float?

  // Metadata
  metadata               Json?           // Additional context data

  createdAt              DateTime        @default(now())

  business               Business?       @relation(fields: [businessId], references: [id], onDelete: SetNull)

  @@index([code])
  @@index([type])
  @@index([senderId])
  @@index([businessId])
  @@index([expiresAt])
}

// ==================== ATHLETE ACCOUNTS ====================

// Links a Client to an Athlete User account (1-to-1)
model AthleteAccount {
  id        String   @id @default(uuid())
  clientId  String   @unique
  userId    String   @unique

  // Athlete preferences
  notificationPrefs Json? // { email: boolean, push: boolean, workoutReminders: boolean }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([userId])
}

// ==================== TRAINING PROGRAMS ====================

model TrainingProgram {
  id          String   @id @default(uuid())
  clientId    String
  coachId     String   // User who created it
  testId      String?  // Optional: linked to specific test results

  name        String   // "Marathon Training - Spring 2025"
  description String?  @db.Text
  goalRace    String?  // "Stockholm Marathon", "Get in shape", "5K PR"
  goalDate    DateTime?
  goalType    String?  // "marathon", "half-marathon", "10k", "5k", "fitness", "cycling", "skiing"

  startDate DateTime
  endDate   DateTime

  // Metadata
  isActive   Boolean @default(true)
  isTemplate Boolean @default(false) // Can be reused as template

  // Generated from which test?
  generatedFromTest Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  coach  User   @relation("CoachPrograms", fields: [coachId], references: [id])
  test   Test?  @relation(fields: [testId], references: [id], onDelete: SetNull)

  weeks TrainingWeek[]

  @@index([clientId])
  @@index([coachId])
  @@index([testId])
  @@index([startDate, endDate])
  @@index([isActive])
}

model TrainingWeek {
  id        String @id @default(uuid())
  programId String

  weekNumber   Int    // 1, 2, 3...
  startDate    DateTime
  endDate      DateTime

  phase        PeriodPhase
  focus        String? // "Build endurance", "Taper week", "Recovery"
  weeklyVolume Float?  // Planned total hours or km

  notes String? @db.Text

  program TrainingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  days    TrainingDay[]

  @@unique([programId, weekNumber])
  @@index([programId])
  @@index([startDate, endDate])
}

model TrainingDay {
  id     String @id @default(uuid())
  weekId String

  dayNumber Int      // 1=Monday, 2=Tuesday, etc.
  date      DateTime

  notes String? @db.Text

  week     TrainingWeek @relation(fields: [weekId], references: [id], onDelete: Cascade)
  workouts Workout[]

  @@unique([weekId, dayNumber])
  @@index([weekId])
  @@index([date])
}

model Workout {
  id    String @id @default(uuid())
  dayId String

  type        WorkoutType
  name        String   // "Long Run", "Tempo Run", "Upper Body Strength"
  description String?  @db.Text
  status      String   @default("PLANNED") // "PLANNED", "MODIFIED", "CANCELLED", "COMPLETED"

  intensity WorkoutIntensity
  duration  Int?   // Planned minutes
  distance  Float? // Planned km (for running)

  // Coach instructions
  instructions String? @db.Text
  coachNotes   String? @db.Text

  // Ordering (if multiple workouts in one day)
  order Int @default(1)

  // Is this a custom workout added by athlete?
  isCustom Boolean @default(false)

  // Hero Card Fields (AI-generated or rule-based)
  heroTitle        String?   // "Posterior Chain Focus"
  heroDescription  String?   @db.Text // "Focus on hinge movements. Primary lift: Deadlift"
  heroCategory     String?   // "HEAVY_LOWER_BODY", "QUAD_DOMINANT", etc.
  heroImageKey     String?   // Key for exercise image lookup
  focusGeneratedAt DateTime?
  focusGeneratedBy String?   // "AI" | "RULE_BASED"

  day      TrainingDay      @relation(fields: [dayId], references: [id], onDelete: Cascade)
  segments WorkoutSegment[]
  logs     WorkoutLog[]
  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dayId, order])
  @@index([type])
  @@index([isCustom])
  @@index([status]) // Filter by workout status
}

model WorkoutSegment {
  id        String @id @default(uuid())
  workoutId String

  order Int    // 1, 2, 3...
  type  String // "warmup", "interval", "cooldown", "exercise", "rest", "work"

  // Running/Cycling specific
  duration  Int?    // minutes
  distance  Float?  // km
  pace      String? // "5:00/km" or calculated from zone
  zone      Int?    // Training zone 1-5
  heartRate String? // "140-150 bpm" or zone-based
  power     Int?    // watts (cycling)

  // Interval-specific
  reps Int? // Number of repetitions (for intervals)

  // Strength/Plyo/Core specific
  exerciseId String? // FK to Exercise library
  sets       Int?
  repsCount  String? // "10" or "10-12" or "AMRAP" or "30 seconds"
  weight     String? // "80kg" or "BW" or "50% 1RM"
  tempo      String? // "3-1-1" (eccentric-pause-concentric)
  rest       Int?    // seconds between sets

  // Section grouping (for structured strength workouts)
  section    WorkoutSectionType @default(MAIN)

  // General
  description String? @db.Text
  notes       String? @db.Text

  workout  Workout   @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exercise Exercise? @relation(fields: [exerciseId], references: [id], onDelete: SetNull)
  setLogs  SetLog[]  // Per-set logging data

  createdAt DateTime @default(now())

  @@index([workoutId, order])
  @@index([exerciseId])
}

// ==================== EXERCISE LIBRARY ====================

model Exercise {
  id          String       @id @default(uuid())
  coachId     String?      // NULL = system exercise, else custom
  name        String       // "Back Squat", "Box Jump", "Plank"
  category    WorkoutType  // STRENGTH, PLYOMETRIC, CORE
  muscleGroup String?      // "Legs", "Core", "Upper Body"

  description  String? @db.Text
  instructions String? @db.Text
  videoUrl     String? // YouTube/Vimeo link
  equipment    String? // "Barbell, Rack", "Box", "None"

  difficulty String? // "Beginner", "Intermediate", "Advanced"

  isPublic Boolean @default(true) // System exercises vs coach-specific

  // Swedish/English names
  nameSv String?
  nameEn String?

  // Scientific Framework Fields
  biomechanicalPillar BiomechanicalPillar? // Primary movement pattern
  progressionLevel    ProgressionLevel?    // Level 1-3 progression
  plyometricIntensity PlyometricIntensity? // For plyometric exercises only
  contactsPerRep      Int?                 // Ground contacts per rep (plyometric)

  // Exercise substitutions and progressions
  substitutes         String?              // JSON array of alternative exercise IDs
  progressionPath     String?              // JSON array: [easier_id, current_id, harder_id]

  // Hybrid Studio Fields
  isHybridMovement    Boolean              @default(false) // Is this a CrossFit/HYROX movement?
  movementCategory    MovementCategory?    // OLYMPIC_LIFT, POWERLIFTING, GYMNASTICS, etc.
  equipmentTypes      EquipmentType[]      @default([]) // Required equipment
  defaultReps         Int?                 // Default rep count for this movement
  defaultWeightMale   Float?               // Default male Rx weight (kg)
  defaultWeightFemale Float?               // Default female Rx weight (kg)
  scaledWeightMale    Float?               // Scaled male weight (kg)
  scaledWeightFemale  Float?               // Scaled female weight (kg)
  foundationMovement  String?              // Alternative for Foundations level
  standardAbbreviation String?             // e.g., "C&J" for Clean & Jerk, "MU" for Muscle-Up

  // Icon fields for themed workout display
  iconUrl             String?              // URL to exercise-specific icon
  iconCategory        String?              // Category for fallback icon: "strength", "cardio", "core", "plyometric", "olympic", "gymnastics"

  // Exercise images (AI-generated, stored in Supabase)
  imageUrls           Json?                // Array of image paths: ["system/posterior-chain/squat-1.webp", ...]
  primaryImageIndex   Int?     @default(0) // Index of primary image for thumbnails

  coach                User?                 @relation(fields: [coachId], references: [id], onDelete: SetNull)
  segments             WorkoutSegment[]
  progressionTracking  ProgressionTracking[]
  oneRepMaxHistory     OneRepMaxHistory[]

  // AI Studio relations
  videoAnalyses        VideoAnalysis[]

  // Hybrid Studio relations
  hybridMovements      HybridMovement[]

  // VBT (Velocity-Based Training) relations
  vbtMeasurements      VBTMeasurement[]
  loadVelocityProfiles LoadVelocityProfile[]

  // Per-set logging
  setLogs              SetLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([category])
  @@index([name])
  @@index([isPublic])
  @@index([biomechanicalPillar])
  @@index([progressionLevel])
  @@index([isHybridMovement])
  @@index([movementCategory])
}

// ==================== WORKOUT LOGGING ====================

model WorkoutLog {
  id         String  @id @default(uuid())
  workoutId  String
  athleteId  String  // User with ATHLETE role
  completed  Boolean @default(false)

  completedAt DateTime?

  // Actual values
  duration Int?   // actual minutes
  distance Float? // actual km
  avgPace  String? // "5:15/km"
  avgHR    Int?   // bpm
  maxHR    Int?   // bpm

  // Cycling-specific power data
  avgPower        Int?    // average watts
  normalizedPower Int?    // normalized power (NP)
  maxPower        Int?    // peak power
  avgCadence      Int?    // average RPM
  elevation       Int?    // total elevation gain in meters
  tss             Float?  // Training Stress Score
  intensityFactor Float?  // IF (NP/FTP ratio)
  powerZone       Int?    // primary zone trained in

  // Subjective feedback
  perceivedEffort Int?    // 1-10 RPE scale
  difficulty      Int?    // 1-5 stars
  feeling         String? // "Great", "Good", "Okay", "Tired", "Struggled"
  notes           String? @db.Text

  // File uploads (Garmin .fit, Strava link, etc.)
  dataFileUrl String?
  stravaUrl   String?

  // Coach feedback
  coachFeedback  String? @db.Text
  coachViewedAt  DateTime?

  workout Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  athlete User    @relation(fields: [athleteId], references: [id])
  setLogs SetLog[]  // Per-set logging data for strength exercises

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workoutId])
  @@index([athleteId])
  @@index([completedAt])
  @@index([completed])
}

// ==================== PER-SET LOGGING ====================

model SetLog {
  id            String   @id @default(uuid())

  // Parent relationships (at least one should be set)
  workoutLogId  String?                        // For WorkoutLog-based logging
  segmentId     String?                        // Link to specific segment
  assignmentId  String?                        // For StrengthSessionAssignment-based logging

  // Exercise identification
  exerciseId    String
  setNumber     Int      // 1, 2, 3...

  // Core metrics
  weight        Float    // kg
  repsCompleted Int
  repsTarget    Int?
  rpe           Int?     // 1-10

  // VBT metrics (optional manual entry)
  meanVelocity  Float?   // m/s
  peakVelocity  Float?   // m/s
  meanPower     Float?   // watts
  peakPower     Float?   // watts

  // Timing
  restTaken     Int?     // seconds of rest taken after this set

  // Calculated fields
  estimated1RM  Float?   // calculated from weight/reps
  velocityZone  String?  // STRENGTH, POWER, SPEED based on velocity

  // Notes
  notes         String?  @db.Text

  completedAt   DateTime @default(now())
  createdAt     DateTime @default(now())

  // Relations
  exercise      Exercise                   @relation(fields: [exerciseId], references: [id])
  workoutLog    WorkoutLog?                @relation(fields: [workoutLogId], references: [id], onDelete: Cascade)
  segment       WorkoutSegment?            @relation(fields: [segmentId], references: [id], onDelete: SetNull)
  assignment    StrengthSessionAssignment? @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([workoutLogId])
  @@index([segmentId])
  @@index([assignmentId])
  @@index([exerciseId])
  @@index([completedAt])
}

// ==================== MESSAGING ====================

model Message {
  id         String  @id @default(uuid())
  senderId   String
  receiverId String

  subject String?
  content String  @db.Text

  // Optional: link to specific workout
  workoutId String?

  isRead Boolean   @default(false)
  readAt DateTime?

  sender   User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  workout  Workout? @relation(fields: [workoutId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@index([workoutId])
  @@index([createdAt])
  @@index([isRead])
}

// ============================================
// TRAINING ENGINE MODELS
// Added: 2025-11-14
// Purpose: Elite training program generation with monitoring and adaptation
// ============================================

// ============================================
// ENHANCED THRESHOLD CALCULATIONS
// ============================================

/// Stores results from D-max, Mod-Dmax, and field test threshold calculations
model ThresholdCalculation {
  id               String   @id @default(uuid())
  testId           String   @unique
  method           String   // "D-MAX", "MOD-DMAX", "OBLA", "FIELD_TEST", "SELF_REPORTED"
  confidence       String   // "VERY_HIGH", "HIGH", "MEDIUM", "LOW"

  // D-max specific data
  polynomialCoeffs Json?    // {a: number, b: number, c: number, d: number}
  r2               Float?   // Goodness of fit (require ≥0.90 for high confidence)
  dmaxIntensity    Float?   // Intensity at D-max point
  dmaxLactate      Float?   // Lactate at D-max point
  dmaxHr           Float?   // Heart rate at D-max point

  // LT1 (Aerobic Threshold) data
  lt1Intensity     Float    // km/h, watts, or m/s
  lt1Lactate       Float    // mmol/L
  lt1Hr            Float    // bpm
  lt1Method        String   // "BASELINE_PLUS_0.5", "HR_DRIFT", "TALK_TEST"

  // LT2 (Anaerobic Threshold) data
  lt2Intensity     Float
  lt2Lactate       Float
  lt2Hr            Float
  lt2PercentVO2max Float?   // LT2 as % of VO2max (for categorization)

  // Metadata
  testDate         DateTime
  notes            String?
  warnings         Json?    // Array of validation warnings

  test             Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([testId])
  @@index([method, confidence]) // Filter by calculation method and confidence level
  @@index([testDate]) // Sort by test date for temporal queries
}

// ============================================
// ATHLETE PROFILING & CATEGORIZATION
// ============================================

/// Central profile for each athlete with categorization and baselines
model AthleteProfile {
  id                  String    @id @default(uuid())
  clientId            String    @unique

  // Categorization (affects methodology selection)
  category            String    // "BEGINNER", "RECREATIONAL", "ADVANCED", "ELITE"
  vo2maxPercentile    Float?    // Percentile for age/gender
  lt2AsPercentVO2max  Float?    // Key categorization metric

  // VDOT-based training data (from race performance)
  currentVDOT         Float?    // Most recent VDOT calculation
  vdotSource          String?   // "RACE_5K", "RACE_10K", "RACE_HM", "RACE_MARATHON", "ESTIMATED"
  vdotConfidence      String?   // "VERY_HIGH", "HIGH", "MEDIUM", "LOW"
  vdotLastUpdated     DateTime?
  vdotAgeAdjusted     Boolean   @default(false) // Whether age adjustment was applied
  vdotGenderAdjusted  Boolean   @default(false) // Whether gender adjustment was applied

  // Lactate profile data (from lab or field tests)
  maxLactate          Float?    // Maximum lactate achieved (mmol/L)
  lt2LactateRatio     Float?    // LT2 as % of max lactate (individual ratio)
  lt2Speed            Float?    // LT2 speed (km/h)
  lt2HeartRate        Int?      // LT2 heart rate (bpm)
  lactateTestDate     DateTime? // Date of most recent lactate test
  lactateConfidence   String?   // "VERY_HIGH", "HIGH", "MEDIUM", "LOW"

  // Metabolic type (affects training recommendations)
  metabolicType       String?   // "SLOW_TWITCH", "FAST_TWITCH_ENDURANCE", "FAST_TWITCH_POWER", "MIXED"
  metabolicTypeSource String?   // "LACTATE_PROFILE", "RACE_PATTERN", "ESTIMATED"

  // Dynamic compression factor (for marathon pace calculation)
  compressionFactor   Float?    // MP as % of LT2 pace (0.75-0.98)
  compressionSource   String?   // "LEVEL_BASED", "AGE_ADJUSTED", "GENDER_ADJUSTED", "CUSTOM"

  // Complete pace zones (stored for quick access)
  danielsZones        Json?     // DanielsZones object
  canovaZones         Json?     // CanovaZones object
  norwegianZones      Json?     // NorwegianZones object
  hrZones             Json?     // HRZones object
  zonesLastUpdated    DateTime?
  zonesPrimarySource  String?   // "VDOT", "LACTATE_RATIO", "HR_ESTIMATION", "PROFILE_ESTIMATION"

  // Monitoring baselines (established over 14-21 days)
  hrvBaseline         Float?    // RMSSD in ms
  hrvStdDev           Float?    // Standard deviation for thresholds
  hrvLastUpdated      DateTime?
  rhrBaseline         Float?    // bpm
  rhrLastUpdated      DateTime?

  // Current training zones (DEPRECATED - use specific zone fields above)
  trainingZones       Json?

  // Equipment & capabilities
  hasLactateMeter     Boolean   @default(false)
  hasHRVMonitor       Boolean   @default(false)
  hasPowerMeter       Boolean   @default(false)

  // Cross-training preferences (JSON: preferredOrder, equipment, limitations, injuryOverrides)
  crossTrainingPreferences Json?

  // Training history context
  yearsRunning        Int?
  typicalWeeklyKm     Float?
  longestLongRun      Float?

  // Norwegian Method tracking
  norwegianPhase      Int?      // Current phase (1-4) in Norwegian transition

  client              Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([clientId])
  @@index([category])
  @@index([hasLactateMeter, hasHRVMonitor]) // Filter athletes by monitoring capabilities
  @@index([vo2maxPercentile]) // Rank athletes by VO2max
  @@index([norwegianPhase]) // Track Norwegian Method progression
  @@index([currentVDOT]) // Rank athletes by VDOT
  @@index([metabolicType]) // Group by metabolic profile
  @@index([vdotLastUpdated]) // Find stale VDOT data
}

// ============================================
// DAILY MONITORING SYSTEM
// ============================================

/// Quick daily check-in for athletes (<2 minutes)
model DailyCheckIn {
  id                  String    @id @default(uuid())
  clientId            String
  date                DateTime  @db.Date

  // Optional HRV/RHR (if athlete has monitors)
  hrv                 Float?    // RMSSD in ms
  restingHR           Float?    // bpm

  // Wellness questionnaire (1-10 scale, 7 questions)
  sleepQuality        Int       // 1=terrible, 10=perfect
  sleepHours          Float?    // Actual hours slept
  soreness            Int       // 1=none, 10=severe
  fatigue             Int       // 1=none, 10=extreme
  stress              Int       // 1=none, 10=extreme
  mood                Int       // 1=terrible, 10=excellent
  motivation          Int       // 1=none, 10=extremely motivated

  // Derived readiness score (0-100)
  readinessScore      Int?
  readinessDecision   String?   // "PROCEED", "REDUCE", "EASY", "REST"

  // Notes
  notes               String?

  // Audio journal (if populated from voice input)
  audioJournal        AudioJournal?

  client              Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([clientId, date])
  @@index([clientId, date])
  @@index([readinessScore])
  @@index([readinessDecision])
}

/// Field test schedule and reminders
model FieldTestSchedule {
  id              String    @id @default(uuid())
  clientId        String
  testType        String    // "30MIN_TT", "HR_DRIFT", "CRITICAL_VELOCITY"
  scheduledDate   DateTime
  required        Boolean   @default(false) // Critical tests must be completed

  completed       Boolean   @default(false)
  completedDate   DateTime?
  fieldTestId     String?   // Link to completed FieldTest

  // Reminders
  reminderSent    Boolean   @default(false)
  reminderDate    DateTime?

  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([clientId, scheduledDate])
  @@index([completed, scheduledDate])
  @@index([clientId, completed])
}

/// Daily metrics for athlete monitoring and readiness assessment
model DailyMetrics {
  id                  String    @id @default(uuid())
  clientId            String
  date                DateTime  @db.Date

  // HRV data
  hrvRMSSD            Float?    // Primary HRV metric (ms)
  hrvQuality          String?   // "GOOD", "FAIR", "POOR"
  hrvArtifactPercent  Float?    // % of recording with artifacts
  hrvDuration         Float?    // Duration of measurement in seconds
  hrvPosition         String?   // "SUPINE", "SEATED"
  hrvStatus           String?   // "EXCELLENT", "GOOD", "MODERATE", "FAIR", "POOR", "VERY_POOR"
  hrvPercent          Float?    // % of baseline
  hrvTrend            String?   // "IMPROVING", "STABLE", "DECLINING"

  // Resting Heart Rate
  restingHR           Float?    // bpm
  restingHRDev        Float?    // Deviation from baseline (bpm)
  restingHRStatus     String?   // Status based on deviation

  // Wellness questionnaire (1-10 scale)
  sleepQuality        Int?      // 1=terrible, 10=perfect
  sleepHours          Float?    // Actual hours slept
  muscleSoreness      Int?      // 1=none, 10=severe
  energyLevel         Int?      // 1=exhausted, 10=energized
  mood                Int?      // 1=terrible, 10=excellent
  stress              Int?      // 1=none, 10=extreme
  injuryPain          Int?      // 1=none, 10=severe

  // Derived scores
  wellnessScore       Float?    // Weighted composite (0-10)
  wellnessStatus      String?   // "EXCELLENT" to "VERY_POOR"

  // Composite readiness
  readinessScore      Float?    // 0-10 weighted composite
  readinessLevel      String?   // "EXCELLENT", "GOOD", "MODERATE", "FAIR", "POOR", "VERY_POOR"
  recommendedAction   String?   // "PROCEED", "MODIFY_LIGHT", "MODIFY_MODERATE", "MODIFY_SIGNIFICANT", "REST_REQUIRED"

  // Detailed breakdown
  factorScores        Json?     // Factor contributions
  redFlags            Json?     // Critical issues
  yellowFlags         Json?     // Warnings

  // Notes
  athleteNotes        String?
  coachNotes          String?

  // Injury details (when injuryPain >= 3)
  injuryBodyPart      String?   // Body part selected: KNEE, LOWER_LEG, etc.
  injurySpecificType  String?   // Specific injury type: PATELLOFEMORAL, SHIN_SPLINTS, etc.
  injurySide          String?   // LEFT, RIGHT, BOTH, NA
  isIllness           Boolean   @default(false)  // True if reporting illness vs injury
  illnessType         String?   // FEVER, GASTROINTESTINAL, COLD, HEADACHE, GENERAL_ILLNESS

  // Keyword analysis from notes
  detectedKeywords    Json?     // Array of detected keywords with categories
  keywordBodyPart     String?   // Body part detected from notes
  keywordSeverity     String?   // Severity level from keywords: LOW, MEDIUM, HIGH
  keywordSummary      String?   // Human-readable summary for coach

  client              Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([clientId, date])
  @@index([clientId, date])
  @@index([clientId, readinessScore]) // Filter athletes by readiness score
  @@index([clientId, readinessLevel]) // Filter by readiness level categories
  @@index([date, readinessLevel]) // Daily readiness overview across all athletes
}

// ============================================
// TRAINING LOAD & ACWR TRACKING
// ============================================

/// Daily training load with ACWR calculation using EWMA method
model TrainingLoad {
  id              String    @id @default(uuid())
  clientId        String
  date            DateTime  @db.Date

  // Daily training load
  dailyLoad       Float     // TSS or TRIMP value
  loadType        String    // "TSS", "TRIMP_EDWARDS", "TRIMP_BANISTER", "TRIMP_LUCIA"

  // ACWR calculations
  acuteLoad       Float?    // 7-day EWMA
  chronicLoad     Float?    // 28-day EWMA
  acwr            Float?    // Acute:Chronic ratio
  acwrZone        String?   // "DETRAINING", "OPTIMAL", "CAUTION", "DANGER", "CRITICAL"
  injuryRisk      String?   // "LOW", "MODERATE", "HIGH", "VERY_HIGH"

  // Session details
  duration        Float     // minutes
  distance        Float?    // km
  avgHR           Float?    // bpm
  maxHR           Float?    // bpm
  avgPace         Float?    // sec/km
  intensity       String    // "RECOVERY", "EASY", "MODERATE", "HARD", "VERY_HARD"

  // Session type
  workoutType     String?   // "EASY", "LONG", "THRESHOLD", "INTERVALS", "TEMPO", "RECOVERY", "RACE"
  workoutId       String?   // Link to planned workout

  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())

  @@index([clientId, date])
  @@index([clientId, acwrZone]) // Filter by ACWR risk zone
  @@index([clientId, injuryRisk]) // Filter by injury risk level
}

// ============================================
// ENHANCED TRAINING PROGRAMS
// ============================================

/// Complete training program with periodization and methodology
model TrainingProgramEngine {
  id              String   @id @default(uuid())
  clientId        String

  // Core settings
  name            String
  methodology     String   // "POLARIZED", "NORWEGIAN", "CANOVA", "PYRAMIDAL", "LYDIARD"
  status          String   @default("DRAFT") // "DRAFT", "ACTIVE", "COMPLETED", "PAUSED", "ARCHIVED"

  // Timeline
  startDate       DateTime
  endDate         DateTime
  totalWeeks      Int
  currentWeek     Int      @default(1)
  currentPhase    String?  // "BASE", "BUILD", "PEAK", "TAPER", "RECOVERY"

  // Goals
  targetRaceDate  DateTime?
  targetDistance  String?  // "5K", "10K", "HALF", "MARATHON", "ULTRA"
  targetTime      String?  // HH:MM:SS

  // Program structure (JSON for flexibility)
  periodization   Json
  weeklyPlans     Json

  // Methodology-specific settings
  methodologyConfig Json?

  // Generation metadata
  generatedBy     String   // "COACH" or "AUTO"
  generatedFrom   Json?    // {testId, fieldTestId, thresholdData}

  // Tracking
  completedWeeks  Int      @default(0)
  missedWorkouts  Int      @default(0)
  modifiedWorkouts Int     @default(0)

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId, status])
  @@index([clientId, startDate, endDate])
  @@index([methodology, status]) // Filter programs by training methodology
  @@index([currentPhase]) // Track athletes in specific training phases
}

// ============================================
// WORKOUT MODIFICATIONS
// ============================================

/// Tracks automatic and manual workout modifications
model WorkoutModification {
  id              String   @id @default(uuid())
  workoutId       String
  date            DateTime @default(now())

  // Decision
  decision        String   // "PROCEED", "MINOR_MODIFICATION", "MODERATE_MODIFICATION", "MAJOR_MODIFICATION", "CANCEL"
  autoGenerated   Boolean  @default(true)

  // Original plan
  plannedType     String
  plannedDuration Float    // minutes
  plannedDistance Float?   // km
  plannedIntensity String
  plannedDetails  Json?

  // Modified plan
  modifiedType    String?
  modifiedDuration Float?
  modifiedDistance Float?
  modifiedIntensity String?
  modifiedDetails Json?

  // Reasoning
  readinessScore  Float?
  factors         Json     // Array of {factor, weight, contribution, status}
  reasoning       String   // Human-readable explanation
  methodology     String?  // Methodology-specific guidance

  // References
  dailyMetricsId  String?
  acwr            Float?

  createdAt       DateTime @default(now())

  @@index([workoutId])
  @@index([date])
  @@index([decision])
  @@index([workoutId, date]) // Temporal workout modification history
  @@index([autoGenerated, decision]) // Filter manual vs automatic modifications
}

// ============================================
// FIELD TESTS
// ============================================

/// Results from field tests (alternative to lab testing)
model FieldTest {
  id              String   @id @default(uuid())
  clientId        String
  testType        String   // "30MIN_TT", "20MIN_TT", "HR_DRIFT", "CRITICAL_VELOCITY", "TALK_TEST", "RACE_BASED"
  date            DateTime

  // Test conditions
  conditions      Json?    // {temperature, humidity, wind, terrain}

  // Raw results (JSON for flexibility across test types)
  results         Json

  // Derived thresholds
  lt1Pace         Float?   // sec/km
  lt1HR           Float?   // bpm
  lt2Pace         Float?   // sec/km
  lt2HR           Float?   // bpm
  confidence      String?  // "VERY_HIGH", "HIGH", "MEDIUM", "LOW"

  // Validation
  valid           Boolean  @default(true)
  warnings        Json?
  errors          Json?

  notes           String?

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())

  @@index([clientId, date])
  @@index([testType, date])
  @@index([clientId, testType, date]) // Composite index for test type filtering
  @@index([confidence, valid]) // Filter high-confidence valid tests
}

// ============================================
// SELF-REPORTED LACTATE MEASUREMENTS
// ============================================

/// Athletes can track their own lactate measurements between lab tests
model SelfReportedLactate {
  id              String   @id @default(uuid())
  clientId        String
  date            DateTime

  // Measurement context
  measurementType String   // "WORKOUT", "RACE", "STANDALONE_TEST"
  workoutType     String?  // "EASY", "TEMPO", "THRESHOLD", "INTERVALS", "LONG"

  // Single measurement data
  intensity       Float?   // km/h, watts, or pace
  lactate         Float?   // mmol/L
  heartRate       Float?   // bpm
  rpe             Int?     // 1-10 scale

  // Multi-stage test data
  measurements    Json?    // [{stage, intensity, lactate, heartRate, rpe}]

  // Equipment & quality
  meterBrand      String?  // "Lactate Plus", "Lactate Scout", etc.
  calibrated      Boolean  @default(false)
  qualityRating   String?  // "GOOD", "FAIR", "POOR"

  // Derived insights
  estimatedLT1    Float?
  estimatedLT2    Float?
  confidence      String?  // "LOW", "MEDIUM", "HIGH"

  // Context
  workoutId       String?
  notes           String?
  photos          Json?    // Array of photo URLs

  // Validation status
  validated       Boolean  @default(false)
  validatedBy     String?  // Coach userId
  validatedAt     DateTime?
  validationNotes String?

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId, date])
  @@index([clientId, measurementType])
  @@index([validated])
  @@index([validated, clientId]) // Coach validation workflow - pending validations
  @@index([validatedBy, validatedAt]) // Track coach validation activity
}

// ============================================
// RACE CALENDAR & MULTI-RACE PLANNING
// ============================================

/// Season-level race planning with A/B/C classification
model RaceCalendar {
  id              String   @id @default(uuid())
  clientId        String
  seasonName      String   // "Spring 2025", "Fall Marathon Build"
  startDate       DateTime
  endDate         DateTime

  races           Race[]

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
}

/// Individual race with classification, goals, and results
model Race {
  id              String   @id @default(uuid())
  calendarId      String
  clientId        String

  // Race details
  name            String
  date            DateTime
  distance        String   // "5K", "10K", "HALF", "MARATHON"
  classification  String   // "A", "B", "C"
  priority        Int      @default(1)

  // Goals
  targetTime      String?  // HH:MM:SS
  targetPace      Float?   // sec/km

  // Preparation
  taperWeeks      Int?
  lastQualityDate DateTime?

  // Results
  actualTime      String?
  actualPace      Float?
  place           Int?
  avgHR           Float?
  maxHR           Float?
  splits          Json?
  conditions      Json?

  // Analysis
  vdot            Float?
  equivalents     Json?
  assessment      String?  // "EXCEEDED", "MET", "CLOSE", "MISSED"

  notes           String?
  photos          Json?

  calendar        RaceCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  client          Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([clientId, date])
  @@index([classification, date])
}

// ============================================
// INJURY MANAGEMENT SYSTEM
// ============================================

/// Injury assessment and pain tracking (University of Delaware Soreness Rules)
model InjuryAssessment {
  id              String   @id @default(uuid())
  clientId        String
  date            DateTime @default(now())
  detectedAt      DateTime @default(now()) // Timestamp of injury detection

  // Pain assessment (0-10 scale)
  painLevel       Int      // 0=none, 10=severe
  painLocation    String?  // "PLANTAR_FASCIA", "ACHILLES", "IT_BAND", etc.
  painTiming      String?  // "DURING_WARMUP", "DURING_WORKOUT", etc.
  gaitAffected    Boolean  @default(false) // RED FLAG if true

  // Soreness rules assessment
  painDuringWarmup Boolean @default(false)
  painContinuesThroughout Boolean @default(false)
  painDisappearsAfterWarmup Boolean @default(false)
  painRedevelopsLater Boolean @default(false)
  painPersists1HourPost Boolean @default(false)

  // Functional assessment
  rangeOfMotion   String?  // "NORMAL", "SLIGHTLY_LIMITED", etc.
  swelling        Boolean  @default(false)
  discoloration   Boolean  @default(false)
  weightBearing   String?  // "NORMAL", "SLIGHTLY_AFFECTED", "LIMPING", "UNABLE"

  // Assessment result
  assessment      String   // "CONTINUE", "MODIFY", "REST_1_DAY", etc.
  status          String   @default("ACTIVE") // "ACTIVE", "MONITORING", "RESOLVED"
  injuryType      String?
  phase           String?  // "ACUTE", "SUBACUTE", "CHRONIC", "RECOVERY"

  // Protocol recommendations
  recommendedProtocol Json?
  estimatedTimeOff String?

  // Follow-up
  resolved        Boolean  @default(false)
  resolvedDate    DateTime?
  notes           String?

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId, date])
  @@index([painLevel, gaitAffected])
  @@index([clientId, resolved]) // Track active vs resolved injuries
  @@index([injuryType, phase]) // Track injury types and phases across athletes
  @@index([clientId, injuryType, resolved]) // Track specific injury resolution
}

// ============================================
// CROSS-TRAINING SYSTEM
// ============================================

/// Cross-training sessions with running equivalencies
model CrossTrainingSession {
  id              String   @id @default(uuid())
  clientId        String
  date            DateTime
  workoutId       String?  // Link to replaced running workout

  // Session details
  modality        String   // "DEEP_WATER_RUNNING", "CYCLING", "ELLIPTICAL", etc.
  duration        Float    // minutes
  distance        Float?   // km (if applicable)
  avgHR           Float?   // bpm
  maxHR           Float?   // bpm
  avgPower        Float?   // watts (cycling)
  rpe             Int?     // 1-10 scale

  // Intensity structure
  intensity       String   // "EASY", "MODERATE", "HARD"
  structure       Json?    // Intervals, rest periods

  // Equipment specific
  bodyWeightSupport Float? // % for AlterG
  resistance      String?
  strokeRate      Float?   // Swimming

  // Conversion calculations
  runningEquivalent Json   // {estimatedTSS, runningDistance, runningDuration, fitnessRetention}
  tssEquivalent   Float?

  // Context
  reason          String?  // "INJURY", "VARIETY", "WEATHER", "PREFERENCE"
  injuryType      String?
  effectiveness   String?  // "EXCELLENT", "GOOD", "MODERATE", "POOR"

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId, date])
  @@index([modality, date])
  @@index([clientId, modality]) // Track preferred/used modalities per athlete
  @@index([reason, injuryType]) // Analyze cross-training usage patterns
}

// ============================================
// STRENGTH TRAINING & PLYOMETRICS
// ============================================

/// Periodized strength training sessions integrated with running
model StrengthTrainingSession {
  id              String   @id @default(uuid())
  clientId        String
  date            DateTime

  // Session type
  phase           String   // "ANATOMICAL_ADAPTATION", "MAXIMUM_STRENGTH", "POWER", "MAINTENANCE"
  sessionType     String   // "STRENGTH_A", "STRENGTH_B", "PLYOMETRICS", "COMBINED"

  // Timing relative to running
  timingRelativeToRun String? // "BEFORE_RUN", "AFTER_RUN_6H", "SEPARATE_DAY"
  runningWorkoutId String?

  // Exercises (JSON arrays)
  strengthExercises Json?   // [{exercise, sets, reps, load, rpe, rest}]
  plyometricExercises Json? // [{exercise, sets, reps, height, contacts, rest}]
  runningDrills   Json?     // [{drill, sets, distance, focus}]

  // Volume tracking
  totalSets       Int?
  totalContacts   Int?      // Plyometric contacts
  duration        Float     // minutes
  rpe             Int?      // Overall session RPE

  // Load progression
  strengthLoad    Float?    // Volume load (sets × reps × weight)
  plyometricLoad  Float?

  // Integration with running
  runningPhase    String?   // "BASE", "BUILD", "PEAK", "COMPETITION", "RECOVERY"
  priorityLevel   String    // "PRIMARY", "SECONDARY", "MAINTENANCE"

  // Effectiveness
  completionRate  Float?    // % of planned exercises completed
  qualityRating   String?   // "EXCELLENT", "GOOD", "MODERATE", "POOR"

  notes           String?

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId, date])
  @@index([phase, date])
  @@index([clientId, phase]) // Track strength phase progression per athlete
  @@index([runningPhase, priorityLevel]) // Analyze strength integration with running
}

// ============================================
// AUTOMATIC PROGRESSION TRACKING
// ============================================

/// Tracks load progression for strength exercises with 1RM estimation
model ProgressionTracking {
  id               String            @id @default(uuid())
  clientId         String
  exerciseId       String
  date             DateTime

  // Workout data
  sets             Int
  repsCompleted    Int               // Actual reps achieved
  repsTarget       Int               // Target reps prescribed
  actualLoad       Float             // Weight used (kg)
  rpe              Int?              // 1-10 rate of perceived exertion

  // 1RM estimation (calculated)
  estimated1RM     Float             // Calculated from Epley/Brzycki formulas
  estimationMethod String            // "EPLEY", "BRZYCKI", "AVERAGE"

  // Progression tracking
  progressionStatus ProgressionStatus @default(ON_TRACK)
  weeksAtCurrentLoad Int             @default(0)
  lastIncrease     DateTime?         // Date when load was last increased
  nextRecommendedLoad Float?         // Auto-calculated next load

  // Phase context
  strengthPhase    StrengthPhase?

  // 2-for-2 rule tracking
  consecutiveSessionsWithExtraReps Int @default(0)
  readyForIncrease Boolean           @default(false)

  // Plateau detection
  plateauWeeks     Int               @default(0)
  deloadRecommended Boolean          @default(false)

  // Notes and overrides
  notes            String?           @db.Text
  manualOverride   Boolean           @default(false) // Coach manually adjusted
  locked           Boolean           @default(false) // Prevent auto-progression

  client           Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  exercise         Exercise          @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([clientId, exerciseId, date])
  @@index([clientId, progressionStatus])
  @@index([exerciseId, date])
  @@index([readyForIncrease])
  @@index([plateauWeeks])
  @@index([clientId, strengthPhase])
}

/// Historical 1RM records for tracking strength gains over time
model OneRepMaxHistory {
  id               String       @id @default(uuid())
  clientId         String
  exerciseId       String
  date             DateTime

  oneRepMax        Float        // Actual tested or estimated 1RM
  source           String       // "TESTED", "ESTIMATED", "CALCULATED"

  // Context
  bodyWeight       Float?       // kg at time of test
  strengthPhase    StrengthPhase?

  notes            String?      @db.Text

  client           Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  exercise         Exercise     @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  createdAt        DateTime     @default(now())

  @@index([clientId, exerciseId, date])
  @@index([clientId, date])
}

// ============================================
// RACE RESULTS & PERFORMANCE TRACKING
// ============================================

/// Race results for VDOT calculation and pace zone determination
model RaceResult {
  id               String   @id @default(uuid())
  clientId         String

  // Race details
  raceName         String?  // "Stockholm Marathon", "Local 5K"
  raceDate         DateTime
  distance         String   // "5K", "10K", "HALF_MARATHON", "MARATHON", "CUSTOM"
  customDistanceKm Float?   // For CUSTOM distance

  // Performance
  timeMinutes      Float    // Total race time in minutes
  timeFormatted    String   // "1:28:00", "45:30", etc.

  // Environmental conditions
  temperature      Float?   // Celsius
  humidity         Float?   // Percentage
  windSpeed        Float?   // m/s
  elevation        Float?   // Meters above sea level
  terrain          String?  // "FLAT", "ROLLING", "HILLY", "TRAIL"

  // Calculated VDOT data (stored for historical tracking)
  vdot             Float?   // Calculated VDOT value
  vdotAdjusted     Float?   // Gender/age adjusted VDOT
  confidence       String?  // "VERY_HIGH", "HIGH", "MEDIUM", "LOW"
  ageInDays        Int?     // Age of result (for confidence decay)

  // Training paces (stored snapshot at time of race)
  trainingPaces    Json?    // Complete DanielsTrainingPaces snapshot
  equivalentTimes  Json?    // Equivalent race times for other distances

  // Race context
  goalTime         String?  // Intended goal time
  goalAchieved     Boolean  @default(false)
  raceType         String?  // "TRAINING_RACE", "B_RACE", "A_RACE", "TIME_TRIAL"

  // Performance analysis
  avgHeartRate     Int?     // bpm
  maxHeartRate     Int?     // bpm
  avgPace          String?  // "4:30/km"
  splits           Json?    // Array of split times

  // Notes and feedback
  conditions       String?  @db.Text // Weather, course, etc.
  athleteNotes     String?  @db.Text // How they felt
  coachNotes       String?  @db.Text // Coach analysis

  // Integration
  usedForZones     Boolean  @default(false) // Is this being used for current training zones?
  trainingProgramId String? // Link to program this race was part of

  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([clientId, raceDate])
  @@index([clientId, usedForZones]) // Find active race results
  @@index([distance, raceDate]) // Compare performances by distance
  @@index([vdot]) // Rank athletes by VDOT
  @@index([confidence]) // Filter high-confidence results
}

/// Sport-specific performance results (Cycling, Swimming, Triathlon, HYROX, Skiing)
/// Unified model for tracking PRs and performance metrics across all sports
model SportPerformance {
  id               String   @id @default(uuid())
  clientId         String

  // Core fields
  sport            SportType // CYCLING, SWIMMING, TRIATHLON, HYROX, SKIING
  eventType        String    // Sport-specific: "FTP_TEST", "CSS_TEST", "HYROX_RACE", etc.
  eventName        String?   // "Vätternrundan", "SM 50m", etc.
  eventDate        DateTime

  // Primary result (time-based events)
  timeSeconds      Float?    // Total time in seconds
  timeFormatted    String?   // "1:28:00", "25:30", etc.
  distanceMeters   Float?    // Distance in meters

  // Power metrics (Cycling)
  powerWatts       Float?    // Average power
  powerMax         Float?    // Max power
  ftp              Float?    // Functional Threshold Power
  wattsPerKg       Float?    // W/kg
  normalizedPower  Float?    // NP for cycling

  // Pace metrics (Swimming, Running)
  pacePerHundred   Float?    // Swimming: seconds per 100m
  css              Float?    // Critical Swim Speed (m/s)
  strokeRate       Float?    // Strokes per minute
  strokeType       String?   // "FREESTYLE", "BACKSTROKE", etc.
  poolLength       Int?      // 25 or 50 meters

  // HYROX specific
  hyroxDivision    String?   // "OPEN", "PRO", "DOUBLES"
  hyroxStations    Json?     // { skiErg: 120, sled: 90, ... } times in seconds
  hyroxRunSplits   Json?     // Array of 8 run split times
  hyroxTotalTime   Float?    // Total race time in seconds

  // Triathlon specific
  swimTime         Float?    // Swim leg in seconds
  bikeTime         Float?    // Bike leg in seconds
  runTime          Float?    // Run leg in seconds
  t1Time           Float?    // Transition 1 in seconds
  t2Time           Float?    // Transition 2 in seconds
  triathlonDistance String?  // "SPRINT", "OLYMPIC", "HALF", "FULL"

  // Skiing specific
  skiingTechnique  String?   // "CLASSIC", "SKATE", "BOTH"
  skiingTerrain    String?   // "FLAT", "ROLLING", "HILLY"
  snowConditions   String?   // "HARD", "SOFT", "WET", "ICY"

  // Heart rate data
  avgHeartRate     Int?
  maxHeartRate     Int?

  // Environmental
  temperature      Float?
  humidity         Float?
  altitude         Float?
  conditions       String?   @db.Text

  // Notes
  athleteNotes     String?   @db.Text
  coachNotes       String?   @db.Text
  isPR             Boolean   @default(false) // Mark as personal record
  usedForZones     Boolean   @default(false) // Used for training zone calculation

  client           Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([clientId, sport])
  @@index([clientId, eventType])
  @@index([sport, eventDate])
  @@index([clientId, isPR])
}

// ============================================
// VIDEO IMPORT MODELS
// Added: 2025-01-25
// Purpose: Import exercise videos from YouTube playlists with auto-matching
// ============================================

model VideoImport {
  id              String    @id @default(uuid())
  userId          String    // Coach who initiated the import
  playlistId      String    // YouTube playlist ID
  playlistTitle   String?   // YouTube playlist title
  playlistUrl     String?   // Full YouTube playlist URL
  status          String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  errorMessage    String?   // Error message if failed
  totalVideos     Int       @default(0)
  matchedVideos   Int       @default(0)
  appliedVideos   Int       @default(0)
  createdAt       DateTime  @default(now())
  completedAt     DateTime?

  user            User         @relation(fields: [userId], references: [id])
  matches         VideoMatch[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model VideoMatch {
  id            String    @id @default(uuid())
  importId      String
  videoId       String    // YouTube video ID
  videoTitle    String    // Original YouTube video title
  videoUrl      String    // Full YouTube video URL
  thumbnailUrl  String?   // YouTube thumbnail URL
  duration      String?   // Video duration (e.g., "2:30")

  exerciseId    String?   // Matched exercise ID (null if unmatched)
  exerciseName  String?   // Cached exercise name for display
  matchScore    Float?    // Match confidence 0.0 - 1.0
  matchMethod   String?   // EXACT, FUZZY, MANUAL
  status        String    @default("PENDING") // PENDING, APPROVED, REJECTED, APPLIED

  appliedAt     DateTime? // When video was applied to exercise
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  import        VideoImport @relation(fields: [importId], references: [id], onDelete: Cascade)

  @@index([importId])
  @@index([exerciseId])
  @@index([status])
  @@index([matchScore])
}

// ============================================
// MULTI-SPORT PROFILE SYSTEM
// Added: 2025-11
// Purpose: Sport-specific athlete profiles for multi-sport platform
// ============================================

/// Central sport profile for each athlete - determines UI, zones, and program types
model SportProfile {
  id              String    @id @default(uuid())
  clientId        String    @unique

  // Primary sport (determines dashboard variant)
  primarySport    SportType @default(RUNNING)

  // Secondary sports (for cross-training or multi-sport athletes)
  secondarySports SportType[] @default([])

  // Onboarding completed
  onboardingCompleted Boolean @default(false)
  onboardingStep      Int     @default(0)

  // Sport-specific settings (JSON for flexibility)
  runningSettings     Json?   // { preferredDistances, terrainPrefs, shoeRotation, etc. }
  cyclingSettings     Json?   // { bikeType, ftpHistory, indoorOutdoorRatio, etc. }
  skiingSettings      Json?   // { technique: 'CLASSIC' | 'SKATE', skiLength, etc. }
  triathlonSettings   Json?   // { primaryDistance: 'SPRINT' | 'OLYMPIC' | 'HALF' | 'FULL', swimCss, etc. }
  hyroxSettings       Json?   // { division, stationWeaknesses, bestTime, etc. }
  generalFitnessSettings Json? // { preferredFormats, equipmentAccess, etc. }
  swimmingSettings    Json?   // { poolLength, cssSpeed, strokePrefs, etc. }

  // Equipment access (affects workout generation)
  equipment           Json?   // { treadmill, bike, rower, skiErg, pool, gym, etc. }

  // Training availability (weekly schedule)
  weeklyAvailability  Json?   // { monday: { available: true, maxHours: 2 }, ... }
  preferredSessionLength Int? // minutes

  // Goals and targets
  currentGoal         String? // "Marathon PR", "Finish HYROX", "Lose weight", etc.
  targetDate          DateTime?
  targetMetric        Json?   // { type: 'TIME' | 'DISTANCE' | 'WEIGHT', value, unit }

  // Theme preferences for workout display
  themePreferences    Json?   // { appTheme: 'FITAPP_DARK' | 'MINIMALIST_WHITE', pdfTheme: 'FITAPP_DARK' | 'MINIMALIST_WHITE' }

  // Experience levels per sport
  runningExperience   String? // "BEGINNER" | "INTERMEDIATE" | "ADVANCED" | "ELITE"
  cyclingExperience   String?
  swimmingExperience  String?
  strengthExperience  String?

  // Active subscription/program info
  activeStandardProgram String? // ID of purchased standard program template
  hasCustomProgram    Boolean @default(false)

  client              Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([clientId])
  @@index([primarySport])
  @@index([onboardingCompleted])
}

// ============================================
// AI STUDIO MODELS
// Added: 2024-12
// Purpose: AI-powered training program generation with RAG
// ============================================

/// Provider for AI models
enum AIProvider {
  ANTHROPIC   // Claude models
  GOOGLE      // Gemini models
  OPENAI      // GPT models & embeddings
}

/// Document types for coach uploads
enum DocumentType {
  PDF
  EXCEL
  MARKDOWN
  VIDEO
  TEXT
}

/// Coach document library for RAG knowledge base
model CoachDocument {
  id              String       @id @default(uuid())
  coachId         String
  name            String       // Display name
  description     String?      @db.Text
  fileType        DocumentType
  fileUrl         String       // Supabase Storage URL
  fileSize        Int?         // bytes
  mimeType        String?      // e.g., "application/pdf"

  // System vs coach uploaded
  isSystem        Boolean      @default(false)

  // Processing status
  processingStatus String      @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  processingError String?
  chunkCount      Int          @default(0)

  // Metadata
  metadata        Json?        // page count, sheet names, duration, etc.

  coach           User         @relation("CoachDocuments", fields: [coachId], references: [id], onDelete: Cascade)
  chunks          KnowledgeChunk[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([coachId])
  @@index([fileType])
  @@index([isSystem])
  @@index([processingStatus])
}

/// Knowledge chunks for RAG - embeddings stored separately via pgvector
model KnowledgeChunk {
  id              String       @id @default(uuid())
  documentId      String
  coachId         String

  content         String       @db.Text // Actual text content
  chunkIndex      Int          // Order within document

  // Embedding stored via raw SQL (pgvector)
  // embedding    vector(1536) -- Added via migration
  embeddingModel  String?      // e.g., "text-embedding-ada-002"

  // Chunk metadata
  metadata        Json?        // page number, section header, etc.
  tokenCount      Int?         // Tokens in this chunk

  document        CoachDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  createdAt       DateTime     @default(now())

  @@index([documentId])
  @@index([coachId])
  @@index([chunkIndex])
}

/// AI conversation sessions in AI Studio
model AIConversation {
  id              String       @id @default(uuid())
  coachId         String
  athleteId       String?      // Optional - can be general knowledge query

  title           String?      // Auto-generated or user-set
  modelUsed       String       // e.g., "claude-4.5-opus", "gemini-3-pro"
  provider        AIProvider   @default(ANTHROPIC)

  // Context configuration
  contextDocuments String[]    @default([]) // Array of document IDs included
  athleteDataIncluded Json?    // Which athlete data points are included
  webSearchEnabled Boolean     @default(false)

  // Usage tracking
  totalTokensUsed Int          @default(0)
  totalCost       Float        @default(0) // Estimated cost in USD

  // Status
  status          String       @default("ACTIVE") // ACTIVE, ARCHIVED, DELETED

  coach           User         @relation("CoachConversations", fields: [coachId], references: [id], onDelete: Cascade)
  athlete         Client?      @relation("AthleteConversations", fields: [athleteId], references: [id], onDelete: SetNull)
  messages        AIMessage[]
  generatedPrograms AIGeneratedProgram[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([coachId])
  @@index([athleteId])
  @@index([status])
  @@index([createdAt])
}

/// Individual messages in AI conversations
model AIMessage {
  id              String       @id @default(uuid())
  conversationId  String

  role            String       // "user", "assistant", "system"
  content         String       @db.Text

  // Token usage for this message
  inputTokens     Int?
  outputTokens    Int?

  // If assistant used tools
  toolCalls       Json?        // Array of tool calls made
  toolResults     Json?        // Results from tools

  // Metadata
  modelUsed       String?      // Model that generated this (for assistant messages)
  latencyMs       Int?         // Response time

  conversation    AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt       DateTime     @default(now())

  @@index([conversationId])
  @@index([role])
  @@index([createdAt])
}

/// Programs generated by AI (before saving to TrainingProgram)
model AIGeneratedProgram {
  id              String       @id @default(uuid())
  conversationId  String
  programId       String?      // Link to TrainingProgram if saved

  // Program data (JSON structure matching TrainingProgram)
  programJson     Json

  // Generation metadata
  prompt          String?      @db.Text // The prompt that generated this
  reasoning       String?      @db.Text // AI's reasoning/explanation

  // Status
  isSaved         Boolean      @default(false)

  conversation    AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([conversationId])
  @@index([programId])
  @@index([isSaved])
}

/// Video analysis results (technique analysis using Gemini)
model VideoAnalysis {
  id              String       @id @default(uuid())
  coachId         String
  athleteId       String?
  exerciseId      String?      // Link to exercise from library

  // Video source
  videoUrl        String       // Supabase Storage URL
  videoType       String       // "STRENGTH", "RUNNING_GAIT", "SPORT_SPECIFIC", "SKIING_*", "HYROX_STATION"
  hyroxStation    String?      // For HYROX_STATION: "SKIERG", "SLED_PUSH", "SLED_PULL", etc.
  cameraAngle     String?      // "FRONT", "SIDE", "BACK" - camera angle for view-specific analysis
  duration        Int?         // seconds

  // MediaPipe landmarks data (if processed locally)
  landmarksData   Json?        // Skeletal tracking data

  // AI analysis results
  aiAnalysis      String?      @db.Text
  aiPoseAnalysis  Json?        // Structured AI pose analysis from Gemini (interpretation, technicalFeedback, patterns, recommendations, score)
  aiProvider      AIProvider   @default(GOOGLE)
  modelUsed       String?      // e.g., "gemini-3-pro"

  // Structured results
  formScore       Int?         // 0-100
  issuesDetected  Json?        // Array of {issue, severity, timestamp}
  recommendations Json?        // Array of recommended corrections
  comparisonData  Json?        // If comparing to previous video

  // Processing status
  status          String       @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  processingError String?

  coach           User         @relation("CoachVideoAnalyses", fields: [coachId], references: [id], onDelete: Cascade)
  athlete         Client?      @relation("AthleteVideoAnalyses", fields: [athleteId], references: [id], onDelete: SetNull)
  exercise        Exercise?    @relation(fields: [exerciseId], references: [id], onDelete: SetNull)

  // Extended analysis (for RUNNING_GAIT type)
  runningGaitAnalysis RunningGaitAnalysis?

  // Extended analysis (for SKIING_* types)
  skiingTechniqueAnalysis SkiingTechniqueAnalysis?

  // Extended analysis (for HYROX_STATION type)
  hyroxStationAnalysis HyroxStationAnalysis?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([coachId])
  @@index([athleteId])
  @@index([exerciseId])
  @@index([status])
}

/// Body composition tracking (bioimpedance measurements)
model BodyComposition {
  id              String       @id @default(uuid())
  clientId        String

  measurementDate DateTime     @db.Date

  // Core measurements
  weightKg        Float?
  bodyFatPercent  Float?
  muscleMassKg    Float?

  // Additional bioimpedance data
  visceralFat     Int?         // Scale typically 1-59
  boneMassKg      Float?
  waterPercent    Float?       // Total body water
  intracellularWaterPercent Float?  // ICW - water inside cells
  extracellularWaterPercent Float?  // ECW - water outside cells

  // Metabolic data
  bmrKcal         Int?         // Basal Metabolic Rate
  metabolicAge    Int?

  // Calculated fields
  bmi             Float?       // Calculated from weight/height
  ffmi            Float?       // Fat-Free Mass Index

  // Source and quality
  deviceBrand     String?      // "Tanita", "InBody", "Omron", etc.
  measurementTime String?      // "MORNING_FASTED", "POST_WORKOUT", etc.

  notes           String?      @db.Text

  client          Client       @relation("ClientBodyComposition", fields: [clientId], references: [id], onDelete: Cascade)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([clientId, measurementDate])
  @@index([clientId])
  @@index([measurementDate])
}

/// User API keys for BYOK (Bring Your Own Key) model
model UserApiKey {
  id              String       @id @default(uuid())
  userId          String       @unique

  // Encrypted API keys (encrypted at application level)
  anthropicKeyEncrypted String?  // Claude API key
  googleKeyEncrypted    String?  // Gemini API key
  openaiKeyEncrypted    String?  // OpenAI API key (for embeddings)

  // Key status (validated = successfully tested)
  anthropicKeyValid Boolean     @default(false)
  googleKeyValid    Boolean     @default(false)
  openaiKeyValid    Boolean     @default(false)

  // Last validation timestamps
  anthropicKeyLastValidated DateTime?
  googleKeyLastValidated    DateTime?
  openaiKeyLastValidated    DateTime?

  // Default AI model preference (used across all AI features)
  defaultModelId  String?
  defaultModel    AIModel?     @relation("UserDefaultModel", fields: [defaultModelId], references: [id], onDelete: SetNull)

  user            User         @relation("UserApiKeys", fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([userId])
}

/// Available AI models (admin-configurable)
model AIModel {
  id              String       @id @default(uuid())

  provider        AIProvider
  modelId         String       @unique // e.g., "claude-4.5-opus-20250101"
  displayName     String       // e.g., "Claude 4.5 Opus"
  description     String?

  // Capabilities
  capabilities    String[]     @default([]) // ["text", "vision", "code", "web_search"]
  maxTokens       Int?         // Max context window
  maxOutputTokens Int?         // Max output tokens

  // Pricing (per 1K tokens)
  inputCostPer1k  Float?
  outputCostPer1k Float?

  // Availability
  isActive        Boolean      @default(true)
  isDefault       Boolean      @default(false) // Default model for new conversations

  // Versioning
  releasedAt      DateTime?
  deprecatedAt    DateTime?

  // User preferences
  userDefaults    UserApiKey[] @relation("UserDefaultModel")

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([provider])
  @@index([isActive])
  @@index([isDefault])
}

// ==================== GEMINI 3 PRO FEATURES ====================

/// Extended running gait analysis data (Gemini 3 Pro structured output)
model RunningGaitAnalysis {
  id                    String    @id @default(uuid())
  videoAnalysisId       String    @unique

  // Biometric data (structured from video)
  cadence               Int?      // steps per minute
  groundContactTime     Float?    // milliseconds
  verticalOscillation   Float?    // centimeters
  strideLength          Float?    // meters
  footStrikePattern     String?   // "HEEL", "MIDFOOT", "FOREFOOT"

  // Asymmetry data (left/right differences)
  asymmetryPercent      Float?    // overall asymmetry %
  leftContactTime       Float?
  rightContactTime      Float?
  leftStrideLength      Float?
  rightStrideLength     Float?

  // Injury risk assessment
  injuryRiskLevel       String?   // "LOW", "MODERATE", "HIGH"
  injuryRiskScore       Int?      // 0-10
  injuryRiskFactors     Json?     // Array of risk factor objects

  // Efficiency metrics
  runningEfficiency     String?   // "EXCELLENT", "GOOD", "MODERATE", "POOR"
  energyLeakages        Json?     // Array of identified inefficiencies

  // Phase-specific analysis
  stancePhaseData       Json?     // { duration, issues, recommendations }
  swingPhaseData        Json?     // { duration, issues, recommendations }

  // Coaching cues (Swedish)
  coachingCues          Json?     // Array of { cue, priority, drillName, explanation }
  drillRecommendations  Json?     // Array of corrective drills

  // Comparison data
  previousComparison    Json?     // Delta from previous analysis

  // Overall assessment
  overallScore          Int?      // 0-100
  summary               String?   @db.Text // Swedish summary

  videoAnalysis         VideoAnalysis @relation(fields: [videoAnalysisId], references: [id], onDelete: Cascade)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([videoAnalysisId])
  @@index([injuryRiskLevel])
  @@index([cadence])
}

/// Skiing technique analysis (for SKIING_CLASSIC, SKIING_SKATING, SKIING_DOUBLE_POLE types)
model SkiingTechniqueAnalysis {
  id                    String    @id @default(uuid())
  videoAnalysisId       String    @unique

  // Technique context
  techniqueType         String    // CLASSIC, SKATING, DOUBLE_POLE
  skatingVariant        String?   // V1, V2, V2_ALT (only for SKATING)
  terrainType           String?   // FLAT, UPHILL, DOWNHILL

  // Overall scores (0-100)
  overallScore          Float?
  balanceScore          Float?    // Classic/Skating only
  timingScore           Float?    // Classic/Skating only
  efficiencyScore       Float?
  powerScore            Float?    // Double pole only
  rhythmScore           Float?    // Double pole only

  // Pole mechanics (all techniques)
  poleAngleAtPlant      Float?    // degrees
  poleAngleAtRelease    Float?    // degrees
  polePlantTiming       String?   // EARLY, ON_TIME, LATE
  poleForceApplication  String?   // GOOD, WEAK, INCONSISTENT
  armSwingSymmetry      Float?    // 0-100 percentage

  // Hip and core position (all techniques)
  hipPositionScore      Float?    // 0-100
  hipHeightConsistency  Float?    // 0-100
  coreEngagement        String?   // GOOD, MODERATE, POOR
  forwardLean           Float?    // degrees from vertical

  // Weight transfer (all techniques)
  weightTransferScore   Float?    // 0-100
  weightShiftTiming     String?   // EARLY, ON_TIME, LATE
  lateralStability      Float?    // 0-100

  // Classic-specific metrics
  kickTimingScore       Float?    // 0-100
  kickExtension         String?   // FULL, PARTIAL, INCOMPLETE
  glidePhaseDuration    Float?    // seconds
  legRecoveryPattern    String?   // EFFICIENT, MODERATE, INEFFICIENT
  waxPocketEngagement   String?   // GOOD, PARTIAL, POOR

  // Skating-specific metrics
  edgeAngleLeft         Float?    // degrees
  edgeAngleRight        Float?    // degrees
  edgeAngleSymmetry     Float?    // 0-100
  pushOffAngle          Float?    // degrees from ski direction
  vPatternWidth         Float?    // cm estimated
  skateFrequency        Float?    // cycles per second
  recoveryLegPath       String?   // COMPACT, WIDE, INCONSISTENT

  // Double pole-specific metrics
  trunkFlexionRange     Float?    // degrees
  compressionDepth      String?   // SHALLOW, OPTIMAL, EXCESSIVE
  returnPhaseSpeed      String?   // FAST, MODERATE, SLOW
  legDriveContribution  String?   // SIGNIFICANT, MODERATE, MINIMAL
  rhythmConsistency     Float?    // 0-100

  // AI insights (Swedish)
  primaryStrengths      Json?     // string[]
  primaryWeaknesses     Json?     // string[]
  techniqueDrills       Json?     // { drill: string, focus: string, priority: number }[]
  comparisonToElite     String?   @db.Text // narrative comparison

  videoAnalysis         VideoAnalysis @relation(fields: [videoAnalysisId], references: [id], onDelete: Cascade)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([videoAnalysisId])
  @@index([techniqueType])
  @@index([overallScore])
}

/// HYROX station analysis (for HYROX_STATION video type)
/// Covers all 8 HYROX stations: SkiErg, Sled Push, Sled Pull, Burpee Broad Jump, Rowing, Farmers Carry, Sandbag Lunge, Wall Balls
model HyroxStationAnalysis {
  id                    String    @id @default(uuid())
  videoAnalysisId       String    @unique

  // Station identification
  stationType           String    // SKIERG, SLED_PUSH, SLED_PULL, BURPEE_BROAD_JUMP, ROWING, FARMERS_CARRY, SANDBAG_LUNGE, WALL_BALLS

  // Overall assessment (0-100)
  overallScore          Float?
  efficiencyScore       Float?
  formScore             Float?
  paceConsistency       Float?

  // Movement quality
  coreStability         Float?    // 0-100
  breathingPattern      String?   // GOOD, INCONSISTENT, POOR
  movementEconomy       Float?    // 0-100

  // Pace analysis
  movementCadence       Float?    // reps per minute or strokes per minute
  cadenceVariation      Float?    // percentage variation
  restPauses            Int?      // number of pauses detected

  // Fatigue indicators
  fatigueIndicators     Json?     // { earlyPhase: string[], latePhase: string[] }
  formDegradation       Float?    // percentage decline from start to end

  // Station-specific metrics (JSON - varies by station)
  stationMetrics        Json?

  // SkiErg specific
  pullLength            String?   // SHORT, OPTIMAL, LONG
  hipHingeDepth         String?   // SHALLOW, OPTIMAL, EXCESSIVE
  armExtension          String?   // INCOMPLETE, FULL, OVEREXTENDED
  legDriveContribution  String?   // MINIMAL, MODERATE, SIGNIFICANT

  // Sled Push specific
  bodyAngle             Float?    // degrees from vertical
  armLockout            String?   // BENT, LOCKED, OVEREXTENDED
  strideLength          String?   // SHORT, OPTIMAL, OVERSTRIDING
  drivePhase            String?   // WEAK, GOOD, POWERFUL

  // Sled Pull specific
  pullTechnique         String?   // ARM_DOMINANT, HIP_DRIVEN, MIXED
  ropePath              String?   // STRAIGHT, DIAGONAL, INCONSISTENT
  anchorStability       String?   // STABLE, SHIFTING, UNSTABLE

  // Burpee Broad Jump specific
  burpeeDepth           String?   // SHALLOW, FULL, EXCESSIVE
  jumpDistance          String?   // SHORT, GOOD, EXCELLENT
  transitionSpeed       String?   // SLOW, MODERATE, FAST
  landingMechanics      String?   // POOR, ACCEPTABLE, GOOD

  // Rowing specific
  driveSequence         String?   // CORRECT, ARMS_EARLY, BACK_EARLY
  laybackAngle          Float?    // degrees
  catchPosition         String?   // COMPRESSED, OPTIMAL, OVERREACHING
  strokeRate            Float?    // strokes per minute
  powerApplication      String?   // FRONT_LOADED, EVEN, BACK_LOADED

  // Farmers Carry specific
  shoulderPack          String?   // ELEVATED, PACKED, DEPRESSED
  trunkPosture          String?   // UPRIGHT, LEANING, SWAYING
  stridePattern         String?   // SHORT_CHOPPY, SMOOTH, OVERSTRIDING
  gripFatigue           String?   // NONE, MODERATE, SIGNIFICANT

  // Sandbag Lunge specific
  bagPosition           String?   // HIGH_CHEST, SHOULDER, DROPPING
  kneeTracking          String?   // GOOD, VALGUS, VARUS
  stepLength            String?   // SHORT, OPTIMAL, OVERSTRIDING
  torsoPosition         String?   // UPRIGHT, FORWARD_LEAN, EXCESSIVE_LEAN

  // Wall Balls specific
  squatDepth            String?   // SHALLOW, PARALLEL, DEEP
  throwMechanics        String?   // ARM_DOMINANT, HIP_DRIVEN, COORDINATED
  wallBallCatchHeight   String?   // HIGH, OPTIMAL, LOW
  rhythmConsistency     Float?    // 0-100

  // Benchmark comparison
  benchmarkLevel        String?   // BEGINNER, INTERMEDIATE, ADVANCED, ELITE
  estimatedStationTime  Int?      // seconds (projected time for standard reps)

  // Athlete profile integration
  isWeakStation         Boolean   @default(false)
  isStrongStation       Boolean   @default(false)

  // AI insights (Swedish)
  primaryStrengths      Json?     // string[]
  primaryWeaknesses     Json?     // string[]
  improvementDrills     Json?     // { drill: string, focus: string, priority: number }[]
  raceStrategyTips      Json?     // string[]

  videoAnalysis         VideoAnalysis @relation(fields: [videoAnalysisId], references: [id], onDelete: Cascade)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([videoAnalysisId])
  @@index([stationType])
  @@index([overallScore])
}

/// Audio recordings for voice-based daily check-in (Gemini 3 Pro transcription)
model AudioJournal {
  id                    String    @id @default(uuid())
  clientId              String
  date                  DateTime  @db.Date

  // Audio file data
  audioUrl              String    // Supabase Storage URL
  duration              Int       // seconds (30-60 typical)
  mimeType              String?   // "audio/webm", "audio/mp4", etc.
  fileSize              Int?      // bytes

  // Transcription
  transcription         String?   @db.Text  // Full text from Gemini
  transcriptionModel    String?   // "gemini-3-pro"
  transcriptionConfidence Float?

  // Structured extraction (from transcription)
  extractedData         Json?     // { rpe, sleepQuality, soreness, energy, etc. }
  extractionConfidence  Float?

  // AI interpretation
  aiInterpretation      Json?     // { readinessEstimate, recommendedAction, flaggedConcerns }

  // Link to DailyCheckIn (if populated from audio)
  dailyCheckInId        String?   @unique

  // Processing status
  status                String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  processingError       String?
  processingTimeMs      Int?

  client                Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  dailyCheckIn          DailyCheckIn? @relation(fields: [dailyCheckInId], references: [id], onDelete: SetNull)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([clientId, date])
  @@index([clientId, date])
  @@index([status])
}

/// Menstrual cycle tracking for female athletes
model MenstrualCycle {
  id                    String    @id @default(uuid())
  clientId              String

  // Cycle metadata
  cycleNumber           Int?      // Sequential cycle number
  startDate             DateTime  @db.Date
  endDate               DateTime? @db.Date
  cycleLength           Int?      // days

  // Phase tracking
  currentPhase          String?   // "MENSTRUAL", "FOLLICULAR", "OVULATORY", "LUTEAL"
  ovulationDate         DateTime? @db.Date

  // AI-generated insights
  phaseRecommendations  Json?     // { phase: { intensityModifier, volumeModifier, focusAreas } }
  aiInsights            Json?     // Patterns, predictions, recommendations

  // Notes
  notes                 String?   @db.Text

  client                Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  dailyLogs             MenstrualDailyLog[]

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([clientId, startDate])
  @@index([currentPhase])
}

/// Daily menstrual symptom log
model MenstrualDailyLog {
  id                    String    @id @default(uuid())
  clientId              String
  cycleId               String?
  date                  DateTime  @db.Date

  // Current phase (auto-calculated)
  cycleDay              Int?      // Day 1-28+ in current cycle
  phase                 String?   // Current phase

  // Symptom tracking (1-5 scale)
  flowIntensity         Int?      // 0=none, 1-5 for flow days
  cramps                Int?      // 1=none, 5=severe
  bloating              Int?
  breastTenderness      Int?
  headache              Int?
  fatigue               Int?      // 1=low fatigue, 5=extreme
  moodScore             Int?      // 1=very low, 5=excellent
  cravings              Int?

  // Training performance
  perceivedEffort       Int?      // RPE for that day
  actualVsPlanned       String?   // "EXCEEDED", "MET", "REDUCED", "SKIPPED"

  // Notes
  notes                 String?   @db.Text

  // AI flags
  aiWarnings            Json?     // Flagged patterns

  client                Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  cycle                 MenstrualCycle? @relation(fields: [cycleId], references: [id], onDelete: SetNull)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([clientId, date])
  @@index([clientId, date])
  @@index([phase])
  @@index([cycleId])
}

// ==================== HYBRID STUDIO ====================

/// Hybrid workout formats (CrossFit, HYROX, functional fitness)
enum HybridFormat {
  AMRAP          // As Many Rounds As Possible
  FOR_TIME       // Complete work as fast as possible
  EMOM           // Every Minute On the Minute
  TABATA         // 20s work / 10s rest × 8
  CHIPPER        // Long sequence of movements done once
  LADDER         // Ascending/descending rep scheme
  INTERVALS      // Work/rest intervals with movements
  HYROX_SIM      // HYROX simulation (run + stations)
  CUSTOM         // Custom format
}

/// Scaling levels for hybrid workouts
enum ScalingLevel {
  RX             // Prescribed/competition standard
  SCALED         // Reduced load/modified movements
  FOUNDATIONS    // Beginner-friendly version
  CUSTOM         // Custom modifications for individual athlete
}

/// Score types for hybrid workout results
enum HybridScoreType {
  TIME           // Completion time (For Time, Chipper)
  ROUNDS_REPS    // Rounds + extra reps (AMRAP)
  LOAD           // Weight lifted (max effort)
  REPS           // Total reps (Tabata)
  CALORIES       // Total calories
  COMPLETION     // Pass/fail (EMOM)
}

/// Equipment types for movements
enum EquipmentType {
  BARBELL
  KETTLEBELL
  DUMBBELL
  BODYWEIGHT
  PULL_UP_BAR
  RINGS
  BOX
  ROPE
  GHD
  MACHINE_ROW
  MACHINE_BIKE
  MACHINE_SKI
  ASSAULT_BIKE
  WALL_BALL
  MEDICINE_BALL
  SANDBAG
  SLED
  RUNNING
  JUMP_ROPE
  YOKE
  SWIMMING
  PARALLETTES
}

/// Movement categories for hybrid workouts
enum MovementCategory {
  OLYMPIC_LIFT      // Clean, Snatch, Jerk variations
  POWERLIFTING      // Squat, Deadlift, Bench
  GYMNASTICS        // Pull-ups, Muscle-ups, HSPU
  MONOSTRUCTURAL    // Run, Row, Bike, Ski
  KETTLEBELL_WORK   // Swings, Turkish Get-up
  STRONGMAN         // Carries, Sled work
  CORE_WORK         // Sit-ups, Toes-to-Bar, Planks
  ACCESSORY         // Lunges, Step-ups
  HYROX_STATION     // HYROX-specific movements
}

/// Hybrid workout template (AMRAP, For Time, EMOM, etc.)
model HybridWorkout {
  id              String       @id @default(uuid())
  name            String
  description     String?      @db.Text

  // Workout format
  format          HybridFormat

  // Time configuration
  timeCap         Int?         // seconds (0 = no cap)
  workTime        Int?         // EMOM/Tabata work portion (seconds)
  restTime        Int?         // EMOM/Tabata rest portion (seconds)
  totalRounds     Int?         // for fixed round workouts
  totalMinutes    Int?         // for EMOM total duration

  // Rep scheme (for display)
  repScheme       String?      // "21-15-9", "10-9-8-7-6-5-4-3-2-1", etc.

  // Movements in this workout
  movements       HybridMovement[]

  // Scaling
  scalingLevel    ScalingLevel @default(RX)
  rxVersionId     String?
  rxVersion       HybridWorkout? @relation("WorkoutScaling", fields: [rxVersionId], references: [id], onDelete: SetNull)
  scaledVersions  HybridWorkout[] @relation("WorkoutScaling")

  // Benchmark/Template info
  isBenchmark     Boolean      @default(false)
  benchmarkSource String?      // "CrossFit", "HYROX", "Hero WOD", "The Girls", "Open"
  benchmarkYear   Int?         // e.g., 2024 for Open 24.1

  // Ownership
  coachId         String?
  coach           User?        @relation("CoachHybridWorkouts", fields: [coachId], references: [id], onDelete: SetNull)
  isPublic        Boolean      @default(false)

  // Stats
  results         HybridWorkoutResult[]
  assignments     HybridWorkoutAssignment[]
  workoutLogs     HybridWorkoutLog[]

  // Tags for filtering
  tags            String[]     @default([])

  // Section data (JSON for flexibility)
  warmupData      Json?        // {notes?: string, movements?: [...]}
  strengthData    Json?        // {notes?: string, movements?: [{sets, reps, rest, ...}]}
  cooldownData    Json?        // {notes?: string, movements?: [...]}
  // Note: existing 'movements' relation is the METCON section

  // Versioning
  version         Int          @default(1)
  versionNotes    String?      @db.Text
  parentId        String?      // Original workout this was versioned from
  parent          HybridWorkout? @relation("WorkoutVersions", fields: [parentId], references: [id], onDelete: SetNull)
  versions        HybridWorkout[] @relation("WorkoutVersions")
  versionHistory  HybridWorkoutVersion[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([coachId])
  @@index([isBenchmark])
  @@index([benchmarkSource])
  @@index([format])
  @@index([scalingLevel])
  @@index([parentId])
}

/// Version history for workout changes
model HybridWorkoutVersion {
  id              String       @id @default(uuid())

  workout         HybridWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId       String

  // Version info
  versionNumber   Int
  changeType      String       // "CREATED", "MODIFIED", "MOVEMENTS_CHANGED", "SCALING_UPDATED"
  changeNotes     String?      @db.Text
  changedBy       String?      // User ID who made the change

  // Snapshot of workout at this version
  snapshot        Json         // Full workout data at this point in time

  createdAt       DateTime     @default(now())

  @@index([workoutId])
  @@index([versionNumber])
}

/// Movement within a hybrid workout
model HybridMovement {
  id              String       @id @default(uuid())

  workout         HybridWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId       String

  exercise        Exercise     @relation(fields: [exerciseId], references: [id])
  exerciseId      String

  // Position in workout
  order           Int
  roundNumber     Int?         // for EMOM alternating minutes (1=odd, 2=even)
  setNumber       Int?         // for rep schemes (1=first set of 21, 2=second set of 15, etc.)

  // Movement prescription
  reps            Int?
  calories        Int?
  distance        Float?       // meters
  duration        Int?         // seconds (for holds, cardio)

  // Load
  weightMale      Float?       // kg
  weightFemale    Float?       // kg
  weightUnit      String?      @default("kg") // "kg" or "lb"
  percentOfMax    Float?       // e.g., 0.7 for 70% of 1RM

  // Special modifiers
  isUnbroken      Boolean      @default(false) // Must complete without rest
  alternateSides  Boolean      @default(false) // e.g., single-arm DB snatch

  // Notes for this specific movement
  notes           String?

  @@index([workoutId])
  @@index([exerciseId])
}

/// Athlete's workout result/score
model HybridWorkoutResult {
  id              String       @id @default(uuid())

  workout         HybridWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId       String

  athlete         Client       @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId       String

  // Score
  scoreType       HybridScoreType
  timeScore       Int?         // seconds (for time-based)
  roundsCompleted Int?         // for AMRAP
  repsCompleted   Int?         // additional reps in AMRAP, or total for Tabata
  loadUsed        Float?       // kg (for max effort)
  caloriesScore   Int?         // for calorie-based workouts

  // Scaling used
  scalingLevel    ScalingLevel
  scalingNotes    String?      // e.g., "Used 30kg instead of 43kg"
  customModifications Json?    // For CUSTOM scaling: [{movementId, modification, originalValue, newValue}]

  // Context
  completedAt     DateTime     @default(now())
  workoutDate     DateTime?    @db.Date // When they did it (may differ from logged time)

  // PR tracking
  isPR            Boolean      @default(false)
  previousBestId  String?      // ID of previous best result

  // Notes and feedback
  notes           String?      @db.Text
  coachFeedback   String?      @db.Text
  perceivedEffort Int?         // RPE 1-10
  difficulty      Int?         // 1-10 how hard vs expected

  // Optional detailed splits
  movementSplits  Json?        // [{movementId, time, reps, notes}]

  // Video link
  videoUrl        String?

  @@index([workoutId])
  @@index([athleteId])
  @@index([completedAt])
  @@index([isPR])
  @@unique([workoutId, athleteId, completedAt])
}

/// Workout assignment - coach assigns workout to athlete(s) for specific date
model HybridWorkoutAssignment {
  id              String       @id @default(uuid())

  workout         HybridWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId       String

  athlete         Client       @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId       String

  // Assignment details
  assignedDate    DateTime     @db.Date // When workout should be done
  assignedBy      String       // Coach user ID
  notes           String?      @db.Text // Coach notes for athlete

  // Status tracking
  status          AssignmentStatus @default(PENDING)
  completedAt     DateTime?    // When athlete marked it complete
  resultId        String?      // Link to the result if completed

  // Customization
  customScaling   String?      // Suggested scaling for this athlete
  scalingNotes    String?      // "Use 30kg for thrusters"

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([workoutId])
  @@index([athleteId])
  @@index([assignedDate])
  @@index([status])
  @@unique([workoutId, athleteId, assignedDate])
}

enum AssignmentStatus {
  PENDING     // Not started
  SCHEDULED   // Athlete acknowledged
  COMPLETED   // Done
  SKIPPED     // Athlete skipped
  MODIFIED    // Coach modified assignment
}

/// Hybrid workout log - tracks Focus Mode execution
model HybridWorkoutLog {
  id                String       @id @default(uuid())

  workout           HybridWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId         String

  athlete           Client       @relation("AthleteHybridLogs", fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId         String

  // Optional link to assignment if this was assigned
  assignmentId      String?

  // Execution timing
  startedAt         DateTime     @default(now())
  completedAt       DateTime?
  status            AssignmentStatus @default(PENDING)

  // Results (depending on format)
  totalTime         Int?         // seconds (for FOR_TIME)
  totalRounds       Int?         // completed rounds (for AMRAP)
  extraReps         Int?         // partial reps in last round

  // Scaling used
  scalingLevel      ScalingLevel @default(RX)
  scalingNotes      String?

  // Round logs
  roundLogs         HybridRoundLog[]

  // Session feedback
  sessionRPE        Int?         // 1-10
  notes             String?      @db.Text
  focusModeUsed     Boolean      @default(true)

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([workoutId])
  @@index([athleteId])
  @@index([startedAt])
  @@index([status])
}

/// Per-round log within a Hybrid workout
model HybridRoundLog {
  id                  String           @id @default(uuid())

  hybridWorkoutLog    HybridWorkoutLog @relation(fields: [hybridWorkoutLogId], references: [id], onDelete: Cascade)
  hybridWorkoutLogId  String

  roundNumber         Int

  // Timing
  startedAt           DateTime?
  completedAt         DateTime?
  duration            Int?         // seconds

  // Movement tracking
  movements           Json         // Array of { movementId, movementName, reps, completed, notes }

  // Status
  completed           Boolean      @default(false)

  createdAt           DateTime     @default(now())

  @@index([hybridWorkoutLogId])
  @@index([roundNumber])
}

// ============================================
// STRENGTH SESSION LIBRARY
// ============================================

/// Coach-owned strength session template
model StrengthSession {
  id                String       @id @default(uuid())
  name              String
  description       String?      @db.Text

  // Session configuration
  phase             StrengthPhase @default(ANATOMICAL_ADAPTATION)
  timingRelativeToRun String?    // "BEFORE_RUN", "AFTER_RUN_6H", "SEPARATE_DAY"
  estimatedDuration Int?         // minutes

  // Exercise data (JSON for flexibility) - MAIN section (required)
  exercises         Json         // [{exerciseId, exerciseName, sets, reps, weight, restSeconds, notes, section?}]

  // Optional section data (JSON)
  warmupData        Json?        // {notes?, duration?, exercises?: [{exerciseId, exerciseName, sets, reps, notes}]}
  coreData          Json?        // {notes?, duration?, exercises?: [{exerciseId, exerciseName, sets, reps, restSeconds, notes}]}
  cooldownData      Json?        // {notes?, duration?, exercises?: [{exerciseId, exerciseName, duration, notes}]}

  // Computed metadata
  totalSets         Int?
  totalExercises    Int?
  volumeLoad        Float?

  // Ownership
  coachId           String
  coach             User         @relation("CoachStrengthSessions", fields: [coachId], references: [id], onDelete: Cascade)
  isPublic          Boolean      @default(false)

  // Tags for filtering
  tags              String[]     @default([])

  // Assignments
  assignments       StrengthSessionAssignment[]

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([coachId])
  @@index([phase])
  @@index([isPublic])
}

/// Assignment of strength session to athlete
model StrengthSessionAssignment {
  id                String       @id @default(uuid())

  session           StrengthSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId         String

  athlete           Client       @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId         String

  // Assignment details
  assignedDate      DateTime     @db.Date
  assignedBy        String       // Coach user ID
  notes             String?      @db.Text

  // Status tracking
  status            AssignmentStatus @default(PENDING)
  completedAt       DateTime?

  // Logged workout data
  actualExercises   Json?        // Logged exercise data with actual weight/reps
  rpe               Int?         // Overall session RPE
  duration          Int?         // Actual duration in minutes

  // Per-set logging (detailed)
  setLogs           SetLog[]

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([sessionId])
  @@index([athleteId])
  @@index([assignedDate])
  @@index([status])
  @@unique([sessionId, athleteId, assignedDate])
}

/// Pre-built strength program templates for quick program generation
model StrengthTemplate {
  id                String        @id @default(uuid())
  name              String
  description       String?       @db.Text

  // Template metadata
  phase             StrengthPhase @default(ANATOMICAL_ADAPTATION)
  durationWeeks     Int           @default(4)
  sessionsPerWeek   Int           @default(2)
  level             ProgressionLevel @default(LEVEL_1)

  // Target demographics
  targetSport       SportType?
  targetGoal        String?       // "strength", "power", "endurance", "hypertrophy"

  // Template content (JSON for flexibility)
  sessions          Json          // Array of session templates with exercises
  progressionRules  Json?         // Automatic progression configuration

  // Ownership
  coachId           String?       // null = system template
  coach             User?         @relation("StrengthTemplateOwner", fields: [coachId], references: [id], onDelete: SetNull)
  isPublic          Boolean       @default(false)
  isSystemTemplate  Boolean       @default(false)

  // Usage tracking
  usageCount        Int           @default(0)

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([coachId])
  @@index([phase])
  @@index([targetSport])
  @@index([isPublic])
  @@index([isSystemTemplate])
}

// ============================================
// CARDIO SESSION LIBRARY
// ============================================

/// Coach-owned cardio session template
model CardioSession {
  id                String       @id @default(uuid())
  name              String
  description       String?      @db.Text

  // Session configuration
  sport             SportType    @default(RUNNING)

  // Segment data (JSON for flexibility)
  segments          Json         // [{type, duration, distance, pace, zone, notes}]

  // Computed totals
  totalDuration     Int?         // seconds
  totalDistance     Float?       // meters
  avgZone           Float?

  // Ownership
  coachId           String
  coach             User         @relation("CoachCardioSessions", fields: [coachId], references: [id], onDelete: Cascade)
  isPublic          Boolean      @default(false)

  // Tags for filtering
  tags              String[]     @default([])

  // Assignments
  assignments       CardioSessionAssignment[]

  // Focus Mode logs
  sessionLogs       CardioSessionLog[]

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([coachId])
  @@index([sport])
  @@index([isPublic])
}

/// Assignment of cardio session to athlete
model CardioSessionAssignment {
  id                String       @id @default(uuid())

  session           CardioSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId         String

  athlete           Client       @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId         String

  // Assignment details
  assignedDate      DateTime     @db.Date
  assignedBy        String       // Coach user ID
  notes             String?      @db.Text

  // Status tracking
  status            AssignmentStatus @default(PENDING)
  completedAt       DateTime?

  // Logged workout data
  actualDuration    Int?         // seconds
  actualDistance    Float?       // meters
  avgHeartRate      Int?
  actualSegments    Json?        // Logged segment data

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([sessionId])
  @@index([athleteId])
  @@index([assignedDate])
  @@index([status])
  @@unique([sessionId, athleteId, assignedDate])
}

/// Cardio session log - tracks Focus Mode execution
model CardioSessionLog {
  id                String       @id @default(uuid())

  session           CardioSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId         String

  athlete           Client       @relation("AthleteCardioLogs", fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId         String

  // Optional link to assignment if this was assigned
  assignmentId      String?

  // Execution timing
  startedAt         DateTime     @default(now())
  completedAt       DateTime?

  // Overall session metrics
  status            AssignmentStatus @default(PENDING)
  actualDuration    Int?         // total seconds
  actualDistance    Float?       // total km
  avgHeartRate      Int?
  maxHeartRate      Int?

  // Segment logs
  segmentLogs       CardioSegmentLog[]

  // Session feedback
  sessionRPE        Int?         // 1-10
  notes             String?      @db.Text
  focusModeUsed     Boolean      @default(true)

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([sessionId])
  @@index([athleteId])
  @@index([startedAt])
  @@index([status])
}

/// Per-segment log within a Cardio session
model CardioSegmentLog {
  id                  String           @id @default(uuid())

  cardioSessionLog    CardioSessionLog @relation(fields: [cardioSessionLogId], references: [id], onDelete: Cascade)
  cardioSessionLogId  String

  segmentIndex        Int
  segmentType         CardioSegmentType

  // Planned values (copied from session definition)
  plannedDuration     Int?         // seconds
  plannedDistance     Float?       // km
  plannedPace         Int?         // sec/km
  plannedZone         Int?         // 1-5

  // Actual values logged
  actualDuration      Int?         // seconds
  actualDistance      Float?       // km
  actualPace          Int?         // sec/km
  actualAvgHR         Int?
  actualMaxHR         Int?

  // Status
  completed           Boolean      @default(false)
  skipped             Boolean      @default(false)
  notes               String?

  startedAt           DateTime?
  completedAt         DateTime?

  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  @@index([cardioSessionLogId])
  @@index([segmentIndex])
}

enum CardioSegmentType {
  WARMUP
  COOLDOWN
  INTERVAL
  STEADY
  RECOVERY
  HILL
  DRILLS
}

// ==================== NUTRITION TIMING SYSTEM ====================

/// Athlete dietary preferences for nutrition guidance personalization
model DietaryPreferences {
  id              String   @id @default(uuid())
  clientId        String   @unique

  // Dietary style
  dietaryStyle    String?  // OMNIVORE | VEGETARIAN | VEGAN | PESCATARIAN | FLEXITARIAN

  // Allergies & intolerances (JSON arrays for flexibility)
  allergies       Json?    // ["NUTS", "SHELLFISH", "DAIRY", "GLUTEN", "SOY", "EGGS", "FISH"]
  intolerances    Json?    // ["LACTOSE", "FRUCTOSE", "HISTAMINE"]

  // Food dislikes (for suggestion filtering)
  dislikedFoods   Json?    // ["oatmeal", "fish", "beans"]

  // Preferences
  preferLowFODMAP    Boolean  @default(false)
  preferWholeGrain   Boolean  @default(true)
  preferSwedishFoods Boolean  @default(true)  // Prioritize Swedish food suggestions

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
}

/// Athlete nutrition goals (weight, body composition, macro preferences)
model NutritionGoal {
  id              String   @id @default(uuid())
  clientId        String   @unique

  // Weight goals
  goalType        String   // WEIGHT_LOSS | WEIGHT_GAIN | MAINTAIN | BODY_RECOMP
  targetWeightKg  Float?
  weeklyChangeKg  Float?   // Target weekly change: 0.25, 0.5, 0.75 kg/week
  targetDate      DateTime?

  // Body composition goals
  targetBodyFatPercent Float?

  // Macro preference (overrides sport-based defaults)
  macroProfile    String?  // BALANCED | HIGH_PROTEIN | LOW_CARB | ENDURANCE | STRENGTH

  // Activity level (for TDEE calculation)
  activityLevel   String   @default("ACTIVE") // SEDENTARY | LIGHTLY_ACTIVE | ACTIVE | VERY_ACTIVE | ATHLETE

  // Custom protein target (g per kg body weight, overrides calculated value)
  customProteinPerKg Float?

  // Display preferences
  showMacroTargets Boolean @default(true)
  showHydration    Boolean @default(true)

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
}

// ==================== VELOCITY-BASED TRAINING (VBT) SYSTEM ====================
// Purpose: Import and analyze data from VBT devices (Vmaxpro, Vitruve, GymAware)
// Added: 2025-12

/// VBT device types for data import
enum VBTDeviceType {
  VMAXPRO         // Vmaxpro/Enode sensor
  VITRUVE         // Vitruve encoder
  GYMAWARE        // GymAware PowerTool
  PUSH            // PUSH Band
  PERCH           // Perch system
  TENDO           // Tendo unit
  GENERIC         // Unknown/generic CSV format
}

/// VBT session - container for uploaded training session data
model VBTSession {
  id              String        @id @default(uuid())
  clientId        String
  coachId         String?       // Coach who uploaded (null if athlete self-upload)

  // Session info
  sessionDate     DateTime      // Date/time of training session
  deviceType      VBTDeviceType @default(GENERIC)
  deviceName      String?       // Device model/name from CSV
  fileName        String?       // Original uploaded filename

  // Session summary (calculated from measurements)
  totalSets       Int           @default(0)
  totalReps       Int           @default(0)
  exerciseCount   Int           @default(0)

  // Notes and context
  notes           String?       @db.Text
  sessionRPE      Int?          // Overall session RPE 1-10
  bodyWeight      Float?        // kg at time of session

  // Import metadata
  rawData         Json?         // Original CSV data preserved
  parseErrors     Json?         // Any parsing errors encountered

  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  measurements    VBTMeasurement[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([clientId])
  @@index([sessionDate])
  @@index([deviceType])
  @@index([clientId, sessionDate])
}

/// Individual VBT rep measurement from device
model VBTMeasurement {
  id              String     @id @default(uuid())
  sessionId       String
  exerciseId      String?    // Linked to our Exercise library (optional)

  // Exercise identification
  exerciseName    String     // Exercise name from CSV
  exerciseMatched Boolean    @default(false) // Whether auto-matched to Exercise

  // Set/rep info
  setNumber       Int
  repNumber       Int

  // Core velocity metrics (all in m/s)
  meanVelocity    Float?     // Average velocity during concentric phase
  peakVelocity    Float?     // Maximum velocity achieved
  meanVelocityDown Float?    // Eccentric mean velocity (if tracked)
  peakVelocityDown Float?    // Eccentric peak velocity (if tracked)

  // Power metrics (all in Watts)
  meanPower       Float?     // Average power output
  peakPower       Float?     // Maximum power output
  meanPowerDown   Float?     // Eccentric mean power
  peakPowerDown   Float?     // Eccentric peak power

  // Load and ROM
  load            Float?     // Weight/load in kg
  rom             Float?     // Range of motion in cm
  romPercentage   Float?     // ROM as % of max ROM for exercise

  // Time metrics (all in seconds)
  concentricTime  Float?     // Duration of concentric phase
  eccentricTime   Float?     // Duration of eccentric phase
  totalRepTime    Float?     // Total rep duration
  timeToPeakVel   Float?     // Time to reach peak velocity

  // Velocity loss tracking (for fatigue monitoring)
  velocityLoss    Float?     // % velocity loss from first rep in set
  velocityLossSet Float?     // % velocity loss across entire set (last vs first)

  // Calculated metrics
  estimatedE1RM   Float?     // Estimated 1RM from load-velocity profile
  velocityZone    String?    // "STRENGTH", "POWER", "SPEED", "SPEED_STRENGTH"
  repQuality      String?    // "GOOD", "FATIGUE", "COMPENSATING", "FAILED"

  // Device-specific raw data
  rawMetrics      Json?      // Preserve all original metrics from device

  session         VBTSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exercise        Exercise?  @relation(fields: [exerciseId], references: [id], onDelete: SetNull)

  createdAt       DateTime   @default(now())

  @@index([sessionId])
  @@index([exerciseId])
  @@index([exerciseName])
  @@index([sessionId, setNumber, repNumber])
  @@index([exerciseId, load])
}

/// Load-Velocity Profile for exercise-specific 1RM estimation
model LoadVelocityProfile {
  id              String   @id @default(uuid())
  clientId        String
  exerciseId      String

  // Profile data points (array of {load, velocity} pairs)
  dataPoints      Json     // [{load: 80, velocity: 0.55}, {load: 100, velocity: 0.35}, ...]

  // Linear regression coefficients (velocity = slope * load + intercept)
  slope           Float?   // Negative value (velocity decreases with load)
  intercept       Float?   // y-intercept (theoretical 0-load velocity)
  rSquared        Float?   // R² goodness of fit

  // Calculated 1RM at different velocity thresholds
  e1RM_0_3        Float?   // e1RM at 0.3 m/s (strength-speed)
  e1RM_0_2        Float?   // e1RM at 0.2 m/s (typical 1RM velocity for most lifts)
  e1RM_0_15       Float?   // e1RM at 0.15 m/s (true max, may fail)

  // Exercise-specific MVT (Minimum Velocity Threshold)
  mvt             Float?   // m/s - velocity at which exercise fails

  // Profile validity
  minLoad         Float?   // Minimum load in profile
  maxLoad         Float?   // Maximum load in profile
  loadRange       Float?   // % of 1RM range covered
  dataPointCount  Int      @default(0)
  isValid         Boolean  @default(false) // Enough data points and good R²

  // When this profile was last updated
  lastMeasurementAt DateTime?

  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  exercise        Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([clientId, exerciseId])
  @@index([clientId])
  @@index([exerciseId])
  @@index([isValid])
}

// ==================== CALENDAR SYSTEM ====================

/// Calendar events for tracking non-training activities (travel, camps, illness, vacation)
model CalendarEvent {
  id                    String                  @id @default(uuid())
  clientId              String

  // Event basics
  type                  CalendarEventType
  title                 String
  description           String?                 @db.Text
  status                CalendarEventStatus     @default(SCHEDULED)

  // Date/time
  startDate             DateTime                @db.Date
  endDate               DateTime                @db.Date
  allDay                Boolean                 @default(true)
  startTime             String?                 // "HH:mm" if not all-day
  endTime               String?                 // "HH:mm" if not all-day

  // Training impact
  trainingImpact        EventImpact             @default(NO_TRAINING)
  impactNotes           String?                 // "Morning sessions only", etc.

  // Altitude-specific (when type = ALTITUDE_CAMP)
  altitude              Int?                    // meters above sea level
  adaptationPhase       AltitudeAdaptationPhase?
  seaLevelReturnDate    DateTime?               // When athlete returns to sea level

  // Illness-specific (when type = ILLNESS)
  illnessType           String?                 // "RESPIRATORY", "GI", "FEVER", etc.
  returnToTrainingDate  DateTime?
  medicalClearance      Boolean                 @default(false)

  // External calendar integration
  externalCalendarId    String?                 // ID in external system
  externalCalendarType  String?                 // "GOOGLE", "OUTLOOK", "APPLE"
  externalCalendarName  String?                 // "Work Calendar", etc.
  lastSyncedAt          DateTime?
  isReadOnly            Boolean                 @default(false) // Imported events cannot be edited

  // Recurrence (future phase)
  isRecurring           Boolean                 @default(false)
  recurrenceRule        String?                 // iCal RRULE format
  recurrenceParentId    String?                 // Link to parent event

  // Metadata
  createdById           String
  lastModifiedById      String?
  color                 String?                 // Custom color override

  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relations
  client                Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy             User                    @relation("CreatedCalendarEvents", fields: [createdById], references: [id])
  lastModifiedBy        User?                   @relation("ModifiedCalendarEvents", fields: [lastModifiedById], references: [id])
  changeHistory         CalendarEventChange[]

  @@index([clientId, startDate, endDate])
  @@index([clientId, type])
  @@index([externalCalendarId, externalCalendarType])
  @@index([createdById])
  @@index([status])
}

/// Change history for calendar events (for notifications and audit trail)
model CalendarEventChange {
  id                    String                  @id @default(uuid())
  eventId               String?
  clientId              String

  // Change details
  changeType            String                  // EVENT_CREATED, EVENT_UPDATED, EVENT_DELETED, WORKOUT_RESCHEDULED, CONFLICT_DETECTED
  changedById           String
  description           String                  @db.Text

  // Snapshot data
  previousData          Json?                   // Snapshot of old state
  newData               Json?                   // Snapshot of new state

  // Notification tracking
  notificationRead      Boolean                 @default(false)
  notificationReadAt    DateTime?

  createdAt             DateTime                @default(now())

  // Relations
  event                 CalendarEvent?          @relation(fields: [eventId], references: [id], onDelete: SetNull)
  client                Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  changedBy             User                    @relation("CalendarChanges", fields: [changedById], references: [id])

  @@index([clientId, notificationRead, createdAt])
  @@index([eventId])
  @@index([changedById])
}

/// External calendar connections (Google, Outlook, Apple iCal)
model ExternalCalendarConnection {
  id                    String                  @id @default(uuid())
  clientId              String

  // Provider info
  provider              String                  // GOOGLE, OUTLOOK, APPLE, ICAL_URL
  calendarName          String                  // Display name
  calendarId            String                  // External calendar ID

  // OAuth tokens (Google/Outlook)
  accessToken           String?                 @db.Text
  refreshToken          String?                 @db.Text
  expiresAt             DateTime?

  // iCal URL (Apple/generic)
  icalUrl               String?                 @db.Text

  // Sync settings
  syncEnabled           Boolean                 @default(true)
  lastSyncAt            DateTime?
  lastSyncError         String?

  // Import settings
  importAsType          CalendarEventType       @default(EXTERNAL_EVENT)
  defaultImpact         EventImpact             @default(NORMAL)

  // Color coding
  color                 String?

  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relations
  client                Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, provider, calendarId])
  @@index([clientId])
  @@index([provider])
}

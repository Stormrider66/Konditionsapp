// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
}

enum TestType {
  RUNNING
  CYCLING
  SKIING
}

enum TestStatus {
  DRAFT
  COMPLETED
  ARCHIVED
}

enum UserRole {
  ADMIN
  COACH
  ATHLETE
}

enum WorkoutType {
  RUNNING
  STRENGTH
  PLYOMETRIC
  CORE
  RECOVERY
  CYCLING
  SKIING
  OTHER
}

enum WorkoutIntensity {
  RECOVERY      // Very easy
  EASY          // Zone 1-2
  MODERATE      // Zone 3
  THRESHOLD     // Zone 4
  INTERVAL      // Zone 5
  MAX           // All-out
}

enum PeriodPhase {
  BASE          // Building aerobic base
  BUILD         // Increasing intensity
  PEAK          // Race-specific training
  TAPER         // Pre-race recovery
  RECOVERY      // Post-race recovery
  TRANSITION    // Off-season
}

enum SubscriptionTier {
  FREE          // Basic features
  BASIC         // Up to 5 athletes
  PRO           // Up to 50 athletes
  ENTERPRISE    // Unlimited athletes
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      UserRole @default(COACH)
  language  String   @default("sv") // "sv" or "en"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Existing relations
  tests    Test[]
  clients  Client[]
  teams    Team[]

  // New relations for training programs
  coachPrograms     TrainingProgram[] @relation("CoachPrograms")
  exercises         Exercise[]
  workoutLogs       WorkoutLog[]
  sentMessages      Message[]         @relation("SentMessages")
  receivedMessages  Message[]         @relation("ReceivedMessages")
  athleteAccount    AthleteAccount?
  subscription      Subscription?

  @@index([email])
  @@index([role])
}

model Team {
  id        String   @id @default(uuid())
  userId    String
  name      String
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  members   Client[]

  @@index([userId])
  @@index([name])
}

model Client {
  id        String   @id @default(uuid())
  userId    String
  teamId    String?
  name      String
  email     String?
  phone     String?
  gender    Gender
  birthDate DateTime
  height    Float    // cm
  weight    Float    // kg
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user             User              @relation(fields: [userId], references: [id])
  team             Team?             @relation(fields: [teamId], references: [id], onDelete: SetNull)
  tests            Test[]
  trainingPrograms TrainingProgram[]
  athleteAccount   AthleteAccount?

  @@index([userId])
  @@index([teamId])
  @@index([name])
  @@index([email])
}

model Test {
  id         String     @id @default(uuid())
  clientId   String
  userId     String
  testDate   DateTime
  testType   TestType
  status     TestStatus @default(DRAFT)

  // Test metadata
  location    String?     // Piteå, Skellefteå, etc.
  testLeader  String?     // Name of test leader

  // Beräknade värden
  maxHR      Int?
  maxLactate Float?
  vo2max     Float?

  // Tröskelvärden
  aerobicThreshold    Json?  // {hr: number, value: number, unit: string}
  anaerobicThreshold  Json?  // {hr: number, value: number, unit: string}

  // Träningszoner
  trainingZones Json?  // Array av zoner

  // Anteckningar
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client           Client            @relation(fields: [clientId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  testStages       TestStage[]
  report           Report?
  trainingPrograms TrainingProgram[]

  @@index([clientId])
  @@index([userId])
  @@index([testDate])
  @@index([location])
}

model TestStage {
  id       String @id @default(uuid())
  testId   String
  sequence Int    // Ordning i testet

  // Gemensamma fält
  duration    Float  // minuter
  heartRate   Int    // slag/min
  lactate     Float  // mmol/L
  vo2         Float? // ml/kg/min

  // Löpspecifika
  speed       Float? // km/h
  incline     Float? // procent

  // Cykelspecifika
  power       Float? // watt
  cadence     Int?   // rpm

  // Skidåkning (Cross-country skiing)
  pace        Float? // min/km

  // Beräknade värden
  economy     Float? // ml/kg/km för löpning
  wattsPerKg  Float? // watt/kg för cykling

  createdAt DateTime @default(now())

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@index([sequence])
}

model Report {
  id        String   @id @default(uuid())
  testId    String   @unique

  // Rapportdata
  htmlContent String  @db.Text
  pdfUrl      String?

  // Metadata
  generatedAt DateTime @default(now())
  generatedBy String

  // Anpassningar
  customNotes     String?
  recommendations String?

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)
}

model TestTemplate {
  id          String   @id @default(uuid())
  userId      String
  name        String
  testType    TestType
  description String?
  stages      Json     // Array of stage configurations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([testType])
  @@index([name])
}

// ==================== SUBSCRIPTION & BILLING ====================

model Subscription {
  id     String             @id @default(uuid())
  userId String             @unique
  tier   SubscriptionTier   @default(FREE)
  status SubscriptionStatus @default(TRIAL)

  // Limits based on tier
  maxAthletes      Int      @default(0) // 0=FREE, 5=BASIC, 50=PRO, -1=ENTERPRISE (unlimited)
  currentAthletes  Int      @default(0)

  // Billing
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  trialEndsAt DateTime?
  cancelAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([tier])
}

// ==================== ATHLETE ACCOUNTS ====================

// Links a Client to an Athlete User account (1-to-1)
model AthleteAccount {
  id        String   @id @default(uuid())
  clientId  String   @unique
  userId    String   @unique

  // Athlete preferences
  notificationPrefs Json? // { email: boolean, push: boolean, workoutReminders: boolean }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([userId])
}

// ==================== TRAINING PROGRAMS ====================

model TrainingProgram {
  id          String   @id @default(uuid())
  clientId    String
  coachId     String   // User who created it
  testId      String?  // Optional: linked to specific test results

  name        String   // "Marathon Training - Spring 2025"
  description String?  @db.Text
  goalRace    String?  // "Stockholm Marathon", "Get in shape", "5K PR"
  goalDate    DateTime?
  goalType    String?  // "marathon", "half-marathon", "10k", "5k", "fitness", "cycling", "skiing"

  startDate DateTime
  endDate   DateTime

  // Metadata
  isActive   Boolean @default(true)
  isTemplate Boolean @default(false) // Can be reused as template

  // Generated from which test?
  generatedFromTest Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  coach  User   @relation("CoachPrograms", fields: [coachId], references: [id])
  test   Test?  @relation(fields: [testId], references: [id], onDelete: SetNull)

  weeks TrainingWeek[]

  @@index([clientId])
  @@index([coachId])
  @@index([testId])
  @@index([startDate, endDate])
  @@index([isActive])
}

model TrainingWeek {
  id        String @id @default(uuid())
  programId String

  weekNumber   Int    // 1, 2, 3...
  startDate    DateTime
  endDate      DateTime

  phase        PeriodPhase
  focus        String? // "Build endurance", "Taper week", "Recovery"
  weeklyVolume Float?  // Planned total hours or km

  notes String? @db.Text

  program TrainingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  days    TrainingDay[]

  @@unique([programId, weekNumber])
  @@index([programId])
  @@index([startDate, endDate])
}

model TrainingDay {
  id     String @id @default(uuid())
  weekId String

  dayNumber Int      // 1=Monday, 2=Tuesday, etc.
  date      DateTime

  notes String? @db.Text

  week     TrainingWeek @relation(fields: [weekId], references: [id], onDelete: Cascade)
  workouts Workout[]

  @@unique([weekId, dayNumber])
  @@index([weekId])
  @@index([date])
}

model Workout {
  id    String @id @default(uuid())
  dayId String

  type        WorkoutType
  name        String   // "Long Run", "Tempo Run", "Upper Body Strength"
  description String?  @db.Text

  intensity WorkoutIntensity
  duration  Int?   // Planned minutes
  distance  Float? // Planned km (for running)

  // Coach instructions
  instructions String? @db.Text
  coachNotes   String? @db.Text

  // Ordering (if multiple workouts in one day)
  order Int @default(1)

  // Is this a custom workout added by athlete?
  isCustom Boolean @default(false)

  day      TrainingDay      @relation(fields: [dayId], references: [id], onDelete: Cascade)
  segments WorkoutSegment[]
  logs     WorkoutLog[]
  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dayId, order])
  @@index([type])
  @@index([isCustom])
}

model WorkoutSegment {
  id        String @id @default(uuid())
  workoutId String

  order Int    // 1, 2, 3...
  type  String // "warmup", "interval", "cooldown", "exercise", "rest", "work"

  // Running/Cycling specific
  duration  Int?    // minutes
  distance  Float?  // km
  pace      String? // "5:00/km" or calculated from zone
  zone      Int?    // Training zone 1-5
  heartRate String? // "140-150 bpm" or zone-based
  power     Int?    // watts (cycling)

  // Interval-specific
  reps Int? // Number of repetitions (for intervals)

  // Strength/Plyo/Core specific
  exerciseId String? // FK to Exercise library
  sets       Int?
  repsCount  String? // "10" or "10-12" or "AMRAP" or "30 seconds"
  weight     String? // "80kg" or "BW" or "50% 1RM"
  tempo      String? // "3-1-1" (eccentric-pause-concentric)
  rest       Int?    // seconds between sets

  // General
  description String? @db.Text
  notes       String? @db.Text

  workout  Workout   @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exercise Exercise? @relation(fields: [exerciseId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([workoutId, order])
  @@index([exerciseId])
}

// ==================== EXERCISE LIBRARY ====================

model Exercise {
  id          String       @id @default(uuid())
  coachId     String?      // NULL = system exercise, else custom
  name        String       // "Back Squat", "Box Jump", "Plank"
  category    WorkoutType  // STRENGTH, PLYOMETRIC, CORE
  muscleGroup String?      // "Legs", "Core", "Upper Body"

  description  String? @db.Text
  instructions String? @db.Text
  videoUrl     String? // YouTube/Vimeo link
  equipment    String? // "Barbell, Rack", "Box", "None"

  difficulty String? // "Beginner", "Intermediate", "Advanced"

  isPublic Boolean @default(true) // System exercises vs coach-specific

  // Swedish/English names
  nameSv String?
  nameEn String?

  coach    User?            @relation(fields: [coachId], references: [id], onDelete: SetNull)
  segments WorkoutSegment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([category])
  @@index([name])
  @@index([isPublic])
}

// ==================== WORKOUT LOGGING ====================

model WorkoutLog {
  id         String  @id @default(uuid())
  workoutId  String
  athleteId  String  // User with ATHLETE role
  completed  Boolean @default(false)

  completedAt DateTime?

  // Actual values
  duration Int?   // actual minutes
  distance Float? // actual km
  avgPace  String? // "5:15/km"
  avgHR    Int?   // bpm
  maxHR    Int?   // bpm

  // Subjective feedback
  perceivedEffort Int?    // 1-10 RPE scale
  difficulty      Int?    // 1-5 stars
  feeling         String? // "Great", "Good", "Okay", "Tired", "Struggled"
  notes           String? @db.Text

  // File uploads (Garmin .fit, Strava link, etc.)
  dataFileUrl String?
  stravaUrl   String?

  // Coach feedback
  coachFeedback  String? @db.Text
  coachViewedAt  DateTime?

  workout Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  athlete User    @relation(fields: [athleteId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workoutId])
  @@index([athleteId])
  @@index([completedAt])
  @@index([completed])
}

// ==================== MESSAGING ====================

model Message {
  id         String  @id @default(uuid())
  senderId   String
  receiverId String

  subject String?
  content String  @db.Text

  // Optional: link to specific workout
  workoutId String?

  isRead Boolean   @default(false)
  readAt DateTime?

  sender   User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  workout  Workout? @relation(fields: [workoutId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@index([workoutId])
  @@index([createdAt])
  @@index([isRead])
}
